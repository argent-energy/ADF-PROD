{
	"$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"factoryName": {
			"type": "string",
			"metadata": "Data Factory name",
			"defaultValue": "adf-aeanalytics-prod"
		}
	},
	"variables": {
		"factoryId": "[concat('Microsoft.DataFactory/factories/', parameters('factoryName'))]"
	},
	"resources": [
		{
			"name": "[concat(parameters('factoryName'), '/SQL_Exp_And_Pos_Data_Marks_Script')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "Exposure And Position Data Marks Script",
						"type": "Script",
						"dependsOn": [],
						"policy": {
							"timeout": "7.00:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"linkedServiceName": {
							"referenceName": "SqlServerArgent",
							"type": "LinkedServiceReference"
						},
						"typeProperties": {
							"scripts": [
								{
									"type": "NonQuery",
									"text": "/*==============================================================================================================================*\r\n * Project:\t\tArgent\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Purpose:\t\tCreate data marts that feed in to Exposure and Position reports\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Description:\t1) Creates purchase contract, sales contract and inventory tables from Core tables created in previous script.\t*\r\n *\t\t\t\t2) Create formatted versions of the yield, blended sales and exposure limit tables for use in the reports\t\t*\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Prerequisites: CoreTables.sql script produces the core tables\t\t\t \t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Outputs: Tables \"Trade.PurchaseContracts\"; \"Trade.SalesContracts\"; \"Trade.InventoryOnHandBalance\";\t\t\t\t\t\t\t*\r\n *\t\t\t\"Trade.BlendedSales\"; \"Trade.Yield\"; \"Trade.ExposureLimits\"\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Impact: If the trade tables are appended to,\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t   then the SQL to Blob pipeline must be re-run\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Date:        29/07/2022\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Version:     1.0\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n *==============================================================================================================================*\r\n * Updates:\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Date\t\t| Version | Author\t\t| Change made\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * -----------------------------------------------------------------------------------------------------------------------------*\r\n * --/--/-- |  1.-\t  |\t\t\t\t|\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t|\t\t  |\t\t\t\t|\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *==============================================================================================================================*/\r\n\r\n /********************************************************************************************************\r\n\tStep 2.1:\tDelete current day's data from the final tables. This ensures that if the script is run more\r\n\t\t\t\tthan once in one day there is no duplicated data.\r\n********************************************************************************************************/\r\n\r\n\tDECLARE @DeleteTableStatement NVARCHAR(MAX)\r\n\tDECLARE Cur2 CURSOR READ_ONLY\r\n\tFOR\r\n\t\t\tSELECT  'Delete from [Trade].[' + TABLE_NAME + ']  where CAST([DateStamp] AS DATE) = CAST(GETDATE() AS DATE)'\r\n\t\t\tFROM    INFORMATION_SCHEMA.TABLES\r\n\t\t\tWHERE   TABLE_SCHEMA = 'Trade'\r\n\t\t\tAND\t\tTABLE_TYPE = 'BASE TABLE' \r\n\t\t\tAND\t\tTABLE_NAME IN ('SalesContracts','InventoryOnHandBalance','PurchaseContracts')\r\n\r\n\r\n\tOPEN Cur2\r\n\tFETCH NEXT FROM Cur2 INTO @DeleteTableStatement\r\n\tWHILE @@FETCH_STATUS = 0\r\n\t\t  BEGIN\r\n\t\t\t\tPRINT 'Executing ' + @DeleteTableStatement\r\n\t\t\t\tEXECUTE sp_executesql @DeleteTableStatement\r\n\t\t\t\tFETCH NEXT FROM Cur2 INTO @DeleteTableStatement\r\n\t\t  END\r\n\tCLOSE Cur2\r\n\tDEALLOCATE Cur2\r\n\r\n/********************************************************************************************************\r\n\tStep 2.2:\tCreate the Trade.Yield table.\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Trade].[Yield]','U') IS NOT NULL\r\n\t\tDROP TABLE [Trade].[Yield]\r\n\r\n\tSELECT\t\tCASE WHEN [Business Unit] = 'BDA' THEN 'BDA BU' ELSE [Business Unit] END AS [Business Unit]\r\n\t,\t\t\t[Item Category]\r\n\t,\t\t\t[Expected yield]\r\n\t,\t\t\tCONVERT(DATE,[Start date],103)\tAS [Start date]\r\n\t,\t\t\tCONVERT(DATE,[End date],103) AS [End date]\r\n\t,\t\t\t[Stamp]\r\n\tINTO\t\t[Trade].[Yield]\r\n\tFROM\t\t[RAW].[NO.Yields]\r\n\r\n/********************************************************************************************************\r\n\tStep 2.3:\tCreate the Trade.PurchaseContracts table.\r\n\r\n\t\t\t\tTrade.PurchaseContracts is built by joining [Core].[PurchaseContracts], [Core].[Suppliers],\r\n\t\t\t\t[Core].[Parties], [Core].[Organizations], [Core].[Items], [Core].[PurchaseOrders], ,\r\n\t\t\t\t[Core].[Users], [Core].[FXRates] and [Trade].[Yield]\r\n\r\n\t\t\t\t[Core].[Organizations] is filtered for [Business Unit Name] values of 'BDA BU', 'Motherwell'\r\n\t\t\t\tand 'Stanlow'.\r\n\r\n\t\t\t\tContracts with an end date prior to July 2021 and an [Amount Released Against Agreement] value of 0\r\n\t\t\t\tare not brought into Trade.PurchaseContracts\r\n\r\n\tAssumptions:\t1)\tChemical contracts (Item Code starts with \"CH\") that do not have a populated end date have\r\n\t\t\t\t\t\tthe end date set to the end of the year of the start date.\r\n\r\n\t\t\t\t\t2)\tDelivered Quantity is calculated by combining [Core].[PurchaseOrders] and [Core].[ReceivingTransactions]\r\n\t\t\t\t\t\tand filtering for [Destination Type Code] = 'INVENTORY', [Line Status] NOT IN ('OPEN','CANCELED','CLOSED FOR INVOICING')\r\n\t\t\t\t\t\tand [Transaction Type] <> 'RETURN TO RECEIVING' then summing [Primary Quantity].\r\n\r\n\t\t\t\t\t3)\tReturned Quantity is calculated by combining [Core].[PurchaseOrders] and [Core].[ReceivingTransactions]\r\n\t\t\t\t\t\tand filtering for [Destination Type Code] = 'INVENTORY', [Line Status] NOT IN ('OPEN','CANCELED','CLOSED FOR INVOICING')\r\n\t\t\t\t\t\tand [Transaction Type] = 'RETURN TO RECEIVING' then summing [Primary Quantity].\r\n\r\n\t\t\t\t\t4)\tYield adjusted volumes are calculated by joining [Trade].[Yields] onto the Core tables on date and item category.\r\n\t\t\t\t\t\tIf the item category is not found in [Trade].[Yields] then the average yield for the business unit is used.\r\n\r\n\t\t\t\t\t5)\tPurchase Document Status is changed to \"Closed\" for contracts that have expired and have a status that is not Closed, Finally Closed or Cancelled.\r\n\t\t\t\t\t\r\n********************************************************************************************************/\r\n\r\n\r\n\r\n\tINSERT INTO [Trade].[PurchaseContracts]\r\n\tSELECT\t\to.[Business Unit Name]\r\n\t,\t\t\tpc.[Blanket Purchase Agreement Number] \r\n\t,\t\t\tCONCAT(LEFT(pc.[Purchase Document Status],1),LOWER(SUBSTRING(pc.[Purchase Document Status],2,LEN(pc.[Purchase Document Status])-1)))\t\tAS [Purchase Document Status]\r\n\t,\t\t\tUPPER(sn.[Supplier Name])\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Supplier Name]\r\n\t,\t\t\tUPPER(s.[Supplier Site Name])\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Supplier Site Name]\r\n\t,\t\t\tpc.[Purchase Document Description]\r\n\t,\t\t\ti.[Item Code]\r\n\t,\t\t\ti.[Item Name]\r\n\t,\t\t\tpc.[Item Description]\r\n\t,\t\t\ti.[Category Code] \r\n\t,\t\t\tpc.[Unit Price] + pc.[Transporter Unit Price] + pc.[Additional Charges 1 Unit Price] + pc.[Additional Charges 2 Unit Price]\r\n\t\t\t\t+ ISNULL(CASE \r\n\t\t\t\t\t\t\tWHEN p.[Shipping Method] IN ('Argent - Truck','Argent - Container','AENL - Truck','AENL - Container','Argent - Drop Ship')\r\n\t\t\t\t\t\t\t\tTHEN (pc.[Transporter Amount] + pc.[Additional Charges 1 Amount] + pc.[Additional Charges 2 Amount])/25\r\n\t\t\t\t\t\t\tELSE (pc.[Transporter Amount] + pc.[Additional Charges 1 Amount] + pc.[Additional Charges 2 Amount])/CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN i.[Item Code] = 'CH00006'\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 650\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE NULLIF(pc.[Blanket Agreement Quantity],0)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\t END,0)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Total Price]\r\n\t,\t\t\tpc.[Unit Price]\r\n\t,\t\t\tpc.[Purchase Document Currency]\r\n\t,\t\t\tISNULL(pc.[Blanket Agreement Quantity],0)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Blanket Agreement Quantity]\r\n\t,\t\t\tpc.[UOM Code]\r\n\t,\t\t\tISNULL(dq.[Delivered Qty],0) - ISNULL(rq.[Returned Qty],0)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Delivered Quantity]\r\n\t,\t\t\tISNULL(oq.[Ordered Qty],0)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Order Quantity]\r\n\t,\t\t\tISNULL(pc.[Blanket Agreement Quantity],0) - (ISNULL(dq.[Delivered Qty],0) - ISNULL(rq.[Returned Qty],0)) - ISNULL(oq.[Ordered Qty],0)\t\tAS [Remaining Quantity]\r\n\t,\t\t\t(ISNULL(pc.[Blanket Agreement Quantity],0) - (ISNULL(dq.[Delivered Qty],0) - ISNULL(rq.[Returned Qty],0)) - ISNULL(oq.[Ordered Qty],0))/25\tAS [Trucks]\r\n\t,\t\t\t((ISNULL(dq.[Delivered Qty],0) - ISNULL(rq.[Returned Qty],0)) + ISNULL(oq.[Ordered Qty],0))/NULLIF(pc.[Blanket Agreement Quantity],0)\t\tAS [Position Now]\r\n\r\n\t--          Calculation below is [Expected Position] = 1 - ([Weeks Remaining]/[Weeknumbers Contract])\r\n\t,\t\t\t1 - (CAST(CASE\r\n\t\t\t\t\t\t\t\tWHEN CONVERT(DATE, DATEADD(DAY, 1, GETDATE() - DATEPART(DW, GETDATE()) + CASE WHEN DATEPART(DW, GETDATE()) < 1 THEN 0 ELSE 7 END )) < CAST(pc.[Agreement Start Date] AS DATE)\r\n\t\t\t\t\t\t\t\t\tTHEN\tCASE\r\n\t\t\t\t\t\t\t\t\t\t\t\tWHEN pc.[Agreement Start Date] IS NULL OR CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND IS NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 0\r\n\t\t\t\t\t\t\t\t\t\t\t\tELSE DATEDIFF(DAY,pc.[Agreement Start Date],CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] <> NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND)/7\r\n\t\t\t\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\t\t\tWHEN CONVERT(DATE, DATEADD(DAY, 1, GETDATE() - DATEPART(DW, GETDATE()) + CASE WHEN DATEPART(DW, GETDATE()) < 1 THEN 0 ELSE 7 END )) > CAST(CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND AS DATE)\r\n\t\t\t\t\t\t\t\t\tTHEN 0\r\n\t\t\t\t\t\t\t\tELSE DATEDIFF(DAY,CONVERT(DATE, DATEADD(DAY, 1, GETDATE() - DATEPART(DW, GETDATE()) + CASE WHEN DATEPART(DW, GETDATE()) < 1 THEN 0 ELSE 7 END )),CAST(CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND AS DATE))/7\r\n\t\t\t\t\t\t  END AS DECIMAL(28,2))\t\t\t\t\t\r\n\t\t\t\t\t/CAST(NULLIF(CASE\r\n\t\t\t\t\t\t\t\t\tWHEN pc.[Agreement Start Date] IS NULL OR CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND IS NULL\r\n\t\t\t\t\t\t\t\t\t\tTHEN 0\r\n\t\t\t\t\t\t\t\t\tELSE DATEDIFF(DAY,pc.[Agreement Start Date],CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND)/7\r\n\t\t\t\t\t\t\t\tEND,0) AS DECIMAL(28,2)))\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Expected Position]\r\n\r\n\t-- [Weeknumbers Contract] is calculated below as difference between [Agreement Start Date] and [Agreement End Date]\r\n\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN pc.[Agreement Start Date] IS NULL OR CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND IS NULL\r\n\t\t\t\t\t\tTHEN 0\r\n\t\t\t\t\tELSE DATEDIFF(DAY,pc.[Agreement Start Date],CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND)/7\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Weeknumbers Contract]\r\n\r\n\t-- [Weeks Remaining] is calculated below as\t\t- Difference between [Agreement Start Date and [Agreement End Date] if GETDATE() < [Agreement Start Date]\r\n\t--\t\t\t\t\t\t\t\t\t\t\t\t- 0 if GETDATE() > [Agreement End Date]\r\n\t--\t\t\t\t\t\t\t\t\t\t\t\t- ELSE difference between [Next Monday] and [Agreement End Date]\r\n\r\n\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN CONVERT(DATE, DATEADD(DAY, 1, GETDATE() - DATEPART(DW, GETDATE()) + CASE WHEN DATEPART(DW, GETDATE()) < 1 THEN 0 ELSE 7 END )) < CAST(pc.[Agreement Start Date] AS DATE)\r\n\t\t\t\t\t\t THEN\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN pc.[Agreement Start Date] = '' OR CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND IS NULL\r\n\t\t\t\t\t\t\t\t\t\tTHEN 0\r\n\t\t\t\t\t\t\t\t\tELSE DATEDIFF(DAY,pc.[Agreement Start Date],CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND)/7\r\n\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\tWHEN CONVERT(DATE, DATEADD(DAY, 1, GETDATE() - DATEPART(DW, GETDATE()) + CASE WHEN DATEPART(DW, GETDATE()) < 1 THEN 0 ELSE 7 END )) > CAST(CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND AS DATE)\r\n\t\t\t\t\t\t THEN 0\r\n\t\t\t\t\tELSE DATEDIFF(DAY,CONVERT(DATE, DATEADD(DAY, 1, GETDATE() - DATEPART(DW, GETDATE()) + CASE WHEN DATEPART(DW, GETDATE()) < 1 THEN 0 ELSE 7 END )),CAST(CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND AS DATE))/7\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Weeks Remaining]\r\n\r\n\t,\t\t\tCONVERT(DATE, DATEADD(DAY, 1, GETDATE() - DATEPART(DW, GETDATE()) + CASE WHEN DATEPART(DW, GETDATE()) < 1 THEN 0 ELSE 7 END ))\t\t\tAS [Next Monday]\r\n\t,\t\t\tpc.[Agreement Start Date]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Agreement End Date]\r\n\t,\t\t\tp.[Shipping Method]\r\n\t,\t\t\tpc.[Incoterm]\r\n\t,\t\t\tpc.[Transporter Name]\r\n\t,\t\t\tpc.[Transporter Unit Price]\r\n\t,\t\t\tpc.[Transporter Amount]\r\n\t,\t\t\tpc.[Transporter Currency]\r\n\t,\t\t\tpc.[Additional Charges 1 Supplier]\t\r\n\t,\t\t\tpc.[Additional Charges 1 Unit Price]\r\n\t,\t\t\tpc.[Additional Charges 1 Amount]\r\n\t,\t\t\tpc.[Additional Charges 1 Currency]\r\n\t,\t\t\tpc.[Additional Charges 2 Supplier]\t\r\n\t,\t\t\tpc.[Additional Charges 2 Unit Price]\r\n\t,\t\t\tpc.[Additional Charges 2 Amount]\r\n\t,\t\t\tpc.[Additional Charges 2 Currency]\r\n\t,\t\t\tu.[Username]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Buyer]\r\n\t,\t\t\tpc.[Sustainability Position]\r\n\t,\t\t\tpc.[Supplier Item]\r\n\t,\t\t\tpc.[Deal Date]\r\n\t,\t\t\tpc.[Agreement Amount]\r\n\t,\t\t\tpc.[Amount Released Against Agreement]\r\n\t,\t\t\tpc.[Note To Vendor]\r\n\t,\t\t\tpc.[FFA Spec]\t\t\t\r\n\t,\t\t\tpc.[Line Status]\r\n\t,\t\t\tfx.[EUR USD]\r\n\t,\t\t\tfx.[EUR GBP]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN CASE\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL THEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31') ELSE pc.[Agreement End Date]  END IS NULL\r\n\r\n\r\n\t\t\t\t\tTHEN CONCAT(LEFT(pc.[Purchase Document Status],1),LOWER(SUBSTRING(pc.[Purchase Document Status],2,LEN(pc.[Purchase Document Status])-1)))\r\n\t\t\t\t\t\r\n\t\t\t\t\tWHEN pc.[Purchase Document Status] not in ('closed' ,'finally closed', 'canceled') AND CAST(CASE WHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL THEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31') ELSE pc.[Agreement End Date] END AS DATE) < GETDATE()\r\n\t\t\t\t\t\tTHEN 'Closed'\r\n\t\t\t\t\tELSE CONCAT(LEFT(pc.[Purchase Document Status],1),LOWER(SUBSTRING(pc.[Purchase Document Status],2,LEN(pc.[Purchase Document Status])-1)))\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Updated Contract Status]\r\n\t,\t\t\tCAST(GETDATE() AS DATE)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [DateStamp]\r\n\t,\t\t\tISNULL(pc.[Blanket Agreement Quantity],0) * ISNULL(ISNULL(y.[Expected yield],av.[Average Yield]),av2.[Average Yield])\t\t\t\t\t\t\tAS [Yield Adjusted Volume]\r\n\t,\t\t\tCAST(ISNULL(ISNULL(DATEADD(d,DATEDIFF(d,pc.[Agreement Start Date],CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t \t  WHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t \t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t \t  ELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t END)/2,pc.[Agreement Start Date]),pc.[Agreement Start Date]),CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  \t  WHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  \t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  \t  ELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  END) AS DATE)\t\t\tAS [Agreement Mid Date]\t\r\n\t,\t\t\tISNULL(pc.[Blanket Agreement Quantity],0) - (ISNULL(dq.[Delivered Qty],0) - ISNULL(rq.[Returned Qty],0))\t\t\t\t\t\t\t\t\t\tAS [Non-Delivered Quantity]\r\n\t,\t\t\t(ISNULL(pc.[Blanket Agreement Quantity],0) - (ISNULL(dq.[Delivered Qty],0) - ISNULL(rq.[Returned Qty],0)))\r\n\t\t\t\t\t* ISNULL(ISNULL(y.[Expected yield],av.[Average Yield]),av2.[Average Yield])\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Yield Adjusted Volume Non-Delivered]\r\n\tFROM\t\t[Core].[PurchaseContracts] pc\r\n\tLEFT JOIN\t[Core].[Suppliers] s\r\n\tON\t\t\tpc.[Supplier] = s.[Vendor ID]\r\n\tAND\t\t\tpc.[Vendor Site ID] = s.[Vendor Site ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Party ID] \r\n\t\t\t\t\t,\t\t\tMIN([Party Name])\tAS [Supplier Name]\r\n\t\t\t\t\tFROM\t\t[Core].[Parties]\r\n\t\t\t\t\tGROUP BY\t[Party ID]\r\n\t\t\t\t) sn\r\n\tON\t\t\ts.[Party ID] = sn.[Party ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Business Unit ID]\r\n\t\t\t\t\t,\t\t\t[Business Unit Name]\r\n\t\t\t\t\tFROM\t\t[Core].[Organizations]\r\n\t\t\t\t\tGROUP BY\t[Business Unit ID]\r\n\t\t\t\t\t,\t\t\t[Business Unit Name]\r\n\t\t\t\t) o\r\n\tON\t\t\tpc.[Purchasing BU] = o.[Business Unit ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Item Code]\r\n\t\t\t\t\t,\t\t\t[Inventory Item ID]\r\n\t\t\t\t\t,\t\t\t[Category Code]\r\n\t\t\t\t\t,\t\t\tMIN([Item Name])\tAS [Item Name]\r\n\t\t\t\t\tFROM\t\t[Core].[Items]\r\n\t\t\t\t\tGROUP BY\t[Item Code]\r\n\t\t\t\t\t,\t\t\t[Inventory Item ID]\r\n\t\t\t\t\t,\t\t\t[Category Code]\r\n\t\t\t\t) i \r\n\tON\t\t\ti.[Inventory Item ID] = pc.[Item ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Party ID]\r\n\t\t\t\t\t,\t\t\tMIN([Party Name])\tAS [Shipping Method]\r\n\t\t\t\t\tFROM\t\t[Core].[Parties]\r\n\t\t\t\t\tGROUP BY\t[Party ID]\r\n\t\t\t\t) p\r\n\tON\t\t\tpc.[Carrier ID] = p.[Party ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[From Header ID]\r\n\t\t\t\t\t,\t\t\t[po].[From Line ID]\r\n\t\t\t\t\t,\t\t\tSUM(ISNULL(CAST(CASE WHEN LTRIM(RTRIM(rt.[Primary Quantity])) IS NULL THEN '0' ELSE LTRIM(RTRIM(rt.[Primary Quantity])) END AS NUMERIC(28,8)),0)) AS [Delivered Qty]\r\n\t\t\t\t\tFROM\t\t[Core].[PurchaseOrders] po\r\n\t\t\t\t\tLEFT JOIN\t[Core].[ReceivingTransactions] rt\r\n\t\t\t\t\tON\t\t\trt.[PO Line ID] = po.[PO Line ID]\r\n\t\t\t\t\tWHERE\t\trt.[Destination Type Code] = 'INVENTORY'\r\n\t\t\t\t\tAND\t\t\tpo.[Line Status] NOT IN ('OPEN','CANCELED','CLOSED FOR INVOICING')\r\n\t\t\t\t\tAND\t\t\trt.[Transaction Type] <> 'RETURN TO RECEIVING'\r\n\t\t\t\t\tGROUP BY\t[From Header ID]\r\n\t\t\t\t\t,\t\t\t[po].[From Line ID]\r\n\t\t\t\t) dq\r\n\tON\t\t\tdq.[From Header ID] = pc.[PO Header ID]\r\n\tAND\t\t\tdq.[From Line ID] = pc.[PO Line ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[From Header ID]\r\n\t\t\t\t\t,\t\t\t[po].[From Line ID]\r\n\t\t\t\t\t,\t\t\tSUM(ISNULL(CAST(CASE WHEN LTRIM(RTRIM(rt.[Primary Quantity])) IS NULL THEN '0' ELSE LTRIM(RTRIM(rt.[Primary Quantity])) END AS NUMERIC(28,8)),0)) AS [Returned Qty]\r\n\t\t\t\t\tFROM\t\t[Core].[PurchaseOrders] po\r\n\t\t\t\t\tLEFT JOIN\t[Core].[ReceivingTransactions] rt\r\n\t\t\t\t\tON\t\t\trt.[PO Line ID] = po.[PO Line ID]\r\n\t\t\t\t\tWHERE\t\trt.[Destination Type Code] = 'INVENTORY'\r\n\t\t\t\t\tAND\t\t\tpo.[Line Status] NOT IN ('OPEN','CANCELED','CLOSED FOR INVOICING')\r\n\t\t\t\t\tAND\t\t\trt.[Transaction Type] = 'RETURN TO RECEIVING'\r\n\t\t\t\t\tGROUP BY\t[From Header ID]\r\n\t\t\t\t\t,\t\t\t[po].[From Line ID]\r\n\t\t\t\t) rq\r\n\tON\t\t\trq.[From Header ID] = pc.[PO Header ID]\r\n\tAND\t\t\trq.[From Line ID] = pc.[PO Line ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[From Header ID]\r\n\t\t\t\t\t,\t\t\t[From Line ID]\r\n\t\t\t\t\t,\t\t\tSUM(ISNULL(CAST(CASE WHEN LTRIM(RTRIM([Ordered Quantity])) IS NULL THEN '0' ELSE LTRIM(RTRIM([Ordered Quantity])) END AS NUMERIC(28,8)),0)) AS [Ordered Qty]\r\n\t\t\t\t\tFROM\t\t[Core].[PurchaseOrders]\r\n\t\t\t\t\tWHERE\t\t[Line Status] IN ('OPEN','CLOSED FOR INVOICING')\r\n\t\t\t\t\tGROUP BY\t[From Header ID]\r\n\t\t\t\t\t,\t\t\t[From Line ID]\r\n\t\t\t\t) oq\r\n\tON\t\t\toq.[From Header ID] = pc.[PO Header ID]\r\n\tAND\t\t\toq.[From Line ID] = pc.[PO Line ID]\r\n\tLEFT JOIN\t[Core].[Users] u\r\n\tON\t\t\tpc.[Buyer] = u.[Person ID]\r\n\tLEFT JOIN\t[Core].[FXRates] fx\r\n\tON\t\t\tCAST(pc.[Agreement Start Date] AS DATE) = CAST(fx.[CONVERSION_DATE] AS DATE)\r\n\tLEFT JOIN\t[Trade].[Yield] y\r\n\tON\t\t\to.[Business Unit Name] = y.[Business Unit]\r\n\tAND\t\t\tCASE WHEN i.[Category Code] = 'Feedstock.TallowABP' THEN 'Feedstock.Tallow' ELSE i.[Category Code] END = y.[Item Category]\r\n\tAND\t\t\t(CASE WHEN YEAR(CAST(pc.[Agreement Start Date] AS DATE)) < 2020 THEN CAST('2020-01-01' AS DATE)\r\n\t\t\t\t\t ELSE CAST(pc.[Agreement Start Date] AS DATE)\r\n\t\t\t\tEND BETWEEN y.[Start Date] AND y.[End date] OR (pc.[Agreement Start Date] > y.[Start Date] AND y.[End date] IS NULL))\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\t\tSELECT\t\tDISTINCT [Business Unit]\r\n\t\t\t\t\t\t,\t\t\t[Start date]\r\n\t\t\t\t\t\t,\t\t\t[End date]\r\n\t\t\t\t\t\t,\t\t\tAVG(CAST([Expected yield] AS DECIMAL(28,8)))OVER(PARTITION BY [Business Unit], [Start date]) AS [Average Yield]\r\n\t\t\t\t\t\tFROM\t\t[Trade].[Yield]\t\r\n\t\t\t\t) av\r\n\tON\t\t\to.[Business Unit Name] = av.[Business Unit]\r\n\tAND\t\t\tCASE WHEN YEAR(CAST(pc.[Agreement Start Date] AS DATE)) < 2020 THEN CAST('2020-01-01' AS DATE)\r\n\t\t\t\t\t ELSE CAST(pc.[Agreement Start Date] AS DATE)\r\n\t\t\t\tEND BETWEEN av.[Start Date] AND ISNULL(av.[End date],CAST(GETDATE() AS DATE))\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\t\tSELECT\t\tDISTINCT [Business Unit]\r\n\t\t\t\t\t\t,\t\t\t[Start date]\r\n\t\t\t\t\t\t,\t\t\t[End date]\r\n\t\t\t\t\t\t,\t\t\tAVG(CAST([Expected yield] AS DECIMAL(28,8)))OVER(PARTITION BY [Business Unit], [Start date]) AS [Average Yield]\r\n\t\t\t\t\t\tFROM\t\t[Trade].[Yield]\t\r\n\t\t\t\t\t\tWHERE\t\tCAST(GETDATE() AS DATE) BETWEEN [Start Date] AND ISNULL([End date],CAST(GETDATE() AS DATE))\r\n\t\t\t\t) av2\r\n\tON\t\t\to.[Business Unit Name] = av2.[Business Unit]\r\n\tWHERE\t\to.[Business Unit Name] IN ('BDA BU','Motherwell','Stanlow')\r\n\tAND\t\t\tpc.[Blanket Purchase Agreement Number] NOT IN (\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tSELECT\t\tDISTINCT [Blanket Purchase Agreement Number]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tFROM\t\t[Core].[PurchaseContracts]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHERE\t\t[Amount Released Against Agreement] = 0\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAND\t\t\t[Agreement End Date] < '2021-07-01'\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t   ) \t\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n/********************************************************************************************************\r\n\tStep 2.4:\tCreate the Trade.SalesContracts table.\r\n\r\n\t\t\t\tTrade.SalesContracts is built by joining [Core].[Parties], [Core].[Organizations], [Core].[Items]\r\n\t\t\t\t, [Core].[SalesContracts], [Core].[SalesOrders_Fulfilled] and [Core].[FXRates]\r\n\r\n\t\t\t\t[Core].[SalesContracts] is filtered for [Version Type] equals ‘C’.​\r\n\r\n\t\t\t\t[Core].[Organizations] is filtered for [Business Unit Name] values of 'BDA BU', 'Motherwell’ and 'Stanlow’\r\n\r\n\tAssumptions:\t1)\tShipped and Order Quantities are calculated by combining [Core].[SalesContracts] and [Core].[SalesOrders_Fulfilled]\r\n\t\t\t\t\t\tthen filtering for [Version Type] = 'C', [ORDERED_UOM] = 'TN' and [REFERENCE_FLINE_ID] IS NULL.\r\n\r\n\t\t\t\t\t2)\tPurchase Document Status is changed to \"Closed\" for contracts that have expired and have a status that is not Closed, Finally Closed, Cancelled or Expired.\r\n\t\t\t\t\t\r\n********************************************************************************************************/\r\n \r\n\r\n\r\n\r\n\tINSERT INTO [Trade].[SalesContracts]\r\n\tSELECT\t\to.[Business Unit Name]\r\n\t,\t\t\tsc.[Sales Contract Number]\r\n\t,\t\t\tsc.[Sales Contract Version]\r\n\t,\t\t\tREPLACE(CONCAT(LEFT(sc.[Sales Contract Status],1),LOWER(SUBSTRING(sc.[Sales Contract Status],2,LEN(sc.[Sales Contract Status])-1))),'_',' ')\tAS [Sales Contract Status]\r\n\t,\t\t\tUPPER(c.[Customer])\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Customer]\r\n\t,\t\t\tc.[Customer Number]\r\n\t,\t\t\tUPPER(sc.[Customer Bill To])\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Customer Bill To]\r\n\t,\t\t\tUPPER(sc.[Customer Ship To])\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Customer Ship To]\r\n\t,\t\t\tsc.[Description]\r\n\t,\t\t\tsc.[Additional Description]\r\n\t,\t\t\tsc.[Item Name]\r\n\t,\t\t\ti.[Item Name]\tAS [Item Description]\r\n\t,\t\t\ti.[Category Code]\r\n\t,\t\t\tCAST(CASE WHEN sc.[Agreement Price] IS NULL THEN '0' ELSE sc.[Agreement Price] END AS NUMERIC(28,8)) \r\n\t\t\t\t- CAST(CASE WHEN sc.[Transporter Unit Price] IS NULL THEN '0' ELSE sc.[Transporter Unit Price] END AS NUMERIC(28,2))\r\n\t\t\t\t- CAST(CASE WHEN sc.[Additional Charges 1 Unit Price] IS NULL THEN '0' ELSE sc.[Additional Charges 1 Unit Price] END AS NUMERIC(28,2))\r\n\t\t\t\t- CAST(CASE WHEN sc.[Additional Charges 2 Unit Price] IS NULL THEN '0' ELSE sc.[Additional Charges 2 Unit Price] END AS NUMERIC(28,2))\t\tAS [Total Price per tonne]\r\n\t,\t\t\t(CAST(CASE WHEN sc.[Transporter Amount] IS NULL THEN '0' ELSE sc.[Transporter Amount] END AS NUMERIC(28,2))\r\n\t\t\t\t+ CAST(CASE WHEN sc.[Additional Charges 1 Amount] IS NULL THEN '0' ELSE sc.[Additional Charges 1 Amount] END AS NUMERIC(28,2))\r\n\t\t\t\t+ CAST(CASE WHEN sc.[Additional Charges 2 Amount] IS NULL THEN '0' ELSE sc.[Additional Charges 2 Amount] END AS NUMERIC(28,2))) * (-1)\t\tAS [Add. Cost per Transport]\r\n\t,\t\t\tsc.[Currency Code]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN sc.[Line Quantity] IS NULL\r\n\t\t\t\t\t\tTHEN CAST(CASE WHEN sc.[Line Amount] IS NULL THEN '0' ELSE sc.[Line Amount] END AS NUMERIC(28,2))/NULLIF(CAST(CASE WHEN sc.[Agreement Price] IS NULL THEN '0' ELSE sc.[Agreement Price] END AS NUMERIC(28,2)),0)\r\n\t\t\t\t\tELSE CAST(sc.[Line Quantity] AS NUMERIC(28,2))\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Line Quantity]\r\n\t,\t\t\tsc.[UOM Code]\r\n\t,\t\t\tsc.[Line Start Date]\r\n\t,\t\t\tsc.[Line End Date]\r\n\t,\t\t\tsc.[Shipping Method]\r\n\t,\t\t\tsc.[Incoterm]\r\n\t,\t\t\to.[Business Unit Name]\t\t\t\t\t\t\t\tAS [Seller]\r\n\t,\t\t\tISNULL(q.[Order Quantity],0)\t\t\t\t\t\tAS [Order Quantity]\t\r\n\t,\t\t\tISNULL(q.[Shipped Quantity],0)\t\t\t\t\t\tAS [Shipped Quantity]\r\n\t,\t\t\tsc.[Line Amount]\r\n\t,\t\t\tsc.[Agreement Price]\r\n\t,\t\t\tsc.[Transporter]\r\n\t,\t\t\tsc.[Transporter Unit Price]\r\n\t,\t\t\tsc.[Transporter Amount]\r\n\t,\t\t\tsc.[Transporter Currency]\r\n\t,\t\t\tsc.[Additional Charges 1 Supplier]\r\n\t,\t\t\tsc.[Additional Charges 1 Description]\r\n\t,\t\t\tsc.[Additional Charges 1 Unit Price]\r\n\t,\t\t\tsc.[Additional Charges 1 Amount]\r\n\t,\t\t\tsc.[Additional Charges 1 Currency]\r\n\t,\t\t\tsc.[Additional Charges 2 Supplier]\r\n\t,\t\t\tsc.[Additional Charges 2 Description]\r\n\t,\t\t\tsc.[Additional Charges 2 Unit Price]\r\n\t,\t\t\tsc.[Additional Charges 2 Amount]\r\n\t,\t\t\tsc.[Additional Charges 2 Currency]\r\n\t,\t\t\tsc.[Trader]\r\n\t,\t\t\tsc.[Deal Date]\r\n\t,\t\t\tsc.[Payment Term]\r\n\t,\t\t\tsc.[Tolerance]\r\n\t,\t\t\tsc.[Laycan]\r\n\t,\t\t\tsc.[Sustainability Contact]\r\n\t,\t\t\tsc.[Sustainability Position]\r\n\t,\t\t\tsc.[Sustainability Position Details]\r\n\t,\t\t\tsc.[Quality]\r\n\t,\t\t\tsc.[Temperature]\r\n\t,\t\t\tsc.[Nomination]\r\n\t,\t\t\tsc.[Nomination Requirement]\t\r\n\t,\t\t\tsc.[Lay Time]\r\n\t,\t\t\tsc.[Inspection]\r\n\t,\t\t\tsc.[Detenation Demurrage]\r\n\t,\t\t\tsc.[Demurrage Vessel]\r\n\t,\t\t\tsc.[Legislation]\r\n\t,\t\t\tsc.[Disposal Method]\r\n\t,\t\t\tsc.[Waste Stream Number]\r\n\t,\t\t\tsc.[Waste Description]\r\n\t,\t\t\tsc.[VET ID]\r\n\t,\t\t\tfx.[EUR USD]\r\n\t,\t\t\tfx.[EUR GBP]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN sc.[Sales Contract Status] not in ('Closed', 'Caneled','Finally closed', 'expired') AND ISDATE([Line End Date]) = 1 AND CAST([Line End Date] AS DATE) < GETDATE()\r\n\t\t\t\t\t\tTHEN 'Closed'\r\n\t\t\t\t\tELSE sc.[Sales Contract Status]\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Updated Contract Status]\r\n\t,\t\t\tCAST(GETDATE() AS DATE)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [DateStamp]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN sc.[Line Quantity] IS NULL\r\n\t\t\t\t\t\tTHEN CAST(CASE WHEN sc.[Line Amount] IS NULL THEN '0' ELSE sc.[Line Amount] END AS NUMERIC(28,2))/NULLIF(CAST(CASE WHEN sc.[Agreement Price] IS NULL THEN '0' ELSE sc.[Agreement Price] END AS NUMERIC(28,2)),0)\r\n\t\t\t\t\tELSE CAST(sc.[Line Quantity] AS NUMERIC(28,2))\r\n\t\t\t\tEND - ISNULL(q.[Shipped Quantity],0)\t\t\t\tAS [Volume Non-Delivered]\r\n\t,\t\t\tCAST(ISNULL(ISNULL(DATEADD(d,DATEDIFF(d,sc.[Line Start Date],sc.[Line End Date])/2,sc.[Line Start Date]),sc.[Line Start Date]),sc.[Line End Date]) AS DATE) AS [Line Mid Date]\r\n\tFROM\t\t[Core].[SalesContracts] sc\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Party ID]\r\n\t\t\t\t\t,\t\t\t[Party Number]\t\tAS [Customer Number]\r\n\t\t\t\t\t,\t\t\tMIN([Party Name])\tAS [Customer]\r\n\t\t\t\t\tFROM\t\t[Core].[Parties]\r\n\t\t\t\t\tGROUP BY\t[Party ID]\r\n\t\t\t\t\t,\t\t\t[Party Number]\r\n\t\t\t\t) c\r\n\tON\t\t\tsc.[Sales Contract Customer] = c.[Party ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Business Unit ID]\r\n\t\t\t\t\t,\t\t\t[Business Unit Name]\r\n\t\t\t\t\tFROM\t\t[Core].[Organizations]\r\n\t\t\t\t\tGROUP BY\t[Business Unit ID]\r\n\t\t\t\t\t,\t\t\t[Business Unit Name]\r\n\t\t\t\t) o\r\n\tON\t\t\tsc.[Business Unit] = o.[Business Unit ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Item Code]\r\n\t\t\t\t\t,\t\t\t[Item Name]\r\n\t\t\t\t\t,\t\t\t[Category Code]\r\n\t\t\t\t\tFROM\t\t[Core].[Items] \r\n\t\t\t\t\tWHERE\t\t[Organization ID] = '300000001513519' --Master Stock List\r\n\t\t\t\t\tGROUP BY\t[Item Code]\r\n\t\t\t\t\t,\t\t\t[Item Name]\r\n\t\t\t\t\t,\t\t\t[Category Code]\r\n\t\t\t\t) i\r\n\tON\t\t\ti.[Item Code] = sc.[Item Name]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tsc.[Contract Header ID]\r\n\t\t\t\t\t,\t\t\tsc.[Line ID]\r\n\t\t\t\t\t,\t\t\tSUM(CAST(sof.[FULFILLED_QTY] AS NUMERIC(28,2)) - 2*CAST(sof.[RMA_DELIVERED_QTY] AS NUMERIC(28,2)))\tAS [Shipped Quantity]\r\n\t\t\t\t\t,\t\t\tSUM(CAST(sof.[ORDERED_QTY] AS NUMERIC(28,2)) - CAST(sof.[FULFILLED_QTY] AS NUMERIC(28,2)))\t\t\tAS [Order Quantity]\r\n\t\t\t\t\tFROM\t\t[Core].[SalesContracts] sc\r\n\t\t\t\t\tLEFT JOIN\t[Core].[SalesOrders_Fulfilled] sof\r\n\t\t\t\t\tON\t\t\tsc.[Contract Header ID] = sof.[AGREEMENT_HEADER_ID]\r\n\t\t\t\t\tAND\t\t\tsc.[Line ID] = sof.[AGREEMENT_LINE_ID]\r\n\t\t\t\t\tWHERE\t\tsc.[Version Type] = 'C'\r\n\t\t\t\t\tAND\t\t\tsof.[ORDERED_UOM] = 'TN'\r\n\t\t\t\t\tAND\t\t\tsof.[REFERENCE_FLINE_ID] IS NULL\r\n\t\t\t\t\tGROUP BY\tsc.[Contract Header ID]\r\n\t\t\t\t\t,\t\t\tsc.[Line ID]\r\n\t\t\t\t) q\t\r\n\tON\t\t\tsc.[Contract Header ID] = q.[Contract Header ID]\r\n\tAND\t\t\tsc.[Line ID] = q.[Line ID]\r\n\tLEFT JOIN\t[Core].[FXRates] fx\r\n\tON\t\t\tCAST(sc.[Line Start Date] AS DATE) = CAST(fx.[CONVERSION_DATE] AS DATE)\r\n\tWHERE\t\t[Version Type] = 'C'\r\n\tAND\t\t\to.[Business Unit Name] IN ('Motherwell','Stanlow','BDA BU')\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n/********************************************************************************************************\r\n\tStep 2.5:\tCreate the Trade.InventoryOnHandBalances table.\r\n\r\n\t\t\t\tTrade.InventoryOnHandBalance is built by joining [Core].[OnHandBalance] and [Trade].[Yield]\r\n\r\n\t\t\t\t[Business Unit Name] is filtered for Motherwell, Stanlow and BDA BU.\r\n\r\n\tAssumptions:\t1)\tIf the Transaction UOM Code = 'LTR' or 'MLT' then the [Primary Transaction Quantity] is multiplied \r\n\t\t\t\t\t\tby 0.0008745 to convert to metric tonnes.\r\n\r\n\t\t\t\t\t2)\tYield adjusted volumes are calculated by joining [Trade].[Yields] onto the Core tables on date and item category.\r\n\t\t\t\t\t\tIf the item category is not found in [Trade].[Yields] then the average yield for the business unit is used.\r\n********************************************************************************************************/\r\n\r\n\r\n\r\n\r\n\tINSERT INTO [Trade].[InventoryOnHandBalance]\r\n\tSELECT\t\tohb.[Inventory Organization Name]\t\t\t\t\t\t\t\tAS [Inventory Organization Name]\t\t\r\n\t,\t\t\tohb.[Item ID]\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Item ID]\t\t\t\t\t\t\t\r\n\t,\t\t\tohb.[Inventory Organization ID]\t\t\t\t\t\t\t\t\tAS [Inventory Organization ID]\t\t\t\r\n\t,\t\t\tohb.[Primary Transaction Quantity]\t\t\t\t\t\t\t\tAS [Primary Transaction Quantity]\t\t\r\n\t,\t\t\tohb.[Subinventory]\t\t\t\t\t\t\t\t\t\t\t\tAS [Subinventory]\t\t\t\t\t\t\r\n\t,\t\t\tohb.[Onhand Quantities ID]\t\t\t\t\t\t\t\t\t\tAS [Onhand Quantities ID]\t\t\t\t\r\n\t,\t\t\tohb.[Transaction UOM Code]\t\t\t\t\t\t\t\t\t\tAS [Transaction UOM Code]\t\t\t\t\r\n\t,\t\t\tohb.[Lot Number]\t\t\t\t\t\t\t\t\t\t\t\tAS [Lot Number]\t\t\t\t\t\t\r\n\t,\t\t\tohb.[Item Code]\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Item Code]\t\t\t\t\t\t\t\r\n\t,\t\t\tohb.[Item Name]\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Item Name]\t\t\t\t\t\t\t\r\n\t,\t\t\tohb.[Category Set Name]\t\t\t\t\t\t\t\t\t\t\tAS [Category Set Name]\t\t\t\t\t\r\n\t,\t\t\tohb.[Category Code]\t\t\t\t\t\t\t\t\t\t\t\tAS [Category Code]\t\t\t\t\t\t\r\n\t,\t\t\tohb.[Category Set Description]\t\t\t\t\t\t\t\t\tAS [Category Set Description]\t\t\t\r\n\t,\t\t\tCAST(GETDATE() AS DATE)\t\t\t\t\t\t\t\t\t\t\tAS [DateStamp]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN ohb.[Transaction UOM Code] IN ('LTR', 'MLT', 'SLT')\r\n\t\t\t\t\t\tTHEN ohb.[Primary Transaction Quantity] * 0.0008745\r\n\t\t\t\t\tELSE ohb.[Primary Transaction Quantity]\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Primary Transaction Quantity MT]\r\n\t,\t\t\tohb.[Business Unit Name]\t\t\t\t\t\t\t\t\t\tAS [Business Unit Name]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN ohb.[Transaction UOM Code] IN ('LTR', 'MLT', 'SLT')\r\n\t\t\t\t\t\tTHEN ohb.[Primary Transaction Quantity] * 0.0008745\r\n\t\t\t\t\tELSE ohb.[Primary Transaction Quantity]\r\n\t\t\t\tEND * ISNULL(y.[Expected yield],av.[Average Yield])\t\t\t\tAS [Yield Adjusted Volume]\r\n\tFROM\t\t[Core].[OnHandBalance] ohb\r\n\tLEFT JOIN\t[Trade].[Yield] y\r\n\tON\t\t\tohb.[Business Unit Name] = y.[Business Unit]\r\n\tAND\t\t\tCASE WHEN ohb.[Category Code] = 'Feedstock.TallowABP' THEN 'Feedstock.Tallow' ELSE ohb.[Category Code] END = y.[Item Category]\r\n\tAND\t\t\tCAST(GETDATE() AS DATE) BETWEEN CONVERT(DATE,y.[Start Date],103) AND ISNULL(CONVERT(DATE,y.[End date],103),CAST(GETDATE() AS DATE))\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\t\tSELECT\t\tDISTINCT [Business Unit]\r\n\t\t\t\t\t\t,\t\t\tCONVERT(DATE,[Start date],103) AS [Start date]\r\n\t\t\t\t\t\t,\t\t\tCONVERT(DATE,[End date],103) AS [End date]\r\n\t\t\t\t\t\t,\t\t\tAVG(CAST([Expected yield] AS DECIMAL(28,8)))OVER(PARTITION BY [Business Unit], [Start date]) AS [Average Yield]\r\n\t\t\t\t\t\tFROM\t\t[Trade].[Yield]\t\r\n\t\t\t\t) av\r\n\tON\t\t\tohb.[Business Unit Name] = av.[Business Unit]\r\n\tAND\t\t\tCAST(GETDATE() AS DATE) BETWEEN av.[Start Date] AND ISNULL(av.[End date],CAST(GETDATE() AS DATE))\r\n\tWHERE\t\t[Business Unit Name] IN ('Motherwell','Stanlow','BDA BU')\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n/********************************************************************************************************\r\n\tStep 2.6:\tCreate the Trade.BlendedSales table.\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Trade].[BlendedSales]','U') IS NOT NULL\r\n\t\tDROP TABLE [Trade].[BlendedSales]\r\n\r\n\tSELECT\t\t'Stanlow' AS [Business Unit Name]\r\n\t,\t\t\t[Customer]\r\n\t,\t\t\t[Period]\r\n\t,\t\t\tCAST([Volume (MT)] AS NUMERIC(28,2))\t\t\t\t\t\t\t\t\tAS [Volume (MT)]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [Period] LIKE '%Sept%' OR [Period] LIKE '%April%' OR [Period] LIKE '%June%' OR [Period] LIKE '%Nov%'\r\n\t\t\t\t\t\tTHEN CAST([Volume (MT)] AS NUMERIC(28,2))/30\r\n\t\t\t\t\tWHEN [Period] LIKE '%Feb%'\r\n\t\t\t\t\t\tTHEN CAST([Volume (MT)] AS NUMERIC(28,2))/CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  WHEN CAST(CAST(LEFT([Period],4) AS NUMERIC(28,2))/4 AS VARCHAR(50)) LIKE '%.00%' \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  THEN 29\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t      ELSE 28\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t      END \r\n\t\t\t\t   ELSE CAST([Volume (MT)] AS NUMERIC(28,2))/31\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Volume per Day]\r\n\t,\t\t\tCAST(GETDATE() AS DATE)\t\t\t\t\t\t\t\t\t\t\tAS [Upload Date]\r\n\tINTO\t\t[Trade].[BlendedSales]\r\n\tFROM\t\t[RAW].[NO.BlendedSales]\r\n\r\n\r\n\r\n/********************************************************************************************************\r\n\tStep 2.7:\tCreate the Trade.ExposureLimits table.\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Trade].[ExposureLimits]','U') IS NOT NULL\r\n\t\tDROP TABLE [Trade].[ExposureLimits]\r\n\r\n\tSELECT\t\t*\r\n\tINTO\t\t[Trade].[ExposureLimits]\r\n\tFROM\t\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\t,\t\t\tROW_NUMBER() OVER (PARTITION BY [Start date] ORDER BY [Start date] DESC) AS [Latest Values]\r\n\t\t\t\t\tFROM\t\t[RAW].[NO.ExposureLimits]\r\n\t\t\t\t) el\r\n\tWHERE\t\t[Latest Values] = 1"
								}
							]
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"folder": {
					"name": "Trade/Exp and Pos"
				},
				"annotations": [],
				"lastPublishTime": "2023-01-03T09:26:55Z"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/SQL_Exp_And_Pos_Drop_RAW_Script')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "Exposure And Position Drop RAW Tables Script",
						"type": "Script",
						"dependsOn": [],
						"policy": {
							"timeout": "7.00:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"linkedServiceName": {
							"referenceName": "SqlServerArgent",
							"type": "LinkedServiceReference"
						},
						"typeProperties": {
							"scripts": [
								{
									"type": "NonQuery",
									"text": "/*==================================================================================================================*\r\n * Project:\t\tArgent\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Purpose:\t\tDrop RAW tables\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Description:\tDrop the RAW tables used to create the Core tables.\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Date:        29/07/2022\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Version:     1.0\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n *==================================================================================================================*\r\n * Updates:\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Date\t\t| Version | Author\t\t| Change made\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * -----------------------------------------------------------------------------------------------------------------*\r\n * --/--/-- |  1.-\t  |\t\t\t\t|\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t|\t\t  |\t\t\t\t|\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *==================================================================================================================*/\r\n \r\n\r\n/********************************************************************************************************\r\n\tStep 1.1:\tDrop tables\r\n********************************************************************************************************/\r\n\r\n\tDECLARE @DropTableStatement NVARCHAR(MAX)\r\n\tDECLARE Cur2 CURSOR READ_ONLY\r\n\tFOR\r\n\t\t\tSELECT  'DROP TABLE [RAW].[' + TABLE_NAME + ']'\r\n\t\t\tFROM    INFORMATION_SCHEMA.TABLES\r\n\t\t\tWHERE   TABLE_SCHEMA = 'RAW'\r\n\t\t\tAND\t\tTABLE_TYPE = 'BASE TABLE' \r\n\t\t\tAND\t\t(TABLE_NAME LIKE 'O.%' AND TABLE_NAME NOT LIKE 'O.GL%' AND TABLE_NAME NOT LIKE 'O.AP_%' AND TABLE_NAME NOT LIKE 'O.RA_CUST%' \r\n\t\t\t        AND TABLE_NAME NOT LIKE 'O.FND%' AND TABLE_NAME NOT LIKE 'O.XLA%' AND TABLE_NAME NOT LIKE '%DISTRIBUTION%' AND TABLE_NAME NOT LIKE '%HZ_CUST%' \r\n\t\t\t\t\tAND TABLE_NAME NOT LIKE '%RCV%' AND TABLE_NAME NOT LIKE '%CST_%' AND TABLE_NAME NOT LIKE '%WSH_%' AND TABLE_NAME NOT LIKE '%DOCUMENT_REFERENCES%'\r\n\t\t\t\t\tAND TABLE_NAME NOT LIKE 'O.DOO%' AND TABLE_NAME NOT LIKE 'O.INV%' AND TABLE_NAME NOT LIKE '%PO_LINE_LOCATIONS_ALL%')\r\n\r\n\r\n\tOPEN Cur2\r\n\tFETCH NEXT FROM Cur2 INTO @DropTableStatement\r\n\tWHILE @@FETCH_STATUS = 0\r\n\t\t  BEGIN\r\n\t\t\t\tPRINT 'Executing ' + @DropTableStatement\r\n\t\t\t\tEXECUTE sp_executesql @DropTableStatement\r\n\t\t\t\tFETCH NEXT FROM Cur2 INTO @DropTableStatement\r\n\t\t  END\r\n\tCLOSE Cur2\r\n\tDEALLOCATE Cur2"
								}
							]
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"folder": {
					"name": "Trade/Exp and Pos"
				},
				"annotations": [],
				"lastPublishTime": "2022-12-16T10:23:23Z"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/SQL_GL_Drop_RAW_Script')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "Drop RAW GL Tables Script",
						"type": "Script",
						"dependsOn": [],
						"policy": {
							"timeout": "7.00:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"linkedServiceName": {
							"referenceName": "SqlServerArgent",
							"type": "LinkedServiceReference"
						},
						"typeProperties": {
							"scripts": [
								{
									"type": "NonQuery",
									"text": "/*==================================================================================================================*\r\n * Project:     Argent                                                                                              *\r\n * Purpose:     Drop RAW tables                                                                                     *\r\n * Description: Drop previously imported GL tables to prevent duplications in PK columns.                            *\r\n * Date:        22/08/2022                                                                                          *\r\n * Version:     1.0                                                                                                 *                                                                          \r\n *==================================================================================================================*\r\n\r\n * Updates:                                                                                                         *\r\n\r\n * Date     | Version | Author      | Change made                                                                   *\r\n\r\n * -----------------------------------------------------------------------------------------------------------------*\r\n\r\n * --/--/-- |  1.-    |             |                                                                               *\r\n\r\n *          |         |             |                                                                               *\r\n\r\n *==================================================================================================================*/\r\n\r\n/********************************************************************************************************\r\n    Step 1.1:   Drop tables\r\n********************************************************************************************************/\r\n\r\n\r\n    DECLARE @DropTableStatement NVARCHAR(MAX)\r\n\r\n    DECLARE Cur2 CURSOR READ_ONLY\r\n\r\n    FOR\r\n\r\n            SELECT  'DROP TABLE [RAW].[' + TABLE_NAME + ']'\r\n\r\n            FROM    INFORMATION_SCHEMA.TABLES\r\n\r\n            WHERE   TABLE_SCHEMA = 'RAW'\r\n\r\n            AND     TABLE_TYPE = 'BASE TABLE'\r\n\r\n           AND    ( TABLE_NAME LIKE 'O.GL%' or TABLE_NAME LIKE 'O.AP_%' or TABLE_NAME  LIKE 'O.RA_CUST%' or TABLE_NAME  LIKE 'O.FND%' or TABLE_NAME  LIKE 'O.XLA%' or TABLE_NAME LIKE '%DISTRIBUTION%' or TABLE_NAME LIKE '%HZ_CUST%'or TABLE_NAME LIKE '%RCV%' or TABLE_NAME LIKE '%CST_%' OR TABLE_NAME LIKE '%WSH_%' OR TABLE_NAME LIKE '%DOCUMENT_REFERENCES%'\r\n                        OR TABLE_NAME LIKE 'O.DOO%' OR TABLE_NAME LIKE 'O.INV%' OR TABLE_NAME LIKE '%PO_LINE_LOCATIONS_ALL%')\r\n\r\n\r\n    OPEN Cur2\r\n    FETCH NEXT FROM Cur2 INTO @DropTableStatement\r\n    WHILE @@FETCH_STATUS = 0\r\n          BEGIN\r\n                PRINT 'Executing ' + @DropTableStatement\r\n                EXECUTE sp_executesql @DropTableStatement\r\n                FETCH NEXT FROM Cur2 INTO @DropTableStatement\r\n          END\r\n    CLOSE Cur2\r\n    DEALLOCATE Cur2\r\n"
								}
							]
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"folder": {
					"name": "Finance"
				},
				"annotations": [],
				"lastPublishTime": "2022-12-16T10:15:56Z"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/SQL_Inventory_OnHandBalance')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "Supply Chain Inventory Table",
						"type": "Script",
						"dependsOn": [],
						"policy": {
							"timeout": "7.00:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"linkedServiceName": {
							"referenceName": "SqlServerArgent",
							"type": "LinkedServiceReference"
						},
						"typeProperties": {
							"scripts": [
								{
									"type": "NonQuery",
									"text": " /********************************************************************************************************\r\n\tStep 2.1:\tDelete current day's data from the inventory table. This ensures the data isn't \r\n\t\t\t\tduplicated if ran more than once a day.\r\n********************************************************************************************************/\t\r\n\r\n\tDECLARE @DeleteTableStatement NVARCHAR(MAX)\r\n\tDECLARE Cur2 CURSOR READ_ONLY\r\n\tFOR\r\n\t\t\tSELECT  'Delete from [SupplyChain].[' + TABLE_NAME + ']  where CAST([DateStamp] AS DATE) = CAST(GETDATE() AS DATE)'\r\n\t\t\tFROM    INFORMATION_SCHEMA.TABLES\r\n\t\t\tWHERE   TABLE_SCHEMA = 'SupplyChain'\r\n\t\t\tAND\t\tTABLE_TYPE = 'BASE TABLE' \r\n\t\t\tAND\t\tTABLE_NAME IN ('InventoryOnHandBalance')\r\n\r\n\r\n\tOPEN Cur2\r\n\tFETCH NEXT FROM Cur2 INTO @DeleteTableStatement\r\n\tWHILE @@FETCH_STATUS = 0\r\n\t\t  BEGIN\r\n\t\t\t\tPRINT 'Executing ' + @DeleteTableStatement\r\n\t\t\t\tEXECUTE sp_executesql @DeleteTableStatement\r\n\t\t\t\tFETCH NEXT FROM Cur2 INTO @DeleteTableStatement\r\n\t\t  END\r\n\tCLOSE Cur2\r\n\tDEALLOCATE Cur2\r\n\r\n /********************************************************************************************************\r\n\tStep 2.2:\tAdd current day's inventory data to SupplyChain.InventoryOnHandBalance\r\n********************************************************************************************************/\t\r\n\r\n\tINSERT INTO [SupplyChain].[InventoryOnHandBalance]\r\n\tSELECT\t\tohb.[Business Unit Name]\t\t\t\t\t\t\t\t\t\tAS [Business Unit Name]\r\n\t,\t\t\tohb.[Inventory Organization Name]\t\t\t\t\t\t\t\tAS [Inventory Organization Name]\t\t\r\n\t,\t\t\tohb.[Item ID]\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Item ID]\t\t\t\t\t\t\t\r\n\t,\t\t\tohb.[Inventory Organization ID]\t\t\t\t\t\t\t\t\tAS [Inventory Organization ID]\t\t\t\r\n\t,\t\t\tohb.[Primary Transaction Quantity]\t\t\t\t\t\t\t\tAS [Primary Transaction Quantity]\t\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN ohb.[Transaction UOM Code] IN ('LTR', 'MLT', 'SLT')\r\n\t\t\t\t\t\tTHEN ohb.[Primary Transaction Quantity] * 0.0008745\r\n\t\t\t\t\tELSE ohb.[Primary Transaction Quantity]\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Primary Transaction Quantity MT]\t\r\n\t,\t\t\tohb.[Subinventory]\t\t\t\t\t\t\t\t\t\t\t\tAS [Subinventory]\t\t\t\t\t\t\r\n\t,\t\t\tohb.[Onhand Quantities ID]\t\t\t\t\t\t\t\t\t\tAS [Onhand Quantities ID]\t\t\t\t\r\n\t,\t\t\tohb.[Transaction UOM Code]\t\t\t\t\t\t\t\t\t\tAS [Transaction UOM Code]\t\t\t\t\r\n\t,\t\t\tohb.[Lot Number]\t\t\t\t\t\t\t\t\t\t\t\tAS [Lot Number]\t\t\t\t\t\t\r\n\t,\t\t\tohb.[Item Code]\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Item Code]\t\t\t\t\t\t\t\r\n\t,\t\t\tohb.[Item Name]\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Item Name]\t\t\t\t\t\t\t\r\n\t,\t\t\tohb.[Category Set Name]\t\t\t\t\t\t\t\t\t\t\tAS [Category Set Name]\t\t\t\t\t\r\n\t,\t\t\tohb.[Category Code]\t\t\t\t\t\t\t\t\t\t\t\tAS [Category Code]\t\t\t\t\t\t\r\n\t,\t\t\tohb.[Category Set Description]\t\t\t\t\t\t\t\t\tAS [Category Set Description]\t\t\t\r\n\t,\t\t\tCAST(GETDATE() AS DATE)\t\t\t\t\t\t\t\t\t\t\tAS [DateStamp]\r\n\tFROM\t\t[Core].[OnHandBalance] ohb\r\n\tWHERE\t\t[Business Unit Name] NOT IN ('ROTIE BU','Quatra BU')\r\n\r\n /********************************************************************************************************\r\n\tStep 2.3:\tJoin inventory data to standard costs, actual costs and purchase orders to pull through\r\n\t\t\t\tprices for inventory data. The value of the i nventory items can then be calculated.\r\n********************************************************************************************************/\t\r\n\r\n\tSELECT\t\t[ohb].[Business Unit Name]\r\n\t,\t\t\t[ohb].[Inventory Organization Name]\r\n\t,\t\t\t[ohb].[Inventory Organization Code]\r\n\t,\t\t\t[ohb].[Subinventory]\r\n\t,\t\t\t[ohb].[Item ID]\r\n\t,\t\t\t[ohb].[Item Code]\r\n\t,\t\t\t[ohb].[Item Name]\r\n\t,\t\t\t[ohb].[Category Code]\r\n\t,\t\t\t[ohb].[Lot Number]\r\n\t,\t\t\t[ohb].[Quantity]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN ISNULL([UOM_CODE],ISNULL(ac.[Unit of Measure],po.[UOM Code])) IN ('LTR','MLT','SLT')\r\n\t\t\t\t\t\tTHEN CAST(ISNULL([TOTAL_COST],ISNULL([Actual Cost],PO.[Unit Price])) AS DECIMAL(28,4)) * 0.0008745\r\n\t\t\t\t\tELSE CAST(ISNULL([TOTAL_COST],ISNULL([Actual Cost],PO.[Unit Price])) AS DECIMAL(28,4))\r\n\t\t\t\tEND AS [Price]\r\n\t,\t\t\t[Quantity] *\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN ISNULL([UOM_CODE],ISNULL(ac.[Unit of Measure],po.[UOM Code])) IN ('LTR','MLT','SLT')\r\n\t\t\t\t\t\t\t\t\t\tTHEN CAST(ISNULL([TOTAL_COST],ISNULL([Actual Cost],PO.[Unit Price])) AS DECIMAL(28,4)) * 0.0008745\r\n\t\t\t\t\t\t\t\t\tELSE CAST(ISNULL([TOTAL_COST],ISNULL([Actual Cost],PO.[Unit Price])) AS DECIMAL(28,4))\r\n\t\t\t\t\t\t\t\tEND\tAS [Value]\r\n\t,\t\t\tISNULL(sc.[CURRENCY_CODE],ISNULL(ac.[CURRENCY_CODE],po.[Purchase Document Currency])) AS [Currency Code]\r\n\t,\t\t\tfx.[EUR GBP]\r\n\t,\t\t\tfx.[EUR USD]\r\n\t,\t\t\t[DateStamp]\r\n\tINTO\t\t#InventoryValue\r\n\tFROM\t\t(\r\n\r\n\t\t\t\t\tSELECT\t\ti.[Business Unit Name]\r\n\t\t\t\t\t,\t\t\ti.[Inventory Organization Name]\r\n\t\t\t\t\t,\t\t\to.[Inventory Organization Code]\r\n\t\t\t\t\t,\t\t\t[Subinventory]\r\n\t\t\t\t\t,\t\t\t[Item ID]\r\n\t\t\t\t\t,\t\t\t[Item Code]\r\n\t\t\t\t\t,\t\t\t[Item Name]\r\n\t\t\t\t\t,\t\t\t[Category Code]\t\t\r\n\t\t\t\t\t,\t\t\t[i].[Lot Number]\r\n\t\t\t\t\t,\t\t\tSUM(CAST([Primary Transaction Quantity MT] AS DECIMAL(28,4))) AS [Quantity]\t\r\n\t\t\t\t\t,\t\t\t[i].[DateStamp]\t\r\n\t\t\t\t\tFROM\t\t[SupplyChain].[InventoryOnHandBalance] i\r\n\t\t\t\t\tLEFT JOIN\t[Core].[Organizations] o\r\n\t\t\t\t\tON\t\t\ti.[Inventory Organization Name] = o.[Inventory Organization Name]\r\n\t\t\t\t\tGROUP BY\ti.[Business Unit Name]\r\n\t\t\t\t\t,\t\t\ti.[Inventory Organization Name]\r\n\t\t\t\t\t,\t\t\to.[Inventory Organization Code]\r\n\t\t\t\t\t,\t\t\t[Subinventory]\r\n\t\t\t\t\t,\t\t\t[Item ID]\r\n\t\t\t\t\t,\t\t\t[Item Code]\r\n\t\t\t\t\t,\t\t\t[Item Name]\r\n\t\t\t\t\t,\t\t\t[Category Code]\t\r\n\t\t\t\t\t,\t\t\t[i].[Lot Number]\r\n\t\t\t\t\t,\t\t\t[i].[DateStamp]\t\r\n\t\t\t\t) ohb\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tsc.[INVENTORY_ITEM_ID]\r\n\t\t\t\t\t,\t\t\tsc.[TOTAL_COST]\r\n\t\t\t\t\t,\t\t\tsc.[CURRENCY_CODE]\r\n\t\t\t\t\t,\t\t\tsc.[UOM_CODE]\r\n\t\t\t\t\t,\t\t\tval.*\r\n\t\t\t\t\tFROM\t\t[Core].[StandardCosts] sc\r\n\t\t\t\t\tLEFT JOIN\t[Core].[CostValUnits] val\r\n\t\t\t\t\tON\t\t\tsc.[VAL_UNIT_ID] = val.[VAL_UNIT_ID]\r\n\t\t\t\t\tWHERE\t\tsc.[STATUS_CODE] = 'PUBLISHED'\r\n\t\t\t\t\tAND\t\t\tCAST(GETDATE() AS DATE) BETWEEN CAST(LEFT([EFFECTIVE_START_DATE],10) AS DATE) AND CAST(LEFT([EFFECTIVE_END_DATE],10) AS DATE)\r\n\t\t\t\t) sc\r\n\tON\t\t\tohb.[Item Id] = sc.[INVENTORY_ITEM_ID]\r\n\tAND\t\t\tLEFT(sc.[VAL_UNIT_CODE],8) LIKE '%' + CASE WHEN [Inventory Organization Code] = 'PTP' THEN 'Not a Used Org.' ELSE [Inventory Organization Code] END + '%'\r\n\tAND\t\t\t[Inventory Organization Code] <> '000'\r\n\tAND\t\t\t([COST_BOOK_ID] LIKE '%484' OR [COST_BOOK_ID] LIKE '%182')\r\n\tLEFT JOIN\t(\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tSELECT\t\t[VAL_UNIT_ID]\r\n\t\t\t\t\t,\t\t\tRIGHT([VAL_UNIT_CODE],LEN([VAL_UNIT_CODE]) - CHARINDEX('-',[VAL_UNIT_CODE],5)) AS [Lot Number]\r\n\t\t\t\t\tFROM\t\t(\r\n\t\t\t\t\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\t\t\t\t\t,\t\t\tROW_NUMBER() OVER (PARTITION BY RIGHT([VAL_UNIT_CODE],LEN([VAL_UNIT_CODE]) - CHARINDEX('-',[VAL_UNIT_CODE],5)) ORDER BY [LAST_UPDATE_DATE] DESC) AS [Latest ID]\r\n\t\t\t\t\t\t\t\t\tFROM\t\t[Core].[CostValUnits]\r\n\t\t\t\t\t\t\t\t\tWHERE\t\t[COST_BOOK_ID] LIKE '%484'\r\n\t\t\t\t\t\t\t\t) lid\r\n\t\t\t\t\tWHERE\t\t[Latest ID] = 1\r\n\t\t\t\t\t) vu\r\n\tON\t\t\tohb.[Lot Number] = vu.[Lot Number]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\t\tSELECT\t\t[VAL_UNIT_ID]\r\n\t\t\t\t\t\t,\t\t\t[INVENTORY_ITEM_ID]\r\n\t\t\t\t\t\t,\t\t\tCAST(CAST([TOTAL_COST] AS FLOAT) AS DECIMAL(28,2)) AS [Actual Cost]\r\n\t\t\t\t\t\t,\t\t\t[CURRENCY_CODE]\r\n\t\t\t\t\t\t,\t\t\t[Item Code]\r\n\t\t\t\t\t\t,\t\t\t[Unit Of Measure]\r\n\t\t\t\t\t\tFROM\t\t(\r\n\t\t\t\t\t\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\t\t\t\t\t\t,\t\t\tROW_NUMBER() OVER (PARTITION BY [VAL_UNIT_ID], [INVENTORY_ITEM_ID] ORDER BY [EFF_DATE] DESC) AS [Latest Cost]\r\n\t\t\t\t\t\t\t\t\t\tFROM\t\t[Core].[ItemCostHistory]\r\n\t\t\t\t\t\t\t\t\t\tWHERE\t\t[COST_BOOK_ID] LIKE '%484'\r\n\t\t\t\t\t\t\t\t\t) cih\r\n\t\t\t\t\t\tLEFT JOIN\t(\r\n\t\t\t\t\t\t\t\t\t\tSELECT\t\tDISTINCT [Inventory Item ID]\r\n\t\t\t\t\t\t\t\t\t\t,\t\t\t[Item Code]\r\n\t\t\t\t\t\t\t\t\t\t,\t\t\t[Item Name]\r\n\t\t\t\t\t\t\t\t\t\t,\t\t\t[Unit Of Measure]\r\n\t\t\t\t\t\t\t\t\t\tFROM\t\t[Core].[Items]\r\n\t\t\t\t\t\t\t\t\t) i\r\n\t\t\t\t\t\tON\t\t\tcih.[INVENTORY_ITEM_ID] = i.[Inventory Item ID]\r\n\t\t\t\t\t\tWHERE\t\t[Latest Cost] = 1\r\n\t\t\t\t\t) ac\r\n\tON\t\t\tac.[VAL_UNIT_ID] = vu.[VAL_UNIT_ID]\r\n\tAND\t\t\tohb.[Item ID] = ac.[INVENTORY_ITEM_ID]\t\r\n\tLEFT JOIN\t[Core].[PurchaseOrders] po\r\n\tON\t\t\tpo.[Purchase Order Number] = ohb.[Lot Number]\r\n\tAND\t\t\tISNULL([TOTAL_COST],[Actual Cost]) IS NULL\r\n\tLEFT JOIN\t[Core].[FXRates] fx\r\n\tON\t\t\tCAST(LEFT([fx].[CONVERSION_DATE],10) AS DATE) = [ohb].[DateStamp]\t\t\r\n\tORDER BY\tohb.[Item Code]\r\n\r\n\tIF OBJECT_ID('[SupplyChain].[InventoryQuantityAndValue]','U') IS NOT NULL\r\n\t\tDROP TABLE [SupplyChain].[InventoryQuantityAndValue]\r\n\r\n\tSELECT\t\t*\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [Currency Code] = 'GBP' THEN [Value]\r\n\t\t\t\t\tWHEN [Currency Code] = 'EUR' THEN [Value]*[EUR GBP]\r\n\t\t\t\t\tWHEN [Currency Code] = 'USD' THEN ([Value]*[EUR GBP])*[EUR USD]\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [Value GBP]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [Currency Code] = 'GBP' THEN [Price]\r\n\t\t\t\t\tWHEN [Currency Code] = 'EUR' THEN [Price]/[EUR GBP]\r\n\t\t\t\t\tWHEN [Currency Code] = 'USD' THEN ([Price]/[EUR GBP])*[EUR USD]\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [Price GBP]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [Currency Code] = 'EUR' THEN [Value]\r\n\t\t\t\t\tWHEN [Currency Code] = 'GBP' THEN [Value]/[EUR GBP]\r\n\t\t\t\t\tWHEN [Currency Code] = 'USD' THEN [Value]*[EUR USD]\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [Value EUR]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [Currency Code] = 'EUR' THEN [Price]\r\n\t\t\t\t\tWHEN [Currency Code] = 'GBP' THEN [Price]/[EUR GBP]\r\n\t\t\t\t\tWHEN [Currency Code] = 'USD' THEN [Price]*[EUR USD]\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [Price EUR]\r\n\tINTO\t\t[SupplyChain].[InventoryQuantityAndValue]\r\n \tFROM\t\t#InventoryValue"
								}
							]
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"folder": {
					"name": "Supply Chain"
				},
				"annotations": []
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/SQL_Inventory_QuantityTracker')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "Supply Chain Inventory Table",
						"type": "Script",
						"dependsOn": [],
						"policy": {
							"timeout": "7.00:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"linkedServiceName": {
							"referenceName": "SqlServerArgent",
							"type": "LinkedServiceReference"
						},
						"typeProperties": {
							"scripts": [
								{
									"type": "NonQuery",
									"text": " /********************************************************************************************************\r\n\tStep 4.1:\tCreate a date list.\r\n********************************************************************************************************/\r\n\r\n\r\n\tIF OBJECT_ID('tempdb..#DateList','U') IS NOT NULL \r\n\t\tDROP TABLE #DateList\r\n\r\n\tDECLARE @StartDate  date = (\r\n\t\t\t\t\t\t\t\t\tSELECT\t\tMIN([DateStamp])\r\n\t\t\t\t\t\t\t\t\tFROM\t\t[SupplyChain].[InventoryQuantityAndValue]\r\n\t\t\t\t\t\t\t\t)\r\n\r\n\tDECLARE @CutoffDate date =\t(\r\n\t\t\t\t\t\t\t\t\tSELECT\t\tMAX([DateStamp])\r\n\t\t\t\t\t\t\t\t\tFROM\t\t[SupplyChain].[InventoryQuantityAndValue]\r\n\t\t\t\t\t\t\t\t);\r\n\r\n\t;WITH seq(n) AS \r\n\t(\r\n\t  SELECT 0 UNION ALL SELECT n + 1 FROM seq\r\n\t  WHERE n < DATEDIFF(DAY, @StartDate, @CutoffDate)\r\n\t),\r\n\td([Date]) AS \r\n\t(\r\n\t  SELECT DATEADD(DAY, n, @StartDate) FROM seq\r\n\t)\r\n\tSELECT [Date] \r\n\tINTO #DateList\r\n\tFROM d\r\n\tORDER BY [Date]\r\n\tOPTION (MAXRECURSION 0);\r\n\r\n /********************************************************************************************************\r\n\tStep 4.2:\tJoin the inventory value table on to the date list.\r\n********************************************************************************************************/\r\n\r\n\tSELECT\t\t* \r\n\tINTO\t\t#DatesAndSubinventory\r\n\tFROM\t\t#DateList dl\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tDISTINCT [Subinventory]\r\n\t\t\t\t\tFROM\t\t[SupplyChain].[InventoryQuantityAndValue]\r\n\t\t\t\t) i\r\n\tON\t\t\t1=1\r\n\tORDER BY\tdl.[Date]\r\n\r\n /********************************************************************************************************\r\n\tStep 4.3:\tSum the quantities and values to the item level for each day.\r\n********************************************************************************************************/\r\n\r\n\tSELECT\t\tdas.[Date]\r\n\t,\t\t\tdas.[Subinventory]\r\n\t,\t\t\t[Item Code]\r\n\t,\t\t\t[Item Name]\r\n\t,\t\t\t[Category Code]\r\n\t,\t\t\tSUM([Quantity]) AS [Quantity]\r\n\t,\t\t\tSUM([Value GBP]) AS [Value GBP]\r\n\t,\t\t\tSUM([Value EUR]) AS [Value EUR]\r\n\tINTO\t\t#InventoryGrouped\r\n\tFROM\t\t#DatesAndSubinventory das\r\n\tLEFT JOIN\t[SupplyChain].[InventoryQuantityAndValue] iq\r\n\tON\t\t\tdas.[Date] = iq.[DateStamp]\r\n\tAND\t\t\tdas.[Subinventory] = iq.[Subinventory]\r\n\tGROUP BY\tdas.[Date]\r\n\t,\t\t\tdas.[Subinventory]\r\n\t,\t\t\t[Item Code]\r\n\t,\t\t\t[Item Name]\r\n\t,\t\t\t[Category Code]\r\n\t,\t\t\t[DateStamp]\r\n\r\n /********************************************************************************************************\r\n\tStep 4.4:\tCalculate the change in quantity for each item per day.\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[SupplyChain].[SubinventoryQuantityTracker]','U') IS NOT NULL\r\n\t\tDROP TABLE [SupplyChain].[SubinventoryQuantityTracker]\r\n\r\n\tSELECT\t\t*\r\n\t,\t\t\t[Quantity] - LAG([Quantity])OVER(PARTITION BY [Subinventory],[Item Code] ORDER BY [Date]) AS [QuantityDifference]\r\n\t,\t\t\tCASE WHEN [Item Code] IS NULL THEN 1 ELSE 0 END AS [Empty Tank Identifier]\r\n\tINTO\t\t[SupplyChain].[SubinventoryQuantityTracker]\r\n\tFROM\t\t#InventoryGrouped\r\n\tORDER BY\t[Subinventory],[Date],[Item Code]\r\n\r\n /********************************************************************************************************\r\n\tStep 4.5:\tFind the most recent date where the subinventory had no items and the most recent date\r\n\t\t\t\twhere the change in quantity of the items increased.\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[SupplyChain].[SubinventoryLastEmptyTankDate]','U') IS NOT NULL\r\n\t\tDROP TABLE [SupplyChain].[SubinventoryLastEmptyTankDate]\r\n\r\n\tSELECT\t\ta.[Date]\r\n\t,\t\t\ta.[Subinventory]\r\n\t,\t\t\tSUM([Quantity])\tAS [Quantity]\r\n\t,\t\t\tSUM([Value GBP]) AS [Value GBP]\r\n\t,\t\t\tSUM([Value EUR]) AS [Value EUR]\r\n\t,\t\t\tb.[Last Empty Date]\r\n\t,\t\t\tc.[Last Increase Date]\r\n\tINTO\t\t[SupplyChain].[SubinventoryLastEmptyTankDate]\r\n\tFROM\t\t[SupplyChain].[SubinventoryQuantityTracker] a\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Subinventory]\r\n\t\t\t\t\t,\t\t\tMAX([Date]) AS [Last Empty Date]\r\n\t\t\t\t\tFROM\t\t[SupplyChain].[SubinventoryQuantityTracker]\r\n\t\t\t\t\tWHERE\t\t[Empty Tank Identifier] = 1\r\n\t\t\t\t\tGROUP BY\t[Subinventory]\r\n\t\t\t\t) b\r\n\tON\t\t\ta.[Subinventory] = b.[Subinventory]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Subinventory]\r\n\t\t\t\t\t,\t\t\tMAX([Date]) AS [Last Increase Date]\r\n\t\t\t\t\tFROM\t\t[SupplyChain].[SubinventoryQuantityTracker]\r\n\t\t\t\t\tWHERE\t\t[QuantityDifference] > 0\r\n\t\t\t\t\tGROUP BY\t[Subinventory]\r\n\t\t\t\t) c\r\n\tON\t\t\ta.[Subinventory] = c.[Subinventory]\r\n\tWHERE\t\t[Date] = (SELECT MAX([Date]) FROM [SupplyChain].[SubinventoryQuantityTracker])\r\n\tGROUP BY\ta.[Date]\r\n\t,\t\t\ta.[Subinventory]\r\n\t,\t\t\tb.[Last Empty Date]\r\n\t,\t\t\tc.[Last Increase Date]\r\n\tORDER BY\ta.[Subinventory],[Date]\r\n"
								}
							]
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"folder": {
					"name": "Supply Chain"
				},
				"annotations": []
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/SQL_Margin_Core_Tables_Script')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "Margin Core Tables Script",
						"type": "Script",
						"dependsOn": [],
						"policy": {
							"timeout": "7.00:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"linkedServiceName": {
							"referenceName": "SqlServerArgent",
							"type": "LinkedServiceReference"
						},
						"typeProperties": {
							"scripts": [
								{
									"type": "NonQuery",
									"text": "/*==============================================================================================================================*\r\n * Project:\t\tArgent\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Purpose:\t\tCreate core tables that feed in to Margin data marts.\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Description:\t1) Creates sales orders, invoices and inventory tables \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n*\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Prerequisites: Run pipelinie in Azure DWH.\t\t\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Outputs: Tables \"Core.SalesOrders\", \"Core.APInvoices\", \"Core.ARInvoices\", \"Core.InventoryTransactions\"\t\t\t\t\t\t*\r\n *\t\t\t\"Core.ShippingDetails\", \"Core.InventoryLotNumbers\", \"Core.InventoryLotNumberTransactions\"\t\t\t\t\t\t\t*\r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Date:       29/07/2022\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Version:     1.0\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\t\t\r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * SQL ATR - Basic joins\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t* \r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *==============================================================================================================================*\r\n * Updates:\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Date\t\t| Version | Author\t\t| Change made\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * -----------------------------------------------------------------------------------------------------------------------------*\r\n * --/--/-- |  1.-\t  |\t\t\t\t|\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t|\t\t  |\t\t\t\t|\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *==============================================================================================================================*/\r\n\r\n/********************************************************************************************************\r\n\tStep 1.1\tCreate core Sales Orders table.\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Core].[SalesOrders]','U') IS NOT NULL\r\n\t\tDROP TABLE [Core].[SalesOrders]\r\n\r\n\tSELECT\t\tCAST(soh.[HEADER_ID] AS NVARCHAR(255))\t\t\t\t\t\t\t\tAS [Header ID]\r\n\t,\t\t\tCAST(soh.[ORDER_NUMBER] AS NVARCHAR(255))\t\t\t\t\t\t\tAS [Order Number]\r\n\t,\t\t\tCAST(soh.[ORG_ID] AS NVARCHAR(255))\t\t\t\t\t\t\t\tAS [Org ID]\r\n\t,\t\t\tCAST(soh.[LEGAL_ENTITY_ID] AS NVARCHAR(255))\t\t\t\t\t\tAS [Legal Entity ID]\r\n\t,\t\t\tCAST(LEFT(soh.[ORDERED_DATE],10) AS DATE)\tAS [Ordered Date]\r\n\t,\t\t\tCAST(soh.[ORDER_TYPE_CODE] AS NVARCHAR(255))\t\t\t\t\t\tAS [Order Type Code]\r\n\t,\t\t\tCAST(soh.[TRANSACTIONAL_CURRENCY_CODE] AS NVARCHAR(255))\t\t\tAS [Transactional Currency Code]\r\n\t,\t\t\tCAST(soh.[STATUS_CODE] AS NVARCHAR(255))\t\t\t\t\t\t\tAS [Status Code]\r\n\t,\t\t\tCAST(soh.[OPEN_FLAG] AS NVARCHAR(255))\t\t\t\t\t\t\t\tAS [Open Flag]\r\n\t,\t\t\tCAST(soh.[ON_HOLD] AS NVARCHAR(255))\t\t\t\t\t\t\t\tAS [On Hold]\r\n\t,\t\t\tCAST(soh.[CANCELED_FLAG] AS NVARCHAR(255))\t\t\t\t\t\t\tAS [Canceled Flag]\r\n\t,\t\t\tCAST(soh.[CHANGE_VERSION_NUMBER] AS NVARCHAR(255))\t\t\t\t\tAS [Change Version Number]\r\n\t,\t\t\tCAST(soh.[IS_EDITABLE] AS NVARCHAR(255))\t\t\t\t\t\t\tAS [Is Editable]\r\n\t,\t\t\tCAST(soh.[SOLD_TO_PARTY_ID]\t AS NVARCHAR(255))\t\t\t\t\tAS [Sold To Party ID]\r\n\t,\t\t\tCAST(soh.[PRICING_SEGMENT_CODE] AS NVARCHAR(255))\t\t\t\t\tAS [Pricing Segment Code]\r\n\t,\t\t\tCAST(soh.[PRICING_STRATEGY_ID] AS NVARCHAR(255))\t\t\t\t\tAS [Pricing Strategy ID]\r\n\t,\t\t\tCAST(soh.[FULFILL_ORG_ID] AS NVARCHAR(255))\t\t\t\t\t\tAS [Fulfill Org ID]\r\n\t,\t\t\tCAST(soh.[REQUEST_SHIP_DATE] AS NVARCHAR(255))\t\t\t\t\t\tAS [Request Ship Date]\r\n\t,\t\t\tCAST(soh.[CARRIER_ID] AS NVARCHAR(255))\t\t\t\t\t\t\tAS [Carrier ID]\r\n\t,\t\t\tCAST(soh.[SHIP_MODE_OF_TRANSPORT] AS NVARCHAR(255))\t\t\t\tAS [Ship Mode Of Transport]\r\n\t,\t\t\tCAST(soh.[SHIP_CLASS_OF_SERVICE] AS NVARCHAR(255))\t\t\t\t\tAS [Ship Class Of Service]\r\n\t,\t\t\tCAST(soh.[SUBMITTED_FLAG] AS NVARCHAR(255))\t\t\t\t\t\tAS [Submitted Flag]\r\n\t,\t\t\tCAST(soh.[REFERENCE_HEADER_ID] AS NVARCHAR(255))\t\t\t\t\tAS [Reference Header ID]\r\n\t,\t\t\tCAST(soh.[PAYMENT_TERM_ID] AS NVARCHAR(255))\t\t\t\t\t\tAS [Payment Term ID]\r\n\t,\t\t\tCAST(soh.[MODIFIED_FLAG] AS NVARCHAR(255))\t\t\t\t\t\t\tAS [Modified Flag]\r\n\t,\t\t\tCAST(soh.[SUBMITTED_DATE] AS NVARCHAR(255))\t\t\t\t\t\tAS [Submitted Date]\r\n\t,\t\t\tCAST(soh.[SUBMITTED_BY]\t AS NVARCHAR(255))\t\t\t\t\t\tAS [Submitted By]\r\n\t,\t\t\tCAST(soh.[MDO_FLAG]\t AS NVARCHAR(255))\t\t\t\t\t\t\tAS [MDO Flag]\r\n\t,\t\t\tCAST(soh.[SOLD_TO_PARTY_CONTACT_ID]\t AS NVARCHAR(255))\t\t\tAS [Sold To Party Contact ID]\r\n\t,\t\t\tCAST(soh.[SOLD_TO_PARTY_CONTACT_POINT_ID] AS NVARCHAR(255))\t\tAS [Sold To Party Contact Point ID]\r\n\t,\t\t\tCAST(soh.[REQUEST_CANCEL_DATE]\t AS NVARCHAR(255))\t\t\t\tAS [Request Cancel Date]\r\n\t,\t\t\tCAST(soh.[CANCEL_REASON_CODE] AS NVARCHAR(255))\t\t\t\t\tAS [Cancel Reason Code]\r\n\t,\t\t\tCAST(soh.[CUSTOMER_PO_NUMBER] AS NVARCHAR(255))\t\t\t\t\tAS [Customer PO Number]\r\n\t,\t\t\tCAST(soh.[COMMENTS]\t AS NVARCHAR(255))\t\t\t\t\t\t\tAS [Comments]\r\n\t,\t\t\tCAST(soh.[AGREEMENT_HEADER_ID] AS NVARCHAR(255))\t\t\t\t\tAS [Agreement Header ID]\r\n\t,\t\t\tCAST(soh.[AGREEMENT_VERSION_NUMBER]\t AS NVARCHAR(255))\t\t\tAS [Agreement Version Number]\r\n\t,\t\t\tCAST(sol.[LINE_ID] AS NVARCHAR(255))\t\t\t\t\t\t\t\tAS [Line ID]\r\n\t,\t\t\tCAST(sol.[LINE_NUMBER] AS NVARCHAR(255))\t\t\t\t\t\t\tAS [Line Number]\r\n\t,\t\t\tCAST(sol.[STATUS_CODE] AS NVARCHAR(255))\t\t\t\t\t\t\tAS [Order Line Status]\r\n\t,\t\t\tCAST(ISNULL(sol.[ORDERED_QTY],0) AS NVARCHAR(255))\t\t\t\t\tAS [Ordered Qty]\r\n\t,\t\t\tCAST(sol.[ORDERED_UOM] AS NVARCHAR(255))\t\t\t\t\t\t\tAS [Ordered UOM]\r\n\t,\t\t\tCAST(sol.[EXTENDED_AMOUNT] AS NVARCHAR(255))\t\t\t\t\t\tAS [Extended Amount]\r\n\t,\t\t\tCAST(sol.[INVENTORY_ITEM_ID] AS NVARCHAR(255))\t\t\t\t\t\tAS [Inventory Item ID]\r\n\t,\t\t\tCAST(sol.[UNIT_LIST_PRICE] AS NVARCHAR(255))\t\t\t\t\t\tAS [Unit List Price]\r\n\t,\t\t\tCAST(sol.[UNIT_SELLING_PRICE] AS NVARCHAR(255))\t\t\t\t\tAS [Unit Selling Price]\r\n\t,\t\t\tCAST(sol.[REFERENCE_LINE_ID] AS NVARCHAR(255))\t\t\t\t\t\tAS [Reference Line ID]\r\n\t,\t\t\tCAST(sol.[INVENTORY_ORGANIZATION_ID] AS NVARCHAR(255))\t\t\t\tAS [Inventory Organization ID]\r\n\t,\t\t\tCAST(sol.[DISPLAY_LINE_NUMBER]\t AS NVARCHAR(255))\t\t\t\tAS [Display Line Number]\r\n\t,\t\t\tCAST(sol.[SCHEDULE_SHIP_DATE] AS NVARCHAR(255))\t\t\t\t\tAS [Schedule Ship Date]\r\n\t,\t\t\tCAST(sol.[RMA_DELIVERED_QTY] AS NVARCHAR(255))\t\t\t\t\t\tAS [RMA Delivered Qty]\r\n\t,\t\t\tCAST(sol.[CANCELED_QTY]\t AS NVARCHAR(255))\t\t\t\t\t\tAS [Canceled Qty]\r\n\t,\t\t\tCAST(GETDATE() AS DATE)\t\t\t\t\t\tAS [DateStamp]\r\n\tINTO\t\t[Core].[SalesOrders]\r\n\tFROM\t\t[RAW].[O.DOO_HEADERS_ALL] soh\r\n\tLEFT JOIN\t[RAW].[O.DOO_LINES_ALL] sol\r\n\tON\t\t\tsoh.[HEADER_ID] = sol.[HEADER_ID]\r\n\tWHERE\t\tsoh.[STATUS_CODE] <> 'DOO_REFERENCE'\r\n\r\n\r\n/********************************************************************************************************\r\n\tStep 1.2\tCreate core invoice tables\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Core].[APInvoices]','U') IS NOT NULL\r\n\t\tDROP TABLE [Core].[APInvoices]\r\n\r\n\r\n\tSELECT\t\tCAST(apa.[INVOICE_ID] AS NVARCHAR(255))\t\t\t\t\t\tAS [Invoice ID]\r\n\t,\t\t\tCAST(apa.[PARTY_ID] AS NVARCHAR(255))\t\t\t\t\t\t\tAS [Party ID]\r\n\t,\t\t\tCAST(apa.[VENDOR_ID] AS NVARCHAR(255))\t\t\t\t\t\t\tAS [Vendor ID]\r\n\t,\t\t\tCAST(apa.[INVOICE_NUM] AS NVARCHAR(255))\t\t\t\t\t\tAS [Invoice Number]\r\n\t,\t\t\tCAST(apa.[SET_OF_BOOKS_ID]\t AS NVARCHAR(255))\t\t\t\tAS [Set of Books ID]\r\n\t,\t\t\tCAST(apa.[INVOICE_CURRENCY_CODE] AS NVARCHAR(255))\t\t\t\tAS [Invoice Currency Code]\r\n\t,\t\t\tCAST(apa.[INVOICE_AMOUNT] AS NVARCHAR(255))\t\t\t\t\tAS [Invoice Amount]\r\n\t,\t\t\tCAST(apa.[VENDOR_SITE_ID] AS NVARCHAR(255))\t\t\t\t\tAS [Vendor Site ID]\r\n\t,\t\t\tCAST(apa.[INVOICE_DATE] AS NVARCHAR(255))\t\t\t\t\t\tAS [Invoice Date]\r\n\t,\t\t\tCAST(apa.[INVOICE_TYPE_LOOKUP_CODE]\t AS NVARCHAR(255))\t\tAS [Invoice Type Lookup Code]\r\n\t,\t\t\tCAST(apa.[TERMS_ID] AS NVARCHAR(255))\t\t\t\t\t\t\tAS [Terms ID]\r\n\t,\t\t\tCAST(apa.[PAYMENT_STATUS_FLAG] AS NVARCHAR(255))\t\t\t\tAS [Payment Status Flag]\r\n\t,\t\t\tCAST(apa.[APPROVAL_STATUS] AS NVARCHAR(255))\t\t\t\t\tAS [Approval Status]\r\n\t,\t\t\tCAST(apa.[ORG_ID] AS NVARCHAR(255))\t\t\t\t\t\t\tAS [Org ID]\r\n\t,\t\t\tCAST(apa.[WFAPPROVAL_STATUS] AS NVARCHAR(255))\t\t\t\t\tAS [Workflow Approval Status]\r\n\t,\t\t\tCAST(apa.[LEGAL_ENTITY_ID] AS NVARCHAR(255))\t\t\t\t\tAS [Legal Entity ID]\r\n\t,\t\t\tCAST(apa.[PAYMENT_METHOD_CODE] AS NVARCHAR(255))\t\t\t\tAS [Payment Method Code]\r\n\t,\t\t\tCAST(apa.[PARTY_SITE_ID] AS NVARCHAR(255))\t\t\t\t\t\tAS [Party Site ID]\r\n\t,\t\t\tCAST(apa.[PAY_PROC_TRXN_TYPE_CODE] AS NVARCHAR(255))\t\t\tAS [Invoice Document Type]\r\n\t,\t\t\tCAST(apa.[DESCRIPTION] AS NVARCHAR(255))\t\t\t\t\t\tAS [Description]\r\n\t,\t\t\tCAST(apa.[AMOUNT_PAID] AS NVARCHAR(255))\t\t\t\t\t\tAS [Amount Paid]\r\n\t,\t\t\tCAST(apa.[EXCHANGE_RATE] AS NVARCHAR(255))\t\t\t\t\t\tAS [Exchange Rate]\r\n\t,\t\t\tCAST(apa.[TOTAL_TAX_AMOUNT]\t AS NVARCHAR(255))\t\t\t\tAS [Total Tax Amount]\r\n\t,\t\t\tCAST(apa.[PO_HEADER_ID] AS NVARCHAR(255))\t\t\t\t\t\tAS [PO Header ID]\r\n\t,\t\t\tCAST(apl.[LINE_NUMBER] AS NVARCHAR(255))\t\t\t\t\t\tAS [Line Number]\r\n\t,\t\t\tCAST(apl.[DESCRIPTION] AS NVARCHAR(255))\t\t\t\t\t\tAS [Invoice Line Description]\r\n\t,\t\t\tCAST(apl.[LINE_TYPE_LOOKUP_CODE] AS NVARCHAR(255))\t\t\t\tAS [Line Type Lookup Code]\r\n\t,\t\t\tCAST(apl.[AMOUNT] AS NVARCHAR(255))\t\t\t\t\t\t\tAS [Invoice Line Amount]\r\n\t,\t\t\tCAST(apl.[CANCELLED_FLAG] AS NVARCHAR(255))\t\t\t\t\tAS [Canelled Flag]\r\n\t,\t\t\tCAST(apl.[TAX_RATE_CODE] AS NVARCHAR(255))\t\t\t\t\t\tAS [Tax Rate Code]\r\n\t,\t\t\tCAST(apl.[TAX_RATE]\t AS NVARCHAR(255))\t\t\t\t\t\tAS [Tax Rate]\r\n\t,\t\t\tCAST(apl.[REQUESTER_ID] AS NVARCHAR(255))\t\t\t\t\t\tAS [Requester ID]\r\n\t,\t\t\tCAST(apl.[ITEM_DESCRIPTION] AS NVARCHAR(255))\t\t\t\t\tAS [Invoice Line Item Description]\r\n\t,\t\t\tCAST(apl.[QUANTITY_INVOICED] AS NVARCHAR(255))\t\t\t\t\tAS [Quantity Invoiced]\r\n\t,\t\t\tCAST(apl.[UNIT_MEAS_LOOKUP_CODE] AS NVARCHAR(255))\t\t\t\tAS [UOM Code]\r\n\t,\t\t\tCAST(apl.[UNIT_PRICE] AS NVARCHAR(255))\t\t\t\t\t\tAS [Unit Price]\r\n\t,\t\t\tCAST(apl.[PO_LINE_ID] AS NVARCHAR(255))\t\t\t\t\t\tAS [PO Line ID]\r\n\t,\t\t\tCAST(apl.[PO_LINE_LOCATION_ID] AS NVARCHAR(255))\t\t\t\tAS [PO Line Location ID]\r\n\t,\t\t\tCAST(apl.[PURCHASING_CATEGORY_ID] AS NVARCHAR(255))\t\t\tAS [Purchasing Category ID]\r\n\t,\t\t\tCAST(apl.[SHIP_TO_LOCATION_ID] AS NVARCHAR(255))\t\t\t\tAS [Ship to Location ID]\r\n\t,\t\t\tCAST(apl.[INVENTORY_ITEM_ID] AS NVARCHAR(255))\t\t\t\t\tAS [Inventory Item ID]\r\n\t,\t\t\tCAST(apl.[RCV_TRANSACTION_ID] AS NVARCHAR(255))\t\t\t\tAS [Receiving Transaction ID]\r\n\t,\t\t\tCAST(apl.[RCV_SHIPMENT_LINE_ID] AS NVARCHAR(255))\t\t\t\tAS [Receiving Shipment Line ID]\r\n\t,\t\t\tCAST(apl.[SHIP_FROM_LOCATION_ID] AS NVARCHAR(255))\t\t\t\tAS [Ship From Location ID]\r\n\t,\t\t\tCAST(GETDATE() AS DATE)\t\t\t\t\t\tAS [DateStamp]\r\n\tINTO\t\t[Core].[APInvoices]\r\n\tFROM\t\t[RAW].[O.AP_INVOICES_ALL] apa\r\n\tLEFT JOIN\t[RAW].[O.AP_INVOICE_LINES_ALL] apl\r\n\tON\t\t\tapa.[INVOICE_ID] = apl.[INVOICE_ID]\r\n\r\n\r\n\r\n\tIF OBJECT_ID('[Core].[ARInvoices]','U') IS NOT NULL\r\n\t\tDROP TABLE [Core].[ARInvoices]\r\n\r\n\tSELECT\t\tara.*\r\n\t,\t\t\tCAST(arl.[CUSTOMER_TRX_LINE_ID] AS NVARCHAR(255))\t\tAS [CUSTOMER_TRX_LINE_ID]\r\n\t,\t\t\tCAST(arl.[LINE_NUMBER] AS NVARCHAR(255))\t\t\t\tAS [LINE_NUMBER]\r\n\t,\t\t\tCAST(arl.[LINE_TYPE] AS NVARCHAR(255))\t\t\t\t\tAS [LINE_TYPE]\r\n\t,\t\t\tCAST(arl.[EXTENDED_AMOUNT] AS NVARCHAR(255))\t\t\tAS [EXTENDED_AMOUNT]\r\n\t,\t\t\tCAST(arl.[QUANTITY_INVOICED] AS NVARCHAR(255))\t\t\tAS [QUANTITY_INVOICED]\r\n\t,\t\t\tCAST(CAST(arl.[UNIT_SELLING_PRICE] AS FLOAT) AS DECIMAL(28,8)) AS [UNIT_SELLING_PRICE]\r\n\t,\t\t\tCAST(arl.[REVENUE_AMOUNT] AS NVARCHAR(255))\t\t\t\tAS [REVENUE_AMOUNT]\r\n\t,\t\t\tCAST(arl.[QUANTITY_ORDERED] AS NVARCHAR(255))\t\t\tAS [QUANTITY_ORDERED]\r\n\t,\t\t\tCAST(arl.[SALES_ORDER] AS NVARCHAR(255))\t\t\t\tAS [SALES_ORDER]\r\n\t,\t\t\tCAST(arl.[SALES_ORDER_LINE] AS NVARCHAR(255))\t\t\tAS [SALES_ORDER_LINE]\r\n\t,\t\t\tCAST(arl.[UOM_CODE] AS NVARCHAR(255))\t\t\t\t\tAS [UOM_CODE]\r\n\t,\t\t\tCAST(CAST(arl.[QUANTITY_CREDITED] AS FLOAT) AS DECIMAL(28,4))\t\tAS [Quantity Credited]\r\n\t,\t\t\tCAST(CAST(arl.[QUANTITY_INVOICED] AS FLOAT) AS DECIMAL(28,4))\t\tAS [Line Quantity Invoiced]\r\n\t,\t\t\tCAST(GETDATE() AS DATE)\t\t\t\t\t\tAS [DateStamp]\r\n\tINTO\t\t[Core].[ARInvoices]\r\n\tFROM\t\t[RAW].[O.RA_CUSTOMER_TRX_ALL] ara\r\n\tLEFT JOIN\t[RAW].[O.RA_CUSTOMER_TRX_LINES_ALL] arl\r\n\tON\t\t\tara.[CUSTOMER_TRX_ID] = arl.[CUSTOMER_TRX_ID]\r\n\r\n\t\r\n\r\n/********************************************************************************************************\r\n\tStep 1.3\tCreate core Inventory Transactions table.\r\n********************************************************************************************************/\r\n\r\n\r\n\tIF OBJECT_ID('[Core].[InventoryTransactions]','U') IS NOT NULL\r\n\t\tDROP TABLE [Core].[InventoryTransactions]\r\n\r\n\r\n\tSELECT\t\tCAST(imt.[TRANSACTION_ID] AS NVARCHAR(255))\t\t\t\t\tAS [TRANSACTION_ID]\r\n\t,\t\t\tCAST(imt.[LAST_UPDATED_BY] AS NVARCHAR(255))\t\t\t\tAS [LAST_UPDATED_BY]\r\n\t,\t\t\tCAST(imt.[CREATION_DATE] AS NVARCHAR(255))\t\t\t\t\tAS [CREATION_DATE]\r\n\t,\t\t\tCAST(imt.[INVENTORY_ITEM_ID] AS NVARCHAR(255))\t\t\t\tAS [INVENTORY_ITEM_ID]\r\n\t,\t\t\tCAST(imt.[ORGANIZATION_ID] AS NVARCHAR(255))\t\t\t\tAS [ORGANIZATION_ID]\r\n\t,\t\t\tCAST(imt.[SUBINVENTORY_CODE] AS NVARCHAR(255))\t\t\t\tAS [SUBINVENTORY_CODE]\r\n\t,\t\t\tCAST(imt.[TRANSACTION_TYPE_ID] AS NVARCHAR(255))\t\t\tAS [TRANSACTION_TYPE_ID]\r\n\t,\t\t\tCAST(imt.[TRANSACTION_ACTION_ID] AS NVARCHAR(255))\t\t\tAS [TRANSACTION_ACTION_ID]\r\n\t,\t\t\tCAST(imt.[TRANSACTION_SOURCE_TYPE_ID] AS NVARCHAR(255))\t\tAS [TRANSACTION_SOURCE_TYPE_ID]\r\n\t,\t\t\tCAST(imt.[PRIMARY_QUANTITY] AS NUMERIC(28,8))\tAS [Primary Quantity]\r\n\t,\t\t\tCAST(imt.[TRANSACTION_DATE] AS NVARCHAR(255))\t\t\t\t\t\t\tAS [TRANSACTION_DATE]\r\n\t,\t\t\tCAST(imt.[REASON_ID] AS NVARCHAR(255))\t\t\t\t\t\t\t\t\tAS [REASON_ID]\r\n\t,\t\t\tCAST(imt.[TRANSACTION_SET_ID] AS NVARCHAR(255))\t\t\t\t\t\tAS [TRANSACTION_SET_ID]\r\n\t,\t\t\tCAST(imt.[SOURCE_LINE_ID] AS NVARCHAR(255))\t\t\t\t\t\t\tAS [SOURCE_LINE_ID]\r\n\t,\t\t\tCAST(imt.[XFR_OWNING_ORGANIZATION_ID] AS NVARCHAR(255))\t\t\t\tAS [XFR_OWNING_ORGANIZATION_ID]\r\n\t,\t\t\tCAST(imt.[TRANSACTION_SOURCE_ID] AS NVARCHAR(255))\t\t\t\t\t\tAS [TRANSACTION_SOURCE_ID]\r\n\t,\t\t\tCAST(imt.[TRANSACTION_SOURCE_NAME] AS NVARCHAR(255))\t\t\t\t\tAS [TRANSACTION_SOURCE_NAME]\r\n\t,\t\t\tCAST(imt.[TRANSACTION_REFERENCE] AS NVARCHAR(255))\t\t\t\t\t\tAS [TRANSACTION_REFERENCE]\r\n\t,\t\t\tCAST(imt.[RCV_TRANSACTION_ID] AS NVARCHAR(255))\t\t\t\t\t\tAS [RCV_TRANSACTION_ID]\r\n\t,\t\t\tCAST(imt.[TRX_SOURCE_LINE_ID] AS NVARCHAR(255))\t\t\t\t\t\tAS [TRX_SOURCE_LINE_ID]\r\n\t,\t\t\tCAST(imt.[TRANSFER_TRANSACTION_ID] AS NVARCHAR(255))\t\t\t\t\tAS [TRANSFER_TRANSACTION_ID]\r\n\t,\t\t\tCAST(imt.[TRANSFER_ORGANIZATION_ID] AS NVARCHAR(255))\t\t\t\t\tAS [TRANSFER_ORGANIZATION_ID]\r\n\t,\t\t\tCAST(imt.[TRANSFER_SUBINVENTORY] AS NVARCHAR(255))\t\t\t\t\t\tAS [TRANSFER_SUBINVENTORY]\r\n\t,\t\t\tCAST(imt.[MOVE_ORDER_LINE_ID] AS NVARCHAR(255))\t\t\t\t\t\tAS [MOVE_ORDER_LINE_ID]\r\n\t,\t\t\tCAST(imt.[PICK_SLIP_NUMBER]\t AS NVARCHAR(255))\t\t\t\t\t\tAS [PICK_SLIP_NUMBER]\r\n\t,\t\t\tCAST(imt.[PICK_SLIP_LINE_NUMBER] AS NVARCHAR(255))\t\t\t\t\t\tAS [PICK_SLIP_LINE_NUMBER]\r\n\t,\t\t\tCAST(imt.[ORIG_SUBINVENTORY_CODE] AS NVARCHAR(255))\t\t\t\t\tAS [ORIG_SUBINVENTORY_CODE]\r\n\t,\t\t\tCAST(imt.[SHIPMENT_NUMBER] AS NVARCHAR(255))\t\t\t\t\t\t\tAS [SHIPMENT_NUMBER]\r\n\t,\t\t\tCAST(imt.[ATTRIBUTE1]\t AS NVARCHAR(255))\t\t\t\t\t\t\tAS [ATTRIBUTE1]\r\n\t,\t\t\tCAST(imt.[PICKING_LINE_ID] AS NVARCHAR(255))\t\t\t\t\t\t\tAS [PICKING_LINE_ID]\r\n\t,\t\t\tCAST(imt.[TRX_SOURCE_DELIVERY_ID] AS NVARCHAR(255))\t\t\t\t\tAS [TRX_SOURCE_DELIVERY_ID]\r\n\t,\t\t\tCAST(imt.[SHIP_TO_LOCATION_ID] AS NVARCHAR(255))\t\t\t\t\t\tAS [SHIP_TO_LOCATION_ID]\r\n\t,\t\t\tCAST(itt.[LANGUAGE] AS NVARCHAR(255))\t\t\t\t\t\t\t\t\tAS [LANGUAGE]\r\n\t,\t\t\tCAST(itt.[TRANSACTION_TYPE_NAME] AS NVARCHAR(255))\t\t\t\t\t\tAS [TRANSACTION_TYPE_NAME]\r\n\t,\t\t\tCAST(itrl.[LINE_ID]\t AS NVARCHAR(255))\t\t\t\t\t\t\t\tAS [LINE_ID]\r\n\t,\t\t\tCAST(itrl.[HEADER_ID]\t AS NVARCHAR(255))\t\t\t\t\t\t\tAS [HEADER_ID]\r\n\t,\t\t\tCAST(itrl.[LINE_NUMBER]\t AS NVARCHAR(255))\t\t\t\t\t\t\tAS [LINE_NUMBER]\r\n\t,\t\t\tCAST(itrl.[FROM_SUBINVENTORY_CODE] AS NVARCHAR(255))\t\t\t\t\tAS [FROM_SUBINVENTORY_CODE]\r\n\t,\t\t\tCAST(itrl.[UOM_CODE] AS NVARCHAR(255))\t\t\t\t\t\t\t\t\tAS [UOM_CODE]\r\n\t,\t\t\tCAST(itrl.[QUANTITY] AS NVARCHAR(255))\t\t\t\t\t\t\t\t\tAS [QUANTITY]\r\n\t,\t\t\tCAST(itrl.[DATE_REQUIRED] AS NVARCHAR(255))\t\t\t\t\t\t\tAS [DATE_REQUIRED]\r\n\t,\t\t\tCAST(itrl.[LINE_STATUS] AS NVARCHAR(255))\t\t\t\t\t\t\t\tAS [LINE_STATUS]\r\n\t,\t\t\tCAST(itrl.[QUANTITY_DELIVERED] AS NVARCHAR(255))\t\t\t\t\t\tAS [QUANTITY_DELIVERED]\r\n\t,\t\t\tCAST(itrl.[TO_SUBINVENTORY_CODE] AS NVARCHAR(255))\t\t\t\t\t\tAS [TO_SUBINVENTORY_CODE]\r\n\t,\t\t\tCAST(itrl.[REQUEST_ID] AS NVARCHAR(255))\t\t\t\t\t\t\t\tAS [REQUEST_ID]\r\n\t,\t\t\tCAST(itrl.[ATTRIBUTE_TIMESTAMP1] AS NVARCHAR(255))\t\t\t\t\t\tAS [ATTRIBUTE_TIMESTAMP1]\r\n\t,\t\t\tCAST(itrl.[TRANSACTION_HEADER_ID] AS NVARCHAR(255))\t\t\t\t\tAS [TRANSACTION_HEADER_ID]\r\n\t,\t\t\tCAST(itrl.[ATTRIBUTE2] AS NVARCHAR(255))\t\t\t\t\t\t\t\tAS [ATTRIBUTE2]\r\n\t,\t\t\tCAST(itrl.[ATTRIBUTE_NUMBER4] AS NVARCHAR(255))\t\t\t\t\t\tAS [ATTRIBUTE_NUMBER4]\r\n\t,\t\t\tCAST(itrl.[ATTRIBUTE_NUMBER5] AS NVARCHAR(255))\t\t\t\t\t\tAS [ATTRIBUTE_NUMBER5]\r\n\t,\t\t\tCAST(itrl.[ATTRIBUTE_NUMBER6] AS NVARCHAR(255))\t\t\t\t\t\tAS [ATTRIBUTE_NUMBER6]\r\n\t,\t\t\tCAST(itrl.[ATTRIBUTE_TIMESTAMP2] AS NVARCHAR(255))\t\t\t\t\t\tAS [ATTRIBUTE_TIMESTAMP2]\r\n\t,\t\t\tCAST(itrl.[REFERENCE_NAME] AS NVARCHAR(255))\t\t\t\t\t\t\tAS [REFERENCE_NAME]\r\n\t,\t\t\tCAST(GETDATE() AS DATE)\t\t\t\t\t\tAS [DateStamp]\r\n\tINTO\t\t[Core].[InventoryTransactions]\r\n\tFROM\t\t[RAW].[O.INV_MATERIAL_TXNS] imt\r\n\tLEFT JOIN\t[RAW].[O.INV_TRANSACTION_TYPES_TL] itt\r\n\tON\t\t\titt.[TRANSACTION_TYPE_ID] = imt.[TRANSACTION_TYPE_ID]\t\r\n\tLEFT JOIN\t[RAW].[O.INV_TXN_REQUEST_LINES] itrl\r\n\tON\t\t\titrl.[LINE_ID] = imt.[MOVE_ORDER_LINE_ID]\r\n\r\n\r\n/********************************************************************************************************\r\n\tStep 1.4\tCreate core shipping details table.\r\n********************************************************************************************************/\r\n\t\r\n\tIF OBJECT_ID('[Core].[ShippingDetails]','U') IS NOT NULL\r\n\t\tDROP TABLE [Core].[ShippingDetails]\r\n\r\n\tSELECT\t\t*\r\n\t,\t\t\tCAST(GETDATE() AS DATE)\t\t\t\t\t\tAS [DateStamp]\r\n\tINTO\t\t[Core].[ShippingDetails]\r\n\tFROM\t\t[RAW].[O.WSH_DELIVERY_DETAILS]\r\n\r\n/********************************************************************************************************\r\n\tStep 1.5\tCreate core inventory lot number tables.\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Core].[InventoryLotNumbers]','U') IS NOT NULL\r\n\t\tDROP TABLE [Core].[InventoryLotNumbers]\r\n\r\n\tSELECT\t\t*\r\n\t,\t\t\tCAST(GETDATE() AS DATE)\t\t\t\t\t\tAS [DateStamp]\r\n\tINTO\t\t[Core].[InventoryLotNumbers]\r\n\tFROM\t\t[RAW].[O.INV_LOT_NUMBERS]\r\n\r\n\r\n\r\n\tIF OBJECT_ID('[Core].[InventoryLotNumberTransactions]','U') IS NOT NULL\r\n\t\tDROP TABLE [Core].[InventoryLotNumberTransactions]\r\n\r\n\tSELECT\t\t*\r\n\t,\t\t\tCAST(GETDATE() AS DATE)\t\t\t\t\t\tAS [DateStamp]\r\n\tINTO\t\t[Core].[InventoryLotNumberTransactions]\r\n\tFROM\t\t[RAW].[O.INV_TRANSACTION_LOT_NUMBERS]\r\n\r\n/********************************************************************************************************\r\n\tStep 1.6\tCreate core receiving shipment headers table.\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Core].[ReceivingShipmentHeaders]','U') IS NOT NULL\r\n\t\tDROP TABLE [Core].[ReceivingShipmentHeaders]\r\n\r\n\tSELECT\t\t*\r\n\t,\t\t\tCAST(GETDATE() AS DATE)\t\t\t\t\t\tAS [DateStamp]\r\n\tINTO\t\t[Core].[ReceivingShipmentHeaders]\r\n\tFROM\t\t[RAW].[O.RCV_SHIPMENT_HEADERS]"
								}
							]
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"folder": {
					"name": "Trade/Margin"
				},
				"annotations": [],
				"lastPublishTime": "2022-11-17T12:13:48Z"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/SQL_Margin_DataMarts')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "Stored procedure1",
						"type": "SqlServerStoredProcedure",
						"dependsOn": [],
						"policy": {
							"timeout": "7.00:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"storedProcedureName": "[[Trade].[SQL_MarginDataMarts_1]"
						},
						"linkedServiceName": {
							"referenceName": "SqlServerArgent",
							"type": "LinkedServiceReference"
						}
					},
					{
						"name": "Stored procedure2",
						"type": "SqlServerStoredProcedure",
						"dependsOn": [
							{
								"activity": "Stored procedure1",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "7.00:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"storedProcedureName": "[[Trade].[SQL_MarginDataMarts_2]"
						},
						"linkedServiceName": {
							"referenceName": "SqlServerArgent",
							"type": "LinkedServiceReference"
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"folder": {
					"name": "Trade/Margin"
				},
				"annotations": [],
				"lastPublishTime": "2022-11-21T16:18:47Z"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/SQL_Margin_Data_Marks_Script')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "Margin Data Marks Script",
						"type": "Script",
						"dependsOn": [],
						"policy": {
							"timeout": "7.00:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"linkedServiceName": {
							"referenceName": "SqlServerArgent",
							"type": "LinkedServiceReference"
						},
						"typeProperties": {
							"scripts": [
								{
									"type": "NonQuery",
									"text": "/*==============================================================================================================================*\r\n * Project:\t\tArgent\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Purpose:\t\tCreate the data marts that will feed into the Margin report.\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Description:\t1) Create Orders And Invoices data marts\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n * Prerequisites: Run tracability loop script.\t\t\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Outputs: Tables \"Trade.PurchaseOrdersAndInvoices\", \"Trade.SalesOrdersAndInvoices\", \"Trade.TraceabilityAndOrders\"\t\t\t\t*\r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * SQL ATR - Basic joins, LAG funtion used on Line 77, Simple maths used throughout\t\t\t\t\t\t\t\t\t\t\t\t* \r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Date:       29/07/2022\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Version:     1.0\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n *==============================================================================================================================*\r\n * Updates:\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Date\t\t| Version | Author\t\t| Change made\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * -----------------------------------------------------------------------------------------------------------------------------*\r\n * --/--/-- |  1.-\t  |\t\t\t\t|\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t|\t\t  |\t\t\t\t|\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *==============================================================================================================================*/\r\n\r\n/********************************************************************************************************\r\n\tStep 3.1\tJoin invoices on to purchase orders to create [Trade].[PurchaseOrdersAndInvoice] table.\r\n\r\n\t\t\t\tIf order number = previous row's order number then Invoice Amount = Invoice Line Amount\r\n\t\t\t\tIf invoiced quantity > 0 then Invoice Amount = Invoice Line Amount\r\n\t\t\t\tElse Invoice Amount = Primary Quantity * Unit Price = Order Amount\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Trade].[PurchaseOrdersAndInvoices]','U') IS NOT NULL\r\n\t\tDROP TABLE [Trade].[PurchaseOrdersAndInvoices]\r\n\r\n\tSELECT\t\tpo.[Purchase Order Number]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Order Number]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN RIGHT(REPLACE(po.[Purchase Order Number],'T',''),2) IN ('O1','O2')\r\n\t\t\t\t\t\tTHEN LEFT(REPLACE(po.[Purchase Order Number],'T',''),LEN(REPLACE(po.[Purchase Order Number],'T',''))-2)\r\n\t\t\t\t\tELSE REPLACE(po.[Purchase Order Number],'T','')\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Parent Order]\r\n\t,\t\t\tsn.[Supplier Name]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Supplier/Customer]\r\n\t,\t\t\ts.[Supplier ID]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Supplier/Customer Number]\r\n\t,\t\t\tISNULL(pc.[Blanket Purchase Agreement Number],'')\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Agreement Number/Sales Contract Number]\r\n\t,\t\t\tISNULL(i.[Item Code],po.[Item Description])\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Item Code]\r\n\t,\t\t\tpo.[Item Description]\r\n\t,\t\t\ti.[Category Code]\r\n\t,\t\t\tpo.[Unit Price]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Agreement Price]\r\n\t,\t\t\trt.[Primary Quantity]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Quantity]\r\n\t,\t\t\tap.[Unit Price]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Invoice Price]\r\n\t,\t\t\tap.[Quantity Invoiced]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Invoiced Quantity]\r\n\t,\t\t\tap.[Invoice Line Amount]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Invoice Line Amount]\r\n\t,\t\t\tpo.[Purchase Document Currency]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Currency]\r\n\t,\t\t\to.[Business Unit Name]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Business Unit]\r\n\t,\t\t\trt.[Inventory Organization Code]\r\n\t,\t\t\trt.[Inventory Organization Name] \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t,\t\t\tpo.[Ordered Quantity]\t\t\r\n\t,\t\t\tap.[Approval Status]\t\r\n\t,\t\t\tp.[Mode of Transport]\t\r\n\t,\t\t\tpo.[Incoterm]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Freight Terms]\t\t\t\t\t\t\t\r\n\t,\t\t\tap.[Invoice Number]\t\t\t\r\n\t,\t\t\tpo.[Purchase Document Status]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Order Status]\r\n\t,\t\t\tCAST(LEFT(rt.[Transaction Date],10) AS DATE)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Transaction Date]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN po.[Purchase Order Number] = LAG(po.[Purchase Order Number])OVER(ORDER BY po.[Purchase Order Number],ap.[Invoice Line Amount] DESC)\r\n\t\t\t\t\t\tTHEN\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN ap.[Approval Status] IN ('NEEDS REAPPROVAL','NEVER APPROVED')\r\n\t\t\t\t\t\t\t\t\t\tTHEN CAST(ap.[Unit Price] AS NUMERIC(28,2)) * CAST(ap.[Quantity Invoiced] AS NUMERIC(28,2))\r\n\t\t\t\t\t\t\t\t\tELSE (-1) * CAST(ap.[Invoice Line Amount] AS NUMERIC(28,2))\r\n\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\tWHEN CAST(ap.[Quantity Invoiced] AS NUMERIC(28,8)) > 0\r\n\t\t\t\t\t\tTHEN\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN ap.[Approval Status] IN ('NEEDS REAPPROVAL','NEVER APPROVED')\r\n\t\t\t\t\t\t\t\t\t\tTHEN CAST(ap.[Unit Price] AS NUMERIC(28,2)) * CAST(ap.[Quantity Invoiced] AS NUMERIC(28,2))\r\n\t\t\t\t\t\t\t\t\tELSE (-1) * CAST(ap.[Invoice Line Amount] AS NUMERIC(28,2))\r\n\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\tELSE (-1) * CAST(rt.[Primary Quantity] AS NUMERIC(28,2)) * CAST(po.[Unit Price] AS NUMERIC(28,2))\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Invoice Amount]\r\n\t,\t\t\tfx.[EUR USD]\r\n\t,\t\t\tfx.[EUR GBP]\r\n\t,\t\t\ty.[Actual Yield]\r\n\t,\t\t\tln.[Lot Numbers]\r\n\t,\t\t\tCAST(GETDATE() AS DATE)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [DateStamp]\r\n\tINTO\t\t[Trade].[PurchaseOrdersAndinvoices]\r\n\tFROM\t\t[Core].[PurchaseOrders] po\r\n\tLEFT JOIN\t[Core].[Suppliers] s\r\n\tON\t\t\tpo.[Supplier] = s.[Vendor ID]\r\n\tAND\t\t\tpo.[Supplier Site] = s.[Vendor Site ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Party ID]\r\n\t\t\t\t\t,\t\t\tMIN([Party Name])\tAS [Supplier Name]\r\n\t\t\t\t\tFROM\t\t[Core].[Parties]\r\n\t\t\t\t\tGROUP BY\t[Party ID]\r\n\t\t\t\t) sn\r\n\tON\t\t\ts.[Party ID] = sn.[Party ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[PO Header ID]\r\n\t\t\t\t\t,\t\t\t[Blanket Purchase Agreement Number]\r\n\t\t\t\t\tFROM\t\t[Core].[PurchaseContracts]\r\n\t\t\t\t\tGROUP BY\t[PO Header ID]\r\n\t\t\t\t\t,\t\t\t[Blanket Purchase Agreement Number]\r\n\t\t\t\t) pc\r\n\tON\t\t\tpc.[PO Header ID] = po.[From Header ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Item Code]\r\n\t\t\t\t\t,\t\t\t[Inventory Item ID]\r\n\t\t\t\t\t,\t\t\t[Category Code]\r\n\t\t\t\t\tFROM\t\t[Core].[Items]\r\n\t\t\t\t\tGROUP BY\t[Item Code]\r\n\t\t\t\t\t,\t\t\t[Inventory Item ID]\r\n\t\t\t\t\t,\t\t\t[Category Code]\r\n\t\t\t\t) i \r\n\tON\t\t\ti.[Inventory Item ID] = po.[Item ID]\t\r\n\tLEFT JOIN\t[Core].[APInvoices] ap\r\n\tON\t\t\tpo.[PO Line ID] = ap.[PO Line ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Business Unit ID]\r\n\t\t\t\t\t,\t\t\t[Business Unit Name]\r\n\t\t\t\t\tFROM\t\t[Core].[Organizations]\r\n\t\t\t\t\tGROUP BY\t[Business Unit ID]\r\n\t\t\t\t\t,\t\t\t[Business Unit Name]\r\n\t\t\t\t) o\r\n\tON\t\t\tpo.[Procurement BU ID] = o.[Business Unit ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Party ID]\r\n\t\t\t\t\t,\t\t\tMIN([Party Name])\tAS [Mode of Transport]\r\n\t\t\t\t\tFROM\t\t[Core].[Parties]\r\n\t\t\t\t\tGROUP BY\t[Party ID]\r\n\t\t\t\t) p\r\n\tON\t\t\tpo.[Carrier ID] = p.[Party ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\ta.*\r\n\t\t\t\t\t,\t\t\tb.[Inventory Organization Name]\r\n\t\t\t\t\t,\t\t\tb.[Inventory Organization Code]\t\r\n\t\t\t\t\tFROM\t\t[Core].[ReceivingTransactions] a\r\n\t\t\t\t\tLEFT JOIN\t[Core].[Organizations] b\r\n\t\t\t\t\tON\t\t\ta.[Organization ID] = b.[Organization ID]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'RECEIVE'\r\n\t\t\t\t\tAND\t\t\tb.[Business Unit Name] IN ('BDA BU','Motherwell','Stanlow')\r\n\t\t\t\t) rt\r\n\tON\t\t\tpo.[PO Line ID] = rt.[PO Line ID]\r\n\tAND\t\t\tpo.[PO Header ID] = rt.[PO Header ID]\r\n\tAND\t\t\t(ap.[Receiving Transaction ID] = rt.[Transaction ID] OR ap.[Receiving Transaction ID] IS NULL)\r\n\tLEFT JOIN\t[Core].[FXRates] fx\r\n\tON\t\t\tCAST([CONVERSION_DATE] AS DATE) = CAST(LEFT(rt.[Transaction Date],10) AS DATE)\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Business Unit]\r\n\t\t\t\t\t,\t\t\t[Start date]\r\n\t\t\t\t\t,\t\t\t[End date]\r\n\t\t\t\t\t,\t\t\tAVG(CAST([Expected yield] AS DECIMAL(28,8))) AS [Actual Yield]\r\n\t\t\t\t\tFROM\t\t[Trade].[Yield]\r\n\t\t\t\t\tGROUP BY\t[Business Unit]\r\n\t\t\t\t\t,\t\t\t[Start date]\r\n\t\t\t\t\t,\t\t\t[End date]\r\n\t\t\t\t) y\r\n\tON\t\t\to.[Business Unit Name] = y.[Business Unit]\r\n\tAND\t\t\tCAST(LEFT(rt.[Transaction Date],10) AS DATE) BETWEEN CAST(y.[Start date] AS DATE) AND ISNULL(CAST(y.[End date] AS DATE),GETDATE())\t\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Document Number]\r\n\t\t\t\t\t,\t\t\t[Lot Numbers]\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Purchase Order Receipt'\r\n\t\t\t\t) ln\r\n\tON\t\t\tln.[Document Number] =  CASE\r\n\t\t\t\t\t\t\t\t\t\t\tWHEN RIGHT(REPLACE(po.[Purchase Order Number],'T',''),2) IN ('O1','O2')\r\n\t\t\t\t\t\t\t\t\t\t\t\tTHEN LEFT(REPLACE(po.[Purchase Order Number],'T',''),LEN(REPLACE(po.[Purchase Order Number],'T',''))-2)\r\n\t\t\t\t\t\t\t\t\t\t\tELSE REPLACE(po.[Purchase Order Number],'T','')\r\n\t\t\t\t\t\t\t\t\t\tEND\r\n\tWHERE\t\t[Purchase Order Number] NOT LIKE '%PU-%'\r\n\tAND\t\t\ti.[Item Code] IS NOT NULL\r\n\tAND\t\t\t[Purchase Document Status] NOT IN ('CANCELED','INCOMPLETE','OPEN')\r\n\tAND\t\t\to.[Business Unit Name] IN ('BDA BU','Motherwell','Stanlow')\r\n\tAND\t\t\tCAST(LEFT(rt.[Transaction Date],10) AS DATE) >= '2021-01-01'\r\n\r\n/********************************************************************************************************\r\n\tStep 3.2\tJoin invoices on to sales orders to create [Trade].[SalesOrdersAndInvoices] table.\r\n\r\n\t\t\t\tInvoice Amount = [UNIT_SELLING_PRICE] * ([Line Quantity Invoiced] - [Quantity Credited])\r\n********************************************************************************************************/\r\n\t\r\n\tIF OBJECT_ID('[Trade].[SalesOrdersAndInvoices]','U') IS NOT NULL\r\n\t\tDROP TABLE [Trade].[SalesOrdersAndInvoices]\r\n\r\n\tSELECT\t\tso.[Order Number]\r\n\t,\t\t\tLEFT(so.[Order Number],5)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Parent Order]\r\n\t,\t\t\tso.[Item Code]\r\n\t,\t\t\tso.[Item Name]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Item Description]\r\n\t,\t\t\tso.[Category Code]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t,\t\t\tCAST(CASE WHEN ar.[UNIT_SELLING_PRICE] IS NULL THEN '0' ELSE ar.[UNIT_SELLING_PRICE] END AS NUMERIC(28,2))\t\t\t\t\tAS [Invoice Price]\r\n\t,\t\t\tCAST(CASE WHEN ar.[Line Quantity Invoiced] IS NULL THEN '0' ELSE ar.[Line Quantity Invoiced] END AS NUMERIC(28,2))\r\n\t\t\t\t\t- ABS(ISNULL(CAST(CASE WHEN ar.[Quantity Credited] IS NULL THEN '0' ELSE ar.[Quantity Credited] END AS NUMERIC(28,2)),0))\tAS [Invoiced Quantity]\r\n\t,\t\t\tso.[Unit of Measure]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Unit of Measure]\r\n\t,\t\t\tCASE \r\n\t\t\t\t\tWHEN so.[Unit of Measure]\t = 'LTR' \r\n\t\t\t\t\t\tTHEN (CAST(CASE WHEN ar.[Line Quantity Invoiced] IS NULL THEN '0' ELSE ar.[Line Quantity Invoiced] END AS NUMERIC(28,2))\r\n\t\t\t\t\t\t\t- ABS(ISNULL(CAST(CASE WHEN ar.[Quantity Credited] IS NULL THEN '0' ELSE ar.[Quantity Credited] END AS NUMERIC(28,2)),0))) * 0.0008745 \r\n\t\t\t\t\t\tELSE CAST(CASE WHEN ar.[Line Quantity Invoiced] IS NULL THEN '0' ELSE ar.[Line Quantity Invoiced] END AS NUMERIC(28,2))\r\n\t\t\t\t\t\t\t- ABS(ISNULL(CAST(CASE WHEN ar.[Quantity Credited] IS NULL THEN '0' ELSE ar.[Quantity Credited] END AS NUMERIC(28,2)),0))\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Invoiced Quantity (TN)]\t\r\n\t,\t\t\tso.[Transactional Currency Code]\r\n\t,\t\t\to.[Business Unit Name]\r\n\t,\t\t\tCAST(LEFT(ar.[TRX_DATE],10) AS DATE)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Transaction Date]\r\n\t,\t\t\tIIF(CAST(CASE WHEN ar.[UNIT_SELLING_PRICE] IS NULL THEN '0' ELSE ar.[UNIT_SELLING_PRICE] END AS NUMERIC(28,2)) < 0\r\n\t\t\t\t\t,(-1) * CAST(CASE WHEN ar.[UNIT_SELLING_PRICE] IS NULL THEN '0' ELSE ar.[UNIT_SELLING_PRICE] END AS NUMERIC(28,2)) \r\n\t\t\t\t\t\t\t* (CAST(CASE WHEN ar.[Line Quantity Invoiced] IS NULL THEN '0' ELSE ar.[Line Quantity Invoiced] END AS NUMERIC(28,2))\r\n\t\t\t\t\t\t\t\t- ABS(ISNULL(CAST(CASE WHEN ar.[Quantity Credited] IS NULL THEN '0' ELSE ar.[Quantity Credited] END AS NUMERIC(28,2)),0)))\r\n\t\t\t\t\t,CAST(CASE WHEN ar.[UNIT_SELLING_PRICE] IS NULL THEN '0' ELSE ar.[UNIT_SELLING_PRICE] END AS NUMERIC(28,2)) \r\n\t\t\t\t\t\t* (CAST(CASE WHEN ar.[Line Quantity Invoiced] IS NULL THEN '0' ELSE ar.[Line Quantity Invoiced] END AS NUMERIC(28,2))\r\n\t\t\t\t\t\t\t- ABS(ISNULL(CAST(CASE WHEN ar.[Quantity Credited] IS NULL THEN '0' ELSE ar.[Quantity Credited] END AS NUMERIC(28,2)),0)))\r\n\t\t\t\t\t)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Invoice Amount]\r\n\t,\t\t\t[EUR GBP]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [EUR:GBP]\r\n\t,\t\t\t[EUR USD]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [EUR:USD]\r\n\t,\t\t\tCAST(GETDATE() AS DATE)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [DateStamp]\r\n\tINTO\t\t[Trade].[SalesOrdersAndInvoices]\r\n\tFROM\t\t(\r\n\t\t\t\t\tSELECT\t\tDISTINCT [Order Number]\r\n\t\t\t\t\t,\t\t\t[Transactional Currency Code]\r\n\t\t\t\t\t,\t\t\t[Org ID]\r\n\t\t\t\t\t,\t\t\tso.[Inventory Item ID]\r\n\t\t\t\t\t,\t\t\t[Inventory Organization ID]\r\n\t\t\t\t\t,\t\t\ti.[Unit of Measure]\r\n\t\t\t\t\t,\t\t\ti.[Item Code]\r\n\t\t\t\t\t,\t\t\ti.[Item Name]\t\t\r\n\t\t\t\t\t,\t\t\ti.[Category Code]\r\n\t\t\t\t\tFROM\t\t[Core].[SalesOrders] so\r\n\t\t\t\t\tLEFT JOIN\t[Core].[Items] i\r\n\t\t\t\t\tON\t\t\ti.[Inventory Item ID] = so.[Inventory Item ID]\r\n\t\t\t\t\tAND\t\t\ti.[Organization ID] = so.[Inventory Organization ID]\r\n\t\t\t\t\tWHERE\t\ti.[Category Code] NOT LIKE '%Services%'\r\n\t\t\t\t) so\r\n\tLEFT JOIN\t[Core].[ARInvoices] ar\r\n\tON\t\t\tso.[Order Number] = ar.[SALES_ORDER]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Business Unit ID]\r\n\t\t\t\t\t,\t\t\t[Business Unit Name]\r\n\t\t\t\t\tFROM\t\t[Core].[Organizations]\r\n\t\t\t\t\tGROUP BY\t[Business Unit ID]\r\n\t\t\t\t\t,\t\t\t[Business Unit Name]\r\n\t\t\t\t) o\r\n\tON\t\t\tso.[Org ID] = o.[Business Unit ID]\r\n\tLEFT JOIN\t[Core].[FXRates] fx\r\n\tON\t\t\tCAST([CONVERSION_DATE] AS DATE) = CAST(LEFT(ar.[TRX_DATE],10) AS DATE)\r\n\tWHERE\t\to.[Business Unit Name] IN ('BDA BU','Motherwell','Stanlow')\r\n\tAND\t\t\tCAST(LEFT(ar.[TRX_DATE],10) AS DATE) >= '2021-01-01'\r\n\tORDER BY\tso.[Order Number]\r\n\r\n/********************************************************************************************************\r\n\tStep 3.3\tJoin [Trade].[PurchaseOrdersAndInvoices] on to [Trade].[TraceabilityLooped] to obtain the original\r\n\t\t\t\tPO value of each feedstock item that feeds into each biodiesel sale.\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Trade].[TraceabilityAndOrders]','U') IS NOT NULL\r\n\t\tDROP TABLE [Trade].[TraceabilityAndOrders]\r\n\r\n\tSELECT\t\tt.*\r\n\t,\t\t\to.[Parent Order]\r\n\t,\t\t\tpoi.[PO Item Code]\r\n\t,\t\t\tpoi.[PO Item Description]\r\n\t,\t\t\tpoi.[PO Item Category]\r\n\t,\t\t\to.[Invoice Amount]\r\n\t,\t\t\to.[PO Quantity]\r\n\t,\t\t\to.[Invoice Amount]/NULLIF(o.[PO Quantity],0) AS [Price per MT]\r\n\t,\t\t\to.[Lot Numbers] AS [Lot Numbers Orders Table]\r\n\t,\t\t\to.[PO Transaction Date]\r\n\t,\t\t\to.[Business Unit] AS [PO Business Unit]\r\n\t,\t\t\tISNULL(sodr.[Returned Flag],'0') AS [Returned Flag]\r\n\tINTO\t\t[Trade].[TraceabilityAndOrders]\r\n\tFROM\t\t[Trade].[TraceabilityLooped] t\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Business Unit]\r\n\t\t\t\t\t,\t\t\t[Parent Order]\r\n\t\t\t\t\t,\t\t\tSUM(CASE WHEN [Currency] = 'USD' THEN [Invoice Amount]/[EUR USD]\r\n\t\t\t\t\t\t\t\t\t\t WHEN [Currency] = 'GBP' THEN [Invoice Amount]/[EUR GBP]\r\n\t\t\t\t\t\t\t\t\t\t ELSE [Invoice Amount]\r\n\t\t\t\t\t\t\t\t\tEND) AS [Invoice Amount]\r\n\t\t\t\t\t,\t\t\tSUM(CAST(CASE\r\n\t\t\t\t\t\t\t\t\t\t\tWHEN [Category Code] LIKE '%Feedstock%' OR [Category Code] LIKE '%Biodiesel%'\r\n\t\t\t\t\t\t\t\t\t\t\t\tTHEN IIF(CAST([Invoiced Quantity] AS DECIMAL(28,8)) = 0,[Invoiced Quantity],[Quantity])\r\n\t\t\t\t\t\t\t\t\t\t\tELSE '0'\r\n\t\t\t\t\t\t\t\t\t\t END AS DECIMAL(28,8))) AS [PO Quantity]\r\n\t\t\t\t\t,\t\t\tMAX([Transaction Date]) AS [PO Transaction Date]\r\n\t\t\t\t\t,\t\t\t[Lot Numbers]\r\n\t\t\t\t\tFROM\t\t[Trade].[PurchaseOrdersAndInvoices]\r\n\t\t\t\t\tGROUP BY\t[Business Unit]\r\n\t\t\t\t\t,\t\t\t[Parent Order]\r\n\t\t\t\t\t,\t\t\t[Lot Numbers]\r\n\t\t\t\t) o\r\n\tON\t\t\tCOALESCE(t.[Lot Numbers_21]\r\n\t\t\t\t\t\t,t.[Lot Numbers_20]\r\n\t\t\t\t\t\t,t.[Lot Numbers_19]\r\n\t\t\t\t\t\t,t.[Lot Numbers_18]\r\n\t\t\t\t\t\t,t.[Lot Numbers_17]\r\n\t\t\t\t\t\t,t.[Lot Numbers_16]\r\n\t\t\t\t\t\t,t.[Lot Numbers_15]\r\n\t\t\t\t\t\t,t.[Lot Numbers_14]\r\n\t\t\t\t\t\t,t.[Lot Numbers_13]\r\n\t\t\t\t\t\t,t.[Lot Numbers_12]\r\n\t\t\t\t\t\t,t.[Lot Numbers_11]\r\n\t\t\t\t\t\t,t.[Lot Numbers_10]\r\n\t\t\t\t\t\t,t.[Lot Numbers_9]\r\n\t\t\t\t\t\t,t.[Lot Numbers_8]\r\n\t\t\t\t\t\t,t.[Lot Numbers_7]\r\n\t\t\t\t\t\t,t.[Lot Numbers_6]\r\n\t\t\t\t\t\t,t.[Lot Numbers_5]\r\n\t\t\t\t\t\t,t.[Lot Numbers_4]\r\n\t\t\t\t\t\t,t.[Lot Numbers_3]\r\n\t\t\t\t\t\t,t.[Lot Numbers_2]\r\n\t\t\t\t\t\t,t.[Lot Numbers]) = o.[Lot Numbers]\t\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Parent Order]\r\n\t\t\t\t\t,\t\t\t[Item Code]\t\t\tAS [PO Item Code]\r\n\t\t\t\t\t,\t\t\t[Item Description]\tAS [PO Item Description]\r\n\t\t\t\t\t,\t\t\t[Category Code]\t\tAS [PO Item Category]\r\n\t\t\t\t\tFROM\t\t[Trade].[PurchaseOrdersAndInvoices]\t\t--20,098\r\n\t\t\t\t\tWHERE\t\t[Category Code] <> 'Services.Services'\r\n\t\t\t\t\tGROUP BY\t[Parent Order]\r\n\t\t\t\t\t,\t\t\t[Item Code]\r\n\t\t\t\t\t,\t\t\t[Item Description]\r\n\t\t\t\t\t,\t\t\t[Category Code]\r\n\t\t\t\t) poi\r\n\tON\t\t\to.[Parent Order] = poi.[Parent Order]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tDISTINCT [Order Number]\t\r\n\t\t\t\t\t,\t\t\t[Line Number]\r\n\t\t\t\t\t,\t\t\t'1' AS [Returned Flag]\r\n\t\t\t\t\tFROM\t\t[Core].[SalesOrderDocumentReferences] sodr\r\n\t\t\t\t\tLEFT JOIN\t[Core].[SalesOrders] so\r\n\t\t\t\t\tON\t\t\tsodr.[DOC_LINE_ID] = so.[Line ID]\r\n\t\t\t\t\tWHERE\t\t[Line ID] IS NOT NULL\r\n\t\t\t\t) sodr\r\n\tON\t\t\tt.[SOURCE_HEADER_NUMBER] = sodr.[Order Number]\t\r\n\tAND\t\t\tt.[SOURCE_LINE_NUMBER] = sodr.[Line Number]\r\n\tORDER BY\tt.[CREATION_DATE]"
								}
							]
						}
					},
					{
						"name": "Margin Data Marks Script_copy1",
						"type": "Script",
						"dependsOn": [
							{
								"activity": "Margin Data Marks Script",
								"dependencyConditions": [
									"Succeeded"
								]
							}
						],
						"policy": {
							"timeout": "7.00:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"linkedServiceName": {
							"referenceName": "SqlServerArgent",
							"type": "LinkedServiceReference"
						},
						"typeProperties": {
							"scripts": [
								{
									"type": "NonQuery",
									"text": "/*==============================================================================================================================*\r\n * Project:\t\tArgent\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Purpose:\t\tCreate the data marts that will feed into the Margin report.\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Description:\t1) Create sales order feedstock value data marts\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n * Prerequisites: Run tracability loop script.\t\t\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Key Outputs: Tables \"[Trade].[SalesOrderFeedstockValues_POLevel_BiodieselQuantity]\"\t\t\t\t\t\t\t\t\t\t\t*\r\n\t\t\t\t\t, \"[Trade].[SalesOrderFeedstockValues_Summarised]\"\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Date:       29/07/2022\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Version:     1.0\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n *==============================================================================================================================*\r\n * Updates:\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Date\t\t| Version | Author\t\t| Change made\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * -----------------------------------------------------------------------------------------------------------------------------*\r\n * --/--/-- |  1.-\t  |\t\t\t\t|\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t|\t\t  |\t\t\t\t|\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *==============================================================================================================================*/\r\n/********************************************************************************************************\r\n\tStep 4.1\tCalculate the original value of feedstock used from the original PO. [Trade].[TraceabilityAndOrders]\r\n\t\t\t\tis not filtered for Returned Flag = 1 so that cost of sales for all order numbers can be calculated.\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Trade].[POValues_RMA]','U') IS NOT NULL\r\n\t\tDROP TABLE [Trade].[POValues_RMA]\r\n\r\n\tSELECT\t\t* \r\n\t,\t\t\tCOALESCE([Quantity_21],[Quantity_19],[Quantity_17],[Quantity_15],[Quantity_13],[Quantity_11],[Quantity_9],[Quantity_7],[Quantity_5],[Quantity_3],[Quantity]) * [Price per MT] AS [PO Value]\r\n\tINTO\t\t[Trade].[POValues_RMA]\r\n\tFROM\t\t[Trade].[TraceabilityAndOrders]\r\n\r\n/********************************************************************************************************\r\n\tStep 4.2\tUse the quantities produced in each batch to calculate the value of feedstock from the original PO\r\n\t\t\t\tthat is used to create the biodiesel batch.\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Trade].[SalesOrderFeedstockValues_POLevel_RMA]','U') IS NOT NULL\r\n\t\tDROP TABLE [Trade].[SalesOrderFeedstockValues_POLevel_RMA]\r\n\r\n\tSELECT\t\t[Physical Date]\r\n\t,\t\t\t[Business Unit Name]\r\n\t,\t\t\t[Document Number] AS [Sales Order Number]\r\n\t,\t\t\t[Item Code]\r\n\t,\t\t\t[Item Name]\r\n\t,\t\t\tSUM(DISTINCT ABS([Quantity])) AS [Total Biodiesel Quantity in MT]\r\n\t,\t\t\tSUM(DISTINCT ABS(CASE WHEN [Returned Flag] = '1' THEN 0 ELSE [Quantity] END)) AS [Total Biodiesel Quantity Not Returned]\r\n\t,\t\t\t[Lot Numbers]\r\n\t,\t\t\t[Parent Order] AS [Purchase Order]\r\n\t,\t\t\t[PO Item Code]\r\n\t,\t\t\t[PO Item Description]\r\n\t,\t\t\t[PO Item Category]\r\n\t,\t\t\t[PO Transaction Date]\r\n\t,\t\t\t[PO Business Unit]\r\n\t,\t\t\tSUM(COALESCE([Quantity_21],[Quantity_19],[Quantity_17],[Quantity_15],[Quantity_13],[Quantity_11],[Quantity_9],[Quantity_7],[Quantity_5],[Quantity_3],[Quantity]))\tAS [PO Quantity Used]\r\n\t,\t\t\tSUM([PO Value]) AS [PO Value Used]\r\n\t,\t\t\tSUM(ABS(ISNULL(([Quantity]/[Quantity_2]),1) * ISNULL(([Quantity_3]/[Quantity_4]),1) * ISNULL(([Quantity_5]/[Quantity_6]),1) * ISNULL(([Quantity_7]/[Quantity_8]),1) * ISNULL(([Quantity_9]/[Quantity_10]),1) \r\n\t\t\t\t\t\t* ISNULL(([Quantity_11]/[Quantity_12]),1) * ISNULL(([Quantity_13]/[Quantity_14]),1) * ISNULL(([Quantity_15]/[Quantity_16]),1) * ISNULL(([Quantity_17]/[Quantity_18]),1) * ISNULL(([Quantity_19]/[Quantity_20]),1) \r\n\t\t\t\t\t\t\t* COALESCE([Quantity_21],[Quantity_19],[Quantity_17],[Quantity_15],[Quantity_13],[Quantity_11],[Quantity_9],[Quantity_7],[Quantity_5],[Quantity_3],[Quantity]))) AS [Feedstock Quantity]\r\n\t,\t\t\tSUM(ABS(ISNULL(([Quantity]/[Quantity_2]),1) * ISNULL(([Quantity_3]/[Quantity_4]),1) * ISNULL(([Quantity_5]/[Quantity_6]),1) * ISNULL(([Quantity_7]/[Quantity_8]),1) * ISNULL(([Quantity_9]/[Quantity_10]),1) \r\n\t\t\t\t\t\t* ISNULL(([Quantity_11]/[Quantity_12]),1) * ISNULL(([Quantity_13]/[Quantity_14]),1) * ISNULL(([Quantity_15]/[Quantity_16]),1) * ISNULL(([Quantity_17]/[Quantity_18]),1) * ISNULL(([Quantity_19]/[Quantity_20]),1) \r\n\t\t\t\t\t\t\t* [PO Value])) AS [Feedstock Value]\r\n\t,\t\t\tCAST(GETDATE() AS DATE) AS [DateStamp]\r\n\t,\t\t\t[Returned Flag]\r\n\tINTO\t\t[Trade].[SalesOrderFeedstockValues_POLevel_RMA]\r\n\tFROM\t\t[Trade].[POValues_RMA]\r\n\tGROUP BY\t[Physical Date]\r\n\t,\t\t\t[Business Unit Name]\r\n\t,\t\t\t[Document Number]\r\n\t,\t\t\t[Item Code]\r\n\t,\t\t\t[Item Name]\r\n\t,\t\t\t[Lot Numbers]\r\n\t,\t\t\t[Parent Order]\r\n\t,\t\t\t[PO Item Code]\r\n\t,\t\t\t[PO Item Description]\r\n\t,\t\t\t[PO Item Category]\r\n\t,\t\t\t[PO Transaction Date]\r\n\t,\t\t\t[PO Business Unit]\r\n\t,\t\t\t[Returned Flag]\r\n\r\n/********************************************************************************************************\r\n\tStep 4.3\tCalculate the biodiesel quantity that each PO has contributed to and also include yields.\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Trade].[SalesOrderFeedstockValues_POLevel_BiodieselQuantity_RMA]','U') IS NOT NULL\r\n\t\tDROP TABLE [Trade].[SalesOrderFeedstockValues_POLevel_BiodieselQuantity_RMA]\r\n\r\n\tSELECT\t\tpo.*\r\n\t,\t\t\tABS(MAX([Total Biodiesel Quantity in MT])OVER(PARTITION BY [Sales Order Number], [Lot Numbers], [Total Biodiesel Quantity in MT])/NULLIF(SUM([Feedstock Quantity])OVER(PARTITION BY [Sales Order Number], [Lot Numbers], [Total Biodiesel Quantity in MT]),0)\r\n\t\t\t\t\t* [Feedstock Quantity]) AS [Biodiesel Quantity Row Level]\r\n\t,\t\t\ty.[Actual Yield]\r\n\tINTO\t\t[Trade].[SalesOrderFeedstockValues_POLevel_BiodieselQuantity_RMA]\r\n\tFROM\t\t[Trade].[SalesOrderFeedstockValues_POLevel_RMA] po\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Business Unit]\r\n\t\t\t\t\t,\t\t\t[Start date]\r\n\t\t\t\t\t,\t\t\t[End date]\r\n\t\t\t\t\t,\t\t\tAVG(CAST([Expected yield] AS DECIMAL(28,8))) AS [Actual Yield]\r\n\t\t\t\t\tFROM\t\t[Trade].[Yield]\r\n\t\t\t\t\tGROUP BY\t[Business Unit]\r\n\t\t\t\t\t,\t\t\t[Start date]\r\n\t\t\t\t\t,\t\t\t[End date]\r\n\t\t\t\t) y\r\n\tON\t\t\tpo.[Business Unit Name] = y.[Business Unit]\r\n\tAND\t\t\tCAST(LEFT([Physical Date],10) AS DATE) BETWEEN CAST(y.[Start date] AS DATE) AND ISNULL(CAST(y.[End date] AS DATE),GETDATE())\r\n\r\n/********************************************************************************************************\r\n\tStep 4.4\tSummarise results at the SO level.\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Trade].[SalesOrderFeedstockValues_Summarised_RMA]','U') IS NOT NULL\r\n\t\tDROP TABLE [Trade].[SalesOrderFeedstockValues_Summarised_RMA]\r\n\r\n\tSELECT\t\tCAST(LEFT([Physical Date],10) AS DATE)\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Physical Date]\r\n\t,\t\t\t[Business Unit Name]\r\n\t,\t\t\t[Sales Order Number]\r\n\t,\t\t\t[Item Code]\r\n\t,\t\t\t[Item Name] \r\n\t,\t\t\tso.[Sales Invoice Amount]\r\n\t,\t\t\tSUM(ABS([Biodiesel Quantity Row Level]))\t\t\t\t\t\t\t\t\t\t\t\tAS [Biodiesel Quantity in MT] \r\n\t,\t\t\tMAX(so.[Sales Invoice Amount])/SUM(ABS([Biodiesel Quantity Row Level]))\t\t\t\t\tAS [Biodiesel Price]\r\n\t,\t\t\tSUM(ABS([Feedstock Value]))\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Feedstock Value]\r\n\t,\t\t\tSUM(CASE\r\n\t\t\t\t\t\tWHEN [Purchase Order] IS NULL\r\n\t\t\t\t\t\t\tTHEN 0\r\n\t\t\t\t\t\tELSE [Feedstock Quantity]\r\n\t\t\t\t\tEND)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Feedstock Quantity in MT]\r\n\t,\t\t\tSUM(ABS([Feedstock Value]))/SUM(CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN [Purchase Order] IS NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 0\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tELSE [Feedstock Quantity]\r\n\t\t\t\t\t\t\t\t\t\t\t\tEND)\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Feedstock Price]\r\n\t,\t\t\ty.[Actual Yield]\r\n\t,\t\t\tIIF(so.[Sales Invoice Amount] IS NULL,'1','0') AS [Not Invoiced Flag]\r\n\t,\t\t\tCAST(GETDATE() AS DATE) AS [DateStamp]\r\n\tINTO\t\t[Trade].[SalesOrderFeedstockValues_Summarised_RMA]\r\n\tFROM\t\t[Trade].[SalesOrderFeedstockValues_POLevel_BiodieselQuantity_RMA] t\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Parent Order]\r\n\t\t\t\t\t,\t\t\tSUM(CASE\r\n\t\t\t\t\t\t\t\t\t\tWHEN [Transactional Currency Code] = 'GBP' THEN [Invoice Amount]/[EUR:GBP]\r\n\t\t\t\t\t\t\t\t\t\tWHEN [Transactional Currency Code] = 'USD' THEN [Invoice Amount]/[EUR:USD]\r\n\t\t\t\t\t\t\t\t\t\tELSE [Invoice Amount] \r\n\t\t\t\t\t\t\t\t\tEND) AS [Sales Invoice Amount]\r\n\t\t\t\t\tFROM\t\t[Trade].[SalesOrdersAndInvoices]\r\n\t\t\t\t\tGROUP BY\t[Parent Order]\r\n\t\t\t\t) so\t\t\r\n\tON\t\t\tt.[Sales Order Number] = so.[Parent Order]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Business Unit]\r\n\t\t\t\t\t,\t\t\t[Start date]\r\n\t\t\t\t\t,\t\t\t[End date]\r\n\t\t\t\t\t,\t\t\tAVG(CAST([Expected yield] AS DECIMAL(28,8))) AS [Actual Yield]\r\n\t\t\t\t\tFROM\t\t[Trade].[Yield]\r\n\t\t\t\t\tGROUP BY\t[Business Unit]\r\n\t\t\t\t\t,\t\t\t[Start date]\r\n\t\t\t\t\t,\t\t\t[End date]\r\n\t\t\t\t) y\r\n\tON\t\t\tt.[Business Unit Name] = y.[Business Unit]\r\n\tAND\t\t\tCAST(LEFT([Physical Date],10) AS DATE) BETWEEN CAST(y.[Start date] AS DATE) AND ISNULL(CAST(y.[End date] AS DATE),GETDATE())\r\n\tGROUP BY\tCAST(LEFT([Physical Date],10) AS DATE)\r\n\t,\t\t\t[Business Unit Name]\r\n\t,\t\t\t[Sales Order Number]\r\n\t,\t\t\t[Item Code]\r\n\t,\t\t\t[Item Name] \r\n\t,\t\t\tso.[Sales Invoice Amount]\r\n\t,\t\t\ty.[Actual Yield]\r\n\t,\t\t\tIIF(so.[Sales Invoice Amount] IS NULL,'1','0')\r\n\r\n\r\n\r\n/********************************************************************************************************\r\n\tStep 4.5\tRerun Step 4.1 but with returned orders removed.\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Trade].[POValues]','U') IS NOT NULL\r\n\t\tDROP TABLE [Trade].[POValues]\r\n\r\n\tSELECT\t\t* \r\n\t,\t\t\tCOALESCE([Quantity_21],[Quantity_19],[Quantity_17],[Quantity_15],[Quantity_13],[Quantity_11],[Quantity_9],[Quantity_7],[Quantity_5],[Quantity_3],[Quantity]) * [Price per MT] AS [PO Value]\r\n\tINTO\t\t[Trade].[POValues]\r\n\tFROM\t\t[Trade].[TraceabilityAndOrders]\r\n\tWHERE\t\t[Returned Flag] <> '1'\r\n\r\n/********************************************************************************************************\r\n\tStep 4.6\tRerun Step 4.2 but with returned orders removed.\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Trade].[SalesOrderFeedstockValues_POLevel]','U') IS NOT NULL\r\n\t\tDROP TABLE [Trade].[SalesOrderFeedstockValues_POLevel]\r\n\r\n\tSELECT\t\t[Physical Date]\r\n\t,\t\t\t[Business Unit Name]\r\n\t,\t\t\t[Document Number] AS [Sales Order Number]\r\n\t,\t\t\t[Item Code]\r\n\t,\t\t\t[Item Name]\r\n\t,\t\t\tSUM(DISTINCT ABS([Quantity])) AS [Total Biodiesel Quantity in MT]\r\n\t,\t\t\t[Lot Numbers]\r\n\t,\t\t\t[Parent Order] AS [Purchase Order]\r\n\t,\t\t\t[PO Item Code]\r\n\t,\t\t\t[PO Item Description]\r\n\t,\t\t\t[PO Item Category]\r\n\t,\t\t\t[PO Transaction Date]\r\n\t,\t\t\t[PO Business Unit]\r\n\t,\t\t\tSUM(COALESCE([Quantity_21],[Quantity_19],[Quantity_17],[Quantity_15],[Quantity_13],[Quantity_11],[Quantity_9],[Quantity_7],[Quantity_5],[Quantity_3],[Quantity]))\tAS [PO Quantity Used]\r\n\t,\t\t\tSUM([PO Value]) AS [PO Value Used]\r\n\t,\t\t\tSUM(ABS(ISNULL(([Quantity]/[Quantity_2]),1) * ISNULL(([Quantity_3]/[Quantity_4]),1) * ISNULL(([Quantity_5]/[Quantity_6]),1) * ISNULL(([Quantity_7]/[Quantity_8]),1) * ISNULL(([Quantity_9]/[Quantity_10]),1) \r\n\t\t\t\t\t\t* ISNULL(([Quantity_11]/[Quantity_12]),1) * ISNULL(([Quantity_13]/[Quantity_14]),1) * ISNULL(([Quantity_15]/[Quantity_16]),1) * ISNULL(([Quantity_17]/[Quantity_18]),1) * ISNULL(([Quantity_19]/[Quantity_20]),1) \r\n\t\t\t\t\t\t\t* COALESCE([Quantity_21],[Quantity_19],[Quantity_17],[Quantity_15],[Quantity_13],[Quantity_11],[Quantity_9],[Quantity_7],[Quantity_5],[Quantity_3],[Quantity]))) AS [Feedstock Quantity]\r\n\t,\t\t\tSUM(ABS(ISNULL(([Quantity]/[Quantity_2]),1) * ISNULL(([Quantity_3]/[Quantity_4]),1) * ISNULL(([Quantity_5]/[Quantity_6]),1) * ISNULL(([Quantity_7]/[Quantity_8]),1) * ISNULL(([Quantity_9]/[Quantity_10]),1) \r\n\t\t\t\t\t\t* ISNULL(([Quantity_11]/[Quantity_12]),1) * ISNULL(([Quantity_13]/[Quantity_14]),1) * ISNULL(([Quantity_15]/[Quantity_16]),1) * ISNULL(([Quantity_17]/[Quantity_18]),1) * ISNULL(([Quantity_19]/[Quantity_20]),1) \r\n\t\t\t\t\t\t\t* [PO Value])) AS [Feedstock Value]\r\n\t,\t\t\tCAST(GETDATE() AS DATE) AS [DateStamp]\r\n\tINTO\t\t[Trade].[SalesOrderFeedstockValues_POLevel]\r\n\tFROM\t\t[Trade].[POValues]\r\n\tGROUP BY\t[Physical Date]\r\n\t,\t\t\t[Business Unit Name]\r\n\t,\t\t\t[Document Number]\r\n\t,\t\t\t[Item Code]\r\n\t,\t\t\t[Item Name]\r\n\t,\t\t\t[Lot Numbers]\r\n\t,\t\t\t[Parent Order]\r\n\t,\t\t\t[PO Item Code]\r\n\t,\t\t\t[PO Item Description]\r\n\t,\t\t\t[PO Item Category]\r\n\t,\t\t\t[PO Transaction Date]\r\n\t,\t\t\t[PO Business Unit]\r\n\r\n/********************************************************************************************************\r\n\tStep 4.7\tRerun Step 4.3 but with returned orders removed.\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Trade].[SalesOrderFeedstockValues_POLevel_BiodieselQuantity]','U') IS NOT NULL\r\n\t\tDROP TABLE [Trade].[SalesOrderFeedstockValues_POLevel_BiodieselQuantity]\r\n\r\n\tSELECT\t\tpo.*\r\n\t,\t\t\tABS(MAX([Total Biodiesel Quantity in MT])OVER(PARTITION BY [Sales Order Number], [Lot Numbers], [Total Biodiesel Quantity in MT])/NULLIF(SUM([Feedstock Quantity])OVER(PARTITION BY [Sales Order Number], [Lot Numbers], [Total Biodiesel Quantity in MT]),0)\r\n\t\t\t\t\t* [Feedstock Quantity]) AS [Biodiesel Quantity Row Level]\r\n\t,\t\t\ty.[Actual Yield]\r\n\tINTO\t\t[Trade].[SalesOrderFeedstockValues_POLevel_BiodieselQuantity]\r\n\tFROM\t\t[Trade].[SalesOrderFeedstockValues_POLevel] po\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Business Unit]\r\n\t\t\t\t\t,\t\t\t[Start date]\r\n\t\t\t\t\t,\t\t\t[End date]\r\n\t\t\t\t\t,\t\t\tAVG(CAST([Expected yield] AS DECIMAL(28,8))) AS [Actual Yield]\r\n\t\t\t\t\tFROM\t\t[Trade].[Yield]\r\n\t\t\t\t\tGROUP BY\t[Business Unit]\r\n\t\t\t\t\t,\t\t\t[Start date]\r\n\t\t\t\t\t,\t\t\t[End date]\r\n\t\t\t\t) y\r\n\tON\t\t\tpo.[Business Unit Name] = y.[Business Unit]\r\n\tAND\t\t\tCAST(LEFT([Physical Date],10) AS DATE) BETWEEN CAST(y.[Start date] AS DATE) AND ISNULL(CAST(y.[End date] AS DATE),GETDATE())\r\n\r\n/********************************************************************************************************\r\n\tStep 4.8\tRerun Step 4.4 but with returned orders removed.\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Trade].[SalesOrderFeedstockValues_Summarised_PreRMAAdjustment]','U') IS NOT NULL\r\n\t\tDROP TABLE [Trade].[SalesOrderFeedstockValues_Summarised_PreRMAAdjustment]\r\n\r\n\tSELECT\t\tCAST(LEFT([Physical Date],10) AS DATE)\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Physical Date]\r\n\t,\t\t\t[Business Unit Name]\r\n\t,\t\t\t[Sales Order Number]\r\n\t,\t\t\t[Item Code]\r\n\t,\t\t\t[Item Name] \r\n\t,\t\t\tso.[Sales Invoice Amount]\r\n\t,\t\t\tSUM(ABS([Biodiesel Quantity Row Level]))\t\t\t\t\t\t\t\t\t\t\t\tAS [Biodiesel Quantity in MT] \r\n\t,\t\t\tMAX(so.[Sales Invoice Amount])/SUM(ABS([Biodiesel Quantity Row Level]))\t\t\t\t\tAS [Biodiesel Price]\r\n\t,\t\t\tSUM(ABS([Feedstock Value]))\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Feedstock Value]\r\n\t,\t\t\tSUM(CASE\r\n\t\t\t\t\t\tWHEN [Purchase Order] IS NULL\r\n\t\t\t\t\t\t\tTHEN 0\r\n\t\t\t\t\t\tELSE [Feedstock Quantity]\r\n\t\t\t\t\tEND)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Feedstock Quantity in MT]\r\n\t,\t\t\tSUM(ABS([Feedstock Value]))/SUM(CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN [Purchase Order] IS NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 0\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tELSE [Feedstock Quantity]\r\n\t\t\t\t\t\t\t\t\t\t\t\tEND)\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Feedstock Price]\r\n\t,\t\t\ty.[Actual Yield]\r\n\t,\t\t\tIIF(so.[Sales Invoice Amount] IS NULL,'1','0') AS [Not Invoiced Flag]\r\n\t,\t\t\tCAST(GETDATE() AS DATE) AS [DateStamp]\r\n\tINTO\t\t[Trade].[SalesOrderFeedstockValues_Summarised_PreRMAAdjustment]\r\n\tFROM\t\t[Trade].[SalesOrderFeedstockValues_POLevel_BiodieselQuantity] t\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Parent Order]\r\n\t\t\t\t\t,\t\t\tSUM(CASE\r\n\t\t\t\t\t\t\t\t\t\tWHEN [Transactional Currency Code] = 'GBP' THEN [Invoice Amount]/[EUR:GBP]\r\n\t\t\t\t\t\t\t\t\t\tWHEN [Transactional Currency Code] = 'USD' THEN [Invoice Amount]/[EUR:USD]\r\n\t\t\t\t\t\t\t\t\t\tELSE [Invoice Amount] \r\n\t\t\t\t\t\t\t\t\tEND) AS [Sales Invoice Amount]\r\n\t\t\t\t\tFROM\t\t[Trade].[SalesOrdersAndInvoices]\r\n\t\t\t\t\tGROUP BY\t[Parent Order]\r\n\t\t\t\t) so\t\t\r\n\tON\t\t\tt.[Sales Order Number] = so.[Parent Order]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Business Unit]\r\n\t\t\t\t\t,\t\t\t[Start date]\r\n\t\t\t\t\t,\t\t\t[End date]\r\n\t\t\t\t\t,\t\t\tAVG(CAST([Expected yield] AS DECIMAL(28,8))) AS [Actual Yield]\r\n\t\t\t\t\tFROM\t\t[Trade].[Yield]\r\n\t\t\t\t\tGROUP BY\t[Business Unit]\r\n\t\t\t\t\t,\t\t\t[Start date]\r\n\t\t\t\t\t,\t\t\t[End date]\r\n\t\t\t\t) y\r\n\tON\t\t\tt.[Business Unit Name] = y.[Business Unit]\r\n\tAND\t\t\tCAST(LEFT([Physical Date],10) AS DATE) BETWEEN CAST(y.[Start date] AS DATE) AND ISNULL(CAST(y.[End date] AS DATE),GETDATE())\r\n\tGROUP BY\tCAST(LEFT([Physical Date],10) AS DATE)\r\n\t,\t\t\t[Business Unit Name]\r\n\t,\t\t\t[Sales Order Number]\r\n\t,\t\t\t[Item Code]\r\n\t,\t\t\t[Item Name] \r\n\t,\t\t\tso.[Sales Invoice Amount]\r\n\t,\t\t\ty.[Actual Yield]\r\n\t,\t\t\tIIF(so.[Sales Invoice Amount] IS NULL,'1','0')\r\n\r\n/********************************************************************************************************\r\n\tStep 4.9\tReturned and resold biodiesel batches are linked using an RMA receipt number. This section calculates the \r\n\t\t\t\tfeedstock value on the original order for biodiesel that has returned and been resold.\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Trade].[RMA_Adjustments]','U') IS NOT NULL\r\n\t\tDROP TABLE [Trade].[RMA_Adjustments]\r\n\r\n\tSELECT\t\t* \r\n\tINTO\t\t[Trade].[RMA_Adjustments] \r\n\tFROM\t\t(\r\n\t\t\t\t\tSELECT\t\tt.[Document Number] AS [Sales Order Number]\r\n\t\t\t\t\t,\t\t\tSUM(DISTINCT (t.[Quantity]/oq.[Quantity]) * [Feedstock Value]) AS [RMA Feedstock Value]\r\n\t\t\t\t\t,\t\t\tSUM(DISTINCT (t.[Quantity]/oq.[Quantity]) * [Feedstock Quantity in MT]) AS [RMA Feedstock Quantity]\r\n\t\t\t\t\tFROM\t\t[Trade].[TraceabilityAndOrders] t\r\n\t\t\t\t\tLEFT JOIN\t(\r\n\t\t\t\t\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\t\t\t\t\tWHERE\t\t[Transaction Type] = 'RMA Receipt'\r\n\t\t\t\t\t\t\t\t) rmar\r\n\t\t\t\t\tON\t\t\tCOALESCE(t.[Lot Numbers_19],t.[Lot Numbers_18],t.[Lot Numbers_17],t.[Lot Numbers_16],t.[Lot Numbers_15],t.[Lot Numbers_14],t.[Lot Numbers_13],t.[Lot Numbers_12],t.[Lot Numbers_11],t.[Lot Numbers_10]\r\n\t\t\t\t\t\t\t\t\t\t,t.[Lot Numbers_9],t.[Lot Numbers_8],t.[Lot Numbers_7],t.[Lot Numbers_6],t.[Lot Numbers_5],t.[Lot Numbers_4],t.[Lot Numbers_3],t.[Lot Numbers_2],t.[Lot Numbers]) = rmar.[Lot Numbers]\r\n\t\t\t\t\tLEFT JOIN\t(\r\n\t\t\t\t\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\t\t\t\t\tFROM\t\t[Core].[SalesOrders]\r\n\t\t\t\t\t\t\t\t) so\r\n\t\t\t\t\tON\t\t\tso.[Order Number] = rmar.[Document Number]\r\n\t\t\t\t\tLEFT JOIN\t(\r\n\t\t\t\t\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\t\t\t\t\tFROM\t\t[Core].[SalesOrderDocumentReferences]\r\n\t\t\t\t\t\t\t\t) ddr\r\n\t\t\t\t\tON\t\t\tso.[Header ID] = ddr.[HEADER_ID]\r\n\t\t\t\t\tAND\t\t\tddr.[DOC_REF_TYPE] = 'ORIGINAL_SALES_ORDER'\r\n\t\t\t\t\tLEFT JOIN\t(\r\n\t\t\t\t\t\t\t\t\tSELECT\t\t[Sales Order Number]\r\n\t\t\t\t\t\t\t\t\t,\t\t\t[Feedstock Value]\r\n\t\t\t\t\t\t\t\t\t,\t\t\t[Feedstock Quantity in MT]\r\n\t\t\t\t\t\t\t\t\t,\t\t\t[Biodiesel Quantity in MT]\r\n\t\t\t\t\t\t\t\t\tFROM\t\t[Trade].[SalesOrderFeedstockValues_Summarised_RMA]\r\n\t\t\t\t\t\t\t\t) ocos\r\n\t\t\t\t\tON\t\t\tddr.[DOC_USER_KEY] = ocos.[Sales Order Number]\r\n\t\t\t\t\tLEFT JOIN\t(\r\n\t\t\t\t\t\t\t\t\tSELECT\t\t[Document Number]\r\n\t\t\t\t\t\t\t\t\t,\t\t\tSUM([Quantity]) AS [Quantity]\r\n\t\t\t\t\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Sales Order Issue'\r\n\t\t\t\t\t\t\t\t\tGROUP BY\t[Document Number]\r\n\t\t\t\t\t\t\t\t) oq\r\n\t\t\t\t\tON\t\t\tddr.[DOC_USER_KEY] = oq.[Document Number]\r\n\t\t\t\t\tWHERE\t\tt.[Parent Order] IS NULL\r\n\t\t\t\t\tGROUP BY\tt.[Document Number]\r\n\t\t\t\t) x\r\n\tWHERE\t\t[RMA Feedstock Value] IS NOT NULL\r\n\r\n/********************************************************************************************************\r\n\tStep 4.10\tSummarise [Trade].[SalesOrderFeedstockValues_Summarised_PreRMAAdjustment] at the SO level\r\n\t\t\t\tand include the RMA adjustments so that resold biodiesel has the correct cost of sales value.\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Trade].[SalesOrderFeedstockValues_Summarised]','U') IS NOT NULL\r\n\t\tDROP TABLE [Trade].[SalesOrderFeedstockValues_Summarised]\r\n\r\n\tSELECT\t\t[Physical Date]\r\n\t,\t\t\t[Business Unit Name]\r\n\t,\t\t\tsofv.[Sales Order Number]\r\n\t,\t\t\t[Item Code]\r\n\t,\t\t\t[Item Name]\r\n\t,\t\t\t[Sales Invoice Amount]\r\n\t,\t\t\t[Biodiesel Quantity in MT]\r\n\t,\t\t\t[Biodiesel Price]\r\n\t,\t\t\tISNULL([Feedstock Value],0) + ISNULL([RMA Feedstock Value],0) AS [Feedstock Value]\r\n\t,\t\t\tISNULL([Feedstock Quantity in MT],0) + ISNULL([RMA Feedstock Quantity],0) AS [Feedstock Quantity in MT]\r\n\t,\t\t\tISNULL((ISNULL([Feedstock Value],0) + ISNULL([RMA Feedstock Value],0))/NULLIF((ISNULL([Feedstock Quantity in MT],0) + ISNULL([RMA Feedstock Quantity],0)),0),0) AS [Feedstock Price]\r\n\t,\t\t\t[Actual Yield]\r\n\t,\t\t\t[Not Invoiced Flag]\r\n\t,\t\t\t[DateStamp]\r\n\tINTO\t\t[Trade].[SalesOrderFeedstockValues_Summarised]\r\n\tFROM\t\t[Trade].[SalesOrderFeedstockValues_Summarised_PreRMAAdjustment] sofv\r\n\tLEFT JOIN\t[Trade].[RMA_Adjustments]  rma\r\n\tON\t\t\tsofv.[Sales Order Number] = rma.[Sales Order Number]"
								}
							]
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"folder": {
					"name": "Trade/Margin"
				},
				"annotations": [],
				"lastPublishTime": "2022-11-21T20:07:57Z"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/SQL_Margin_Traceability_Loop')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "Stored procedure1",
						"type": "SqlServerStoredProcedure",
						"dependsOn": [],
						"policy": {
							"timeout": "0.12:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"storedProcedureName": "[[Trade].[SQL_MarginTraceabilityLoop]"
						},
						"linkedServiceName": {
							"referenceName": "SqlServerArgent",
							"type": "LinkedServiceReference"
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"folder": {
					"name": "Trade/Margin"
				},
				"annotations": [],
				"lastPublishTime": "2022-11-21T16:18:47Z"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/SQL_Margin_Traceability_Report_Script')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "Margin Traceability Report Script",
						"type": "Script",
						"dependsOn": [],
						"policy": {
							"timeout": "7.00:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"linkedServiceName": {
							"referenceName": "SqlServerArgent",
							"type": "LinkedServiceReference"
						},
						"typeProperties": {
							"scripts": [
								{
									"type": "NonQuery",
									"text": "/*==============================================================================================================================*\r\n * Project:\t\tArgent\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Purpose:\t\tFind the feedstock items that have been used to create each biodiesel sale\t\t\t\t\t\t\t\t\t\t*\r\n * Description:\t1) Create the traceability table which contains all movements of feedstock/biodiesel and the quantities involved*\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n *\t\t\t\t2) Self join the traceability table multiple times to trace each biodiesel sale back to the feedstock items\t    *\r\n *\t\t\t\t   that have been purchased.\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Prerequisites: Run Core tables script.\t\t\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Outputs: Tables \"Trade.Traceability\", \"Trade.TraceabilityLooped\"\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Date:       29/07/2022\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Version:     1.0\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\t\r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * SQL ATR - Complicated process but made up of basic joins.\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t* \r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n *==============================================================================================================================*\r\n * Updates:\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Date\t\t| Version | Author\t\t| Change made\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * -----------------------------------------------------------------------------------------------------------------------------*\r\n * --/--/-- |  1.-\t  |\t\t\t\t|\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t|\t\t  |\t\t\t\t|\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *==============================================================================================================================*/\r\n/********************************************************************************************************\r\n\tStep 2.1\tCreate traceability table.\r\n\r\n\t\t\t\tThis table is built using [Core].[InventoryTransactions], [Core].[ShippingDetails],\r\n\t\t\t\t[Core].[SalesOrders], [Core].[SalesOrders_Fulfilled], [Core].[Organizations], [Core].[ReceivingTransactions],\r\n\t\t\t\t[Core].[PurchaseOrders], [Core].[InventoryLotNumberTransactions] and [Core].[InventoryLotNumbers].\r\n\r\n\t\t\t\tThe table contains details all movements of inventory items throughout the business. This includes all feedstock items\r\n\t\t\t\tthat have been purchased, the quantity of every feedstock/biodiesel batch that gets created as well as the quantities of\r\n\t\t\t\tthe items used to produce them and also the details of the biodiesel sold.\r\n********************************************************************************************************/\r\n\tIF OBJECT_ID('[Trade].[Traceability]','U') IS NOT NULL\r\n\t\tDROP TABLE [Trade].[Traceability]\r\n\r\n\tSELECT\t\to.[Business Unit Name]\r\n\t,\t\t\tit.[SUBINVENTORY_CODE]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Subinventory]\r\n\t,\t\t\tCOALESCE(\r\n\t\t\t\t\t\t\tLEFT(it.[ATTRIBUTE_TIMESTAMP1],10)\r\n\t\t\t\t\t\t,\tLEFT(rt.[ATTRIBUTE_TIMESTAMP2],10)\r\n\t\t\t\t\t\t,\tCASE\r\n\t\t\t\t\t\t\t\tWHEN so.[Comments] LIKE '%Time Off Site%'\r\n\t\t\t\t\t\t\t\t\tTHEN \r\n\t\t\t\t\t\t\t\t\t\tCONCAT(\r\n\t\t\t\t\t\t\t\t\t\t\tRIGHT(SUBSTRING(so.[Comments],CHARINDEX('Time Off Site',so.[Comments])+14,10),4)\r\n\t\t\t\t\t\t\t\t\t\t,\tSUBSTRING(SUBSTRING(so.[Comments],CHARINDEX('Time Off Site',so.[Comments])+14,10),3,4)\r\n\t\t\t\t\t\t\t\t\t\t,\tLEFT(SUBSTRING(so.[Comments],CHARINDEX('Time Off Site',so.[Comments])+14,10),2)\r\n\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\tELSE so.[Schedule Ship Date]\r\n\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\t,\tLEFT(sof.[REQUEST_SHIP_DATE],10)\r\n\t\t\t\t\t\t,\tLEFT(it.[TRANSACTION_DATE],10)\r\n\t\t\t\t\t\t)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Physical Date]\r\n\t,\t\t\tCOALESCE(\r\n\t\t\t\t\t\t\tpo.[Purchase Order Number]\r\n\t\t\t\t\t\t,\tso.[Order Number]\r\n\t\t\t\t\t\t,\tit.[TRANSACTION_SOURCE_NAME]\r\n\t\t\t\t\t\t,\tit.[TRANSACTION_REFERENCE]\t\r\n\t\t\t\t\t\t,\trsh.[RA_DOCUMENT_NUMBER]\r\n\t\t\t\t\t\t)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Document Number]\r\n\t,\t\t\tit.[TRANSACTION_TYPE_NAME]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Transaction Type]\r\n\t,\t\t\ti.[Item Code]\r\n\t,\t\t\ti.[Item Name]\r\n\t,\t\t\ti.[Unit of Measure]\t\t\t\t\t\t\t\t\t\t\t\r\n\t,\t\t\tCAST(ilnt.[PRIMARY_QUANTITY] AS NUMERIC(28,8))\t\t\t\t\t\t\t\t\t\t\tAS [Quantity]\r\n\t,\t\t\tit.[TRANSFER_SUBINVENTORY]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Transfer Subinventory]\r\n\t,\t\t\tilnt.[LOT_NUMBER]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Lot Numbers]\r\n\t,\t\t\tit.[TRANSACTION_ID]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Transaction ID]\r\n\t,\t\t\tit.[CREATION_DATE]\r\n\t,\t\t\tit.[TRANSACTION_DATE]\r\n\t,\t\t\tsd.[SOURCE_HEADER_NUMBER]\r\n\t,\t\t\tsd.[SOURCE_LINE_NUMBER]\r\n\t,\t\t\tCAST(GETDATE() AS DATE)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [DateStamp]\r\n\tINTO\t\t[Trade].[Traceability]\r\n\tFROM\t\t[Core].[InventoryTransactions] it\r\n\tLEFT JOIN\t[Core].[ShippingDetails] sd\r\n\tON\t\t\tit.[TRX_SOURCE_LINE_ID] = sd.[DELIVERY_DETAIL_ID]\r\n\tAND\t\t\tit.[TRANSACTION_SOURCE_TYPE_ID] = '2'\t\t\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Header ID]\r\n\t\t\t\t\t,\t\t\t[Order Number]\r\n\t\t\t\t\t,\t\t\t[Comments]\r\n\t\t\t\t\t,\t\t\tMAX([Schedule Ship Date]) AS [Schedule Ship Date]\r\n\t\t\t\t\t,\t\t\t[Submitted Flag]\r\n\t\t\t\t\tFROM\t\t[Core].[SalesOrders]\r\n\t\t\t\t\tGROUP BY\t[Header ID]\r\n\t\t\t\t\t,\t\t\t[Order Number]\r\n\t\t\t\t\t,\t\t\t[Comments]\r\n\t\t\t\t\t,\t\t\t[Submitted Flag]\r\n\t\t\t\t) so\r\n\tON\t\t\tso.[Order Number] = sd.[SOURCE_HEADER_NUMBER]\r\n\tAND\t\t\tso.[Submitted Flag] = 'Y'\t\r\n\tLEFT JOIN\t[Core].[SalesOrders_Fulfilled] sof\r\n\tON\t\t\tso.[Header ID] = sof.[HEADER_ID]\r\n\tAND\t\t\tsof.[FULFILL_LINE_ID] = sd.[SOURCE_SHIPMENT_ID]\r\n\tLEFT JOIN\t[Core].[Organizations] o\r\n\tON\t\t\to.[Organization ID] = it.[ORGANIZATION_ID]\r\n\tLEFT JOIN\t[Core].[Items] i\r\n\tON\t\t\ti.[Inventory Item ID] = it.[INVENTORY_ITEM_ID]\r\n\tAND\t\t\ti.[Organization ID] = it.[ORGANIZATION_ID]\r\n\tLEFT JOIN\t[Core].[ReceivingTransactions] rt\r\n\tON\t\t\trt.[Transaction ID] = it.[RCV_TRANSACTION_ID]\r\n\tLEFT JOIN\t[Core].[ReceivingShipmentHeaders] rsh\r\n\tON\t\t\trt.[Receipt Advice Header ID] = rsh.[SHIPMENT_HEADER_ID]\r\n    AND\t\t\trt.[Source Document Code] = 'RMA'\r\n    AND\t\t\trt.[Transaction Type] = 'DELIVER'\r\n\tLEFT JOIN\t[Core].[PurchaseOrders] po\r\n\tON\t\t\tpo.[PO Header ID] = rt.[PO Header ID]\r\n\tAND\t\t\tpo.[PO Line ID] = rt.[PO Line ID]\r\n\tLEFT JOIN\t[Core].[InventoryLotNumberTransactions] ilnt\r\n\tON\t\t\tilnt.[TRANSACTION_ID] = it.[TRANSACTION_ID]\r\n\tLEFT JOIN\t[Core].[InventoryLotNumbers] iln\r\n\tON\t\t\tiln.[LOT_NUMBER] = ilnt.[LOT_NUMBER]\r\n\tAND\t\t\tiln.[ORGANIZATION_ID] = o.[Organization ID]\r\n\tAND\t\t\tiln.[LOT_ATTRIBUTE_CATEGORY] IN ('Biodiesel','AENL Weigh Bridge')\r\n\tWHERE\t\to.[Business Unit Name] IN ('BDA BU','Motherwell','Stanlow')\r\n\tAND\t\t\to.[Inventory Organization Code] IN ('BDA','MBDR','MBLD''MCOM','MPTP','SBDR','SBLD','SCOM','SPOP','SPTP')\r\n\tAND\t\t\tLEFT(it.[TRANSACTION_DATE],10) >= '2021-01-01'\r\n\r\n/********************************************************************************************************\r\n\tStep 2.2\tFind the feedstock items that feed into each biodiesel batch.\r\n\r\n\t\t\t\tThis table is built by left joining [Trade].[Traceability] onto itself multiple times.\r\n********************************************************************************************************/\r\n\r\n\r\n\tIF OBJECT_ID('[Trade].[TraceabilityLooped]','U') IS NOT NULL\r\n\t\tDROP TABLE [Trade].[TraceabilityLooped]\r\n\r\n\tSELECT\t\tt1.[Physical Date]\r\n\t,\t\t\tt1.[CREATION_DATE]\r\n\t,\t\t\tt1.[Business Unit Name]\r\n\t,\t\t\tt1.[Document Number]\r\n\t,\t\t\tt1.[Transaction Type]\r\n\t,\t\t\tt1.[Item Code]\r\n\t,\t\t\tt1.[Item Name]\r\n\t,\t\t\tt1.[Unit of Measure]\r\n\t,\t\t\tCASE WHEN t1.[Unit of Measure] = 'LTR' THEN t1.[Quantity] * 0.0008745 ELSE t1.[Quantity] END AS [Quantity]\r\n\t,\t\t\tt1.[SOURCE_HEADER_NUMBER]\t\t\r\n\t,\t\t\tt1.[SOURCE_LINE_NUMBER]\r\n\t,\t\t\tt1.[Lot Numbers]\r\n\t,\t\t\tt2.[Document Number]\t\t\t\tAS [Document Number_2]\t\t\t\r\n\t,\t\t\tt2.[Transaction Type]\t\t\t\tAS [Transaction Type_2]\t\t\t\r\n\t,\t\t\tt2.[Item Code]\t\t\t\t\t\tAS [Item Code_2]\t\t\t\t\r\n\t,\t\t\tt2.[Item Name]\t\t\t\t\t\tAS [Item Name_2]\t\r\n\t,\t\t\tt2.[Unit of Measure]\t\t\t\tAS [Unit of Measure_2]\t\t\r\n\t,\t\t\tCASE WHEN t2.[Unit of Measure] = 'LTR' THEN t2.[Quantity] * 0.0008745 ELSE t2.[Quantity] END\t\t\t\t\t\tAS [Quantity_2]\t\t\t\t\t\r\n\t,\t\t\tt2.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_2]\t\t\t\r\n\t,\t\t\tt3.[Document Number] \t\t\t\tAS [Document Number_3] \t\t\t\r\n\t,\t\t\tt3.[Transaction Type]\t\t\t\tAS [Transaction Type_3]\t\t\t\r\n\t,\t\t\tt3.[Item Code]\t\t\t\t\t\tAS [Item Code_3]\t\t\t\t\r\n\t,\t\t\tt3.[Item Name]\t\t\t\t\t\tAS [Item Name_3]\t\r\n\t,\t\t\tt3.[Unit of Measure]\t\t\t\tAS [Unit of Measure_3]\t\t\t\t\r\n\t,\t\t\tCASE WHEN t3.[Unit of Measure] = 'LTR' THEN t3.[Quantity] * 0.0008745 ELSE t3.[Quantity] END\t\t\t\t\t\tAS [Quantity_3]\t\t\t\t\t\r\n\t,\t\t\tt3.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_3]\t\t\t\t\r\n\t,\t\t\tt4.[Document Number] \t\t\t\tAS [Document Number_4] \t\t\t\r\n\t,\t\t\tt4.[Transaction Type]\t\t\t\tAS [Transaction Type_4]\t\t\t\r\n\t,\t\t\tt4.[Item Code]\t\t\t\t\t\tAS [Item Code_4]\t\t\t\t\r\n\t,\t\t\tt4.[Item Name]\t\t\t\t\t\tAS [Item Name_4]\t\t\r\n\t,\t\t\tt4.[Unit of Measure]\t\t\t\tAS [Unit of Measure_4]\t\t\r\n\t,\t\t\tCASE WHEN t4.[Unit of Measure] = 'LTR' THEN t4.[Quantity] * 0.0008745 ELSE t4.[Quantity] END\t\t\t\t\t\tAS [Quantity_4]\t\t\t\t\t\r\n\t,\t\t\tt4.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_4]\t\t\t\t\r\n\t,\t\t\tt5.[Document Number] \t\t\t\tAS [Document Number_5] \t\t\t\r\n\t,\t\t\tt5.[Transaction Type]\t\t\t\tAS [Transaction Type_5]\t\t\t\r\n\t,\t\t\tt5.[Item Code]\t\t\t\t\t\tAS [Item Code_5]\t\t\t\t\r\n\t,\t\t\tt5.[Item Name]\t\t\t\t\t\tAS [Item Name_5]\r\n\t,\t\t\tt5.[Unit of Measure]\t\t\t\tAS [Unit of Measure_5]\t\t\t\t\t\r\n\t,\t\t\tCASE WHEN t5.[Unit of Measure] = 'LTR' THEN t5.[Quantity] * 0.0008745 ELSE t5.[Quantity] END\t\t\t\t\t\tAS [Quantity_5]\t\t\t\t\t\r\n\t,\t\t\tt5.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_5]\t\t\t\r\n\t,\t\t\tt6.[Document Number] \t\t\t\tAS [Document Number_6] \t\t\t\r\n\t,\t\t\tt6.[Transaction Type]\t\t\t\tAS [Transaction Type_6]\t\t\t\r\n\t,\t\t\tt6.[Item Code]\t\t\t\t\t\tAS [Item Code_6]\t\t\t\t\r\n\t,\t\t\tt6.[Item Name]\t\t\t\t\t\tAS [Item Name_6]\t\r\n\t,\t\t\tt6.[Unit of Measure]\t\t\t\tAS [Unit of Measure_6]\t\t\t\r\n\t,\t\t\tCASE WHEN t6.[Unit of Measure] = 'LTR' THEN t6.[Quantity] * 0.0008745 ELSE t6.[Quantity] END\t\t\t\t\t\tAS [Quantity_6]\t\t\t\t\t\r\n\t,\t\t\tt6.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_6]\t\r\n\t,\t\t\tt7.[Document Number] \t\t\t\tAS [Document Number_7] \t\t\t\r\n\t,\t\t\tt7.[Transaction Type]\t\t\t\tAS [Transaction Type_7]\t\t\t\r\n\t,\t\t\tt7.[Item Code]\t\t\t\t\t\tAS [Item Code_7]\t\t\t\t\r\n\t,\t\t\tt7.[Item Name]\t\t\t\t\t\tAS [Item Name_7]\t\r\n\t,\t\t\tt7.[Unit of Measure]\t\t\t\tAS [Unit of Measure_7]\t\t\t\t\r\n\t,\t\t\tCASE WHEN t7.[Unit of Measure] = 'LTR' THEN t7.[Quantity] * 0.0008745 ELSE t7.[Quantity] END\t\t\t\t\t\tAS [Quantity_7]\t\t\t\t\t\r\n\t,\t\t\tt7.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_7]\r\n\t,\t\t\tt8.[Document Number] \t\t\t\tAS [Document Number_8] \t\t\t\r\n\t,\t\t\tt8.[Transaction Type]\t\t\t\tAS [Transaction Type_8]\t\t\t\r\n\t,\t\t\tt8.[Item Code]\t\t\t\t\t\tAS [Item Code_8]\t\t\t\t\r\n\t,\t\t\tt8.[Item Name]\t\t\t\t\t\tAS [Item Name_8]\t\r\n\t,\t\t\tt8.[Unit of Measure]\t\t\t\tAS [Unit of Measure_8]\t\t\t\t\r\n\t,\t\t\tCASE WHEN t8.[Unit of Measure] = 'LTR' THEN t8.[Quantity] * 0.0008745 ELSE t8.[Quantity] END\t\t\t\t\tAS [Quantity_8]\t\t\t\t\t\r\n\t,\t\t\tt8.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_8]\t\t\t\r\n\t,\t\t\tt9.[Document Number] \t\t\t\tAS [Document Number_9] \t\t\t\r\n\t,\t\t\tt9.[Transaction Type]\t\t\t\tAS [Transaction Type_9]\t\t\t\r\n\t,\t\t\tt9.[Item Code]\t\t\t\t\t\tAS [Item Code_9]\t\t\t\t\r\n\t,\t\t\tt9.[Item Name]\t\t\t\t\t\tAS [Item Name_9]\t\r\n\t,\t\t\tt9.[Unit of Measure]\t\t\t\tAS [Unit of Measure_9]\t\t\t\t\r\n\t,\t\t\tCASE WHEN t9.[Unit of Measure] = 'LTR' THEN t9.[Quantity] * 0.0008745 ELSE t9.[Quantity] END\t\t\t\t\tAS [Quantity_9]\t\t\t\t\t\r\n\t,\t\t\tt9.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_9]\t\t\t\r\n\t,\t\t\tt10.[Document Number] \t\t\t\tAS [Document Number_10] \t\t\t\r\n\t,\t\t\tt10.[Transaction Type]\t\t\t\tAS [Transaction Type_10]\t\t\t\r\n\t,\t\t\tt10.[Item Code]\t\t\t\t\t\tAS [Item Code_10]\t\t\t\t\r\n\t,\t\t\tt10.[Item Name]\t\t\t\t\t\tAS [Item Name_10]\t\r\n\t,\t\t\tt10.[Unit of Measure]\t\t\t\tAS [Unit of Measure_10]\t\t\t\t\r\n\t,\t\t\tCASE WHEN t10.[Unit of Measure] = 'LTR' THEN t10.[Quantity] * 0.0008745 ELSE t10.[Quantity] END\t\t\t\t\tAS [Quantity_10]\t\t\t\t\t\r\n\t,\t\t\tt10.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_10]\t\r\n\t,\t\t\tt11.[Document Number]\t\t\t\tAS [Document Number_11] \t\r\n\t,\t\t\tt11.[Transaction Type]\t\t\t\tAS [Transaction Type_11]\t\r\n\t,\t\t\tt11.[Item Code]\t\t\t\t\t\tAS [Item Code_11]\t\t\t\r\n\t,\t\t\tt11.[Item Name]\t\t\t\t\t\tAS [Item Name_11]\t\t\r\n\t,\t\t\tt11.[Unit of Measure]\t\t\t\tAS [Unit of Measure_11]\t\t\r\n\t,\t\t\tCASE WHEN t11.[Unit of Measure] = 'LTR' THEN t11.[Quantity] * 0.0008745 ELSE t11.[Quantity] END\t\t\t\t\tAS [Quantity_11]\t\t\t\r\n\t,\t\t\tt11.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_11]\t\t\r\n\t,\t\t\tt12.[Document Number]\t\t\t\tAS [Document Number_12]\t\t\t\r\n\t,\t\t\tt12.[Transaction Type]\t\t\t\tAS [Transaction Type_12]\t\t\t\r\n\t,\t\t\tt12.[Item Code]\t\t\t\t\t\tAS [Item Code_12]\t\t\t\t\r\n\t,\t\t\tt12.[Item Name]\t\t\t\t\t\tAS [Item Name_12]\t\t\r\n\t,\t\t\tt12.[Unit of Measure]\t\t\t\tAS [Unit of Measure_12]\t\t\t\r\n\t,\t\t\tCASE WHEN t12.[Unit of Measure] = 'LTR' THEN t12.[Quantity] * 0.0008745 ELSE t12.[Quantity] END\t\t\t\t\tAS [Quantity_12]\t\t\t\t\t\r\n\t,\t\t\tt12.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_12]\t\t\t\r\n\t,\t\t\tt13.[Document Number] \t\t\t\tAS [Document Number_13] \t\t\t\r\n\t,\t\t\tt13.[Transaction Type]\t\t\t\tAS [Transaction Type_13]\t\t\t\r\n\t,\t\t\tt13.[Item Code]\t\t\t\t\t\tAS [Item Code_13]\t\t\t\t\r\n\t,\t\t\tt13.[Item Name]\t\t\t\t\t\tAS [Item Name_13]\t\t\r\n\t,\t\t\tt13.[Unit of Measure]\t\t\t\tAS [Unit of Measure_13]\t\t\t\r\n\t,\t\t\tCASE WHEN t13.[Unit of Measure] = 'LTR' THEN t13.[Quantity] * 0.0008745 ELSE t13.[Quantity] END\t\t\t\t\tAS [Quantity_13]\t\t\t\t\t\r\n\t,\t\t\tt13.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_13]\t\t\t\t\r\n\t,\t\t\tt14.[Document Number] \t\t\t\tAS [Document Number_14] \t\t\t\r\n\t,\t\t\tt14.[Transaction Type]\t\t\t\tAS [Transaction Type_14]\t\t\t\r\n\t,\t\t\tt14.[Item Code]\t\t\t\t\t\tAS [Item Code_14]\t\t\t\t\r\n\t,\t\t\tt14.[Item Name]\t\t\t\t\t\tAS [Item Name_14]\t\t\r\n\t,\t\t\tt14.[Unit of Measure]\t\t\t\tAS [Unit of Measure_14]\t\t\t\t\r\n\t,\t\t\tCASE WHEN t14.[Unit of Measure] = 'LTR' THEN t14.[Quantity] * 0.0008745 ELSE t14.[Quantity] END\t\t\t\t\tAS [Quantity_14]\t\t\t\t\t\r\n\t,\t\t\tt14.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_14]\t\t\t\t\r\n\t,\t\t\tt15.[Document Number] \t\t\t\tAS [Document Number_15] \t\t\t\r\n\t,\t\t\tt15.[Transaction Type]\t\t\t\tAS [Transaction Type_15]\t\t\t\r\n\t,\t\t\tt15.[Item Code]\t\t\t\t\t\tAS [Item Code_15]\t\t\t\t\r\n\t,\t\t\tt15.[Item Name]\t\t\t\t\t\tAS [Item Name_15]\t\t\r\n\t,\t\t\tt15.[Unit of Measure]\t\t\t\tAS [Unit of Measure_15]\t\t\t\r\n\t,\t\t\tCASE WHEN t15.[Unit of Measure] = 'LTR' THEN t15.[Quantity] * 0.0008745 ELSE t15.[Quantity] END\t\t\t\t\tAS [Quantity_15]\t\t\t\t\t\r\n\t,\t\t\tt15.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_15]\t\t\t\r\n\t,\t\t\tt16.[Document Number] \t\t\t\tAS [Document Number_16] \t\t\t\r\n\t,\t\t\tt16.[Transaction Type]\t\t\t\tAS [Transaction Type_16]\t\t\t\r\n\t,\t\t\tt16.[Item Code]\t\t\t\t\t\tAS [Item Code_16]\t\t\t\t\r\n\t,\t\t\tt16.[Item Name]\t\t\t\t\t\tAS [Item Name_16]\t\r\n\t,\t\t\tt16.[Unit of Measure]\t\t\t\tAS [Unit of Measure_16]\t\t\t\t\r\n\t,\t\t\tCASE WHEN t16.[Unit of Measure] = 'LTR' THEN t16.[Quantity] * 0.0008745 ELSE t16.[Quantity] END\t\t\t\t\tAS [Quantity_16]\t\t\t\t\t\r\n\t,\t\t\tt16.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_16]\t\r\n\t,\t\t\tt17.[Document Number] \t\t\t\tAS [Document Number_17] \t\t\t\r\n\t,\t\t\tt17.[Transaction Type]\t\t\t\tAS [Transaction Type_17]\t\t\t\r\n\t,\t\t\tt17.[Item Code]\t\t\t\t\t\tAS [Item Code_17]\t\t\t\t\r\n\t,\t\t\tt17.[Item Name]\t\t\t\t\t\tAS [Item Name_17]\t\t\r\n\t,\t\t\tt17.[Unit of Measure]\t\t\t\tAS [Unit of Measure_17]\t\t\t\r\n\t,\t\t\tCASE WHEN t17.[Unit of Measure] = 'LTR' THEN t17.[Quantity] * 0.0008745 ELSE t17.[Quantity] END\t\t\t\t\tAS [Quantity_17]\t\t\t\t\t\r\n\t,\t\t\tt17.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_17]\t\r\n\t,\t\t\tt18.[Document Number] \t\t\t\tAS [Document Number_18] \t\t\t\r\n\t,\t\t\tt18.[Transaction Type]\t\t\t\tAS [Transaction Type_18]\t\t\t\r\n\t,\t\t\tt18.[Item Code]\t\t\t\t\t\tAS [Item Code_18]\t\t\t\t\r\n\t,\t\t\tt18.[Item Name]\t\t\t\t\t\tAS [Item Name_18]\t\r\n\t,\t\t\tt18.[Unit of Measure]\t\t\t\tAS [Unit of Measure_18]\t\t\t\t\t\r\n\t,\t\t\tCASE WHEN t18.[Unit of Measure] = 'LTR' THEN t18.[Quantity] * 0.0008745 ELSE t18.[Quantity] END\t\t\t\t\tAS [Quantity_18]\t\t\t\t\t\r\n\t,\t\t\tt18.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_18]\t\t\r\n\t,\t\t\tt19.[Document Number] \t\t\t\tAS [Document Number_19] \t\t\t\r\n\t,\t\t\tt19.[Transaction Type]\t\t\t\tAS [Transaction Type_19]\t\t\t\r\n\t,\t\t\tt19.[Item Code]\t\t\t\t\t\tAS [Item Code_19]\t\t\t\t\r\n\t,\t\t\tt19.[Item Name]\t\t\t\t\t\tAS [Item Name_19]\t\t\r\n\t,\t\t\tt19.[Unit of Measure]\t\t\t\tAS [Unit of Measure_19]\t\t\t\r\n\t,\t\t\tCASE WHEN t19.[Unit of Measure] = 'LTR' THEN t19.[Quantity] * 0.0008745 ELSE t19.[Quantity] END\t\t\t\t\t\tAS [Quantity_19]\t\t\t\t\t\r\n\t,\t\t\tt19.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_19]\t\t\r\n\t,\t\t\tt20.[Document Number] \t\t\t\tAS [Document Number_20] \t\t\t\r\n\t,\t\t\tt20.[Transaction Type]\t\t\t\tAS [Transaction Type_20]\t\t\t\r\n\t,\t\t\tt20.[Item Code]\t\t\t\t\t\tAS [Item Code_20]\t\t\t\t\r\n\t,\t\t\tt20.[Item Name]\t\t\t\t\t\tAS [Item Name_20]\t\r\n\t,\t\t\tt20.[Unit of Measure]\t\t\t\tAS [Unit of Measure_20]\t\t\t\t\r\n\t,\t\t\tCASE WHEN t20.[Unit of Measure] = 'LTR' THEN t20.[Quantity] * 0.0008745 ELSE t20.[Quantity] END\t\t\t\t\t\tAS [Quantity_20]\t\t\t\t\t\r\n\t,\t\t\tt20.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_20]\t\r\n\t,\t\t\tt21.[Document Number] \t\t\t\tAS [Document Number_21] \t\t\t\r\n\t,\t\t\tt21.[Transaction Type]\t\t\t\tAS [Transaction Type_21]\t\t\t\r\n\t,\t\t\tt21.[Item Code]\t\t\t\t\t\tAS [Item Code_21]\t\t\t\t\r\n\t,\t\t\tt21.[Item Name]\t\t\t\t\t\tAS [Item Name_21]\t\r\n\t,\t\t\tt21.[Unit of Measure]\t\t\t\tAS [Unit of Measure_21]\t\t\t\t\r\n\t,\t\t\tCASE WHEN t21.[Unit of Measure] = 'LTR' THEN t21.[Quantity] * 0.0008745 ELSE t21.[Quantity] END\t\t\t\t\t\tAS [Quantity_21]\t\t\t\t\t\r\n\t,\t\t\tt21.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_21]\t\r\n\t,\t\t\tCAST(GETDATE() AS DATE)\t\t\t\tAS [DateStamp]\r\n\tINTO\t\t[Trade].[TraceabilityLooped]\r\n\tFROM\t\t[Trade].[Traceability] t1\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Product Completion'\r\n\t\t\t\t\tAND\t\t\t[Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t) t2\r\n\tON\t\t\tt1.[Lot Numbers] = t2.[Lot Numbers]\r\n\tAND\t\t\tt1.[Item Code] = t2.[Item Code]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Material Issue'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t3\r\n\tON\t\t\tt2.[Document Number] = t3.[Document Number]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Product Completion'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t4\r\n\tON\t\t\tt3.[Lot Numbers] = t4.[Lot Numbers]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Material Issue'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t5\r\n\tON\t\t\tt4.[Document Number] = t5.[Document Number]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Product Completion'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t6\r\n\tON\t\t\tt5.[Lot Numbers] = t6.[Lot Numbers]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Material Issue'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t7\r\n\tON\t\t\tt6.[Document Number] = t7.[Document Number]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Product Completion'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t8\r\n\tON\t\t\tt7.[Lot Numbers] = t8.[Lot Numbers]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Material Issue'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t9\r\n\tON\t\t\tt8.[Document Number] = t9.[Document Number]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Product Completion'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t10\r\n\tON\t\t\tt9.[Lot Numbers] = t10.[Lot Numbers]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Material Issue'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t11\r\n\tON\t\t\tt10.[Document Number] = t11.[Document Number]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Product Completion'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t12\r\n\tON\t\t\tt11.[Lot Numbers] = t12.[Lot Numbers]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Material Issue'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t13\r\n\tON\t\t\tt12.[Document Number] = t13.[Document Number]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Product Completion'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t14\r\n\tON\t\t\tt13.[Lot Numbers] = t14.[Lot Numbers]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Material Issue'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t15\r\n\tON\t\t\tt14.[Document Number] = t15.[Document Number]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Product Completion'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t16\r\n\tON\t\t\tt15.[Lot Numbers] = t16.[Lot Numbers]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Material Issue'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t17\r\n\tON\t\t\tt16.[Document Number] = t17.[Document Number]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Product Completion'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t18\r\n\tON\t\t\tt17.[Lot Numbers] = t18.[Lot Numbers]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Material Issue'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t19\r\n\tON\t\t\tt18.[Document Number] = t19.[Document Number]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Product Completion'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t20\r\n\tON\t\t\tt19.[Lot Numbers] = t20.[Lot Numbers]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Material Issue'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t21\r\n\tON\t\t\tt20.[Document Number] = t21.[Document Number]\r\n\tWHERE\t\tt1.[Transaction Type] = 'Sales Order Issue'\r\n\tAND\t\t\tt1.[Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')"
								}
							]
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"folder": {
					"name": "Trade/Margin"
				},
				"annotations": [],
				"lastPublishTime": "2022-11-21T20:07:57Z"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/SQL_Pricing_Data_Marks_Script')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "Pricing Data Marks Script",
						"type": "Script",
						"dependsOn": [],
						"policy": {
							"timeout": "7.00:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"linkedServiceName": {
							"referenceName": "SqlServerArgent",
							"type": "LinkedServiceReference"
						},
						"typeProperties": {
							"scripts": [
								{
									"type": "NonQuery",
									"text": "/********************************************************************************************************\r\n\t1.1 Update the raw tables with the current day's data, pulled from the data warehouse.\r\n********************************************************************************************************/\r\n\r\n\tDECLARE @DeleteTableStatement NVARCHAR(MAX)\r\n\tDECLARE Cur2 CURSOR READ_ONLY\r\n\tFOR\r\n\t\t\tSELECT  'Delete from [RAW].[' + TABLE_NAME + ']  where stamp <> (select distinct max(stamp) from [RAW].[' + TABLE_NAME + '])'\r\n\t\t\tFROM    INFORMATION_SCHEMA.TABLES\r\n\t\t\tWHERE   TABLE_SCHEMA = 'RAW'\r\n\t\t\t\t\tAND TABLE_TYPE = 'BASE TABLE' and TABLE_NAME like 'RAW.P.%'\r\n\r\n\r\n\tOPEN Cur2\r\n\tFETCH NEXT FROM Cur2 INTO @DeleteTableStatement\r\n\tWHILE @@FETCH_STATUS = 0\r\n\t\t  BEGIN\r\n\t\t\t\tPRINT 'Executing ' + @DeleteTableStatement\r\n\t\t\t\tEXECUTE sp_executesql @DeleteTableStatement\r\n\t\t\t\tFETCH NEXT FROM Cur2 INTO @DeleteTableStatement\r\n\t\t  END\r\n\tCLOSE Cur2\r\n\tDEALLOCATE Cur2\r\n\r\n/***************************************************\r\nDrop list of dates*/\r\n\r\nIF OBJECT_ID('[RAW].[DateList]','U') IS NOT NULL \r\n\t\tDROP TABLE [RAW].[DateList]\r\n\r\n/***************************************************\r\nDeclare variables to produce list of dates*/\r\n\r\n-- prevent set or regional settings from interfering with \r\n-- interpretation of dates / literals\r\nSET DATEFIRST  1, -- 1 = Monday, 7 = Sunday\r\n    DATEFORMAT mdy, \r\n    LANGUAGE   BRITISH;\r\n-- assume the above is here in all subsequent code blocks.\r\n\r\n--DECLARE @StartDate  date = '20190101';\r\n\r\n--DECLARE @CutoffDate date = DATEADD(DAY, -1, DATEADD(YEAR, 4, @StartDate));\r\n\r\nDECLARE @StartDate  date = '20181211';\r\n\r\nDECLARE @CutoffDate date =\t(\r\n\t\t\t\t\t\t\t\tSELECT\tMAX([Date])\r\n\t\t\t\t\t\t\t\tFROM\t(\r\n\t\t\t\t\t\t\t\t\t\t\tSELECT CAST([Date] AS DATE) AS [Date] FROM [RAW].[RAW.P.Argus Pricing]\r\n\t\t\t\t\t\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\t\t\t\t\t\tSELECT CAST([Date] AS DATE) AS [Date] FROM [RAW].[RAW.P.Reuters MGO Pricing]\r\n\t\t\t\t\t\t\t\t\t\t\tUNION ALL\r\n\t\t\t\t\t\t\t\t\t\t\tSELECT CAST([Date] AS DATE) AS [Date] FROM [RAW].[RAW.P.Reuters Pricing]\r\n\t\t\t\t\t\t\t\t\t\t)d\r\n\t\t\t\t\t\t\t);\r\n\r\n/***************************************************\r\nCreate list of dates and insert into table*/\r\n\r\n;WITH seq(n) AS \r\n(\r\n  SELECT 0 UNION ALL SELECT n + 1 FROM seq\r\n  WHERE n < DATEDIFF(DAY, @StartDate, @CutoffDate)\r\n),\r\nd([Date]) AS \r\n(\r\n  SELECT DATEADD(DAY, n, @StartDate) FROM seq\r\n)\r\nSELECT [Date] \r\nINTO [RAW].[DateList]\r\nFROM d\r\nORDER BY [Date]\r\nOPTION (MAXRECURSION 0);\r\n\r\n--1461\r\n\r\n/***************************************************\r\nJoin Pricing table to DateList on a 1=1 basis*/\r\n\r\nIF OBJECT_ID('[Core].[PreJoinArgusPricing]','U') IS NOT NULL \r\n\t\tDROP TABLE [Core].[PreJoinArgusPricing]\r\n\r\nSELECT * \r\nINTO [Core].[PreJoinArgusPricing]\r\nFROM [RAW].[DateList]\r\nLEFT JOIN  (SELECT DISTINCT\tCAST([Description] AS NVARCHAR(250)) AS [Description]\r\n\t\t\t\t\t\t\t,[Contract/Delivery]\r\n\t\t\t\t\t\t\t,[Time Stamp]\r\n\t\t\t\t\t\t\t,[Price Type]\r\n\t\t\t\t\t\t\t,[Currency/Unit]\r\n\t\t\t\t\t\t\t,[Delivery Mode]\r\n\t\t\t\t\t\t\t,[Fill Type]\t\r\n\t\t\t\t\t\t\t, 'Argus' AS [Source]\t\t\r\n\t\t\tFROM [RAW].[RAW.P.Argus Pricing]) REF\r\nON 1=1\r\n\r\nUNION ALL\r\n\r\nSELECT\t\tdl.[Date] AS [Date]\r\n,\t\t\t[Description] AS [Description]\r\n,\t\t\t'' AS [Contract/Delivery]\r\n,\t\t\t'' AS [Time Stamp]\r\n,\t\t\t[Price Type] \r\n,\t\t\t'' AS [Currency/Unit]\r\n,\t\t\t'' AS [Delivery Mode]\r\n,\t\t\t'' AS [Fill Type]\r\n,\t\t\t'Reuters' AS [Source]\r\nFROM\t\t[RAW].[DateList] dl\r\nLEFT JOIN\t(\r\n\t\t\t\tSELECT\t\tDISTINCT CAST([Description] AS NVARCHAR(250)) AS [Description]\r\n\t\t\t\t,\t\t\t[Price Type]\r\n\t\t\t\tFROM\t\t[RAW].[RAW.P.Reuters MGO Pricing]\r\n\t\t\t) mgo\r\nON\t\t\t1=1\r\n\r\nUNION ALL\r\n\r\nSELECT\t\tdl.[Date] AS [Date]\r\n,\t\t\t[Description] AS [Description]\r\n,\t\t\t'' AS [Contract/Delivery]\r\n,\t\t\t'' AS [Time Stamp]\r\n,\t\t\t[Price Type] \r\n,\t\t\t'' AS [Currency/Unit]\r\n,\t\t\t'' AS [Delivery Mode]\r\n,\t\t\t'' AS [Fill Type]\r\n,\t\t\t'Reuters' AS [Source]\r\nFROM\t\t[RAW].[DateList] dl\r\nLEFT JOIN\t(\r\n\t\t\t\tSELECT\t\tDISTINCT CAST([Description] AS NVARCHAR(250)) AS [Description]\r\n\t\t\t\t,\t\t\t[Price Type]\r\n\t\t\t\tFROM\t\t[RAW].[RAW.P.Reuters Pricing]\r\n\t\t\t\tWHERE\t\t[Description] NOT LIKE 'EUR%'\r\n\t\t\t\tAND\t\t\t[Date] IS NOT NULL\r\n\t\t\t) rp\r\nON\t\t\t1=1\r\n\r\n--33603\r\n\r\n/***************************************************\r\nSimplify fuel price descriptions*/\r\n\r\nIF OBJECT_ID('[Core].[DescIDArgusPricing]','U') IS NOT NULL \r\n\t\tDROP TABLE [Core].[DescIDArgusPricing]\r\n\r\nSELECT DISTINCT \r\n\t\tPJ.*,\r\n--\t\tPJ.[Description] + '_' + PJ.[Price Type] AS [DescPT],\r\n--\t\tCASE \r\n--\t\tWHEN PJ.[Description] = 'Biodiesel Palm OME RED ARA range barge fob'\t\t\t\t\t\t\t\t\t\tTHEN 'Argus_Fuel_Price1'\r\n--\t\tWHEN PJ.[Description] = 'Biodiesel FAME 0C CFPP RED ARA range barge fob'\t\t\t\t\t\t\t\t\tTHEN 'Argus_Fuel_Price2'\r\n--\t\tWHEN PJ.[Description] = 'Biodiesel palm oil mill effluent RED Malaysia/Indonesia fob'\t\t\t\t\t\tTHEN 'Argus_Fuel_Price3'\r\n--\t\tWHEN PJ.[Description] = 'Biodiesel Rapeseed OME RED ARA range barge fob'\t\t\t\t\t\t\t\t\tTHEN 'Argus_Fuel_Price4'\r\n--\t\tWHEN PJ.[Description] = 'Biodiesel tallow OME RED ARA range barge fob'\t\t\t\t\t\t\t\t\t\tTHEN 'Argus_Fuel_Price5'\r\n--\t\tWHEN PJ.[Description] = 'UCO (used cooking oil) cif ARA USD/t'\t\t\t\t\t\t\t\t\t\t\t\tTHEN 'Argus_Fuel_Price6'\r\n--\t\tWHEN PJ.[Description] = 'UCO (used cooking oil) fob China'\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 'Argus_Fuel_Price7'\r\n--\t\tWHEN PJ.[Description] = 'Biodiesel UCOME (used cooking oil) RED ARA range barge fob'\t\t\t\t\t\tTHEN 'Argus_Fuel_Price8'\r\n--\t\tWHEN PJ.[Description] = 'HVO (hydrotreated vegetable oil) fob ARA range (Class I) USD/t'\t\t\t\t\tTHEN 'Argus_Fuel_Price9'\r\n--\t\tWHEN PJ.[Description] = 'HVO (hydrotreated vegetable oil) fob ARA range (Class II) USD/t'\t\t\t\t\tTHEN 'Argus_Fuel_Price10'\r\n--\t\tWHEN PJ.[Description] = 'HVO (hydrotreated vegetable oil) fob ARA range (Class III) USD/t'\t\t\t\t\tTHEN 'Argus_Fuel_Price11'\r\n--\t\tWHEN PJ.[Description] = 'Palm oil futures Bursa Malaysia month'\t\t\t\t\t\t\t\t\t\t\t\tTHEN 'Argus_Fuel_Price12'\r\n--\t\tWHEN PJ.[Description] = 'Rapeseed oil fob Dutch Mill RSO'\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 'Argus_Fuel_Price13'\r\n--\t\tWHEN PJ.[Description] = 'SAF (sustainable aviation fuel) fob ARA range (Class II) USD/t'\t\t\t\t\tTHEN 'Argus_Fuel_Price14'\r\n--\t\tWHEN PJ.[Description] = 'Tallow (categories 1 & 2) fca northwest Europe EUR/t'\t\t\t\t\t\t\t\tTHEN 'Argus_Fuel_Price15'\r\n--\t\tWHEN PJ.[Description] = 'Freight PME Malaysia - ARA 3-5kt'\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 'Argus_Fuel_Price16'\r\n--\t\tWHEN PJ.[Description] = 'UCO (used cooking oil) RED bulk China fob'\t\t\t\t\t\t\t\t\t\t\tTHEN 'Argus_Fuel_Price17'\r\n--\t\tWHEN PJ.[Description] = 'Gasoil NWE 7-28 day swaps'\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 'Argus_Fuel_Price18'\r\n--\t\tWHEN PJ.[Description] = 'Soybean oil Argentina waterborne fob upriver USD/t month'\t\t\t\t\t\t\tTHEN 'Argus_Fuel_Price19'\r\n--\t\tWHEN PJ.[Description] = 'Biofuel soybean oil Argentina vs CBOT waterborne fob San Lorenzo'--high\t\t\t\tTHEN 'Argus_Fuel_Price20'\r\n--\t\tWHEN PJ.[Description] = 'Biofuel soybean oil Argentina vs CBOT waterborne fob San Lorenzo'--low\t\t\t\t\tTHEN 'Argus_Fuel_Price21'\r\n--\t\tWHEN PJ.[Description] = 'Biodiesel SME Argentina waterborne fob upriver'\t\t\t\t\t\t\t\t\tTHEN 'Argus_Fuel_Price22'\r\n--\t\tWHEN PJ.[Description] = 'Biodiesel UCOME (used cooking oil) RED bulk China fob'\t\t\t\t\t\t\t\tTHEN 'Argus_Fuel_Price23'\r\n--\t\tELSE 'ERROR' END AS [Description ID],\r\n\t\tAP.[Value]\r\n--\t\tISNULL(AP.[value],LAG(AP.[value],33602,-999) OVER(ORDER BY PJ.[description], PJ.[Date] ASC))  AS [Filled Value]\r\n--\t\tLAST_VALUE(AP.[value]) OVER( ORDER BY PJ.[description],  pj.[date] ASC) AS [LASTVALUE]\r\nINTO [Core].[DescIDArgusPricing]\r\nFROM [Core].[PreJoinArgusPricing] PJ\r\nLEFT JOIN\t(\r\n\t\t\t\tSELECT\t\tDISTINCT [Date]\r\n\t\t\t\t,\t\t\t[Description]\r\n\t\t\t\t,\t\t\t[Contract/Delivery]\r\n\t\t\t\t,\t\t\t[Time Stamp]\r\n\t\t\t\t,\t\t\t[Price Type] \r\n\t\t\t\t,\t\t\t[Currency/Unit]\r\n\t\t\t\t,\t\t\t[Delivery Mode]\r\n\t\t\t\t,\t\t\t[Fill Type]\r\n\t\t\t\t,\t\t\t[Value]\r\n\t\t\t\tFROM\t\t[RAW].[RAW.P.Argus Pricing]\r\n\r\n\t\t\t\tUNION ALL\r\n\r\n\t\t\t\tSELECT\t\tDISTINCT [Date] AS [Date]\r\n\t\t\t\t,\t\t\t[Description] AS [Description]\r\n\t\t\t\t,\t\t\t'' AS [Contract/Delivery]\r\n\t\t\t\t,\t\t\t'' AS [Time Stamp]\r\n\t\t\t\t,\t\t\t[Price Type] \r\n\t\t\t\t,\t\t\t'' AS [Currency/Unit]\r\n\t\t\t\t,\t\t\t'' AS [Delivery Mode]\r\n\t\t\t\t,\t\t\t'' AS [Fill Type]\r\n\t\t\t\t,\t\t\t[Value] AS [Value]\r\n\t\t\t\tFROM\t\t[RAW].[RAW.P.Reuters MGO Pricing]\r\n\r\n\t\t\t\tUNION ALL\t\r\n\r\n\t\t\t\tSELECT\t\tDISTINCT [Date] --AS [Date]\r\n\t\t\t\t,\t\t\t[Description] --AS [Description]\r\n\t\t\t\t,\t\t\t'' AS [Contract/Delivery]\r\n\t\t\t\t,\t\t\t'' AS [Time Stamp]\r\n\t\t\t\t,\t\t\t[Price Type] \r\n\t\t\t\t,\t\t\t'' AS [Currency/Unit]\r\n\t\t\t\t,\t\t\t'' AS [Delivery Mode]\r\n\t\t\t\t,\t\t\t'' AS [Fill Type]\r\n\t\t\t\t,\t\t\t[Value] AS [Value]\r\n\t\t\t\tFROM\t\t[RAW].[RAW.P.Reuters Pricing]\r\n\t\t\t\tWHERE\t\t[Description] NOT LIKE 'EUR%'\r\n\t\t\t\tAND\t\t\t[Date] IS NOT NULL\r\n\t\t\t) AP\r\nON\tPJ.[Date]\t\t\t\t= AP.[Date]\r\nAND\tPJ.[description]\t\t= AP.[Description]\r\nAND\tPJ.[Contract/Delivery]\t= AP.[Contract/Delivery]\r\nAND\tPJ.[Time Stamp]\t\t\t= AP.[Time Stamp]\r\nAND\tPJ.[Price Type]\t\t\t= AP.[Price Type]\r\nAND\tPJ.[Currency/Unit]\t\t= AP.[Currency/Unit]\r\nAND\tPJ.[Delivery Mode]\t\t= AP.[Delivery Mode]\r\nAND\tPJ.[Fill Type]\t\t\t= AP.[Fill Type]\r\n\r\n--36126\r\n\r\n/***************************************************\r\nAverage Price Table Calculation*/\r\n\r\nIF OBJECT_ID('[Core].[BiofuelArgusPricing]','U') IS NOT NULL \r\n\t\tDROP TABLE [Core].[BiofuelArgusPricing]\r\n\r\nSELECT * \r\nINTO [Core].[BiofuelArgusPricing] \r\nFROM [Core].[DescIDArgusPricing]\r\nWHERE [Description] = 'Biofuel soybean oil Argentina vs CBOT waterborne fob San Lorenzo'\r\n\r\n--2922\r\n\r\nIF OBJECT_ID('[Core].[BiofuelAvgArgusPricing]','U') IS NOT NULL \r\n\t\tDROP TABLE [Core].[BiofuelAvgArgusPricing]\r\n\r\nSELECT\r\n\t\t[Date],\r\n\t\tAVG(CAST([Value] AS FLOAT)) AS [AVG_Value]\r\nINTO [Core].[BiofuelAvgArgusPricing]\r\nFROM [Core].[BiofuelArgusPricing]\r\nGROUP BY [Date]\r\nORDER BY [Date]\r\n\r\n--1461\r\n\r\nIF OBJECT_ID('[Core].[BiofuelArgusPricingDone]','U') IS NOT NULL \r\n\t\tDROP TABLE [Core].[BiofuelArgusPricingDone]\r\n\r\nSELECT DISTINCT\r\n\t\tAP.[Date],\r\n\t\tAP.[Description],\r\n\t\tAP.[Contract/Delivery],\r\n\t\tAP.[Time Stamp],\r\n\t\t'high low avg' AS [Price Type],\r\n\t\tAP.[Currency/Unit],\r\n\t\tAP.[Delivery Mode],\r\n\t\tAP.[Fill Type],\r\n\t\tAP.[Source],\r\n\t\tAV.[AVG_Value] AS [Value]\r\nINTO [Core].[BiofuelArgusPricingDone]\r\nFROM [Core].[BiofuelArgusPricing] AP\r\nLEFT JOIN [Core].[BiofuelAvgArgusPricing] AV\r\nON AV.[Date] = AP.[Date]\r\n\r\n--1461\r\n\r\n/***************************************************\r\nAddition Price Table Calculation*/\r\n\r\nIF OBJECT_ID('[Core].[SoybeanArgusPricing]','U') IS NOT NULL \r\n\t\tDROP TABLE [Core].[SoybeanArgusPricing]\r\n\r\nSELECT * \r\nINTO [Core].[SoybeanArgusPricing] \r\nFROM [Core].[DescIDArgusPricing]\r\nWHERE [Description] = 'Biofuel soybean oil Argentina vs CBOT waterborne fob San Lorenzo' \r\nOR [Description] = 'Soybean oil Argentina waterborne fob upriver USD/t month'\r\n\r\n--4014\r\n\r\n\r\nIF OBJECT_ID('[Core].[SoybeanAddArgusPricing]','U') IS NOT NULL \r\n\t\tDROP TABLE [Core].[SoybeanAddArgusPricing]\r\n\r\nSELECT\t[Date]\r\n,\t\tCASE WHEN [Null Flag] > 0 THEN NULL\r\n\t\t\tELSE NULLIF((SUM(CAST(CASE WHEN [Description] LIKE 'Biofuel%' THEN '0' ELSE [Value] END AS FLOAT)) \r\n\t\t\t\t\t+ SUM(CAST(CASE WHEN [Description] LIKE 'Soybean%' THEN '0' ELSE [Value] END AS FLOAT))/2),0)\r\n\t\t\tEND AS [SUM_Value]\r\nINTO [Core].[SoybeanAddArgusPricing]\r\nFROM\t\t(\r\n\t\t\t\tSELECT\t*\r\n\t\t\t\t,\t\tSUM(CASE WHEN [Value] IS NULL THEN 1 ELSE 0 END) OVER (PARTITION BY [Date])\t AS [Null Flag]\t\t\t\t\t\t\t\t\r\n\t\t\t\tFROM [Core].[SoybeanArgusPricing]\r\n\t\t\t) sap\r\nGROUP BY [Date]\r\n,\t\t[Null Flag]\r\nORDER BY [Date]\r\n\t\t\r\n--1461\r\n\r\nIF OBJECT_ID('[Core].[SoybeanArgusPricingDone]','U') IS NOT NULL \r\n\t\tDROP TABLE [Core].[SoybeanArgusPricingDone]\r\n\r\nSELECT DISTINCT\r\n\t\tAP.[Date],\r\n\t\t'Soybean oil Argentina waterborne fob upriver USD/t month' AS [Description],\r\n\t\t'' AS [Contract/Delivery],\r\n\t\tAP.[Time Stamp],\r\n\t\t'midpoint_calc' AS [Price Type],\r\n\t\tAP.[Currency/Unit],\r\n\t\tAP.[Delivery Mode],\r\n\t\tAP.[Fill Type],\r\n\t\tAP.[Source],\r\n\t\tAD.[SUM_Value] AS [Value]\r\nINTO [Core].[SoybeanArgusPricingDone]\r\nFROM [Core].[SoybeanArgusPricing] AP\r\nLEFT JOIN [Core].[SoybeanAddArgusPricing] AD\r\nON AD.[Date] = AP.[Date]\r\n\r\n\r\n/***************************************************\r\nJoin all pre partition*/\r\n\r\nIF OBJECT_ID('[Core].[ArgusPricingPrePrePartition]','U') IS NOT NULL \r\n\t\tDROP TABLE [Core].[ArgusPricingPrePrePartition]\r\n\r\nSELECT *\r\nINTO [Core].[ArgusPricingPrePrePartition]\r\nFROM [Core].[DescIDArgusPricing]\r\nUNION ALL\r\nSELECT *\r\nFROM [Core].[BiofuelArgusPricingDone]\r\nUNION ALL\r\nSELECT *\r\nFROM [Core].[SoybeanArgusPricingDone]\r\n\r\n\r\n--36525\r\n\r\nIF OBJECT_ID('[Core].[ArgusPricingPrePartition]','U') IS NOT NULL \r\n\t\tDROP TABLE [Core].[ArgusPricingPrePartition]\r\n\r\nSELECT\r\n\t\t*,\r\n\t\tCASE WHEN [Source] = 'Argus' THEN [Description]+'_'+[Price Type] ELSE [Description] END AS [Full Description]\r\nINTO [Core].[ArgusPricingPrePartition]\r\nFROM [Core].[ArgusPricingPrePrePartition]\r\n\r\n--36525\r\n\r\n\r\n/***************************************************\r\nLoop to create description ID's*/\r\n\r\nIF OBJECT_ID('[Core].[DescID]','U') IS NOT NULL \r\n\t\tDROP TABLE [Core].[DescID]\r\n\r\nCREATE TABLE [Core].[DescID]\r\n([Description] NVARCHAR(128), [ID] NVARCHAR(32))\r\n\r\nDECLARE @counter INT\r\nDECLARE @maxcount INT\r\nDECLARE @description NVARCHAR(128)\r\nSET @maxcount = (SELECT COUNT(DISTINCT [Full Description]) FROM [Core].[ArgusPricingPrePartition])\r\nSET @counter = 1\r\nDECLARE clicker CURSOR FOR\r\n\r\nSELECT DISTINCT [Full Description] FROM [Core].[ArgusPricingPrePartition]\r\n\r\nOPEN clicker\r\nFETCH NEXT FROM clicker INTO @description\r\n\r\nWHILE @@FETCH_STATUS = 0 AND @maxcount >= @counter\r\nBEGIN\r\n\t\tINSERT INTO [Core].[DescID]\r\n\t\tVALUES (@description,@counter)\r\n\t\tSET @counter = @counter + 1\r\n\t\tFETCH NEXT FROM clicker INTO @description\r\nEND\r\n\r\nCLOSE clicker\r\nDEALLOCATE clicker\r\n\r\n\r\n/***************************************************\r\nJoin ID's to main table*/\r\n\r\nIF OBJECT_ID('[Core].[FixedArgusPricingPrePartition]','U') IS NOT NULL \r\n\t\tDROP TABLE [Core].[FixedArgusPricingPrePartition]\r\n\r\nSELECT\tPP.*,\r\n\t\tID.[ID]\r\nINTO [Core].[FixedArgusPricingPrePartition]\r\nFROM [Core].[ArgusPricingPrePartition] PP\r\nLEFT JOIN [Core].[DescID] ID\r\nON ID.[Description] = PP.[Full Description]\r\nORDER BY [Full Description],[Date]\r\n\r\n--36525\r\n\r\n\r\n/***************************************************\r\nFills down any missing prices using first value*/\r\n\r\nIF OBJECT_ID('[Core].[FixedArgusPricing]','U') IS NOT NULL \r\n\t\tDROP TABLE [Core].[FixedArgusPricing]\r\n\r\nSELECT DISTINCT\r\n\t\t*, \r\n\t\tFIRST_VALUE([Value]) OVER (PARTITION BY ID.ID, ID.[Value_Partition] ORDER BY ID.[ID], [Date]) AS [NewValue]\r\nINTO [Core].[FixedArgusPricing]\r\nFROM   (SELECT\r\n\t\t\t*,\r\n\t\t\tSUM(CASE WHEN [Value] IS NOT NULL THEN 1 ELSE 0 END) OVER (ORDER BY [ID], [Date]) AS [Value_Partition]\r\n\t\tFROM [Core].[FixedArgusPricingPrePartition]\r\n\t\t) AS ID\r\nORDER BY [ID], [Date] ASC\r\n\r\n--38,802\r\n\r\n--the bottom of the script aligns to point 2.6 in tom stews data marks script all be it with some neatening up to do most likely.\r\n\r\n\r\n/***************************************************\r\nJoin fuel lookup data and FX rates*/\r\n\r\n\t\tIF OBJECT_ID('[Trade].[Pricing]','U') IS NOT NULL\r\n\t\t\tDROP TABLE [Trade].[Pricing]\r\n\r\n\t\tSELECT\t\tfap.[Date]\r\n\t\t,\t\t\tIIF(fap.[Value] IS NULL,1,0)\t\tAS [Filled Down Flag]\r\n\t\t,\t\t\tfap.[Full Description]\t\t\t\tAS [Attribute]\r\n\t\t,\t\t\tfap.[NewValue]\t\t\t\t\t\tAS [Original Value] \r\n\t\t,\t\t\tfl.[Category]\r\n\t\t,\t\t\tfl.[Name]\r\n\t\t,\t\t\tfl.[UOM]\t\t\t\t\t\t\tAS [Original UOM]\r\n\t\t,\t\t\tfl.[Transport Cost]\r\n\t\t,\t\t\tfl.[Transport UOM]\r\n\t\t,\t\t\tfl.[Yield Assumption]\r\n\t\t,\t\t\tfx.[EUR:USD] as [FX Rates.Eur:USD] \r\n\t\t,\t\t\tCASE WHEN fl.[UOM] = 'USD/t'\t\t\tTHEN fap.[NewValue]/fx.[EUR:USD]\tELSE fap.[NewValue] END AS [Value EUR]\r\n\t\t,\t\t\tCASE WHEN fl.[Transport UOM] = 'USD'\tTHEN fl.[Transport Cost]/fx.[EUR:USD]\tELSE CASE WHEN fl.[Transport Cost] IS NULL THEN 0 ELSE fl.[Transport Cost] END END AS [Transport Cost EUR]\r\n\t\t,\t\t\t'€/mt' AS [UOM]\r\n\t\tINTO\t\t[Trade].[Pricing]\r\n\t\tFROM\t\t[Core].[FixedArgusPricing] fap\r\n\t\tLEFT JOIN\t(\r\n\t\t\t\t\t\tSELECT\t\tDISTINCT *\r\n\t\t\t\t\t\tFROM\t\t[RAW].[RAW.P.Fuel Lookup]\r\n\t\t\t\t\t) fl\r\n\t\tON\t\t\tfap.[Description] = fl.[Description]\r\n\t\tAND\t\t\tfap.[Price Type] = CASE WHEN fl.[Name] = 'SBO fob Argentina' THEN 'midpoint_calc' ELSE fl.[Price Type] END\r\n\t\tLEFT JOIN\t(\r\n\t\t\t\t\t\tSELECT\t\t[Date]\tAS [Date]\r\n\t\t\t\t\t\t,\t\t\tCASE WHEN [EUR:USD] IS NOT NULL THEN [EUR:USD] ELSE MAX([EUR:USD]) OVER (PARTITION BY [RowGroup] ORDER BY [Date]) END AS [EUR:USD]\r\n\t\t\t\t\t\tFROM\t\t(\r\n\t\t\t\t\t\t\t\t\t\tSELECT\t\tdl.[Date]\r\n\t\t\t\t\t\t\t\t\t\t,\t\t\tCAST(rp.[Date] AS DATE) AS [RP Date]\r\n\t\t\t\t\t\t\t\t\t\t,\t\t\tCAST([Value] AS DECIMAL(28,8)) AS [EUR:USD]\r\n\t\t\t\t\t\t\t\t\t\t,\t\t\tCOUNT(rp.[Date]) OVER (ORDER BY dl.[Date]) AS [RowGroup]\r\n\t\t\t\t\t\t\t\t\t\tFROM\t\t[RAW].[DateList] dl\r\n\t\t\t\t\t\t\t\t\t\tLEFT JOIN\t(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tSELECT\t\tDISTINCT *\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tFROM\t\t[RAW].[RAW.P.Reuters Pricing]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHERE\t\t[Description] LIKE 'EUR=%'\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t) rp\r\n\t\t\t\t\t\t\t\t\t\tON\t\t\tdl.[Date] = CAST(rp.[Date] AS DATE)\r\n\t\t\t\t\t\t\t\t\t) rg\r\n\t\t\t\t\t) fx\r\n\t\tON\t\t\tfx.[Date] = fap.[Date]\r\n\t\tWHERE\t\tfap.[NewValue] IS NOT NULL\r\n"
								}
							]
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"folder": {
					"name": "Trade/Pricing"
				},
				"annotations": [],
				"lastPublishTime": "2022-09-02T10:43:10Z"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/SQL_PurchaseContracts_SalesContracts')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "PC_SC",
						"type": "Script",
						"dependsOn": [],
						"policy": {
							"timeout": "7.00:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"linkedServiceName": {
							"referenceName": "SqlServerArgent",
							"type": "LinkedServiceReference"
						},
						"typeProperties": {
							"scripts": [
								{
									"type": "NonQuery",
									"text": " /********************************************************************************************************\r\n\tStep 1.1:\tDelete current day's data from the final tables. This ensures that if the script is run more\r\n\t\t\t\tthan once in one day there is no duplicated data.\r\n********************************************************************************************************/\r\n\t\r\n\tDECLARE @DeleteTableStatement NVARCHAR(MAX)\r\n\tDECLARE Cur2 CURSOR READ_ONLY\r\n\tFOR\r\n\t\t\tSELECT  'Delete from [SupplyChain].[' + TABLE_NAME + ']  where CAST([DateStamp] AS DATE) = CAST(GETDATE() AS DATE)'\r\n\t\t\tFROM    INFORMATION_SCHEMA.TABLES\r\n\t\t\tWHERE   TABLE_SCHEMA = 'SupplyChain'\r\n\t\t\tAND\t\tTABLE_TYPE = 'BASE TABLE' \r\n\t\t\tAND\t\tTABLE_NAME IN ('SalesContracts','PurchaseContracts')\r\n\r\n\r\n\tOPEN Cur2\r\n\tFETCH NEXT FROM Cur2 INTO @DeleteTableStatement\r\n\tWHILE @@FETCH_STATUS = 0\r\n\t\t  BEGIN\r\n\t\t\t\tPRINT 'Executing ' + @DeleteTableStatement\r\n\t\t\t\tEXECUTE sp_executesql @DeleteTableStatement\r\n\t\t\t\tFETCH NEXT FROM Cur2 INTO @DeleteTableStatement\r\n\t\t  END\r\n\tCLOSE Cur2\r\n\tDEALLOCATE Cur2\r\n\t\r\n /********************************************************************************************************\r\n\tStep 1.2:\tAdd current day's purchase contracts data to SupplyChain.PurchaseContracts\r\n********************************************************************************************************/\t\r\n\t\r\n\t\r\n\tINSERT INTO [SupplyChain].[PurchaseContracts]\r\n\tSELECT\t\to.[Business Unit Name]\r\n\t,\t\t\tpc.[Blanket Purchase Agreement Number] \r\n\t,\t\t\tCONCAT(LEFT(pc.[Purchase Document Status],1),LOWER(SUBSTRING(pc.[Purchase Document Status],2,LEN(pc.[Purchase Document Status])-1)))\t\tAS [Purchase Document Status]\r\n\t,\t\t\tUPPER(sn.[Supplier Name])\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Supplier Name]\r\n\t,\t\t\tUPPER(s.[Supplier Site Name])\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Supplier Site Name]\r\n\t,\t\t\tpc.[Purchase Document Description]\r\n\t,\t\t\ti.[Item Code]\r\n\t,\t\t\ti.[Item Name]\r\n\t,\t\t\tpc.[Item Description]\r\n\t,\t\t\ti.[Category Code] \r\n\t,\t\t\tpc.[Unit Price] + pc.[Transporter Unit Price] + pc.[Additional Charges 1 Unit Price] + pc.[Additional Charges 2 Unit Price]\r\n\t\t\t\t+ ISNULL(CASE \r\n\t\t\t\t\t\t\tWHEN p.[Shipping Method] IN ('Argent - Truck','Argent - Container','AENL - Truck','AENL - Container','Argent - Drop Ship')\r\n\t\t\t\t\t\t\t\tTHEN (pc.[Transporter Amount] + pc.[Additional Charges 1 Amount] + pc.[Additional Charges 2 Amount])/25\r\n\t\t\t\t\t\t\tELSE (pc.[Transporter Amount] + pc.[Additional Charges 1 Amount] + pc.[Additional Charges 2 Amount])/CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN i.[Item Code] = 'CH00006'\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 650\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE NULLIF(pc.[Blanket Agreement Quantity],0)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\t END,0)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Total Price]\r\n\t,\t\t\tpc.[Unit Price]\r\n\t,\t\t\tpc.[Purchase Document Currency]\r\n\t,\t\t\tISNULL(pc.[Blanket Agreement Quantity],0)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Blanket Agreement Quantity]\r\n\t,\t\t\tpc.[UOM Code]\r\n\t,\t\t\tISNULL(dq.[Delivered Qty],0) - ISNULL(rq.[Returned Qty],0)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Delivered Quantity]\r\n\t,\t\t\tISNULL(oq.[Ordered Qty],0)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Order Quantity]\r\n\t,\t\t\tISNULL(pc.[Blanket Agreement Quantity],0) - (ISNULL(dq.[Delivered Qty],0) - ISNULL(rq.[Returned Qty],0)) - ISNULL(oq.[Ordered Qty],0)\t\tAS [Remaining Quantity]\r\n\t,\t\t\t(ISNULL(pc.[Blanket Agreement Quantity],0) - (ISNULL(dq.[Delivered Qty],0) - ISNULL(rq.[Returned Qty],0)) - ISNULL(oq.[Ordered Qty],0))/25\tAS [Trucks]\r\n\t,\t\t\t((ISNULL(dq.[Delivered Qty],0) - ISNULL(rq.[Returned Qty],0)) + ISNULL(oq.[Ordered Qty],0))/NULLIF(pc.[Blanket Agreement Quantity],0)\t\tAS [Position Now]\r\n\r\n\t--          Calculation below is [Expected Position] = 1 - ([Weeks Remaining]/[Weeknumbers Contract])\r\n\t,\t\t\t1 - (CAST(CASE\r\n\t\t\t\t\t\t\t\tWHEN CONVERT(DATE, DATEADD(DAY, 1, GETDATE() - DATEPART(DW, GETDATE()) + CASE WHEN DATEPART(DW, GETDATE()) < 1 THEN 0 ELSE 7 END )) < CAST(pc.[Agreement Start Date] AS DATE)\r\n\t\t\t\t\t\t\t\t\tTHEN\tCASE\r\n\t\t\t\t\t\t\t\t\t\t\t\tWHEN pc.[Agreement Start Date] IS NULL OR CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND IS NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 0\r\n\t\t\t\t\t\t\t\t\t\t\t\tELSE DATEDIFF(DAY,pc.[Agreement Start Date],CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] <> NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND)/7\r\n\t\t\t\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\t\t\tWHEN CONVERT(DATE, DATEADD(DAY, 1, GETDATE() - DATEPART(DW, GETDATE()) + CASE WHEN DATEPART(DW, GETDATE()) < 1 THEN 0 ELSE 7 END )) > CAST(CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND AS DATE)\r\n\t\t\t\t\t\t\t\t\tTHEN 0\r\n\t\t\t\t\t\t\t\tELSE DATEDIFF(DAY,CONVERT(DATE, DATEADD(DAY, 1, GETDATE() - DATEPART(DW, GETDATE()) + CASE WHEN DATEPART(DW, GETDATE()) < 1 THEN 0 ELSE 7 END )),CAST(CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND AS DATE))/7\r\n\t\t\t\t\t\t  END AS DECIMAL(28,2))\t\t\t\t\t\r\n\t\t\t\t\t/CAST(NULLIF(CASE\r\n\t\t\t\t\t\t\t\t\tWHEN pc.[Agreement Start Date] IS NULL OR CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND IS NULL\r\n\t\t\t\t\t\t\t\t\t\tTHEN 0\r\n\t\t\t\t\t\t\t\t\tELSE DATEDIFF(DAY,pc.[Agreement Start Date],CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND)/7\r\n\t\t\t\t\t\t\t\tEND,0) AS DECIMAL(28,2)))\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Expected Position]\r\n\r\n\t-- [Weeknumbers Contract] is calculated below as difference between [Agreement Start Date] and [Agreement End Date]\r\n\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN pc.[Agreement Start Date] IS NULL OR CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND IS NULL\r\n\t\t\t\t\t\tTHEN 0\r\n\t\t\t\t\tELSE DATEDIFF(DAY,pc.[Agreement Start Date],CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND)/7\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Weeknumbers Contract]\r\n\r\n\t-- [Weeks Remaining] is calculated below as\t\t- Difference between [Agreement Start Date and [Agreement End Date] if GETDATE() < [Agreement Start Date]\r\n\t--\t\t\t\t\t\t\t\t\t\t\t\t- 0 if GETDATE() > [Agreement End Date]\r\n\t--\t\t\t\t\t\t\t\t\t\t\t\t- ELSE difference between [Next Monday] and [Agreement End Date]\r\n\r\n\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN CONVERT(DATE, DATEADD(DAY, 1, GETDATE() - DATEPART(DW, GETDATE()) + CASE WHEN DATEPART(DW, GETDATE()) < 1 THEN 0 ELSE 7 END )) < CAST(pc.[Agreement Start Date] AS DATE)\r\n\t\t\t\t\t\t THEN\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN pc.[Agreement Start Date] = '' OR CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND IS NULL\r\n\t\t\t\t\t\t\t\t\t\tTHEN 0\r\n\t\t\t\t\t\t\t\t\tELSE DATEDIFF(DAY,pc.[Agreement Start Date],CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND)/7\r\n\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\tWHEN CONVERT(DATE, DATEADD(DAY, 1, GETDATE() - DATEPART(DW, GETDATE()) + CASE WHEN DATEPART(DW, GETDATE()) < 1 THEN 0 ELSE 7 END )) > CAST(CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND AS DATE)\r\n\t\t\t\t\t\t THEN 0\r\n\t\t\t\t\tELSE DATEDIFF(DAY,CONVERT(DATE, DATEADD(DAY, 1, GETDATE() - DATEPART(DW, GETDATE()) + CASE WHEN DATEPART(DW, GETDATE()) < 1 THEN 0 ELSE 7 END )),CAST(CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND AS DATE))/7\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Weeks Remaining]\r\n\r\n\t,\t\t\tCONVERT(DATE, DATEADD(DAY, 1, GETDATE() - DATEPART(DW, GETDATE()) + CASE WHEN DATEPART(DW, GETDATE()) < 1 THEN 0 ELSE 7 END ))\t\t\tAS [Next Monday]\r\n\t,\t\t\tpc.[Agreement Start Date]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Agreement End Date]\r\n\t,\t\t\tp.[Shipping Method]\r\n\t,\t\t\tpc.[Incoterm]\r\n\t,\t\t\tpc.[Transporter Name]\r\n\t,\t\t\tpc.[Transporter Unit Price]\r\n\t,\t\t\tpc.[Transporter Amount]\r\n\t,\t\t\tpc.[Transporter Currency]\r\n\t,\t\t\tpc.[Additional Charges 1 Supplier]\t\r\n\t,\t\t\tpc.[Additional Charges 1 Unit Price]\r\n\t,\t\t\tpc.[Additional Charges 1 Amount]\r\n\t,\t\t\tpc.[Additional Charges 1 Currency]\r\n\t,\t\t\tpc.[Additional Charges 2 Supplier]\t\r\n\t,\t\t\tpc.[Additional Charges 2 Unit Price]\r\n\t,\t\t\tpc.[Additional Charges 2 Amount]\r\n\t,\t\t\tpc.[Additional Charges 2 Currency]\r\n\t,\t\t\tu.[Username]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Buyer]\r\n\t,\t\t\tpc.[Sustainability Position]\r\n\t,\t\t\tpc.[Supplier Item]\r\n\t,\t\t\tpc.[Deal Date]\r\n\t,\t\t\tpc.[Agreement Amount]\r\n\t,\t\t\tpc.[Amount Released Against Agreement]\r\n\t,\t\t\tpc.[Note To Vendor]\r\n\t,\t\t\tpc.[FFA Spec]\t\t\t\r\n\t,\t\t\tpc.[Line Status]\r\n\t,\t\t\tfx.[EUR USD]\r\n\t,\t\t\tfx.[EUR GBP]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN CASE\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL THEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31') ELSE pc.[Agreement End Date]  END IS NULL\r\n\r\n\r\n\t\t\t\t\tTHEN CONCAT(LEFT(pc.[Purchase Document Status],1),LOWER(SUBSTRING(pc.[Purchase Document Status],2,LEN(pc.[Purchase Document Status])-1)))\r\n\t\t\t\t\t\r\n\t\t\t\t\tWHEN pc.[Purchase Document Status] not in ('closed' ,'finally closed', 'canceled') AND CAST(CASE WHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL THEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31') ELSE pc.[Agreement End Date] END AS DATE) < GETDATE()\r\n\t\t\t\t\t\tTHEN 'Closed'\r\n\t\t\t\t\tELSE CONCAT(LEFT(pc.[Purchase Document Status],1),LOWER(SUBSTRING(pc.[Purchase Document Status],2,LEN(pc.[Purchase Document Status])-1)))\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Updated Contract Status]\r\n\t,\t\t\tCAST(GETDATE() AS DATE)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [DateStamp]\r\n\t,\t\t\tISNULL(pc.[Blanket Agreement Quantity],0) * ISNULL(ISNULL(y.[Expected yield],av.[Average Yield]),av2.[Average Yield])\t\t\t\t\t\t\tAS [Yield Adjusted Volume]\r\n\t,\t\t\tCAST(ISNULL(ISNULL(DATEADD(d,DATEDIFF(d,pc.[Agreement Start Date],CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t \t  WHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t \t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t \t  ELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t END)/2,pc.[Agreement Start Date]),pc.[Agreement Start Date]),CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  \t  WHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  \t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  \t  ELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  END) AS DATE)\t\t\tAS [Agreement Mid Date]\t\r\n\t,\t\t\tISNULL(pc.[Blanket Agreement Quantity],0) - (ISNULL(dq.[Delivered Qty],0) - ISNULL(rq.[Returned Qty],0))\t\t\t\t\t\t\t\t\t\tAS [Non-Delivered Quantity]\r\n\t,\t\t\t(ISNULL(pc.[Blanket Agreement Quantity],0) - (ISNULL(dq.[Delivered Qty],0) - ISNULL(rq.[Returned Qty],0)))\r\n\t\t\t\t\t* ISNULL(ISNULL(y.[Expected yield],av.[Average Yield]),av2.[Average Yield])\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Yield Adjusted Volume Non-Delivered]\r\n\r\n\r\n\r\n\t--SELECT\t\t[o].[Business Unit Name]\r\n\t--,\t\t\tCOUNT(1)\r\n\tFROM\t\t[Core].[PurchaseContracts] pc\r\n\tLEFT JOIN\t[Core].[Suppliers] s\r\n\tON\t\t\tpc.[Supplier] = s.[Vendor ID]\r\n\tAND\t\t\tpc.[Vendor Site ID] = s.[Vendor Site ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Party ID] \r\n\t\t\t\t\t,\t\t\tMIN([Party Name])\tAS [Supplier Name]\r\n\t\t\t\t\tFROM\t\t[Core].[Parties]\r\n\t\t\t\t\tGROUP BY\t[Party ID]\r\n\t\t\t\t) sn\r\n\tON\t\t\ts.[Party ID] = sn.[Party ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Business Unit ID]\r\n\t\t\t\t\t,\t\t\t[Business Unit Name]\r\n\t\t\t\t\tFROM\t\t[Core].[Organizations]\r\n\t\t\t\t\tGROUP BY\t[Business Unit ID]\r\n\t\t\t\t\t,\t\t\t[Business Unit Name]\r\n\t\t\t\t) o\r\n\tON\t\t\tpc.[Purchasing BU] = o.[Business Unit ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Item Code]\r\n\t\t\t\t\t,\t\t\t[Inventory Item ID]\r\n\t\t\t\t\t,\t\t\t[Category Code]\r\n\t\t\t\t\t,\t\t\tMIN([Item Name])\tAS [Item Name]\r\n\t\t\t\t\tFROM\t\t[Core].[Items]\r\n\t\t\t\t\tGROUP BY\t[Item Code]\r\n\t\t\t\t\t,\t\t\t[Inventory Item ID]\r\n\t\t\t\t\t,\t\t\t[Category Code]\r\n\t\t\t\t) i \r\n\tON\t\t\ti.[Inventory Item ID] = pc.[Item ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Party ID]\r\n\t\t\t\t\t,\t\t\tMIN([Party Name])\tAS [Shipping Method]\r\n\t\t\t\t\tFROM\t\t[Core].[Parties]\r\n\t\t\t\t\tGROUP BY\t[Party ID]\r\n\t\t\t\t) p\r\n\tON\t\t\tpc.[Carrier ID] = p.[Party ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[From Header ID]\r\n\t\t\t\t\t,\t\t\tSUM(ISNULL(CAST(CASE WHEN LTRIM(RTRIM(rt.[Primary Quantity])) IS NULL THEN '0' ELSE LTRIM(RTRIM(rt.[Primary Quantity])) END AS NUMERIC(28,8)),0)) AS [Delivered Qty]\r\n\t\t\t\t\tFROM\t\t[Core].[PurchaseOrders] po\r\n\t\t\t\t\tLEFT JOIN\t[Core].[ReceivingTransactions] rt\r\n\t\t\t\t\tON\t\t\trt.[PO Line ID] = po.[PO Line ID]\r\n\t\t\t\t\tWHERE\t\trt.[Destination Type Code] = 'INVENTORY'\r\n\t\t\t\t\tAND\t\t\tpo.[Line Status] NOT IN ('OPEN','CANCELED','CLOSED FOR INVOICING')\r\n\t\t\t\t\tAND\t\t\trt.[Transaction Type] <> 'RETURN TO RECEIVING'\r\n\t\t\t\t\tGROUP BY\t[From Header ID]\r\n\t\t\t\t) dq\r\n\tON\t\t\tdq.[From Header ID] = pc.[PO Header ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[From Header ID]\r\n\t\t\t\t\t,\t\t\tSUM(ISNULL(CAST(CASE WHEN LTRIM(RTRIM(rt.[Primary Quantity])) IS NULL THEN '0' ELSE LTRIM(RTRIM(rt.[Primary Quantity])) END AS NUMERIC(28,8)),0)) AS [Returned Qty]\r\n\t\t\t\t\tFROM\t\t[Core].[PurchaseOrders] po\r\n\t\t\t\t\tLEFT JOIN\t[Core].[ReceivingTransactions] rt\r\n\t\t\t\t\tON\t\t\trt.[PO Line ID] = po.[PO Line ID]\r\n\t\t\t\t\tWHERE\t\trt.[Destination Type Code] = 'INVENTORY'\r\n\t\t\t\t\tAND\t\t\tpo.[Line Status] NOT IN ('OPEN','CANCELED','CLOSED FOR INVOICING')\r\n\t\t\t\t\tAND\t\t\trt.[Transaction Type] = 'RETURN TO RECEIVING'\r\n\t\t\t\t\tGROUP BY\t[From Header ID]\r\n\t\t\t\t) rq\r\n\tON\t\t\trq.[From Header ID] = pc.[PO Header ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[From Header ID]\r\n\t\t\t\t\t,\t\t\tSUM(ISNULL(CAST(CASE WHEN LTRIM(RTRIM([Ordered Quantity])) IS NULL THEN '0' ELSE LTRIM(RTRIM([Ordered Quantity])) END AS NUMERIC(28,8)),0)) AS [Ordered Qty]\r\n\t\t\t\t\tFROM\t\t[Core].[PurchaseOrders]\r\n\t\t\t\t\tWHERE\t\t[Line Status] IN ('OPEN','CLOSED FOR INVOICING')\r\n\t\t\t\t\tGROUP BY\t[From Header ID]\r\n\t\t\t\t) oq\r\n\tON\t\t\toq.[From Header ID] = pc.[PO Header ID]\r\n\tLEFT JOIN\t[Core].[Users] u\r\n\tON\t\t\tpc.[Buyer] = u.[Person ID]\r\n\tLEFT JOIN\t[Core].[FXRates] fx\r\n\tON\t\t\tCAST(pc.[Agreement Start Date] AS DATE) = CAST(fx.[CONVERSION_DATE] AS DATE)\r\n\tLEFT JOIN\t[Trade].[Yield] y\r\n\tON\t\t\to.[Business Unit Name] = y.[Business Unit]\r\n\tAND\t\t\tCASE WHEN i.[Category Code] = 'Feedstock.TallowABP' THEN 'Feedstock.Tallow' ELSE i.[Category Code] END = y.[Item Category]\r\n\tAND\t\t\t(CASE WHEN YEAR(CAST(pc.[Agreement Start Date] AS DATE)) < 2020 THEN CAST('2020-01-01' AS DATE)\r\n\t\t\t\t\t ELSE CAST(pc.[Agreement Start Date] AS DATE)\r\n\t\t\t\tEND BETWEEN y.[Start Date] AND y.[End date] OR (pc.[Agreement Start Date] > y.[Start Date] AND y.[End date] IS NULL))\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\t\tSELECT\t\tDISTINCT [Business Unit]\r\n\t\t\t\t\t\t,\t\t\t[Start date]\r\n\t\t\t\t\t\t,\t\t\t[End date]\r\n\t\t\t\t\t\t,\t\t\tAVG(CAST([Expected yield] AS DECIMAL(28,8)))OVER(PARTITION BY [Business Unit], [Start date]) AS [Average Yield]\r\n\t\t\t\t\t\tFROM\t\t[Trade].[Yield]\t\r\n\t\t\t\t) av\r\n\tON\t\t\to.[Business Unit Name] = av.[Business Unit]\r\n\tAND\t\t\tCASE WHEN YEAR(CAST(pc.[Agreement Start Date] AS DATE)) < 2020 THEN CAST('2020-01-01' AS DATE)\r\n\t\t\t\t\t ELSE CAST(pc.[Agreement Start Date] AS DATE)\r\n\t\t\t\tEND BETWEEN av.[Start Date] AND ISNULL(av.[End date],CAST(GETDATE() AS DATE))\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\t\tSELECT\t\tDISTINCT [Business Unit]\r\n\t\t\t\t\t\t,\t\t\t[Start date]\r\n\t\t\t\t\t\t,\t\t\t[End date]\r\n\t\t\t\t\t\t,\t\t\tAVG(CAST([Expected yield] AS DECIMAL(28,8)))OVER(PARTITION BY [Business Unit], [Start date]) AS [Average Yield]\r\n\t\t\t\t\t\tFROM\t\t[Trade].[Yield]\t\r\n\t\t\t\t\t\tWHERE\t\tCAST(GETDATE() AS DATE) BETWEEN [Start Date] AND ISNULL([End date],CAST(GETDATE() AS DATE))\r\n\t\t\t\t) av2\r\n\tON\t\t\to.[Business Unit Name] = av2.[Business Unit]\r\n\tWHERE\t\to.[Business Unit Name] NOT IN ('ROTIE BU','Quatra BU')\r\n\tAND\t\t\tpc.[Blanket Purchase Agreement Number] NOT IN (\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tSELECT\t\tDISTINCT [Blanket Purchase Agreement Number]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tFROM\t\t[Core].[PurchaseContracts]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHERE\t\t[Amount Released Against Agreement] = 0\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAND\t\t\t[Agreement End Date] < '2021-07-01'\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t   ) \t\r\n\r\n /********************************************************************************************************\r\n\tStep 1.3:\tAdd current day's sales contracts data to SupplyChain.SalesContracts\r\n********************************************************************************************************/\t\r\n\r\n\tINSERT INTO [SupplyChain].[SalesContracts]\t\t\t\r\n\tSELECT\t\to.[Business Unit Name]\r\n\t,\t\t\tsc.[Sales Contract Number]\r\n\t,\t\t\tsc.[Sales Contract Version]\r\n\t,\t\t\tREPLACE(CONCAT(LEFT(sc.[Sales Contract Status],1),LOWER(SUBSTRING(sc.[Sales Contract Status],2,LEN(sc.[Sales Contract Status])-1))),'_',' ')\tAS [Sales Contract Status]\r\n\t,\t\t\tUPPER(c.[Customer])\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Customer]\r\n\t,\t\t\tc.[Customer Number]\r\n\t,\t\t\tUPPER(sc.[Customer Bill To])\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Customer Bill To]\r\n\t,\t\t\tUPPER(sc.[Customer Ship To])\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Customer Ship To]\r\n\t,\t\t\tsc.[Description]\r\n\t,\t\t\tsc.[Additional Description]\r\n\t,\t\t\tsc.[Item Name]\r\n\t,\t\t\ti.[Item Name]\tAS [Item Description]\r\n\t,\t\t\ti.[Category Code]\r\n\t,\t\t\tCAST(CASE WHEN sc.[Agreement Price] IS NULL THEN '0' ELSE sc.[Agreement Price] END AS NUMERIC(28,8)) \r\n\t\t\t\t- CAST(CASE WHEN sc.[Transporter Unit Price] IS NULL THEN '0' ELSE sc.[Transporter Unit Price] END AS NUMERIC(28,2))\r\n\t\t\t\t- CAST(CASE WHEN sc.[Additional Charges 1 Unit Price] IS NULL THEN '0' ELSE sc.[Additional Charges 1 Unit Price] END AS NUMERIC(28,2))\r\n\t\t\t\t- CAST(CASE WHEN sc.[Additional Charges 2 Unit Price] IS NULL THEN '0' ELSE sc.[Additional Charges 2 Unit Price] END AS NUMERIC(28,2))\t\tAS [Total Price per tonne]\r\n\t,\t\t\t(CAST(CASE WHEN sc.[Transporter Amount] IS NULL THEN '0' ELSE sc.[Transporter Amount] END AS NUMERIC(28,2))\r\n\t\t\t\t+ CAST(CASE WHEN sc.[Additional Charges 1 Amount] IS NULL THEN '0' ELSE sc.[Additional Charges 1 Amount] END AS NUMERIC(28,2))\r\n\t\t\t\t+ CAST(CASE WHEN sc.[Additional Charges 2 Amount] IS NULL THEN '0' ELSE sc.[Additional Charges 2 Amount] END AS NUMERIC(28,2))) * (-1)\t\tAS [Add. Cost per Transport]\r\n\t,\t\t\tsc.[Currency Code]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN sc.[Line Quantity] IS NULL\r\n\t\t\t\t\t\tTHEN CAST(CASE WHEN sc.[Line Amount] IS NULL THEN '0' ELSE sc.[Line Amount] END AS NUMERIC(28,2))/NULLIF(CAST(CASE WHEN sc.[Agreement Price] IS NULL THEN '0' ELSE sc.[Agreement Price] END AS NUMERIC(28,2)),0)\r\n\t\t\t\t\tELSE CAST(sc.[Line Quantity] AS NUMERIC(28,2))\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Line Quantity]\r\n\t,\t\t\tsc.[UOM Code]\r\n\t,\t\t\tsc.[Line Start Date]\r\n\t,\t\t\tsc.[Line End Date]\r\n\t,\t\t\tsc.[Shipping Method]\r\n\t,\t\t\tsc.[Incoterm]\r\n\t,\t\t\to.[Business Unit Name]\t\t\t\t\t\t\t\tAS [Seller]\r\n\t,\t\t\tISNULL(q.[Order Quantity],0)\t\t\t\t\t\tAS [Order Quantity]\t\r\n\t,\t\t\tISNULL(q.[Shipped Quantity],0)\t\t\t\t\t\tAS [Shipped Quantity]\r\n\t,\t\t\tsc.[Line Amount]\r\n\t,\t\t\tsc.[Agreement Price]\r\n\t,\t\t\tsc.[Transporter]\r\n\t,\t\t\tsc.[Transporter Unit Price]\r\n\t,\t\t\tsc.[Transporter Amount]\r\n\t,\t\t\tsc.[Transporter Currency]\r\n\t,\t\t\tsc.[Additional Charges 1 Supplier]\r\n\t,\t\t\tsc.[Additional Charges 1 Description]\r\n\t,\t\t\tsc.[Additional Charges 1 Unit Price]\r\n\t,\t\t\tsc.[Additional Charges 1 Amount]\r\n\t,\t\t\tsc.[Additional Charges 1 Currency]\r\n\t,\t\t\tsc.[Additional Charges 2 Supplier]\r\n\t,\t\t\tsc.[Additional Charges 2 Description]\r\n\t,\t\t\tsc.[Additional Charges 2 Unit Price]\r\n\t,\t\t\tsc.[Additional Charges 2 Amount]\r\n\t,\t\t\tsc.[Additional Charges 2 Currency]\r\n\t,\t\t\tsc.[Trader]\r\n\t,\t\t\tsc.[Deal Date]\r\n\t,\t\t\tsc.[Payment Term]\r\n\t,\t\t\tsc.[Tolerance]\r\n\t,\t\t\tsc.[Laycan]\r\n\t,\t\t\tsc.[Sustainability Contact]\r\n\t,\t\t\tsc.[Sustainability Position]\r\n\t,\t\t\tsc.[Sustainability Position Details]\r\n\t,\t\t\tsc.[Quality]\r\n\t,\t\t\tsc.[Temperature]\r\n\t,\t\t\tsc.[Nomination]\r\n\t,\t\t\tsc.[Nomination Requirement]\t\r\n\t,\t\t\tsc.[Lay Time]\r\n\t,\t\t\tsc.[Inspection]\r\n\t,\t\t\tsc.[Detenation Demurrage]\r\n\t,\t\t\tsc.[Demurrage Vessel]\r\n\t,\t\t\tsc.[Legislation]\r\n\t,\t\t\tsc.[Disposal Method]\r\n\t,\t\t\tsc.[Waste Stream Number]\r\n\t,\t\t\tsc.[Waste Description]\r\n\t,\t\t\tsc.[VET ID]\r\n\t,\t\t\tfx.[EUR USD]\r\n\t,\t\t\tfx.[EUR GBP]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN sc.[Sales Contract Status] not in ('Closed', 'Caneled','Finally closed', 'expired') AND ISDATE([Line End Date]) = 1 AND CAST([Line End Date] AS DATE) < GETDATE()\r\n\t\t\t\t\t\tTHEN 'Closed'\r\n\t\t\t\t\tELSE sc.[Sales Contract Status]\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Updated Contract Status]\r\n\t,\t\t\tCAST(GETDATE() AS DATE)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [DateStamp]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN sc.[Line Quantity] IS NULL\r\n\t\t\t\t\t\tTHEN CAST(CASE WHEN sc.[Line Amount] IS NULL THEN '0' ELSE sc.[Line Amount] END AS NUMERIC(28,2))/NULLIF(CAST(CASE WHEN sc.[Agreement Price] IS NULL THEN '0' ELSE sc.[Agreement Price] END AS NUMERIC(28,2)),0)\r\n\t\t\t\t\tELSE CAST(sc.[Line Quantity] AS NUMERIC(28,2))\r\n\t\t\t\tEND - ISNULL(q.[Shipped Quantity],0)\t\t\t\tAS [Volume Non-Delivered]\r\n\t,\t\t\tCAST(ISNULL(ISNULL(DATEADD(d,DATEDIFF(d,sc.[Line Start Date],sc.[Line End Date])/2,sc.[Line Start Date]),sc.[Line Start Date]),sc.[Line End Date]) AS DATE) AS [Line Mid Date]\r\n\tFROM\t\t[Core].[SalesContracts] sc\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Party ID]\r\n\t\t\t\t\t,\t\t\t[Party Number]\t\tAS [Customer Number]\r\n\t\t\t\t\t,\t\t\tMIN([Party Name])\tAS [Customer]\r\n\t\t\t\t\tFROM\t\t[Core].[Parties]\r\n\t\t\t\t\tGROUP BY\t[Party ID]\r\n\t\t\t\t\t,\t\t\t[Party Number]\r\n\t\t\t\t) c\r\n\tON\t\t\tsc.[Sales Contract Customer] = c.[Party ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Business Unit ID]\r\n\t\t\t\t\t,\t\t\t[Business Unit Name]\r\n\t\t\t\t\tFROM\t\t[Core].[Organizations]\r\n\t\t\t\t\tGROUP BY\t[Business Unit ID]\r\n\t\t\t\t\t,\t\t\t[Business Unit Name]\r\n\t\t\t\t) o\r\n\tON\t\t\tsc.[Business Unit] = o.[Business Unit ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Item Code]\r\n\t\t\t\t\t,\t\t\t[Item Name]\r\n\t\t\t\t\t,\t\t\t[Category Code]\r\n\t\t\t\t\tFROM\t\t[Core].[Items] \r\n\t\t\t\t\tWHERE\t\t[Organization ID] = '300000001513519' --Master Stock List\r\n\t\t\t\t\tGROUP BY\t[Item Code]\r\n\t\t\t\t\t,\t\t\t[Item Name]\r\n\t\t\t\t\t,\t\t\t[Category Code]\r\n\t\t\t\t) i\r\n\tON\t\t\ti.[Item Code] = sc.[Item Name]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tsc.[Contract Header ID]\r\n\t\t\t\t\t,\t\t\tsc.[Line ID]\r\n\t\t\t\t\t,\t\t\tSUM(CAST(sof.[FULFILLED_QTY] AS NUMERIC(28,2)) - 2*CAST(sof.[RMA_DELIVERED_QTY] AS NUMERIC(28,2)))\tAS [Shipped Quantity]\r\n\t\t\t\t\t,\t\t\tSUM(CAST(sof.[ORDERED_QTY] AS NUMERIC(28,2)) - CAST(sof.[FULFILLED_QTY] AS NUMERIC(28,2)))\t\t\tAS [Order Quantity]\r\n\t\t\t\t\tFROM\t\t[Core].[SalesContracts] sc\r\n\t\t\t\t\tLEFT JOIN\t[Core].[SalesOrders_Fulfilled] sof\r\n\t\t\t\t\tON\t\t\tsc.[Contract Header ID] = sof.[AGREEMENT_HEADER_ID]\r\n\t\t\t\t\tAND\t\t\tsc.[Line ID] = sof.[AGREEMENT_LINE_ID]\r\n\t\t\t\t\tWHERE\t\tsc.[Version Type] = 'C'\r\n\t\t\t\t\tAND\t\t\tsof.[ORDERED_UOM] = 'TN'\r\n\t\t\t\t\tAND\t\t\tsof.[REFERENCE_FLINE_ID] IS NULL\r\n\t\t\t\t\tGROUP BY\tsc.[Contract Header ID]\r\n\t\t\t\t\t,\t\t\tsc.[Line ID]\r\n\t\t\t\t) q\t\r\n\tON\t\t\tsc.[Contract Header ID] = q.[Contract Header ID]\r\n\tAND\t\t\tsc.[Line ID] = q.[Line ID]\r\n\tLEFT JOIN\t[Core].[FXRates] fx\r\n\tON\t\t\tCAST(sc.[Line Start Date] AS DATE) = CAST(fx.[CONVERSION_DATE] AS DATE)\r\n\tWHERE\t\t[Version Type] = 'C'\r\n\tAND\t\t\to.[Business Unit Name] NOT IN ('ROTIE BU','Quatra BU')\t\t\t\t\t\t\t\t   "
								}
							]
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"folder": {
					"name": "Supply Chain"
				},
				"annotations": []
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/SQL_SalesContracts_Invoices')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "SalesContracts_To_Invoices",
						"type": "Script",
						"dependsOn": [],
						"policy": {
							"timeout": "7.00:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"linkedServiceName": {
							"referenceName": "SqlServerArgent",
							"type": "LinkedServiceReference"
						},
						"typeProperties": {
							"scripts": [
								{
									"type": "Query",
									"text": " /********************************************************************************************************\r\n\tStep 3.1:\tCreate a table linking sales invoices to sales contracts.\r\n********************************************************************************************************/\t\r\n\r\n\tIF OBJECT_ID('[SupplyChain].[SalesInvoicesAndContractNumber]','U') IS NOT NULL\r\n\t\tDROP TABLE [SupplyChain].[SalesInvoicesAndContractNumber]\r\n\r\n\tSELECT\t\tsc.[Sales Contract Number]\r\n\t,\t\t\tsoi.[Order Number]\r\n    ,\t\t\tsoi.[Parent Order]\r\n    ,\t\t\tsoi.[Invoice Price]\r\n    ,\t\t\tsoi.[Invoiced Quantity]\r\n    ,\t\t\tsoi.[Transactional Currency Code]\r\n    ,\t\t\tsoi.[Business Unit Name]\r\n    ,\t\t\tsoi.[Transaction Date]\r\n    ,\t\t\tsoi.[Invoice Amount]\r\n    ,\t\t\tsoi.[EUR:GBP]\r\n    ,\t\t\tsoi.[EUR:USD]\r\n    ,\t\t\tsoi.[Sold To Party ID]\r\n    ,\t\t\tCAST(GETDATE() AS DATE) AS [DateStamp]\r\n\tINTO\t\t[SupplyChain].[SalesInvoicesAndContractNumber]\r\n\tFROM\t\tFinance.SalesOrdersAndInvoices soi\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tDISTINCT [Agreement Header ID]\r\n\t\t\t\t\t,\t\t\t[Order Number]\r\n\t\t\t\t\tFROM\t\tCore.[SalesOrders]\r\n\t\t\t\t) so\r\n\tON\t\t\tsoi.[Order Number] = so.[Order Number]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tDISTINCT [Sales Contract Number]\r\n\t\t\t\t\t,\t\t\t[Contract Header ID]\r\n\t\t\t\t\tFROM\t\tCore.SalesContracts\r\n\t\t\t\t) sc\r\n\tON\t\t\tsc.[Contract Header ID] = so.[Agreement Header ID]\r\n\tORDER BY\t[Transaction Date]\r\n\r\n\r\n /********************************************************************************************************\r\n\tStep 3.2:\tCreate a table linking purchase invoices to purchase contracts.\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[SupplyChain].[PurchaseInvoicesAndContractNumber]','U') IS NOT NULL\r\n\t\tDROP TABLE [SupplyChain].[PurchaseInvoicesAndContractNumber]\r\n\r\n\tSELECT\t\tpc.[Blanket Purchase Agreement Number]\r\n\t,\t\t\tpoi.[Order Number]\r\n    ,\t\t\tpoi.[Parent Order]\r\n    ,\t\t\tpoi.[Supplier/Customer]\r\n    ,\t\t\tpoi.[Supplier/Customer Number]\r\n    ,\t\t\tpoi.[Agreement Number/Sales Contract Number]\r\n    ,\t\t\tpoi.[Item Code]\r\n    ,\t\t\tpoi.[Item Description]\r\n    ,\t\t\tpoi.[Category Code]\r\n    ,\t\t\tpoi.[UOM Code]\r\n    ,\t\t\tpoi.[Agreement Price]\r\n    ,\t\t\tpoi.Quantity\r\n    ,\t\t\tpoi.[Invoice Price]\r\n    ,\t\t\tpoi.[Invoiced Quantity]\r\n    ,\t\t\tpoi.[Invoice Line Amount]\r\n    ,\t\t\tpoi.Currency\r\n    ,\t\t\tpoi.[Business Unit]\r\n    ,\t\t\tpoi.[Inventory Organization Code]\r\n    ,\t\t\tpoi.[Inventory Organization Name]\r\n    ,\t\t\tpoi.[Ordered Quantity]\r\n    ,\t\t\tpoi.[Approval Status]\r\n    ,\t\t\tpoi.[Mode of Transport]\r\n    ,\t\t\tpoi.[Freight Terms]\r\n    ,\t\t\tpoi.[Invoice Number]\r\n    ,\t\t\tpoi.[Order Status]\r\n    ,\t\t\tpoi.[Transaction Date]\r\n    ,\t\t\tpoi.[Invoice Amount]\r\n    ,\t\t\tpoi.[EUR USD]\r\n    ,\t\t\tpoi.[EUR GBP]\r\n    ,\t\t\tCAST(GETDATE() AS DATE) AS [DateStamp]\r\n\tINTO\t\t[SupplyChain].[PurchaseInvoicesAndContractNumber]\r\n\tFROM\t\t[Finance].[PurchaseOrdersAndinvoices] poi\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tDISTINCT [Purchase Order Number]\r\n\t\t\t\t\t,\t\t\t[From Header ID]\r\n\t\t\t\t\t,\t\t\t[From Line ID]\r\n\t\t\t\t\tFROM\t\tCore.PurchaseOrders\r\n\t\t\t\t) po\r\n\tON\t\t\tpoi.[Order Number] = po.[Purchase Order Number]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tDISTINCT [Blanket Purchase Agreement Number]\r\n\t\t\t\t\t,\t\t\t[PO Header ID]\r\n\t\t\t\t\t,\t\t\t[PO Line ID]\r\n\t\t\t\t\tFROM\t\tCore.PurchaseContracts\r\n\t\t\t\t) pc\r\n\tON\t\t\tpo.[From Header ID] = pc.[PO Header ID]\r\n\tAND\t\t\tpo.[From Line ID] = pc.[PO Line ID]\r\n\tWHERE\t\t[poi].[Business Unit] NOT IN ('ROTIE BU','Quatra BU')"
								}
							],
							"scriptBlockExecutionTimeout": "02:00:00"
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"folder": {
					"name": "Supply Chain"
				},
				"annotations": []
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/SQL_ShippingData')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "Shipping Data",
						"type": "Script",
						"dependsOn": [],
						"policy": {
							"timeout": "7.00:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"linkedServiceName": {
							"referenceName": "SqlServerArgent",
							"type": "LinkedServiceReference"
						},
						"typeProperties": {
							"scripts": [
								{
									"type": "NonQuery",
									"text": " /********************************************************************************************************\r\n\tStep 5.1:\tCombine shipping files\r\n********************************************************************************************************/\t\r\n\r\nIF OBJECT_ID('[SupplyChain].[Shipping]','U') IS NOT NULL\r\n\t\tDROP TABLE [SupplyChain].[Shipping]\r\n\t\r\n\tSELECT\t\tROW_NUMBER()OVER(ORDER BY [Country]) AS [Index]\r\n\t,\t\t\t*\r\n\tINTO\t\t[SupplyChain].[Shipping]\r\n\tFROM\t\t(\r\n\r\n\t\t\t\t\tSELECT\t\t'UK'\t\t\tAS [Country]\r\n\t\t\t\t\t,\t\t\t[Product]\r\n\t\t\t\t\t,\t\t\t[BL date]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN [Planned] LIKE '%RTD%' OR [Planned] LIKE '%Rtm%' OR [Planned] LIKE '%Rotterdam%' OR [Planned] LIKE '% Rdam%'\r\n\t\t\t\t\t\t\t\t\t\tTHEN 'Rotterdam'\r\n\t\t\t\t\t\t\t\t\tWHEN [Planned] LIKE '%Ams%'\r\n\t\t\t\t\t\t\t\t\t\tTHEN 'Amsterdam'\r\n\t\t\t\t\t\t\t\t\tWHEN [Planned] LIKE '%Klang%'\r\n\t\t\t\t\t\t\t\t\t\tTHEN 'Port Klang'\r\n\t\t\t\t\t\t\t\t\tWHEN [Planned] LIKE '%Savona%'\r\n\t\t\t\t\t\t\t\t\t\tTHEN 'Port Klang'\r\n\t\t\t\t\t\t\t\t\tELSE NULL\r\n\t\t\t\t\t\t\t\tEND\t\t\tAS [Planned Port]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN [Planned] IS NULL\r\n\t\t\t\t\t\t\t\t\t\tTHEN NULL\r\n\t\t\t\t\t\t\t\t\tWHEN TRY_CAST([Planned] AS DATE) IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\tTHEN [Planned]\r\n\t\t\t\t\t\t\t\t\tWHEN [Planned] LIKE 'end%'\r\n\t\t\t\t\t\t\t\t\t\tTHEN CAST(CAST(CONCAT('30 ',RIGHT([Planned],LEN([Planned])-CHARINDEX('-',[Planned],1)),' 2023') AS DATE) AS NVARCHAR(255))\r\n\t\t\t\t\t\t\t\t\tELSE CAST(CAST(REPLACE(CONCAT(RIGHT(REPLACE(REPLACE(REPLACE([Planned],'17-Mar','17 Mar'),' Port Klang',''),' Ams',''),6),' 2023'),'  ',' ') AS DATE) AS NVARCHAR(255))\r\n\t\t\t\t\t\t\t\tEND\tAS [Planned Date]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN [ATA Stanlow] IS NULL\r\n\t\t\t\t\t\t\t\t\t\tTHEN NULL\r\n\t\t\t\t\t\t\t\t\tWHEN TRY_CAST([ATA Stanlow] AS DATE) IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\tTHEN [ATA Stanlow]\r\n\t\t\t\t\t\t\t\t\tELSE CAST(CAST(REPLACE(CONCAT(RIGHT(NULLIF(NULLIF([ATA Stanlow],'Vasto'),'Port Klang'),6),' 2023'),'  ','') AS DATE) AS NVARCHAR(255))\r\n\t\t\t\t\t\t\t\tEND\tAS [ATA Date]\r\n\t\t\t\t\t,\t\t\t[Vessel]\r\n\t\t\t\t\t,\t\t\t[mothervessel]\r\n\t\t\t\t\t,\t\t\t[x] AS [Vessel Transfer Indicator]\r\n\t\t\t\t\t,\t\t\t[Customer]\r\n\t\t\t\t\t,\t\t\t[L/D]\r\n\t\t\t\t\t,\t\t\t[Tonnage]\t\t\r\n\t\t\t\t\t,\t\t\tLTRIM(RTRIM(REPLACE([Oracle Contract nr.],'+','/'))) AS [Oracle Contract nr.]\r\n\t\t\t\t\t,\t\t\tLTRIM(RTRIM(REPLACE([Oracle Order nr.],'+','/')))  AS [Oracle Order nr.]\r\n\t\t\t\t\t,\t\t\tLTRIM(RTRIM(REPLACE([Self-procurement orders],'+','/'))) AS [Self-procurement orders]\r\n\t\t\t\t\t,\t\t\tLTRIM(RTRIM(REPLACE([Transport  orders],'+','/'))) AS [Transport orders]\r\n\t\t\t\t\tFROM\t\t[RAW].[SC.Shipping2023UK]\r\n\t\t\t\t\tWHERE\t\t[Product] IS NOT NULL\r\n\t\t\t\t\tAND\t\t\t[Product] <> 'Product'\r\n\r\n\t\t\t\t\tUNION ALL\r\n\r\n\t\t\t\t\tSELECT\t\t'UK' AS [Country]\r\n\t\t\t\t\t,\t\t\t[Product]\r\n\t\t\t\t\t,\t\t\t[BL date]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN [Planned] LIKE '%RTD%' OR [Planned] LIKE '%Rtm%' OR [Planned] LIKE '%Rotterdam%' OR [Planned] LIKE '% Rdam%'\r\n\t\t\t\t\t\t\t\t\t\tTHEN 'Rotterdam'\r\n\t\t\t\t\t\t\t\t\tWHEN [Planned] LIKE '%Ams%'\r\n\t\t\t\t\t\t\t\t\t\tTHEN 'Amsterdam'\r\n\t\t\t\t\t\t\t\t\tWHEN [Planned] LIKE '%Klang%'\r\n\t\t\t\t\t\t\t\t\t\tTHEN 'Port Klang'\r\n\t\t\t\t\t\t\t\t\tWHEN [Planned] LIKE '%Savona%'\r\n\t\t\t\t\t\t\t\t\t\tTHEN 'Port Klang'\r\n\t\t\t\t\t\t\t\t\tELSE NULL\r\n\t\t\t\t\t\t\t\tEND AS [Planned Port]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN [Planned] = 'Amsterdam' OR [Planned] IS NULL\r\n\t\t\t\t\t\t\t\t\t\tTHEN NULL\r\n\t\t\t\t\t\t\t\t\tWHEN TRY_CAST([Planned] AS DATE) IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\tTHEN [Planned]\r\n\t\t\t\t\t\t\t\t\tELSE CAST(CAST(REPLACE(REPLACE(CONCAT(RIGHT(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE([Planned],'Rdam',''),'Rtm ',''),' Ams',''),'Rtd',''),'Ams ',''),'Sept','Sep'),6),' 2022'),'  ',' '),'-',' ') AS DATE) AS NVARCHAR(255))\r\n\t\t\t\t\t\t\t\tEND AS [Planned Date]\r\n\t\t\t\t\t,\t\t\tNULLIF([ATA],'Amsterdam') AS [ATA Date]\r\n\t\t\t\t\t,\t\t\t[Vessel]\r\n\t\t\t\t\t,\t\t\t[mothervessel]\r\n\t\t\t\t\t,\t\t\t'' AS [Vessel Transfer Indicator]\r\n\t\t\t\t\t,\t\t\t[Customer]\r\n\t\t\t\t\t,\t\t\t[L/D]\r\n\t\t\t\t\t,\t\t\t[Tonnage]\r\n\t\t\t\t\t,\t\t\tLTRIM(RTRIM(REPLACE([Oracle Contract nr.],'+','/'))) AS [Oracle Contract nr.]\r\n\t\t\t\t\t,\t\t\tLTRIM(RTRIM(REPLACE([Oracle Order nr.],'+','/'))) AS [Oracle Order nr.]\t\r\n\t\t\t\t\t,\t\t\tLTRIM(RTRIM(REPLACE([Self-procurement orders],'+','/'))) AS [Self-procurement orders]\r\n\t\t\t\t\t,\t\t\tLTRIM(RTRIM(REPLACE([Transport orders],'+','/'))) AS [Transport orders]\r\n\t\t\t\t\tFROM\t\t[RAW].[SC.Shipping2022UK]\r\n\t\t\t\t\tWHERE\t\t[Product] IS NOT NULL\r\n\r\n\t\t\t\t\tUNION ALL\r\n\r\n\t\t\t\t\tSELECT\t\t'NL' AS [Country]\r\n\t\t\t\t\t,\t\t\t[Product]\r\n\t\t\t\t\t,\t\t\tNULL AS [BL Date]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN [Planned] LIKE '%RTD%' OR [Planned] LIKE '%Rtm%' OR [Planned] LIKE '%Rotterdam%' OR [Planned] LIKE '% Rdam%'\r\n\t\t\t\t\t\t\t\t\t\tTHEN 'Rotterdam'\r\n\t\t\t\t\t\t\t\t\tWHEN [Planned] LIKE '%Ams%'\r\n\t\t\t\t\t\t\t\t\t\tTHEN 'Amsterdam'\r\n\t\t\t\t\t\t\t\t\tWHEN [Planned] LIKE '%Klang%'\r\n\t\t\t\t\t\t\t\t\t\tTHEN 'Port Klang'\r\n\t\t\t\t\t\t\t\t\tWHEN [Planned] LIKE '%Savona%'\r\n\t\t\t\t\t\t\t\t\t\tTHEN 'Port Klang'\r\n\t\t\t\t\t\t\t\t\tELSE NULL\r\n\t\t\t\t\t\t\t\tEND AS [Planned Port]\r\n\t\t\t\t\t,\t\t\t[Planned] AS [Planned Date]\r\n\t\t\t\t\t,\t\t\t[ATA] AS [ATA Date]\r\n\t\t\t\t\t,\t\t\t[Vessel]\r\n\t\t\t\t\t,\t\t\t'' AS [mothervessel]\r\n\t\t\t\t\t,\t\t\t'' AS [Vessel Transfer Indicator]\r\n\t\t\t\t\t,\t\t\t[Customer]\r\n\t\t\t\t\t,\t\t\t[L/D]\r\n\t\t\t\t\t,\t\t\t[Tonnage]\r\n\t\t\t\t\t,\t\t\tLTRIM(RTRIM(REPLACE([Contract],'+','/'))) AS [Oracle Contract nr.]\r\n\t\t\t\t\t,\t\t\tLTRIM(RTRIM(REPLACE(REPLACE([Order],'4 8','4/8'),'+','/')))  AS [Oracle Order nr.]\t\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN [T or Self-procument] LIKE '%T'\r\n\t\t\t\t\t\t\t\t\t\tTHEN NULL\r\n\t\t\t\t\t\t\t\t\tELSE LTRIM(RTRIM(REPLACE([T or Self-procument],'+','/')))\r\n\t\t\t\t\t\t\t\tEND AS [Self-procurement orders]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN [T or Self-procument] LIKE '%T'\r\n\t\t\t\t\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE([T or Self-procument],'+','/')))\r\n\t\t\t\t\t\t\t\t\tELSE NULL\r\n\t\t\t\t\t\t\t\tEND AS [Transport orders]\r\n\t\t\t\t\tFROM\t\t[RAW].[SC.ShippingNL]\r\n\t\t\t\t\tWHERE\t\t[Product] IS NOT NULL\r\n\t\t\t) x\r\n\tWHERE\t[Product] <> 'Product'\r\n\r\n /********************************************************************************************************\r\n\tStep 5.2:\tSeparate order numbers and unpivot data to create list of order numbers\r\n\t\t\t\tper shipping index.\r\n********************************************************************************************************/\t\r\n\tIF OBJECT_ID('tempdb..#ShippingSeparatedContractsAndOrders/','U') IS NOT NULL\r\n\t\tDROP TABLE #ShippingSeparatedContractsAndOrders\r\n\t\r\n\tSELECT\t\t[s].[Index]\r\n\t,\t\t\t[Country]\r\n\t,\t\t\t[Product]\r\n\t,\t\t\t[BL Date]\r\n\t,\t\t\t[Planned Port]\r\n\t,\t\t\t[Planned Date]\r\n\t,\t\t\t[ATA Date]\r\n\t,\t\t\t[Vessel]\r\n\t,\t\t\t[Customer]\r\n\t,\t\t\t[L/D]\r\n\t,\t\t\t[Tonnage]\r\n\t,\t\t\t[Oracle Contract nr.]\r\n\t,\t\t\t[Oracle Order nr.]\r\n\t,\t\t\t[Self-procurement orders]\r\n\t,\t\t\t[Transport orders]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [Oracle Order nr.] NOT LIKE '%/%'\r\n\t\t\t\t\t\tTHEN [Oracle Order nr.]\r\n\t\t\t\t\tELSE LTRIM(RTRIM(REPLACE(SUBSTRING([Oracle Order nr.],1,[OrderSeparatorIndex1]),'/','')))\r\n\t\t\t\tEND AS [Order1]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [NumberOfOrders] = 2\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Oracle Order nr.],[OrderSeparatorIndex1],LEN([Oracle Order nr.])),'/','')))\r\n\t\t\t\t\tWHEN [NumberOfOrders] > 2\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Oracle Order nr.],[OrderSeparatorIndex1],[OrderSeparatorIndex2]-[OrderSeparatorIndex1]),'/','')))\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [Order2]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [NumberOfOrders] = 3\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Oracle Order nr.],[OrderSeparatorIndex2],LEN([Oracle Order nr.])),'/','')))\r\n\t\t\t\t\tWHEN [NumberOfOrders] > 3\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Oracle Order nr.],[OrderSeparatorIndex2],[OrderSeparatorIndex3]-[OrderSeparatorIndex2]),'/','')))\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [Order3]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [NumberOfOrders] = 4\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Oracle Order nr.],[OrderSeparatorIndex3],LEN([Oracle Order nr.])),'/','')))\r\n\t\t\t\t\tWHEN [NumberOfOrders] > 4\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Oracle Order nr.],[OrderSeparatorIndex3],[OrderSeparatorIndex4]-[OrderSeparatorIndex3]),'/','')))\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [Order4]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [NumberOfOrders] = 5\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Oracle Order nr.],[OrderSeparatorIndex4],LEN([Oracle Order nr.])),'/','')))\r\n\t\t\t\tEND AS [Order5]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [Self-procurement orders] NOT LIKE '%/%'\r\n\t\t\t\t\t\tTHEN [Self-procurement orders]\r\n\t\t\t\t\tELSE LTRIM(RTRIM(REPLACE(SUBSTRING([Self-procurement orders],1,[SP_OrderSeparatorIndex1]),'/','')))\r\n\t\t\t\tEND AS [SP_Order1]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [NumberOf_SP_Orders] = 2\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Self-procurement orders],[SP_OrderSeparatorIndex1],LEN([Self-procurement orders])),'/','')))\r\n\t\t\t\t\tWHEN [NumberOf_SP_Orders] > 2\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Self-procurement orders],[SP_OrderSeparatorIndex1],[SP_OrderSeparatorIndex2]-[SP_OrderSeparatorIndex1]),'/','')))\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [SP_Order2]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [NumberOf_SP_Orders] = 3\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Self-procurement orders],[SP_OrderSeparatorIndex2],LEN([Self-procurement orders])),'/','')))\r\n\t\t\t\t\tWHEN [NumberOf_SP_Orders] > 3\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Self-procurement orders],[SP_OrderSeparatorIndex2],[SP_OrderSeparatorIndex3]-[SP_OrderSeparatorIndex2]),'/','')))\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [SP_Order3]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [NumberOf_SP_Orders] = 4\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Self-procurement orders],[SP_OrderSeparatorIndex3],LEN([Self-procurement orders])),'/','')))\r\n\t\t\t\t\tWHEN [NumberOf_SP_Orders] > 4\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Self-procurement orders],[SP_OrderSeparatorIndex3],[SP_OrderSeparatorIndex4]-[SP_OrderSeparatorIndex3]),'/','')))\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [SP_Order4]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [NumberOf_SP_Orders] = 5\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Self-procurement orders],[SP_OrderSeparatorIndex4],LEN([Self-procurement orders])),'/','')))\r\n\t\t\t\tEND AS [SP_Order5]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [Transport orders] NOT LIKE '%/%'\r\n\t\t\t\t\t\tTHEN [Transport orders]\r\n\t\t\t\t\tELSE LTRIM(RTRIM(REPLACE(SUBSTRING([Transport orders],1,[T_OrderSeparatorIndex1]),'/','')))\r\n\t\t\t\tEND AS [T_Order1]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [NumberOf_T_Orders] = 2\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Transport orders],[T_OrderSeparatorIndex1],LEN([Transport orders])),'/','')))\r\n\t\t\t\t\tWHEN [NumberOf_T_Orders] > 2\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Transport orders],[T_OrderSeparatorIndex1],[T_OrderSeparatorIndex2]-[T_OrderSeparatorIndex1]),'/','')))\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [T_Order2]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [NumberOf_T_Orders] = 3\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Transport orders],[T_OrderSeparatorIndex2],LEN([Transport orders])),'/','')))\r\n\t\t\t\t\tWHEN [NumberOf_T_Orders] > 3\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Transport orders],[T_OrderSeparatorIndex2],[T_OrderSeparatorIndex3]-[T_OrderSeparatorIndex2]),'/','')))\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [T_Order3]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [NumberOf_T_Orders] = 4\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Transport orders],[T_OrderSeparatorIndex3],LEN([Transport orders])),'/','')))\r\n\t\t\t\t\tWHEN [NumberOf_T_Orders] > 4\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Transport orders],[T_OrderSeparatorIndex3],[T_OrderSeparatorIndex4]-[T_OrderSeparatorIndex3]),'/','')))\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [T_Order4]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [NumberOf_T_Orders] = 5\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Transport orders],[T_OrderSeparatorIndex4],LEN([Transport orders])),'/','')))\r\n\t\t\t\tEND AS [T_Order5]\r\n\tINTO\t\t#ShippingSeparatedContractsAndOrders\r\n\tFROM\t\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\t,\t\t\tLEN([Oracle Order nr.]) - LEN(REPLACE([Oracle Order nr.],'/','')) + 1 AS [NumberOfOrders]\r\n\t\t\t\t\t,\t\t\tLEN([Oracle Order nr.]) - LEN(REPLACE([Oracle Order nr.],'/','')) AS [NumberOfOrderSeparators]\r\n\t\t\t\t\t,\t\t\tCHARINDEX('/',[Oracle Order nr.],1) AS [OrderSeparatorIndex1]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN LEN([Oracle Order nr.]) - LEN(REPLACE([Oracle Order nr.],'/','')) > 1\r\n\t\t\t\t\t\t\t\t\t\tTHEN CHARINDEX('/',[Oracle Order nr.],CHARINDEX('/',[Oracle Order nr.])+1)\r\n\t\t\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\t\t\tEND AS [OrderSeparatorIndex2]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN LEN([Oracle Order nr.]) - LEN(REPLACE([Oracle Order nr.],'/','')) > 2\r\n\t\t\t\t\t\t\t\t\t\tTHEN CHARINDEX('/',[Oracle Order nr.],CHARINDEX('/',[Oracle Order nr.],CHARINDEX('/',[Oracle Order nr.])+1)+1)\r\n\t\t\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\t\t\tEND AS [OrderSeparatorIndex3]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN LEN([Oracle Order nr.]) - LEN(REPLACE([Oracle Order nr.],'/','')) > 3\r\n\t\t\t\t\t\t\t\t\t\tTHEN CHARINDEX('/',[Oracle Order nr.],CHARINDEX('/',[Oracle Order nr.],CHARINDEX('/',[Oracle Order nr.],CHARINDEX('/',[Oracle Order nr.])+1)+1)+1)\r\n\t\t\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\t\t\tEND AS [OrderSeparatorIndex4]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN LEN([Oracle Order nr.]) - LEN(REPLACE([Oracle Order nr.],'/','')) > 4\r\n\t\t\t\t\t\t\t\t\t\tTHEN CHARINDEX('/',[Oracle Order nr.],CHARINDEX('/',[Oracle Order nr.],CHARINDEX('/',[Oracle Order nr.],CHARINDEX('/',[Oracle Order nr.],CHARINDEX('/',[Oracle Order nr.])+1)+1)+1)+1)\r\n\t\t\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\t\t\tEND AS [OrderSeparatorIndex5]\r\n\t\t\t\t\t,\t\t\tLEN([Self-procurement orders]) - LEN(REPLACE([Self-procurement orders],'/','')) + 1 AS [NumberOf_SP_Orders]\r\n\t\t\t\t\t,\t\t\tLEN([Self-procurement orders]) - LEN(REPLACE([Self-procurement orders],'/','')) AS [NumberOf_SP_OrderSeparators]\r\n\t\t\t\t\t,\t\t\tCHARINDEX('/',[Self-procurement orders],1) AS [SP_OrderSeparatorIndex1]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN LEN([Self-procurement orders]) - LEN(REPLACE([Self-procurement orders],'/','')) > 1\r\n\t\t\t\t\t\t\t\t\t\tTHEN CHARINDEX('/',[Self-procurement orders],CHARINDEX('/',[Self-procurement orders])+1)\r\n\t\t\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\t\t\tEND AS [SP_OrderSeparatorIndex2]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN LEN([Self-procurement orders]) - LEN(REPLACE([Self-procurement orders],'/','')) > 2\r\n\t\t\t\t\t\t\t\t\t\tTHEN CHARINDEX('/',[Self-procurement orders],CHARINDEX('/',[Self-procurement orders],CHARINDEX('/',[Self-procurement orders])+1)+1)\r\n\t\t\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\t\t\tEND AS [SP_OrderSeparatorIndex3]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN LEN([Self-procurement orders]) - LEN(REPLACE([Self-procurement orders],'/','')) > 3\r\n\t\t\t\t\t\t\t\t\t\tTHEN CHARINDEX('/',[Self-procurement orders],CHARINDEX('/',[Self-procurement orders],CHARINDEX('/',[Self-procurement orders],CHARINDEX('/',[Self-procurement orders])+1)+1)+1)\r\n\t\t\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\t\t\tEND AS [SP_OrderSeparatorIndex4]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN LEN([Self-procurement orders]) - LEN(REPLACE([Self-procurement orders],'/','')) > 4\r\n\t\t\t\t\t\t\t\t\t\tTHEN CHARINDEX('/',[Self-procurement orders],CHARINDEX('/',[Self-procurement orders],CHARINDEX('/',[Self-procurement orders],CHARINDEX('/',[Self-procurement orders],CHARINDEX('/',[Self-procurement orders])+1)+1)+1)+1)\r\n\t\t\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\t\t\tEND AS [SP_OrderSeparatorIndex5]\r\n\t\t\t\t\t,\t\t\tLEN([Transport orders]) - LEN(REPLACE([Transport orders],'/','')) + 1 AS [NumberOf_T_Orders]\r\n\t\t\t\t\t,\t\t\tLEN([Transport orders]) - LEN(REPLACE([Transport orders],'/','')) AS [NumberOf_T_OrderSeparators]\r\n\t\t\t\t\t,\t\t\tCHARINDEX('/',[Transport orders],1) AS [T_OrderSeparatorIndex1]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN LEN([Transport orders]) - LEN(REPLACE([Transport orders],'/','')) > 1\r\n\t\t\t\t\t\t\t\t\t\tTHEN CHARINDEX('/',[Transport orders],CHARINDEX('/',[Transport orders])+1)\r\n\t\t\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\t\t\tEND AS [T_OrderSeparatorIndex2]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN LEN([Transport orders]) - LEN(REPLACE([Transport orders],'/','')) > 2\r\n\t\t\t\t\t\t\t\t\t\tTHEN CHARINDEX('/',[Transport orders],CHARINDEX('/',[Transport orders],CHARINDEX('/',[Transport orders])+1)+1)\r\n\t\t\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\t\t\tEND AS [T_OrderSeparatorIndex3]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN LEN([Transport orders]) - LEN(REPLACE([Transport orders],'/','')) > 3\r\n\t\t\t\t\t\t\t\t\t\tTHEN CHARINDEX('/',[Transport orders],CHARINDEX('/',[Transport orders],CHARINDEX('/',[Transport orders],CHARINDEX('/',[Transport orders])+1)+1)+1)\r\n\t\t\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\t\t\tEND AS [T_OrderSeparatorIndex4]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN LEN([Transport orders]) - LEN(REPLACE([Transport orders],'/','')) > 4\r\n\t\t\t\t\t\t\t\t\t\tTHEN CHARINDEX('/',[Transport orders],CHARINDEX('/',[Transport orders],CHARINDEX('/',[Transport orders],CHARINDEX('/',[Transport orders],CHARINDEX('/',[Transport orders])+1)+1)+1)+1)\r\n\t\t\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\t\t\tEND AS [T_OrderSeparatorIndex5]\r\n\t\t\t\t\tFROM\t\tSupplyChain.Shipping \r\n\t\t\t\t) s\r\n\r\n\tSELECT\t\t*\r\n\tINTO\t\t#ShippingOrdersUnpivot\r\n\tFROM\t\t(\r\n\t\t\t\t\tSELECT\t\t[b].[Index]\r\n\t\t\t\t\t,\t\t\t[b].[Country]\r\n\t\t\t\t\t,\t\t\t[b].[BL date]\r\n\t\t\t\t\t,\t\t\t[b].[Planned Port]\r\n\t\t\t\t\t,\t\t\t[b].[Planned Date]\r\n\t\t\t\t\t,\t\t\t[b].[ATA Date]\r\n\t\t\t\t\t,\t\t\t[b].[Vessel]\r\n\t\t\t\t\t,\t\t\t[b].[Customer]\r\n\t\t\t\t\t,\t\t\t[b].[L/D]\r\n\t\t\t\t\t,\t\t\t[b].[Tonnage]\r\n\t\t\t\t\t,\t\t\tREPLACE([Order Number],'SO','') AS [Order Number]\r\n\t\t\t\t\t,\t\t\t'Standard' AS [Order Type] \r\n\t\t\t\t\tFROM\t\t#ShippingSeparatedContractsAndOrders a\r\n\t\t\t\t\tUNPIVOT\t\t([Order Number] FOR [Order] IN ([Order1],[Order2],[Order3],[Order4],[Order5])) b\r\n\t\t\t\t\t\r\n\t\t\t\t\tUNION ALL\r\n\r\n\t\t\t\t\tSELECT\t\t[b].[Index]\r\n\t\t\t\t\t,\t\t\t[b].[Country]\r\n\t\t\t\t\t,\t\t\t[b].[BL date]\r\n\t\t\t\t\t,\t\t\t[b].[Planned Port]\r\n\t\t\t\t\t,\t\t\t[b].[Planned Date]\r\n\t\t\t\t\t,\t\t\t[b].[ATA Date]\r\n\t\t\t\t\t,\t\t\t[b].[Vessel]\r\n\t\t\t\t\t,\t\t\t[b].[Customer]\r\n\t\t\t\t\t,\t\t\t[b].[L/D]\r\n\t\t\t\t\t,\t\t\t[b].[Tonnage]\r\n\t\t\t\t\t,\t\t\tREPLACE([b].[SP Order Number],'SO','') AS [Order Number]\r\n\t\t\t\t\t,\t\t\t'Self-Procurement' AS [Order Type]\r\n\t\t\t\t\tFROM\t\t#ShippingSeparatedContractsAndOrders\r\n\t\t\t\t\tUNPIVOT\t\t([SP Order Number] FOR [S-P Order] IN([SP_Order1],[SP_Order2],[SP_Order3],[SP_Order4],[SP_Order5])) b\r\n\r\n\t\t\t\t\tUNION ALL\r\n\r\n\t\t\t\t\tSELECT\t\t[b].[Index]\r\n\t\t\t\t\t,\t\t\t[b].[Country]\r\n\t\t\t\t\t,\t\t\t[b].[BL date]\r\n\t\t\t\t\t,\t\t\t[b].[Planned Port]\r\n\t\t\t\t\t,\t\t\t[b].[Planned Date]\r\n\t\t\t\t\t,\t\t\t[b].[ATA Date]\r\n\t\t\t\t\t,\t\t\t[b].[Vessel]\r\n\t\t\t\t\t,\t\t\t[b].[Customer]\r\n\t\t\t\t\t,\t\t\t[b].[L/D]\r\n\t\t\t\t\t,\t\t\t[b].[Tonnage]\r\n\t\t\t\t\t,\t\t\tREPLACE([b].[T Order Number],'SO','') AS [Order Number]\r\n\t\t\t\t\t,\t\t\t'Transport' AS [Order Type]\r\n\t\t\t\t\tFROM\t\t#ShippingSeparatedContractsAndOrders\r\n\t\t\t\t\tUNPIVOT\t\t([T Order Number] FOR [T Order] IN([T_Order1],[T_Order2],[T_Order3],[T_Order4],[T_Order5])) b\r\n\t\t\t\t) u\r\n\tORDER BY\t[Index]\r\n\r\n /********************************************************************************************************\r\n\tStep 5.3:\tCreate final shipping contracts table\r\n********************************************************************************************************/\t\r\n\r\nIF OBJECT_ID('SupplyChain.ShippingContracts','U') IS NOT NULL\r\n\t\tDROP TABLE SupplyChain.ShippingContracts\r\n\r\n\tSELECT\t\tu.*\r\n\t,\t\t\tCOALESCE(poi.[Agreement Number/Sales Contract Number],soi.[Sales Contract Number]) AS [Agreement/Sales Contract Number]\r\n\t,\t\t\tCOALESCE(poi.[Transaction Date],soi.[Transaction Date]) AS [Transaction Date]\r\n\t,\t\t\tCOALESCE(poi.[Invoiced Quantity],soi.[Invoiced Quantity]) AS [Invoiced Quantity]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN TRY_CAST([u].[Order Number] AS FLOAT) IS NULL THEN 'Purchases'\r\n\t\t\t\t\tELSE 'Sales'\r\n\t\t\t\tEND AS [Sales/Purchase]\r\n\t,\t\t\tpoi.[Inventory Organization Code]\r\n\t,\t\t\tpoi.[Inventory Organization Name]\r\n\t,\t\t\tpoi.[Approval Status]\r\n\t,\t\t\tpoi.[Order Status]\t\t\t\r\n\t,\t\t\tCOALESCE(poi.[Supplier/Customer Number],sc.[Customer Number]) AS [Supplier/Customer Number]\r\n\t,\t\t\tCOALESCE(pc.[Supplier Name],sc.[Customer]) AS [Supplier/Customer]\t\t\r\n\t,\t\t\ti.[Item Code]\r\n\t,\t\t\ti.[Item Name]\r\n\t,\t\t\tCOALESCE(poi.[Mode of Transport],sc.[Shipping Method]) AS [Shipping Method]\r\n\t,\t\t\tCOALESCE(poi.[Business Unit],soi.[Business Unit Name],pc.[Business Unit Name],sc.[Business Unit Name]) AS [Business Unit Name]\r\n\t,\t\t\tCAST(LEFT(so.[Request Ship Date],10) AS DATE) AS [Request Ship Date]\r\n\t,\t\t\tCAST(LEFT(so.[Schedule Ship Date],10) AS DATE) AS [Schedule Ship Date]\r\n\t,\t\t\tCAST(LEFT(po.[Requested Date],10) AS DATE) AS [Requested Date]\r\n\t,\t\t\tCAST(LEFT([Pick up Date],10) AS DATE) AS [Pick Up Date]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN TRY_CAST([u].[Order Number] AS FLOAT) IS NULL\r\n\t\t\t\t\t\tTHEN bu.[Country]\r\n\t\t\t\t\tELSE COALESCE(l2.[Country],l3.[Country],l4.[Country])\r\n\t\t\t\tEND AS [Ship To Country]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN TRY_CAST([u].[Order Number] AS FLOAT) IS NULL\r\n\t\t\t\t\t\tTHEN bu.[City]\r\n\t\t\t\t\tELSE COALESCE(l2.[City],L3.[City],l4.[City])\r\n\t\t\t\tEND AS [Ship To City]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN TRY_CAST([u].[Order Number] AS FLOAT) IS NULL\r\n\t\t\t\t\t\tTHEN bu.[Postal Code]\r\n\t\t\t\t\tELSE COALESCE(l2.[Postal Code],l3.[Postal Code],l4.[Postal Code])\r\n\t\t\t\tEND AS [Ship To Postal Code]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN TRY_CAST([u].[Order Number] AS FLOAT) IS NULL\r\n\t\t\t\t\t\tTHEN bu.[Address]\r\n\t\t\t\t\tELSE COALESCE(l2.[Address],l3.[Address],l4.[Address])\r\n\t\t\t\tEND AS [Ship To Address]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN TRY_CAST([u].[Order Number] AS FLOAT) IS NULL\r\n\t\t\t\t\t\tTHEN bu.[Business Unit Name]\r\n\t\t\t\t\tELSE COALESCE(l2.[Company Name],l3.[Company Name],l4.[Company Name])\r\n\t\t\t\tEND AS [Ship To Company]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN TRY_CAST([u].[Order Number] AS FLOAT) IS NULL\r\n\t\t\t\t\t\tTHEN COALESCE(l1.[Country],l5.[Country])\r\n\t\t\t\t\tELSE bu.[Country]\r\n\t\t\t\tEND AS [Ship From Country]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN TRY_CAST([u].[Order Number] AS FLOAT) IS NULL\r\n\t\t\t\t\t\tTHEN COALESCE(l1.[City],l5.[City])\r\n\t\t\t\t\tELSE bu.[City]\r\n\t\t\t\tEND AS [Ship From City]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN TRY_CAST([u].[Order Number] AS FLOAT) IS NULL\r\n\t\t\t\t\t\tTHEN COALESCE(l1.[Postal Code],L5.[Postal Code])\r\n\t\t\t\t\tELSE bu.[Postal Code]\r\n\t\t\t\tEND AS [Ship From Postal Code]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN TRY_CAST([u].[Order Number] AS FLOAT) IS NULL\r\n\t\t\t\t\t\tTHEN COALESCE(l1.[Address],NULLIF(REPLACE(CONCAT([l5].[Company Name],',',ISNULL([l5].[Address Line 2],''),',',ISNULL([l5].[Address Line 3],'')),',,',','),','))\r\n\t\t\t\t\tELSE bu.[Address]\r\n\t\t\t\tEND AS [Ship From Address]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN TRY_CAST([u].[Order Number] AS FLOAT) IS NULL\r\n\t\t\t\t\t\tTHEN COALESCE(l1.[Company Name],l5.[Company Name])\r\n\t\t\t\t\tELSE bu.[Business Unit Name]\t\r\n\t\t\t\tEND AS [Ship From Company]\r\n\tINTO\t\tSupplyChain.ShippingContracts\r\n\tFROM\t\t#ShippingOrdersUnpivot u\r\n\tLEFT JOIN\t[Core].[PurchaseOrders] po\r\n\tON\t\t\tpo.[Purchase Order Number] = u.[Order Number]\r\n\tLEFT JOIN\t[Core].[SalesOrders] so\r\n\tON\t\t\tso.[Order Number] = u.[Order Number]\r\n\tAND\t\t\tLEN(u.[Order Number]) <> 3\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tDISTINCT [PO Header ID]\r\n\t\t\t\t\t,\t\t\t[PO Line ID]\r\n\t\t\t\t\t,\t\t\t[Ship From Location ID]\r\n\t\t\t\t\t,\t\t\t[Deliver To Location ID]\r\n\t\t\t\t\t,\t\t\t[Transaction Type]\r\n\t\t\t\t\tFROM\t\t[Core].[ReceivingTransactions]\r\n\t\t\t\t) rt\r\n\tON\t\t\tpo.[PO Header ID] = rt.[PO Header ID]\r\n\tAND\t\t\tpo.[PO Line ID] = rt.[PO Line ID]\r\n\tAND\t\t\trt.[Transaction Type] = 'RECEIVE'\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tDISTINCT [SOURCE_HEADER_NUMBER]\r\n\t\t\t\t\t,\t\t\t[SHIP_FROM_LOCATION_ID]\r\n\t\t\t\t\t,\t\t\t[SHIP_TO_LOCATION_ID]\r\n\t\t\t\t\tFROM\t\t[Core].[ShippingDetails]\r\n\t\t\t\t) sd\r\n\tON\t\t\tso.[Order Number] = sd.[SOURCE_HEADER_NUMBER]\r\n\tAND\t\t\tso.[Submitted Flag] = 'Y'\t\r\n\tLEFT JOIN\tSupplyChain.PurchaseInvoicesAndContractNumber poi\r\n\tON\t\t\tpo.[Purchase Order Number] = poi.[Order Number]\r\n\tLEFT JOIN\tSupplyChain.SalesInvoicesAndContractNumber soi\r\n\tON\t\t\tso.[Order Number] = soi.[Order Number]\r\n\tAND\t\t\tsoi.[Invoiced Quantity] <> 0\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Inventory Item ID]\r\n\t\t\t\t\t,\t\t\t[Item Code]\r\n\t\t\t\t\t,\t\t\tMAX([Item Name]) AS [Item Name] \r\n\t\t\t\t\tFROM\t\tCore.Items\r\n\t\t\t\t\tGROUP BY\t[Inventory Item ID]\r\n\t\t\t\t\t,\t\t\t[Item Code]\r\n\t\t\t\t) i\r\n\tON\t\t\ti.[Inventory Item ID] = COALESCE(po.[Item ID],so.[Inventory Item ID])\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tDISTINCT [Sales Contract Number]\r\n\t\t\t\t\t,\t\t\t[Shipping Method]\r\n\t\t\t\t\t,\t\t\t[Business Unit Name]\r\n\t\t\t\t\t,\t\t\t[Customer Ship To]\r\n\t\t\t\t\t,\t\t\t[sc].[Customer]\r\n\t\t\t\t\t,\t\t\t[sc].[Customer Number]\r\n\t\t\t\t\tFROM\t\t[SupplyChain].[SalesContracts] sc\r\n\t\t\t\t\tWHERE\t\tsc.[DateStamp] = (SELECT MAX([DateStamp]) FROM [SupplyChain].[SalesContracts])\r\n\t\t\t\t) sc\r\n\tON\t\t\tCOALESCE(COALESCE(poi.[Agreement Number/Sales Contract Number],soi.[Sales Contract Number]),u.[Order Number]) = sc.[Sales Contract Number]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\t,\t\t\tREPLACE(CONCAT([Company Name],',',ISNULL([Address Line 2],''),',',ISNULL([Address Line 3],'')),',,',',') AS [Address]\r\n\t\t\t\t\tFROM\t\tCore.Locations\r\n\t\t\t\t) l1\r\n\tON\t\t\trt.[Ship From Location ID] = l1.[Location ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\t,\t\t\tREPLACE(CONCAT([Company Name],',',ISNULL([Address Line 2],''),',',ISNULL([Address Line 3],'')),',,',',') AS [Address]\r\n\t\t\t\t\tFROM\t\tCore.Locations\r\n\t\t\t\t) l2\r\n\tON\t\t\tsd.[SHIP_TO_LOCATION_ID] = l2.[Location ID]\r\n\t\tLEFT JOIN\t(\r\n\t\t\t\t\t\tSELECT\t\tDISTINCT [Business Unit Name],\r\n                                    [Blanket Purchase Agreement Number],\r\n\t\t\t\t\t\t\t\t\t[Supplier Name],\r\n                                    DateStamp\r\n\t\t\t\t\t\tFROM\t\tSupplyChain.PurchaseContracts\r\n\t\t\t\t\t\tWHERE\t\t[DateStamp] = (SELECT MAX([DateStamp]) FROM [SupplyChain].PurchaseContracts)\r\n\t\t\t\t) pc\r\n\tON\t\t\tpc.[Blanket Purchase Agreement Number] = COALESCE(COALESCE(poi.[Agreement Number/Sales Contract Number],soi.[Sales Contract Number]),u.[Order Number])\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tDISTINCT [Business Unit Name]\r\n\t\t\t\t\t,\t\t\t[Business Unit ID]\r\n\t\t\t\t\t,\t\t\to.[Party ID]\r\n\t\t\t\t\t,\t\t\tp.[Location ID]\r\n\t\t\t\t\t,\t\t\tl.[Country]\r\n\t\t\t\t\t,\t\t\tl.[City]\r\n\t\t\t\t\t,\t\t\tl.[Postal Code]\r\n\t\t\t\t\t,\t\t\tl.[Company Name]\r\n\t\t\t\t\t,\t\t\tREPLACE(CONCAT([l].[Company Name],',',ISNULL([l].[Address Line 2],''),',',ISNULL([l].[Address Line 3],'')),',,',',') AS [Address]\r\n\t\t\t\t\tFROM\t\tCore.Organizations o\r\n\t\t\t\t\tLEFT JOIN\tCore.Parties p\r\n\t\t\t\t\tON\t\t\tp.[Party ID] = o.[Party ID]\r\n\t\t\t\t\tLEFT JOIN\tCore.Locations l\r\n\t\t\t\t\tON\t\t\tp.[Location ID] = l.[Location ID]\r\n\t\t\t\t\tWHERE\t\to.[Party ID] <> 'N/A'\r\n\t\t\t\t) bu\r\n\tON\t\t\tCOALESCE(poi.[Business Unit],soi.[Business Unit Name],pc.[Business Unit Name],sc.[Business Unit Name]) = bu.[Business Unit Name]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Party ID]\r\n\t\t\t\t\t,\t\t\t[Party Site Name]\r\n\t\t\t\t\t,\t\t\tl.[Country]\r\n\t\t\t\t\t,\t\t\tl.[City]\r\n\t\t\t\t\t,\t\t\tl.[Postal Code]\r\n\t\t\t\t\t,\t\t\tl.[Company Name]\r\n\t\t\t\t\t,\t\t\tREPLACE(CONCAT([l].[Company Name],',',ISNULL([l].[Address Line 2],''),',',ISNULL([l].[Address Line 3],'')),',,',',') AS [Address]\r\n\t\t\t\t\tFROM\t\tCore.Parties p\r\n\t\t\t\t\tLEFT JOIN\tCore.Locations l\r\n\t\t\t\t\tON\t\t\tp.[Location ID] = l.[Location ID]\r\n\t\t\t\t) l3\r\n\tON\t\t\tso.[Sold To Party ID] = l3.[Party ID]\r\n\tAND\t\t\tsc.[Customer Ship To] = l3.[Party Site Name]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Party ID]\r\n\t\t\t\t\t,\t\t\t[Party Site Name]\r\n\t\t\t\t\t,\t\t\tl.[Country]\r\n\t\t\t\t\t,\t\t\tl.[City]\r\n\t\t\t\t\t,\t\t\tl.[Postal Code]\r\n\t\t\t\t\t,\t\t\tREPLACE(CONCAT([l].[Company Name],',',ISNULL([l].[Address Line 2],''),',',ISNULL([l].[Address Line 3],'')),',,',',') AS [Address]\r\n\t\t\t\t\t,\t\t\tl.[Company Name]\r\n\t\t\t\t\tFROM\t\tCore.Parties p\r\n\t\t\t\t\tLEFT JOIN\tCore.Locations l\r\n\t\t\t\t\tON\t\t\tp.[Location ID] = l.[Location ID]\r\n\t\t\t\t\tWHERE\t\tp.[Primary Party Site] = 'Y'\r\n\t\t\t\t\tAND\t\t\tp.[Party Site Name] <> 'Do Not Use'\r\n\t\t\t\t) l4\r\n\tON\t\t\tso.[Sold To Party ID] = l4.[Party ID]\r\n\tLEFT JOIN\tCore.Suppliers su\r\n\tON\t\t\tsu.[Vendor ID] = po.[Supplier]\r\n\tAND\t\t\tsu.[Vendor SIte ID] = po.[Supplier Site]\r\n\tLEFT JOIN\tCore.Locations l5\r\n\tON\t\t\tl5.[Location ID] = su.[Location ID]\r\n\tORDER BY\t[Index], COALESCE(poi.[Transaction Date],soi.[Transaction Date])"
								}
							]
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"folder": {
					"name": "Supply Chain"
				},
				"annotations": []
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/SQL_SubledgerSuppliersCustomers')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "SQL_SubledgerSuppliersCustomers",
						"type": "SqlServerStoredProcedure",
						"dependsOn": [],
						"policy": {
							"timeout": "7.00:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"storedProcedureName": "[[Finance].[SQL_SubledgerSuppliersCustomers]"
						},
						"linkedServiceName": {
							"referenceName": "SqlServerArgent",
							"type": "LinkedServiceReference"
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"folder": {
					"name": "Finance"
				},
				"annotations": [],
				"lastPublishTime": "2022-12-11T15:32:40Z"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/SQL_Subledger_TransactionsList_Blend_CoreTables')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "SQL_Subledger_TL_Blend_CoreTables",
						"type": "SqlServerStoredProcedure",
						"dependsOn": [],
						"policy": {
							"timeout": "7.00:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"storedProcedureName": "[[Finance].[SQL_Subledger_TL_Blend_CoreTables]"
						},
						"linkedServiceName": {
							"referenceName": "SqlServerArgent",
							"type": "LinkedServiceReference"
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"folder": {
					"name": "Finance"
				},
				"annotations": [],
				"lastPublishTime": "2022-12-11T20:19:19Z"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/SQL_TransactionsList')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "SQL_TransactionsList",
						"type": "SqlServerStoredProcedure",
						"dependsOn": [],
						"policy": {
							"timeout": "7.00:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"storedProcedureName": "[[Finance].[SQL_TransactionsList]"
						},
						"linkedServiceName": {
							"referenceName": "SqlServerArgent",
							"type": "LinkedServiceReference"
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"folder": {
					"name": "Finance"
				},
				"annotations": [],
				"lastPublishTime": "2022-12-11T15:32:40Z"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/audit_pipeline')]",
			"type": "Microsoft.DataFactory/factories/pipelines",
			"apiVersion": "2018-06-01",
			"properties": {
				"activities": [
					{
						"name": "audit_tables_rowcounts",
						"description": "This job gets details of row count and puts them in an audit table by calling a stored procedure ",
						"type": "SqlServerStoredProcedure",
						"dependsOn": [],
						"policy": {
							"timeout": "0.01:00:00",
							"retry": 0,
							"retryIntervalInSeconds": 30,
							"secureOutput": false,
							"secureInput": false
						},
						"userProperties": [],
						"typeProperties": {
							"storedProcedureName": "[[dbo].[prc_audit_table_rowcount]"
						},
						"linkedServiceName": {
							"referenceName": "SqlServerArgent",
							"type": "LinkedServiceReference"
						}
					}
				],
				"policy": {
					"elapsedTimeMetric": {},
					"cancelAfter": {}
				},
				"folder": {
					"name": "Audit"
				},
				"annotations": [],
				"lastPublishTime": "2022-08-31T12:30:58Z"
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/Binary_Destination_Oracle')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"description": "Connection to your data destination store.  ",
				"linkedServiceName": {
					"referenceName": "AzureDataLakeStorage",
					"type": "LinkedServiceReference"
				},
				"annotations": [],
				"type": "Binary",
				"typeProperties": {
					"location": {
						"type": "AzureBlobFSLocation",
						"fileSystem": "oracle-data"
					}
				}
			},
			"dependsOn": []
		},
		{
			"name": "[concat(parameters('factoryName'), '/Binary_Source_Oracle')]",
			"type": "Microsoft.DataFactory/factories/datasets",
			"apiVersion": "2018-06-01",
			"properties": {
				"description": "Connection to your data source store. ",
				"linkedServiceName": {
					"referenceName": "FTP Oracle",
					"type": "LinkedServiceReference"
				},
				"annotations": [],
				"type": "Binary",
				"typeProperties": {
					"location": {
						"type": "FtpServerLocation",
						"fileName": "*.CSV"
					}
				}
			},
			"dependsOn": []
		}
	]
}