{
	"name": "SQL_Operations_MainPipeline",
	"properties": {
		"activities": [
			{
				"name": "GroupCAPEXCommittedExpenditure",
				"type": "Script",
				"dependsOn": [],
				"policy": {
					"timeout": "0.12:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"linkedServiceName": {
					"referenceName": "AzureSqlDatabase1",
					"type": "LinkedServiceReference"
				},
				"typeProperties": {
					"scripts": [
						{
							"type": "Query",
							"text": "/*==============================================================================================================================*\r\n * Project:\t\tArgent\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Purpose:\t\tCreate Group CAPEX Committed Expenditure table\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Date:        26/10/2023\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Version:     1.0\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n *==============================================================================================================================*\r\n * Updates:\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Date\t\t| Version | Author\t\t| Change made\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * -----------------------------------------------------------------------------------------------------------------------------*\r\n * --/--/-- |  1.-\t  |\t\t\t\t|\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t|\t\t  |\t\t\t\t|\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *==============================================================================================================================*/\r\n\r\n/********************************************************************************************************\r\n\tStep 1.1:\tCreate Group CAPEX Committed Expenditure\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Operations].[GroupCapexCommitedExpenditure]','U') IS NOT NULL\r\n\t\tDROP TABLE [Operations].[GroupCapexCommitedExpenditure]\r\n\r\n\tSELECT\t\t[Unit Price] * CAST([Ordered Quantity] AS NUMERIC(28,4)) AS [Ordered Amount]\r\n\t,\t\t\tCAST(LEFT([Pick up Date],10) AS DATE) AS [Promised Delivery Date]\r\n\t,\t\t\tp.[Party Email Address]\tAS [Requester]\r\n\t,\t\t\tpo.[Last Update Date] AS [Line Last Updated Date]\r\n\t,\t\t\t[Purchase Document Currency] AS [Currency]\r\n\t,\t\t\tCAST([Ordered Quantity] AS NUMERIC(28,4)) AS [Net Ordered Quantity]\r\n\t,\t\t\tp.[Party Name] AS [Buyer]\r\n\t,\t\t\tNULLIF(CONCAT(gls.[SEGMENT1],'-',gls.[SEGMENT2],'-',gls.[SEGMENT3],'-',gls.[SEGMENT4],'-',gls.[SEGMENT5],'-',gls.[SEGMENT6]),'-----') AS [Concatenated Segments]\r\n\t,\t\t\t[po].[Item Description]\r\n\t,\t\t\tCAST([Ordered Quantity] AS NUMERIC(28,4)) - [Received Quantity] AS [Open Ordered Quantity]\r\n\t,\t\t\tp2.[Party Name] AS [Supplier]\r\n\t,\t\t\tpo.[Purchase Order Number] AS [Order]\r\n\t,\t\t\tCAST(LEFT([po].[PO Creation Date],10) AS DATE) AS [Report Date]\r\n\t,\t\t\tpl.[LOCATION_CODE] AS [Location Code]\r\n\t,\t\t\tpod.[QUANTITY_ORDERED] AS [Distribution Quantity]\r\n\t,\t\t\tpo.[Unit Price] AS [Price]\r\n\t,\t\t\tCASE\t\t\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'GBP'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[EUR GBP],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'USD'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[EUR USD],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'CNY'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[EUR CNY],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'AUD'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[EUR AUD],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'CAD'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[EUR CAD],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'CHF'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[GBP CHF],0)/NULLIF([fx].[EUR GBP],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'HKD'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[GBP HKD],0)/NULLIF([fx].[EUR GBP],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'SEK'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[GBP SEK],0)/NULLIF([fx].[EUR GBP],0)\r\n\t\t\t\t\tELSE po.[Unit Price]\r\n\t\t\t\tEND AS [Price EUR]\r\n\t,\t\t\tCASE\t\t\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'EUR'\r\n\t\t\t\t\t\tTHEN po.[Unit Price] * fx.[EUR GBP]\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'USD'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[EUR USD],0) * fx.[EUR GBP]\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'CNY'\r\n\t\t\t\t\t\tTHEN po.[Unit Price] * fx.[CNY GBP]\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'AUD'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[EUR AUD],0) * fx.[EUR GBP]\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'CAD'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[EUR CAD],0) * fx.[EUR GBP]\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'CHF'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[GBP CHF],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'HKD'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[GBP HKD],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'SEK'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[GBP SEK],0)\r\n\t\t\t\t\tELSE po.[Unit Price]\r\n\t\t\t\tEND AS [Price GBP]\r\n\t,\t\t\tpod.[AMOUNT_DELIVERED] AS [Delivered Amount in Funtional Currency]\r\n\t,\t\t\tpo.[Unit Price] * CAST(pod.[QUANTITY_ORDERED] AS DECIMAL(28,4)) AS [Total Price]\r\n\t,\t\t\t(CASE\t\t\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'GBP'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[EUR GBP],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'USD'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[EUR USD],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'CNY'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[EUR CNY],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'AUD'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[EUR AUD],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'CAD'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[EUR CAD],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'CHF'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[GBP CHF],0)/NULLIF([fx].[EUR GBP],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'HKD'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[GBP HKD],0)/NULLIF([fx].[EUR GBP],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'SEK'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[GBP SEK],0)/NULLIF([fx].[EUR GBP],0)\r\n\t\t\t\t\tELSE po.[Unit Price]\r\n\t\t\t\tEND) *  CAST(pod.[QUANTITY_ORDERED] AS DECIMAL(28,4)) AS [Total Price EUR]\r\n\t,\t\t\t(CASE\t\t\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'EUR'\r\n\t\t\t\t\t\tTHEN po.[Unit Price] * fx.[EUR GBP]\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'USD'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[EUR USD],0) * fx.[EUR GBP]\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'CNY'\r\n\t\t\t\t\t\tTHEN po.[Unit Price] * fx.[CNY GBP]\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'AUD'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[EUR AUD],0) * fx.[EUR GBP]\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'CAD'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[EUR CAD],0) * fx.[EUR GBP]\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'CHF'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[GBP CHF],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'HKD'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[GBP HKD],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'SEK'\r\n\t\t\t\t\t\tTHEN po.[Unit Price]/NULLIF([fx].[GBP SEK],0)\r\n\t\t\t\t\tELSE po.[Unit Price]\r\n\t\t\t\tEND) * CAST(pod.[QUANTITY_ORDERED] AS DECIMAL(28,4)) AS [Total Price GBP]\r\n\t,\t\t\tpo.[Purchase Document Status] AS [Schedule Status]\r\n\t,\t\t\tgls.[SEGMENT2] AS [Cost Centre Code]\r\n\t,\t\t\tgld.[DESCRIPTION] AS [Cost Centre Description]\r\n\t,\t\t\to.[Business Unit Name] AS [Business Unit]\r\n\t,\t\t\tcat.[CATEGORY_CODE]\tAS [Category Name]\r\n\t,\t\t\ttv.[DESCRIPTION] AS [Project Segment Description]\r\n\t,\t\t\tgls.[SEGMENT4] AS [Project Segment Value]\r\n\t,\t\t\tpod.[AMOUNT_BILLED] AS [Delivered Amount]\r\n\t,\t\t\tCASE\t\t\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'GBP'\r\n\t\t\t\t\t\tTHEN pod.[AMOUNT_BILLED]/NULLIF([fx].[EUR GBP],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'USD'\r\n\t\t\t\t\t\tTHEN pod.[AMOUNT_BILLED]/NULLIF([fx].[EUR USD],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'CNY'\r\n\t\t\t\t\t\tTHEN pod.[AMOUNT_BILLED]/NULLIF([fx].[EUR CNY],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'AUD'\r\n\t\t\t\t\t\tTHEN pod.[AMOUNT_BILLED]/NULLIF([fx].[EUR AUD],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'CAD'\r\n\t\t\t\t\t\tTHEN pod.[AMOUNT_BILLED]/NULLIF([fx].[EUR CAD],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'CHF'\r\n\t\t\t\t\t\tTHEN pod.[AMOUNT_BILLED]/NULLIF([fx].[GBP CHF],0)/NULLIF([fx].[EUR GBP],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'HKD'\r\n\t\t\t\t\t\tTHEN pod.[AMOUNT_BILLED]/NULLIF([fx].[GBP HKD],0)/NULLIF([fx].[EUR GBP],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'SEK'\r\n\t\t\t\t\t\tTHEN pod.[AMOUNT_BILLED]/NULLIF([fx].[GBP SEK],0)/NULLIF([fx].[EUR GBP],0)\r\n\t\t\t\t\tELSE pod.[AMOUNT_BILLED]\r\n\t\t\t\tEND AS [Delivered Amount EUR]\r\n\t,\t\t\tCASE\t\t\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'EUR'\r\n\t\t\t\t\t\tTHEN pod.[AMOUNT_BILLED] * fx.[EUR GBP]\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'USD'\r\n\t\t\t\t\t\tTHEN pod.[AMOUNT_BILLED]/NULLIF([fx].[EUR USD],0) * fx.[EUR GBP]\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'CNY'\r\n\t\t\t\t\t\tTHEN pod.[AMOUNT_BILLED] * fx.[CNY GBP]\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'AUD'\r\n\t\t\t\t\t\tTHEN pod.[AMOUNT_BILLED]/NULLIF([fx].[EUR AUD],0) * fx.[EUR GBP]\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'CAD'\r\n\t\t\t\t\t\tTHEN pod.[AMOUNT_BILLED]/NULLIF([fx].[EUR CAD],0) * fx.[EUR GBP]\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'CHF'\r\n\t\t\t\t\t\tTHEN pod.[AMOUNT_BILLED]/NULLIF([fx].[GBP CHF],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'HKD'\r\n\t\t\t\t\t\tTHEN pod.[AMOUNT_BILLED]/NULLIF([fx].[GBP HKD],0)\r\n\t\t\t\t\tWHEN po.[Purchase Document Currency] = 'SEK'\r\n\t\t\t\t\t\tTHEN pod.[AMOUNT_BILLED]/NULLIF([fx].[GBP SEK],0)\r\n\t\t\t\t\tELSE pod.[AMOUNT_BILLED]\r\n\t\t\t\tEND AS [Delivered Amount GBP]\t\t\t\r\n\t,\t\t\tpod.[QUANTITY_DELIVERED] AS [Delivered Quantity]\r\n\t,\t\t\tlcc.[LEDGER_CURRENCY_CODE]\tAS [Ledger Currency]\r\n\t,\t\t\t[Purchase Document Currency] AS [Default Currency] -- set to purchase document currency\r\n\tINTO\t\t[Operations].[GroupCapexCommitedExpenditure]\r\n\tFROM\t\tCore.PurchaseOrders po -- 136,118\r\n\tLEFT JOIN\tCore.Users u\r\n\tON\t\t\tu.[Person ID] = po.[Buyer] --136,118\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tDISTINCT [Party Name]\r\n\t\t\t\t\t,\t\t\t[Party Email Address]\r\n\t\t\t\t\tFROM\t\tCore.Parties\r\n\t\t\t\t) p\r\n\tON\t\t\tu.[Username] = p.[Party Email Address]\r\n\tLEFT JOIN\tCore.PO_Distributions pod\r\n\tON\t\t\tpo.[PO Header ID] = pod.[PO_HEADER_ID]\r\n\tAND\t\t\tpo.[PO Line ID] = pod.[PO_LINE_ID]\r\n\tLEFT JOIN\tCore.GL_SegmentsInScope gls\r\n\tON\t\t\tpod.[CODE_COMBINATION_ID] = gls.[CODE_COMBINATION_ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[PO Distribution ID]\r\n\t\t\t\t\t,\t\t\tSUM(CAST([Primary Quantity] AS DECIMAL(28,4))) AS [Received Quantity]\r\n\t\t\t\t\tFROM\t\tCore.ReceivingTransactions\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'RECEIVE'\r\n\t\t\t\t\tGROUP BY\t[PO Distribution ID]\r\n\t\t\t\t) rq\r\n\tON\t\t\trq.[PO Distribution ID] = pod.[PO_DISTRIBUTION_ID]\r\n\tLEFT JOIN\tCore.Suppliers s\r\n\tON\t\t\ts.[Vendor ID] = po.[Supplier]\r\n\tAND\t\t\ts.[Vendor Site ID] = po.[Supplier Site]\r\n\tLEFT JOIN\tCore.Parties p2\r\n\tON\t\t\tp2.[Party ID] = s.[Party ID]\r\n\tAND\t\t\tp2.[Party SIte ID] = s.[Party Site ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tDISTINCT [Business Unit ID]\r\n\t\t\t\t\t,\t\t\t[Business Unit Name]\r\n\t\t\t\t\tFROM\t\tCore.Organizations\r\n\t\t\t\t) o\r\n\tON\t\t\to.[Business Unit ID] = po.[Purchasing BU]\r\n\tLEFT JOIN\tCore.GL_Descriptions gld\r\n\tON\t\t\tgld.[SEGMENT] = gls.[SEGMENT2]\r\n\tAND\t\t\tgld.[VALUE_CATEGORY] = 'Cost Centre Argent'\r\n\tLEFT JOIN\t(\r\n\r\n\t\t\t\tSELECT DISTINCT [SOURCE_DOC_NUMBER], [LEDGER_CURRENCY_CODE] \r\n\t\t\t\tFROM\t\t[RAW].[O.CMR_RCV_DISTRIBUTIONS] crd\r\n\r\n\t\t\t\tLEFT JOIN\t[RAW].[O.CMR_RCV_EVENTS] cre\r\n\r\n\t\t\t\tON\t\t\tcre.[ACCOUNTING_EVENT_ID] = crd.[ACCOUNTING_EVENT_ID]\r\n\r\n\t\t\t\tWHERE [EVENT_SOURCE] = 'PO'\r\n\t\t\t\t) lcc\r\n\tON\t\t\tpo.[Purchase Order Number] = lcc.[SOURCE_DOC_NUMBER]\r\n\tLEFT JOIN\t[RAW].[O.FND_VS_TYPED_VALUES_VL] tv\r\n\tON\t\t\ttv.[VALUE] = gls.[SEGMENT4]\r\n\tAND\t\t\ttv.[VALUE_SET_ID] = '55004'\r\n\tLEFT JOIN\t[Core].[PER_Locations] pl\r\n\tON\t\t\tpo.[Ship to Location ID] = pl.[LOCATION_ID]\r\n\tLEFT JOIN\t[Core].[EGP_Categories_B] cat\r\n\tON\t\t\tcat.[CATEGORY_ID] = po.[Category ID]\r\n\tLEFT JOIN\t[Core].[FXRates] fx\r\n\tON\t\t\tfx.[CONVERSION_DATE] = CAST(LEFT([po].[PO Creation Date],10) AS DATE)\r\n\tWHERE\t\tpo.[Purchase Document Status] NOT IN ('Rejected','Canceled')\r\n\tAND\t\t\tgls.[SEGMENT4] != '00000'\r\n"
						}
					],
					"scriptBlockExecutionTimeout": "02:00:00"
				}
			},
			{
				"name": "PastPO_NotReceipted",
				"type": "Script",
				"state": "Inactive",
				"onInactiveMarkAs": "Succeeded",
				"dependsOn": [
					{
						"activity": "GroupCAPEXCommittedExpenditure",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"policy": {
					"timeout": "0.12:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"linkedServiceName": {
					"referenceName": "AzureSqlDatabase1",
					"type": "LinkedServiceReference"
				},
				"typeProperties": {
					"scripts": [
						{
							"type": "Query",
							"text": "/*==============================================================================================================================*\n * Project:\t\tArgent\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\n * Purpose:\t\tCreate Past PO's Not Receipted table\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\n * Date:        25/10/2023\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\n * Version:     1.0\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\n *==============================================================================================================================*\n * Updates:\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\n * Date\t\t| Version | Author\t\t| Change made\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\n * -----------------------------------------------------------------------------------------------------------------------------*\n * --/--/-- |  1.-\t  |\t\t\t\t|\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\n *\t\t\t|\t\t  |\t\t\t\t|\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\n *==============================================================================================================================*/\n\n/********************************************************************************************************\n\tStep 1.1:\tCreate Past PO's Not Receipted table \n********************************************************************************************************/\n\t\n\tIF OBJECT_ID('Operations.PastPO_NotReceipted','U') IS NOT NULL\n\t\tDROP TABLE Operations.PastPO_NotReceipted\n\n\tSELECT\t\tp.[PchId] AS [PO Number]\n\t,\t\t\tp.[PchDescr] AS [PO Description]\n\t,\t\t\tv.[VdrDescr] AS [Vendor Description]\n\t,\t\t\tISNULL(s.[SUSEDES],'Unknown') AS [UserEmail]\n\t,\t\t\tpl.[PchlLineId] AS [PO Line]\n\t,\t\t\tpl.[PchlDescr] AS [PO Line Description]\n\t,\t\t\tpl.[PchlTotPrice] AS [Price]\n\t,\t\t\tpl.[PchlCurId] AS [Currency]\n\t,\t\t\tCASE \n\t\t\t\t\tWHEN pl.[PchlCurId] = 'GBP'\n\t\t\t\t\t\tTHEN pl.[PchlTotPrice]/NULLIF([fx].[EUR GBP],0) \n\t\t\t\t\tELSE pl.[PchlTotPrice]\n\t\t\t\tEND AS [Price EUR]\n\t,\t\t\tCASE \n\t\t\t\t\tWHEN pl.[PchlCurId] = 'EUR'\n\t\t\t\t\t\tTHEN pl.[PchlTotPrice] * [fx].[EUR GBP] \n\t\t\t\t\tELSE pl.[PchlTotPrice]\n\t\t\t\tEND AS [Price GBP]\n\t,\t\t\tpl.[PchlDepId] AS [Dept]\n\t,\t\t\tpl.[_PCHLPCHTYPEID] AS [Order Type]\n\t,\t\t\t[rs].[SRECSCDES] AS [Line Status]\n\t,\t\t\tpl.PchlDlvDate\n\tINTO\t\tOperations.PastPO_NotReceipted\n\tFROM\t\tUltimo.Purchase p\n\tLEFT JOIN\tUltimo.PurchaseLine pl\n\tON\t\t\tp.[PchId] = pl.[PchlPchId]\n\tLEFT JOIN\tUltimo.Vendor v\n\tON\t\t\tp.[PchVdrId] = v.[VdrId]\n\tLEFT JOIN\tUltimo.SUSER s\n\tON\t\t\tp.[PchRequestEmpId] = s.[SUSEEMPID]\n\tLEFT JOIN\t[Ultimo].[SRECORDSTATUSCOUNTRY] rs\n\tON\t\t\trs.[SRECSCSTATUS] = pl.[PchlRecStatus]\n\tAND\t\t\t[rs].[SRECSCREC] = 'PURCHASELINE'\n\tAND\t\t\t[rs].[SRECSCCOU] = 'EN'\n\tLEFT JOIN\t[Core].[FXRates] fx\n\tON\t\t\tfx.[CONVERSION_DATE] = pl.PchlDlvDate\n\tWHERE\t\t[rs].[SRECSCDES] IN ('Draft','Active','Partially received')\n\tAND\t\t\tpl.PchlDlvDate <= CAST(GETDATE() AS DATE)"
						}
					],
					"scriptBlockExecutionTimeout": "02:00:00"
				}
			},
			{
				"name": "WarehouseTables",
				"type": "Script",
				"state": "Inactive",
				"onInactiveMarkAs": "Succeeded",
				"dependsOn": [
					{
						"activity": "PastPO_NotReceipted",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"policy": {
					"timeout": "7.00:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"linkedServiceName": {
					"referenceName": "AzureSqlDatabase1",
					"type": "LinkedServiceReference"
				},
				"typeProperties": {
					"scripts": [
						{
							"type": "Query",
							"text": "/*==============================================================================================================================*\r\n * Project:\t\tArgent\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Purpose:\t\tCreate Warehouse tables\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Date:        26/10/2023\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Version:     1.0\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n *==============================================================================================================================*\r\n * Updates:\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Date\t\t| Version | Author\t\t| Change made\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * -----------------------------------------------------------------------------------------------------------------------------*\r\n * --/--/-- |  1.-\t  |\t\t\t\t|\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t|\t\t  |\t\t\t\t|\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *==============================================================================================================================*/\r\n/********************************************************************************************************\r\n\tStep 1.1:\tCreate Warehouse tables\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Operations].[StockAdjustments]','U') IS NOT NULL\r\n\t\tDROP TABLE [Operations].[StockAdjustments]\r\n\r\n\tSELECT\t\t[wso].[WhsoDepId] AS [Dept]\r\n\t,\t\t\t[wso].[WhsoId] AS [S.A. No]\r\n\t,\t\t\t[wso].[WhsoBookDate] AS [Book Date]\r\n\t,\t\t\t[wso].[WhsoType] AS [S.A. Type]\r\n\t,\t\t\t[wso].[WhsoDescr] AS [S.A. Desc]\r\n\t,\t\t\t[wso].[WhsoJobId] AS [Job ID]\r\n\t,\t\t\tj.[JobDescr] AS [Job Description]\r\n\t,\t\t\t[wsol].[WhsolLineId] AS [S.A. Line ID]\r\n\t,\t\t\t[wsol].[WhsolArtId] AS [Article ID]\r\n\t,\t\t\ta.ArtDescr AS [Article Description]\r\n\t,\t\t\t[wso].[WhsoId]\r\n\t,\t\t\t[wsol].[WhsolQty] AS [Qty Out]\r\n\t,\t\t\t[wsol].[WhsolQtyIn] AS [Qty In]\r\n\t,\t\t\t[wsol].[WhsolTotalPrice] AS [Total Price]\r\n\t,\t\t\tCAST(GETDATE() AS DATE) AS [DateStamp]\r\n\tINTO\t\t[Operations].[StockAdjustments]\r\n\tFROM\t\tUltimo.WhsServeOutLine wsol\r\n\tLEFT JOIN\tUltimo.WhsServeOut wso\r\n\tON\t\t\twso.[WhsoId] = wsol.[WhsolWhsoId]\r\n\tLEFT JOIN\tUltimo.Job j\r\n\tON\t\t\twso.[WhsoJobId] = j.[JobId]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tDISTINCT *\r\n\t\t\t\t\tFROM\t\tUltimo.Article\r\n\t\t\t\t) a\r\n\tON\t\t\ta.[ArtId] = wsol.[WhsolArtId]\r\n\tWHERE\t\t[wso].[WhsoRecStatus] = 2\r\n\tORDER BY\t[wso].[WhsoBookDate] \r\n\r\n\tIF OBJECT_ID('[Operations].[StockValue]','U') IS NOT NULL\r\n\t\tDROP TABLE [Operations].[StockValue]\r\n\r\n\tSELECT\t\t[a].[ArtId] AS [Article]\r\n\t,\t\t\t[aw].[ArtwWhsId] AS [Warehouse]\r\n\t,\t\t\t[a].[ArtDescr] AS [Article Description]\r\n\t,\t\t\t[a].[_ArtNr] AS [Article Number]\r\n\t,\t\t\tSUM([awl].[ArtWhslQuantity]) AS [Stock Quantity]\r\n\t,\t\t\tMAX([a].[ArtPurchPrice]) AS [Article Price]\r\n\t,\t\t\tMAX([a].[ArtPurchPrice]) * SUM([awl].[ArtWhslQuantity]) AS [Total Value]\r\n\t,\t\t\tCAST(GETDATE() AS DATE) AS [DateStamp]\r\n\tINTO\t\t[Operations].[StockValue]\r\n\tFROM\t\tUltimo.ArticleWarehouseLocation awl\r\n\tLEFT JOIN\tUltimo.ArticleWarehouse aw\r\n\tON\t\t\tCONCAT(awl.[ArtWhslArtId],[awl].[ArtWhslWhslWhsId]) = CONCAT(aw.[ArtwArtId],[aw].[ArtwWhsId])\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tDISTINCT *\r\n\t\t\t\t\tFROM\t\tUltimo.Article\r\n\t\t\t\t) a\r\n\tON\t\t\taw.[ArtwArtId] = a.[ArtId]\r\n\tWHERE\t\t[a].[ArtId] IS NOT NULL\r\n\tAND\t\t\t[a].[ArtRecStatus] = 0\r\n\tAND\t\t\t[aw].[ArtwWhsId] <> 'MGD'\r\n\tGROUP BY\t[a].[ArtId]\r\n\t,\t\t\t[aw].[ArtwWhsId]\r\n\t,\t\t\t[a].[ArtDescr]\r\n\t,\t\t\t[a].[_ArtNr]\r\n\tORDER BY\t[a].[ArtId]\r\n\r\n\r\n\r\n\tIF OBJECT_ID('[Operations].[StockCount]','U') IS NOT NULL\r\n\t\tDROP TABLE [Operations].[StockCount]\r\n\r\n\tSELECT\t\t[a].[ArtId] AS [Article]\r\n\t,\t\t\t[a].[ArtDescr] AS [Article Description]\r\n\t,\t\t\tSTRING_AGG(ISNULL(v.[VdrDescr],'many/none'),',') AS [Vendor]\r\n\t,\t\t\t[a].[_ArtNr] AS [Article Number]\r\n\t,\t\t\t[aw].[ArtwWhsId] AS [Warehouse]\r\n\t,\t\t\twl.WhslDescription AS [Location]\r\n\t,\t\t\t[awl].[ArtWhslQuantity] AS [Physical Stock]\r\n\t,\t\t\t[a].[ArtPurchPrice] AS [Article Price]\r\n\t,\t\t\t[awl].[ArtWhslQuantity] * [a].[ArtPurchPrice] AS [Total Value]\r\n\t,\t\t\tCAST(GETDATE() AS DATE) AS [DateStamp]\r\n\tINTO\t\t[Operations].[StockCount]\r\n\tFROM\t\tUltimo.ArticleWarehouseLocation awl\r\n\tLEFT JOIN\tUltimo.ArticleWarehouse aw\r\n\tON\t\t\tCONCAT(awl.[ArtWhslArtId],[awl].[ArtWhslWhslWhsId]) = CONCAT(aw.[ArtwArtId],[aw].[ArtwWhsId])\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tDISTINCT *\r\n\t\t\t\t\tFROM\t\tUltimo.Article\r\n\t\t\t\t) a\r\n\tON\t\t\taw.[ArtwArtId] = a.[ArtId]\r\n\tLEFT JOIN\tUltimo.WarehouseLocation wl\r\n\tON\t\t\tawl.[ArtWhslWhslCode] = wl.[WhslCode]\r\n\tLEFT JOIN\tUltimo.ArticleVendor av\r\n\tON\t\t\ta.[ArtId] = av.[ArtvArtId]\r\n\tLEFT JOIN\tUltimo.Vendor v\r\n\tON\t\t\tv.[VdrId] = av.[ArtvVdrId]\r\n\tWHERE\t\t[aw].[ArtwWhsId] <> 'MGD'\r\n\tAND\t\t\t[WhslWhsId] <> 'GAR'\r\n\tAND\t\t\t[a].[ArtId] IS NOT NULL\r\n\tAND\t\t\t[a].[ArtRecStatus] = 0\r\n\tGROUP BY\t[a].[ArtId]\r\n\t,\t\t\t[a].[ArtDescr]\r\n\t,\t\t\t[a].[_ArtNr] \r\n\t,\t\t\t[aw].[ArtwWhsId]\r\n\t,\t\t\twl.WhslDescription \r\n\t,\t\t\t[awl].[ArtWhslQuantity] \r\n\t,\t\t\t[a].[ArtPurchPrice]\r\n\r\n\r\n\tIF OBJECT_ID('[Operations].[BelowMinStock]','U') IS NOT NULL\r\n\t\tDROP TABLE [Operations].[BelowMinStock]\r\n\r\n\tSELECT\t\ta.[ArtId] AS [Article]\r\n\t,\t\t\t[a].[ArtDescr] AS [Article Description]\r\n\t,\t\t\tSTRING_AGG(ISNULL(v.[VdrDescr],'many/none'),',') AS [Vendor]\r\n\t,\t\t\t[a].[_ArtNr] AS [Article Number]\r\n\t,\t\t\taw.[ArtwWhsId] AS [Warehouse]\r\n\t,\t\t\taw.[ArtwStock] AS [In Stock]\r\n\t,\t\t\t[a].[ArtPurchLevel] AS [Min]\r\n\t,\t\t\t[a].[ArtMaximum] AS [Max]\r\n\t,\t\t\t[a].[ArtPurchasePrepQty] AS [Order in Prep]\r\n\t,\t\t\t[a].[ArtPurchQty] AS [On Order]\r\n\t,\t\t\t[a].[ArtPurch] AS [Re-Order]\r\n\t,\t\t\tCASE\t\r\n\t\t\t\t\tWHEN ([aw].[ArtwStock] + [a].[ArtPurchQty]) < [a].[ArtPurchLevel]\r\n\t\t\t\t\t\tTHEN [a].[ArtMaximum] - [a].[ArtPurchQty]\r\n\t\t\t\t\tELSE 0\r\n\t\t\t\tEND AS [Order Now]\r\n\t,\t\t\t[a].[ArtPurchPrice] AS [Article Price]\r\n\t,\t\t\tCAST(GETDATE() AS DATE) AS [DateStamp]\r\n\tINTO\t\t[Operations].[BelowMinStock]\r\n\tFROM\t\tUltimo.ArticleWarehouse aw\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tDISTINCT *\r\n\t\t\t\t\tFROM\t\tUltimo.Article\r\n\t\t\t\t) a\r\n\tON\t\t\taw.[ArtwArtId] = a.[ArtId]\r\n\tLEFT JOIN\tUltimo.ArticleVendor av\r\n\tON\t\t\ta.[ArtId] = av.[ArtvArtId]\r\n\tLEFT JOIN\tUltimo.Vendor v\r\n\tON\t\t\tv.[VdrId] = av.[ArtvVdrId]\r\n\tWHERE\t\t[aw].[ArtwWhsId] <> 'MGD'\r\n\tAND\t\t\t[a].[ArtId] IS NOT NULL\r\n\tAND\t\t\t[a].[ArtRecStatus] = 0\r\n\tGROUP BY\ta.[ArtId]\r\n\t,\t\t\t[a].[ArtDescr] \r\n\t,\t\t\t[a].[_ArtNr] \r\n\t,\t\t\taw.[ArtwWhsId]\r\n\t,\t\t\taw.[ArtwStock] \r\n\t,\t\t\t[a].[ArtPurchLevel]\r\n\t,\t\t\t[a].[ArtMaximum] \r\n\t,\t\t\t[a].[ArtPurchasePrepQty] \r\n\t,\t\t\t[a].[ArtPurchQty]\r\n\t,\t\t\t[a].[ArtPurch]\r\n\t,\t\t\tCASE\t\r\n\t\t\t\t\tWHEN ([aw].[ArtwStock] + [a].[ArtPurchQty]) < [a].[ArtPurchLevel]\r\n\t\t\t\t\t\tTHEN [a].[ArtMaximum] - [a].[ArtPurchQty]\r\n\t\t\t\t\tELSE 0\r\n\t\t\t\tEND \r\n\t,\t\t\t[a].[ArtPurchPrice]\r\n\r\n\t\r\n\tIF OBJECT_ID('[Operations].[Job_Equipment]','U') IS NOT NULL\r\n\t\tDROP TABLE [Operations].[Job_Equipment]\r\n\r\n\tSELECT\t\t*\r\n\t,\t\t\tCAST(GETDATE() AS DATE) AS [DateStamp]\r\n\tINTO\t\t[Operations].[Job_Equipment]\r\n\tFROM\t\tUltimo.Job j\r\n\tLEFT JOIN\tUltimo.Equipment e\r\n\tON\t\t\tj.[JobEqmId] = e.[EqmId]\r\n\r\n\r\n"
						}
					],
					"scriptBlockExecutionTimeout": "02:00:00"
				}
			}
		],
		"folder": {
			"name": "Operations"
		},
		"annotations": []
	}
}