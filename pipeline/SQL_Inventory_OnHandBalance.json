{
	"name": "SQL_Inventory_OnHandBalance",
	"properties": {
		"activities": [
			{
				"name": "Supply Chain Inventory Table",
				"type": "Script",
				"dependsOn": [],
				"policy": {
					"timeout": "7.00:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"linkedServiceName": {
					"referenceName": "SqlServerArgent",
					"type": "LinkedServiceReference"
				},
				"typeProperties": {
					"scripts": [
						{
							"type": "NonQuery",
							"text": "/********************************************************************************************************\r\n\tStep 2.1:\tDelete current day's data from the inventory table. This ensures the data isn't \r\n\t\t\t\tduplicated if ran more than once a day.\r\n********************************************************************************************************/\t\r\n\r\n\tDECLARE @DeleteTableStatement NVARCHAR(MAX)\r\n\tDECLARE Cur2 CURSOR READ_ONLY\r\n\tFOR\r\n\t\t\tSELECT  'Delete from [SupplyChain].[' + TABLE_NAME + ']  where CAST([DateStamp] AS DATE) = CAST(GETDATE() AS DATE)'\r\n\t\t\tFROM    INFORMATION_SCHEMA.TABLES\r\n\t\t\tWHERE   TABLE_SCHEMA = 'SupplyChain'\r\n\t\t\tAND\t\tTABLE_TYPE = 'BASE TABLE' \r\n\t\t\tAND\t\tTABLE_NAME IN ('InventoryOnHandBalance')\r\n\r\n\r\n\tOPEN Cur2\r\n\tFETCH NEXT FROM Cur2 INTO @DeleteTableStatement\r\n\tWHILE @@FETCH_STATUS = 0\r\n\t\t  BEGIN\r\n\t\t\t\tPRINT 'Executing ' + @DeleteTableStatement\r\n\t\t\t\tEXECUTE sp_executesql @DeleteTableStatement\r\n\t\t\t\tFETCH NEXT FROM Cur2 INTO @DeleteTableStatement\r\n\t\t  END\r\n\tCLOSE Cur2\r\n\tDEALLOCATE Cur2\r\n\r\n /********************************************************************************************************\r\n\tStep 2.2:\tAdd current day's inventory data to SupplyChain.InventoryOnHandBalance\r\n********************************************************************************************************/\t\r\n\r\n\tINSERT INTO [SupplyChain].[InventoryOnHandBalance]\r\n\tSELECT\t\tohb.[Business Unit Name]\t\t\t\t\t\t\t\t\t\tAS [Business Unit Name]\r\n\t,\t\t\tohb.[Inventory Organization Name]\t\t\t\t\t\t\t\tAS [Inventory Organization Name]\t\t\r\n\t,\t\t\tohb.[Item ID]\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Item ID]\t\t\t\t\t\t\t\r\n\t,\t\t\tohb.[Inventory Organization ID]\t\t\t\t\t\t\t\t\tAS [Inventory Organization ID]\t\t\t\r\n\t,\t\t\tohb.[Primary Transaction Quantity]\t\t\t\t\t\t\t\tAS [Primary Transaction Quantity]\t\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN ohb.[Transaction UOM Code] IN ('LTR', 'MLT', 'SLT')\r\n\t\t\t\t\t\tTHEN ohb.[Primary Transaction Quantity] * 0.0008745\r\n\t\t\t\t\tELSE ohb.[Primary Transaction Quantity]\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Primary Transaction Quantity MT]\t\r\n\t,\t\t\tohb.[Subinventory]\t\t\t\t\t\t\t\t\t\t\t\tAS [Subinventory]\t\t\t\t\t\t\r\n\t,\t\t\tohb.[Onhand Quantities ID]\t\t\t\t\t\t\t\t\t\tAS [Onhand Quantities ID]\t\t\t\t\r\n\t,\t\t\tohb.[Transaction UOM Code]\t\t\t\t\t\t\t\t\t\tAS [Transaction UOM Code]\t\t\t\t\r\n\t,\t\t\tohb.[Lot Number]\t\t\t\t\t\t\t\t\t\t\t\tAS [Lot Number]\t\t\t\t\t\t\r\n\t,\t\t\tohb.[Item Code]\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Item Code]\t\t\t\t\t\t\t\r\n\t,\t\t\tohb.[Item Name]\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Item Name]\t\t\t\t\t\t\t\r\n\t,\t\t\tohb.[Category Set Name]\t\t\t\t\t\t\t\t\t\t\tAS [Category Set Name]\t\t\t\t\t\r\n\t,\t\t\tohb.[Category Code]\t\t\t\t\t\t\t\t\t\t\t\tAS [Category Code]\t\t\t\t\t\t\r\n\t,\t\t\tohb.[Category Set Description]\t\t\t\t\t\t\t\t\tAS [Category Set Description]\t\t\t\r\n\t,\t\t\tCAST(GETDATE() AS DATE)\t\t\t\t\t\t\t\t\t\t\tAS [DateStamp]\r\n\tFROM\t\t[Core].[OnHandBalance] ohb\r\n\tWHERE\t\t[Business Unit Name] NOT IN ('ROTIE BU','Quatra BU')\r\n\r\n /********************************************************************************************************\r\n\tStep 2.3:\tJoin inventory data to standard costs, actual costs and purchase orders to pull through\r\n\t\t\t\tprices for inventory data. The value of the i nventory items can then be calculated.\r\n********************************************************************************************************/\t\r\n\r\n\tSELECT\t\t[ohb].[Business Unit Name]\r\n\t,\t\t\t[ohb].[Inventory Organization Name]\r\n\t,\t\t\t[ohb].[Inventory Organization Code]\r\n\t,\t\t\t[ohb].[Subinventory]\r\n\t,\t\t\t[ohb].[Item ID]\r\n\t,\t\t\t[ohb].[Item Code]\r\n\t,\t\t\t[ohb].[Item Name]\r\n\t,\t\t\t[ohb].[Category Code]\r\n\t,\t\t\t[ohb].[Lot Number]\r\n\t,\t\t\t[ohb].[Quantity]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN ISNULL([UOM_CODE],ISNULL(ac.[Unit of Measure],po.[UOM Code])) IN ('LTR','MLT','SLT')\r\n\t\t\t\t\t\tTHEN CAST(ISNULL(sc.[TOTAL_COST],ISNULL(ac.[Actual Cost],PO.[Unit Price])) AS DECIMAL(28,4)) * 0.0008745\r\n\t\t\t\t\tELSE CAST(ISNULL(sc.[TOTAL_COST],ISNULL(ac.[Actual Cost],PO.[Unit Price])) AS DECIMAL(28,4))\r\n\t\t\t\tEND AS [Price]\r\n\t,\t\t\t[Quantity] *\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN ISNULL([UOM_CODE],ISNULL(ac.[Unit of Measure],po.[UOM Code])) IN ('LTR','MLT','SLT')\r\n\t\t\t\t\t\t\t\t\t\tTHEN CAST(ISNULL(sc.[TOTAL_COST],ISNULL(ac.[Actual Cost],PO.[Unit Price])) AS DECIMAL(28,4)) * 0.0008745\r\n\t\t\t\t\t\t\t\t\tELSE CAST(ISNULL(sc.[TOTAL_COST],ISNULL(ac.[Actual Cost],PO.[Unit Price])) AS DECIMAL(28,4))\r\n\t\t\t\t\t\t\t\tEND\tAS [Value]\r\n\t,\t\t\tISNULL(sc.[CURRENCY_CODE],ISNULL(ac.[CURRENCY_CODE],po.[Purchase Document Currency])) AS [Currency Code]\r\n\t,\t\t\tfx.[EUR GBP]\r\n\t,\t\t\tfx.[EUR USD]\r\n\t,\t\t\t[DateStamp]\r\n\tINTO\t\t#InventoryValue\r\n\tFROM\t\t(\r\n\r\n\t\t\t\t\tSELECT\t\ti.[Business Unit Name]\r\n\t\t\t\t\t,\t\t\ti.[Inventory Organization Name]\r\n\t\t\t\t\t,\t\t\to.[Inventory Organization Code]\r\n\t\t\t\t\t,\t\t\t[Subinventory]\r\n\t\t\t\t\t,\t\t\t[Item ID]\r\n\t\t\t\t\t,\t\t\t[Item Code]\r\n\t\t\t\t\t,\t\t\t[Item Name]\r\n\t\t\t\t\t,\t\t\t[Category Code]\t\t\r\n\t\t\t\t\t,\t\t\t[i].[Lot Number]\r\n\t\t\t\t\t,\t\t\tSUM(CAST([Primary Transaction Quantity MT] AS DECIMAL(28,4))) AS [Quantity]\t\r\n\t\t\t\t\t,\t\t\t[i].[DateStamp]\t\r\n\t\t\t\t\tFROM\t\t[SupplyChain].[InventoryOnHandBalance] i\r\n\t\t\t\t\tLEFT JOIN\t[Core].[Organizations] o\r\n\t\t\t\t\tON\t\t\ti.[Inventory Organization Name] = o.[Inventory Organization Name]\r\n\t\t\t\t\tGROUP BY\ti.[Business Unit Name]\r\n\t\t\t\t\t,\t\t\ti.[Inventory Organization Name]\r\n\t\t\t\t\t,\t\t\to.[Inventory Organization Code]\r\n\t\t\t\t\t,\t\t\t[Subinventory]\r\n\t\t\t\t\t,\t\t\t[Item ID]\r\n\t\t\t\t\t,\t\t\t[Item Code]\r\n\t\t\t\t\t,\t\t\t[Item Name]\r\n\t\t\t\t\t,\t\t\t[Category Code]\t\r\n\t\t\t\t\t,\t\t\t[i].[Lot Number]\r\n\t\t\t\t\t,\t\t\t[i].[DateStamp]\t\r\n\t\t\t\t) ohb\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tsc.[INVENTORY_ITEM_ID]\r\n\t\t\t\t\t,\t\t\tsc.[TOTAL_COST]\r\n\t\t\t\t\t,\t\t\tsc.[CURRENCY_CODE]\r\n\t\t\t\t\t,\t\t\tsc.[UOM_CODE]\r\n\t\t\t\t\t,\t\t\tval.*\r\n\t\t\t\t\tFROM\t\t[Core].[StandardCosts] sc\r\n\t\t\t\t\tLEFT JOIN\t[Core].[CostValUnits] val\r\n\t\t\t\t\tON\t\t\tsc.[VAL_UNIT_ID] = val.[VAL_UNIT_ID]\r\n\t\t\t\t\tWHERE\t\tsc.[STATUS_CODE] = 'PUBLISHED'\r\n\t\t\t\t\tAND\t\t\tCAST(GETDATE() AS DATE) BETWEEN CAST(LEFT([EFFECTIVE_START_DATE],10) AS DATE) AND CAST(LEFT([EFFECTIVE_END_DATE],10) AS DATE)\r\n\t\t\t\t) sc\r\n\tON\t\t\tohb.[Item Id] = sc.[INVENTORY_ITEM_ID]\r\n\tAND\t\t\tLEFT(sc.[VAL_UNIT_CODE],8) LIKE '%' + CASE WHEN [Inventory Organization Code] = 'PTP' THEN 'Not a Used Org.' ELSE [Inventory Organization Code] END + '%'\r\n\tAND\t\t\t[Inventory Organization Code] <> '000'\r\n\tAND\t\t\t([COST_BOOK_ID] LIKE '%484' OR [COST_BOOK_ID] LIKE '%182')\r\n\tLEFT JOIN\t(\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tSELECT\t\t[VAL_UNIT_ID]\r\n\t\t\t\t\t,\t\t\tRIGHT([VAL_UNIT_CODE],LEN([VAL_UNIT_CODE]) - CHARINDEX('-',[VAL_UNIT_CODE],5)) AS [Lot Number]\r\n\t\t\t\t\tFROM\t\t(\r\n\t\t\t\t\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\t\t\t\t\t,\t\t\tROW_NUMBER() OVER (PARTITION BY RIGHT([VAL_UNIT_CODE],LEN([VAL_UNIT_CODE]) - CHARINDEX('-',[VAL_UNIT_CODE],5)) ORDER BY [LAST_UPDATE_DATE] DESC) AS [Latest ID]\r\n\t\t\t\t\t\t\t\t\tFROM\t\t[Core].[CostValUnits]\r\n\t\t\t\t\t\t\t\t\tWHERE\t\t[COST_BOOK_ID] LIKE '%484'\r\n\t\t\t\t\t\t\t\t) lid\r\n\t\t\t\t\tWHERE\t\t[Latest ID] = 1\r\n\t\t\t\t\t) vu\r\n\tON\t\t\tohb.[Lot Number] = vu.[Lot Number]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\t\tSELECT\t\t[VAL_UNIT_ID]\r\n\t\t\t\t\t\t,\t\t\t[INVENTORY_ITEM_ID]\r\n\t\t\t\t\t\t,\t\t\tCAST(CAST([TOTAL_COST] AS FLOAT) AS DECIMAL(28,2)) AS [Actual Cost]\r\n\t\t\t\t\t\t,\t\t\t[CURRENCY_CODE]\r\n\t\t\t\t\t\t,\t\t\t[Item Code]\r\n\t\t\t\t\t\t,\t\t\t[Unit Of Measure]\r\n\t\t\t\t\t\tFROM\t\t(\r\n\t\t\t\t\t\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\t\t\t\t\t\t,\t\t\tROW_NUMBER() OVER (PARTITION BY [VAL_UNIT_ID], [INVENTORY_ITEM_ID] ORDER BY [EFF_DATE] DESC) AS [Latest Cost]\r\n\t\t\t\t\t\t\t\t\t\tFROM\t\t[Core].[ItemCostHistory]\r\n\t\t\t\t\t\t\t\t\t\tWHERE\t\t[COST_BOOK_ID] LIKE '%484'\r\n\t\t\t\t\t\t\t\t\t) cih\r\n\t\t\t\t\t\tLEFT JOIN\t(\r\n\t\t\t\t\t\t\t\t\t\tSELECT\t\tDISTINCT [Inventory Item ID]\r\n\t\t\t\t\t\t\t\t\t\t,\t\t\t[Item Code]\r\n\t\t\t\t\t\t\t\t\t\t,\t\t\t[Item Name]\r\n\t\t\t\t\t\t\t\t\t\t,\t\t\t[Unit Of Measure]\r\n\t\t\t\t\t\t\t\t\t\tFROM\t\t[Core].[Items]\r\n\t\t\t\t\t\t\t\t\t) i\r\n\t\t\t\t\t\tON\t\t\tcih.[INVENTORY_ITEM_ID] = i.[Inventory Item ID]\r\n\t\t\t\t\t\tWHERE\t\t[Latest Cost] = 1\r\n\t\t\t\t\t) ac\r\n\tON\t\t\tac.[VAL_UNIT_ID] = vu.[VAL_UNIT_ID]\r\n\tAND\t\t\tohb.[Item ID] = ac.[INVENTORY_ITEM_ID]\t\r\n\tLEFT JOIN\t[Core].[PurchaseOrders] po\r\n\tON\t\t\tpo.[Purchase Order Number] = ohb.[Lot Number]\r\n\tAND\t\t\tISNULL([TOTAL_COST],[Actual Cost]) IS NULL\r\n\tLEFT JOIN\t[Core].[FXRates] fx\r\n\tON\t\t\tCAST(LEFT([fx].[CONVERSION_DATE],10) AS DATE) = [ohb].[DateStamp]\t\t\r\n\tORDER BY\tohb.[Item Code]\r\n\r\n\t-- Currency Conversions\r\n\tIF OBJECT_ID('[SupplyChain].[InventoryQuantityAndValue]','U') IS NOT NULL\r\n\t\tDROP TABLE [SupplyChain].[InventoryQuantityAndValue]\r\n\r\n\tSELECT\t\t*\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [Currency Code] = 'GBP' THEN [Value]\r\n\t\t\t\t\tWHEN [Currency Code] = 'EUR' THEN [Value]*[EUR GBP]\r\n\t\t\t\t\tWHEN [Currency Code] = 'USD' THEN ([Value]*[EUR GBP])*[EUR USD]\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [Value GBP]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [Currency Code] = 'GBP' THEN [Price]\r\n\t\t\t\t\tWHEN [Currency Code] = 'EUR' THEN [Price]/[EUR GBP]\r\n\t\t\t\t\tWHEN [Currency Code] = 'USD' THEN ([Price]/[EUR GBP])*[EUR USD]\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [Price GBP]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [Currency Code] = 'EUR' THEN [Value]\r\n\t\t\t\t\tWHEN [Currency Code] = 'GBP' THEN [Value]/[EUR GBP]\r\n\t\t\t\t\tWHEN [Currency Code] = 'USD' THEN [Value]*[EUR USD]\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [Value EUR]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [Currency Code] = 'EUR' THEN [Price]\r\n\t\t\t\t\tWHEN [Currency Code] = 'GBP' THEN [Price]/[EUR GBP]\r\n\t\t\t\t\tWHEN [Currency Code] = 'USD' THEN [Price]*[EUR USD]\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [Price EUR]\r\n\tINTO\t\t[SupplyChain].[InventoryQuantityAndValue]\r\n \tFROM\t\t#InventoryValue"
						}
					]
				}
			}
		],
		"folder": {
			"name": "Supply Chain"
		},
		"annotations": []
	}
}