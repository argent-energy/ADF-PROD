{
	"name": "SQL_PurchaseContracts_SalesContracts",
	"properties": {
		"activities": [
			{
				"name": "PC_SC",
				"type": "Script",
				"dependsOn": [],
				"policy": {
					"timeout": "7.00:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"linkedServiceName": {
					"referenceName": "SqlServerArgent",
					"type": "LinkedServiceReference"
				},
				"typeProperties": {
					"scripts": [
						{
							"type": "NonQuery",
							"text": "/********************************************************************************************************\r\n\tStep 1.1:\tDelete current day's data from the final tables. This ensures that if the script is run more\r\n\t\t\t\tthan once in one day there is no duplicated data.\r\n********************************************************************************************************/\r\n\t\r\n\tDECLARE @DeleteTableStatement NVARCHAR(MAX)\r\n\tDECLARE Cur2 CURSOR READ_ONLY\r\n\tFOR\r\n\t\t\tSELECT  'Delete from [SupplyChain].[' + TABLE_NAME + ']  where CAST([DateStamp] AS DATE) = CAST(GETDATE() AS DATE)'\r\n\t\t\tFROM    INFORMATION_SCHEMA.TABLES\r\n\t\t\tWHERE   TABLE_SCHEMA = 'SupplyChain'\r\n\t\t\tAND\t\tTABLE_TYPE = 'BASE TABLE' \r\n\t\t\tAND\t\tTABLE_NAME IN ('SalesContracts','PurchaseContracts')\r\n\r\n\r\n\tOPEN Cur2\r\n\tFETCH NEXT FROM Cur2 INTO @DeleteTableStatement\r\n\tWHILE @@FETCH_STATUS = 0\r\n\t\t  BEGIN\r\n\t\t\t\tPRINT 'Executing ' + @DeleteTableStatement\r\n\t\t\t\tEXECUTE sp_executesql @DeleteTableStatement\r\n\t\t\t\tFETCH NEXT FROM Cur2 INTO @DeleteTableStatement\r\n\t\t  END\r\n\tCLOSE Cur2\r\n\tDEALLOCATE Cur2\r\n\t\r\n /********************************************************************************************************\r\n\tStep 1.2:\tAdd current day's purchase contracts data to SupplyChain.PurchaseContracts\r\n********************************************************************************************************/\t\r\n\t\r\n\t\r\nINSERT INTO [SupplyChain].[PurchaseContracts]\r\n\tSELECT\t\to.[Business Unit Name]\r\n\t,\t\t\tpc.[Blanket Purchase Agreement Number] \r\n\t,\t\t\tCONCAT(LEFT(pc.[Purchase Document Status],1),LOWER(SUBSTRING(pc.[Purchase Document Status],2,LEN(pc.[Purchase Document Status])-1)))\t\tAS [Purchase Document Status]\r\n\t,\t\t\tUPPER(sn.[Supplier Name])\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Supplier Name]\r\n\t,\t\t\tUPPER(s.[Supplier Site Name])\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Supplier Site Name]\r\n\t,\t\t\tpc.[Purchase Document Description]\r\n\t,\t\t\ti.[Item Code]\r\n\t,\t\t\ti.[Item Name]\r\n\t,\t\t\tpc.[Item Description]\r\n\t,\t\t\ti.[Category Code] \r\n\t,\t\t\tpc.[Unit Price] + pc.[Transporter Unit Price] + pc.[Additional Charges 1 Unit Price] + pc.[Additional Charges 2 Unit Price]\r\n\t\t\t\t+ ISNULL(CASE \r\n\t\t\t\t\t\t\tWHEN p.[Shipping Method] IN ('Argent - Truck','Argent - Container','AENL - Truck','AENL - Container','Argent - Drop Ship')\r\n\t\t\t\t\t\t\t\tTHEN (pc.[Transporter Amount] + pc.[Additional Charges 1 Amount] + pc.[Additional Charges 2 Amount])/25\r\n\t\t\t\t\t\t\tELSE (pc.[Transporter Amount] + pc.[Additional Charges 1 Amount] + pc.[Additional Charges 2 Amount])/CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN i.[Item Code] = 'CH00006'\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 650\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE NULLIF(pc.[Blanket Agreement Quantity],0)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\t END,0)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Total Price]\r\n\t,\t\t\tpc.[Unit Price]\r\n\t,\t\t\tpc.[Purchase Document Currency]\r\n\t,\t\t\tISNULL(pc.[Blanket Agreement Quantity],0)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Blanket Agreement Quantity]\r\n\t,\t\t\tpc.[UOM Code]\r\n\t,\t\t\tISNULL(dq.[Delivered Qty],0) - ISNULL(rq.[Returned Qty],0)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Delivered Quantity]\r\n\t,\t\t\tISNULL(oq.[Ordered Qty],0)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Order Quantity]\r\n\t,\t\t\tISNULL(pc.[Blanket Agreement Quantity],0) - (ISNULL(dq.[Delivered Qty],0) - ISNULL(rq.[Returned Qty],0)) - ISNULL(oq.[Ordered Qty],0)\t\tAS [Remaining Quantity]\r\n\t,\t\t\t(ISNULL(pc.[Blanket Agreement Quantity],0) - (ISNULL(dq.[Delivered Qty],0) - ISNULL(rq.[Returned Qty],0)) - ISNULL(oq.[Ordered Qty],0))/25\tAS [Trucks]\r\n\t,\t\t\t((ISNULL(dq.[Delivered Qty],0) - ISNULL(rq.[Returned Qty],0)) + ISNULL(oq.[Ordered Qty],0))/NULLIF(pc.[Blanket Agreement Quantity],0)\t\tAS [Position Now]\r\n\r\n\t--          Calculation below is [Expected Position] = 1 - ([Weeks Remaining]/[Weeknumbers Contract])\r\n\t,\t\t\t1 - (CAST(CASE\r\n\t\t\t\t\t\t\t\tWHEN CONVERT(DATE, DATEADD(DAY, 1, GETDATE() - DATEPART(DW, GETDATE()) + CASE WHEN DATEPART(DW, GETDATE()) < 1 THEN 0 ELSE 7 END )) < CAST(pc.[Agreement Start Date] AS DATE)\r\n\t\t\t\t\t\t\t\t\tTHEN\tCASE\r\n\t\t\t\t\t\t\t\t\t\t\t\tWHEN pc.[Agreement Start Date] IS NULL OR CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND IS NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 0\r\n\t\t\t\t\t\t\t\t\t\t\t\tELSE DATEDIFF(DAY,pc.[Agreement Start Date],CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] <> NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND)/7\r\n\t\t\t\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\t\t\tWHEN CONVERT(DATE, DATEADD(DAY, 1, GETDATE() - DATEPART(DW, GETDATE()) + CASE WHEN DATEPART(DW, GETDATE()) < 1 THEN 0 ELSE 7 END )) > CAST(CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND AS DATE)\r\n\t\t\t\t\t\t\t\t\tTHEN 0\r\n\t\t\t\t\t\t\t\tELSE DATEDIFF(DAY,CONVERT(DATE, DATEADD(DAY, 1, GETDATE() - DATEPART(DW, GETDATE()) + CASE WHEN DATEPART(DW, GETDATE()) < 1 THEN 0 ELSE 7 END )),CAST(CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND AS DATE))/7\r\n\t\t\t\t\t\t  END AS DECIMAL(28,2))\t\t\t\t\t\r\n\t\t\t\t\t/CAST(NULLIF(CASE\r\n\t\t\t\t\t\t\t\t\tWHEN pc.[Agreement Start Date] IS NULL OR CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND IS NULL\r\n\t\t\t\t\t\t\t\t\t\tTHEN 0\r\n\t\t\t\t\t\t\t\t\tELSE DATEDIFF(DAY,pc.[Agreement Start Date],CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND)/7\r\n\t\t\t\t\t\t\t\tEND,0) AS DECIMAL(28,2)))\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Expected Position]\r\n\r\n\t-- [Weeknumbers Contract] is calculated below as difference between [Agreement Start Date] and [Agreement End Date]\r\n\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN pc.[Agreement Start Date] IS NULL OR CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND IS NULL\r\n\t\t\t\t\t\tTHEN 0\r\n\t\t\t\t\tELSE DATEDIFF(DAY,pc.[Agreement Start Date],CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND)/7\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Weeknumbers Contract]\r\n\r\n\t-- [Weeks Remaining] is calculated below as\t\t- Difference between [Agreement Start Date and [Agreement End Date] if GETDATE() < [Agreement Start Date]\r\n\t--\t\t\t\t\t\t\t\t\t\t\t\t- 0 if GETDATE() > [Agreement End Date]\r\n\t--\t\t\t\t\t\t\t\t\t\t\t\t- ELSE difference between [Next Monday] and [Agreement End Date]\r\n\r\n\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN CONVERT(DATE, DATEADD(DAY, 1, GETDATE() - DATEPART(DW, GETDATE()) + CASE WHEN DATEPART(DW, GETDATE()) < 1 THEN 0 ELSE 7 END )) < CAST(pc.[Agreement Start Date] AS DATE)\r\n\t\t\t\t\t\t THEN\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN pc.[Agreement Start Date] = '' OR CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND IS NULL\r\n\t\t\t\t\t\t\t\t\t\tTHEN 0\r\n\t\t\t\t\t\t\t\t\tELSE DATEDIFF(DAY,pc.[Agreement Start Date],CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND)/7\r\n\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\tWHEN CONVERT(DATE, DATEADD(DAY, 1, GETDATE() - DATEPART(DW, GETDATE()) + CASE WHEN DATEPART(DW, GETDATE()) < 1 THEN 0 ELSE 7 END )) > CAST(CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND AS DATE)\r\n\t\t\t\t\t\t THEN 0\r\n\t\t\t\t\tELSE DATEDIFF(DAY,CONVERT(DATE, DATEADD(DAY, 1, GETDATE() - DATEPART(DW, GETDATE()) + CASE WHEN DATEPART(DW, GETDATE()) < 1 THEN 0 ELSE 7 END )),CAST(CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND AS DATE))/7\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Weeks Remaining]\r\n\r\n\t,\t\t\tCONVERT(DATE, DATEADD(DAY, 1, GETDATE() - DATEPART(DW, GETDATE()) + CASE WHEN DATEPART(DW, GETDATE()) < 1 THEN 0 ELSE 7 END + 1 ))\t\t\tAS [Next Monday]\r\n\t,\t\t\tpc.[Agreement Start Date]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\tELSE pc.[Agreement End Date]\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Agreement End Date]\r\n\t,\t\t\tp.[Shipping Method]\r\n\t,\t\t\tpc.[Incoterm]\r\n\t,\t\t\tpc.[Transporter Name]\r\n\t,\t\t\tpc.[Transporter Unit Price]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN pc.[Transporter Amount] <> 0\r\n\t\t\t\t\t\tTHEN [pc].[Transporter Amount]\r\n\t\t\t\t\tELSE CASE \r\n\t\t\t\t\t\t\tWHEN p.[Shipping Method] IN ('Argent - Truck','Argent - Container','AENL - Truck','AENL - Container','Argent - Drop Ship')\r\n\t\t\t\t\t\t\t\tTHEN pc.[Transporter Unit Price] * 25\r\n\t\t\t\t\t\t\tELSE pc.[Transporter Unit Price] *  CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHEN i.[Item Code] = 'CH00006'\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tTHEN 650\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tELSE NULLIF(pc.[Blanket Agreement Quantity],0)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\tEND\r\n\t\t\t\tEND AS [Transporter Amount]\r\n\t,\t\t\tISNULL(pc.[Transporter Currency],pc.[Purchase Document Currency]) AS [Transporter Currency]\r\n\t,\t\t\tpc.[Additional Charges 1 Supplier]\t\r\n\t,\t\t\tpc.[Additional Charges 1 Unit Price]\r\n\t,\t\t\tpc.[Additional Charges 1 Amount]\r\n\t,\t\t\tpc.[Additional Charges 1 Currency]\r\n\t,\t\t\tpc.[Additional Charges 2 Supplier]\t\r\n\t,\t\t\tpc.[Additional Charges 2 Unit Price]\r\n\t,\t\t\tpc.[Additional Charges 2 Amount]\r\n\t,\t\t\tpc.[Additional Charges 2 Currency]\r\n\t,\t\t\tu.[Username]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Buyer]\r\n\t,\t\t\tpc.[Sustainability Position]\r\n\t,\t\t\tpc.[Supplier Item]\r\n\t,\t\t\tpc.[Deal Date]\r\n\t,\t\t\tpc.[Agreement Amount]\r\n\t,\t\t\tpc.[Amount Released Against Agreement]\r\n\t,\t\t\tpc.[Note To Vendor]\r\n\t,\t\t\tpc.[FFA Spec]\t\t\t\r\n\t,\t\t\tpc.[Line Status]\r\n\t,\t\t\tfx.[EUR USD]\r\n\t,\t\t\tfx.[EUR GBP]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN CASE\tWHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL THEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31') ELSE pc.[Agreement End Date]  END IS NULL\r\n\r\n\r\n\t\t\t\t\tTHEN CONCAT(LEFT(pc.[Purchase Document Status],1),LOWER(SUBSTRING(pc.[Purchase Document Status],2,LEN(pc.[Purchase Document Status])-1)))\r\n\t\t\t\t\t\r\n\t\t\t\t\tWHEN pc.[Purchase Document Status] not in ('closed' ,'finally closed', 'canceled') AND CAST(CASE WHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL THEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31') ELSE pc.[Agreement End Date] END AS DATE) < GETDATE()\r\n\t\t\t\t\t\tTHEN 'Closed'\r\n\t\t\t\t\tELSE CONCAT(LEFT(pc.[Purchase Document Status],1),LOWER(SUBSTRING(pc.[Purchase Document Status],2,LEN(pc.[Purchase Document Status])-1)))\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Updated Contract Status]\r\n\t,\t\t\tCAST(GETDATE() AS DATE)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [DateStamp]\r\n\t,\t\t\tISNULL(pc.[Blanket Agreement Quantity],0) * ISNULL(ISNULL(y.[Expected yield],av.[Average Yield]),av2.[Average Yield])\t\t\t\t\t\t\tAS [Yield Adjusted Volume]\r\n\t,\t\t\tCAST(ISNULL(ISNULL(DATEADD(d,DATEDIFF(d,pc.[Agreement Start Date],CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t \t  WHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t \t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t \t  ELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t END)/2,pc.[Agreement Start Date]),pc.[Agreement Start Date]),CASE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  \t  WHEN LEFT(i.[Item Code],2) = 'CH' AND pc.[Agreement End Date] IS NULL AND pc.[Agreement Start Date] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  \t\tTHEN CONCAT(YEAR(pc.[Agreement Start Date]),'-12-31')\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  \t  ELSE pc.[Agreement End Date]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  END) AS DATE)\t\t\tAS [Agreement Mid Date]\t\r\n\t,\t\t\tISNULL(pc.[Blanket Agreement Quantity],0) - (ISNULL(dq.[Delivered Qty],0) - ISNULL(rq.[Returned Qty],0))\t\t\t\t\t\t\t\t\t\tAS [Non-Delivered Quantity]\r\n\t,\t\t\t(ISNULL(pc.[Blanket Agreement Quantity],0) - (ISNULL(dq.[Delivered Qty],0) - ISNULL(rq.[Returned Qty],0)))\r\n\t\t\t\t\t* ISNULL(ISNULL(y.[Expected yield],av.[Average Yield]),av2.[Average Yield])\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Yield Adjusted Volume Non-Delivered]\r\n\tFROM\t\t[Core].[PurchaseContracts] pc\r\n\tLEFT JOIN\t[Core].[Suppliers] s\r\n\tON\t\t\tpc.[Supplier] = s.[Vendor ID]\r\n\tAND\t\t\tpc.[Vendor Site ID] = s.[Vendor Site ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Party ID] \r\n\t\t\t\t\t,\t\t\tMIN([Party Name])\tAS [Supplier Name]\r\n\t\t\t\t\tFROM\t\t[Core].[Parties]\r\n\t\t\t\t\tGROUP BY\t[Party ID]\r\n\t\t\t\t) sn\r\n\tON\t\t\ts.[Party ID] = sn.[Party ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Business Unit ID]\r\n\t\t\t\t\t,\t\t\t[Business Unit Name]\r\n\t\t\t\t\tFROM\t\t[Core].[Organizations]\r\n\t\t\t\t\tGROUP BY\t[Business Unit ID]\r\n\t\t\t\t\t,\t\t\t[Business Unit Name]\r\n\t\t\t\t) o\r\n\tON\t\t\tpc.[Purchasing BU] = o.[Business Unit ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Item Code]\r\n\t\t\t\t\t,\t\t\t[Inventory Item ID]\r\n\t\t\t\t\t,\t\t\t[Category Code]\r\n\t\t\t\t\t,\t\t\tMIN([Item Name])\tAS [Item Name]\r\n\t\t\t\t\tFROM\t\t[Core].[Items]\r\n\t\t\t\t\tGROUP BY\t[Item Code]\r\n\t\t\t\t\t,\t\t\t[Inventory Item ID]\r\n\t\t\t\t\t,\t\t\t[Category Code]\r\n\t\t\t\t) i \r\n\tON\t\t\ti.[Inventory Item ID] = pc.[Item ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Party ID]\r\n\t\t\t\t\t,\t\t\tMIN([Party Name])\tAS [Shipping Method]\r\n\t\t\t\t\tFROM\t\t[Core].[Parties]\r\n\t\t\t\t\tGROUP BY\t[Party ID]\r\n\t\t\t\t) p\r\n\tON\t\t\tpc.[Carrier ID] = p.[Party ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[From Header ID]\r\n\t\t\t\t\t,\t\t\t[po].[From Line ID]\r\n\t\t\t\t\t,\t\t\tSUM(ISNULL(CAST(CASE WHEN LTRIM(RTRIM(rt.[Primary Quantity])) IS NULL THEN '0' ELSE LTRIM(RTRIM(rt.[Primary Quantity])) END AS NUMERIC(28,8)),0)) AS [Delivered Qty]\r\n\t\t\t\t\tFROM\t\t[Core].[PurchaseOrders] po\r\n\t\t\t\t\tLEFT JOIN\t[Core].[ReceivingTransactions] rt\r\n\t\t\t\t\tON\t\t\trt.[PO Line ID] = po.[PO Line ID]\r\n\t\t\t\t\tWHERE\t\trt.[Destination Type Code] = 'INVENTORY'\r\n\t\t\t\t\tAND\t\t\tpo.[Line Status] NOT IN ('OPEN','CANCELED','CLOSED FOR INVOICING')\r\n\t\t\t\t\tAND\t\t\trt.[Transaction Type] <> 'RETURN TO RECEIVING'\r\n\t\t\t\t\tGROUP BY\t[From Header ID]\r\n\t\t\t\t\t,\t\t\t[po].[From Line ID]\r\n\t\t\t\t) dq\r\n\tON\t\t\tdq.[From Header ID] = pc.[PO Header ID]\r\n\tAND\t\t\tdq.[From Line ID] = pc.[PO Line ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[From Header ID]\r\n\t\t\t\t\t,\t\t\t[po].[From Line ID]\r\n\t\t\t\t\t,\t\t\tSUM(ISNULL(CAST(CASE WHEN LTRIM(RTRIM(rt.[Primary Quantity])) IS NULL THEN '0' ELSE LTRIM(RTRIM(rt.[Primary Quantity])) END AS NUMERIC(28,8)),0)) AS [Returned Qty]\r\n\t\t\t\t\tFROM\t\t[Core].[PurchaseOrders] po\r\n\t\t\t\t\tLEFT JOIN\t[Core].[ReceivingTransactions] rt\r\n\t\t\t\t\tON\t\t\trt.[PO Line ID] = po.[PO Line ID]\r\n\t\t\t\t\tWHERE\t\trt.[Destination Type Code] = 'INVENTORY'\r\n\t\t\t\t\tAND\t\t\tpo.[Line Status] NOT IN ('OPEN','CANCELED','CLOSED FOR INVOICING')\r\n\t\t\t\t\tAND\t\t\trt.[Transaction Type] = 'RETURN TO RECEIVING'\r\n\t\t\t\t\tGROUP BY\t[From Header ID]\r\n\t\t\t\t\t,\t\t\t[po].[From Line ID]\r\n\t\t\t\t) rq\r\n\tON\t\t\trq.[From Header ID] = pc.[PO Header ID]\r\n\tAND\t\t\trq.[From Line ID] = pc.[PO Line ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[From Header ID]\r\n\t\t\t\t\t,\t\t\t[From Line ID]\r\n\t\t\t\t\t,\t\t\tSUM(ISNULL(CAST(CASE WHEN LTRIM(RTRIM([Ordered Quantity])) IS NULL THEN '0' ELSE LTRIM(RTRIM([Ordered Quantity])) END AS NUMERIC(28,8)),0)) AS [Ordered Qty]\r\n\t\t\t\t\tFROM\t\t[Core].[PurchaseOrders]\r\n\t\t\t\t\tWHERE\t\t[Line Status] IN ('OPEN','CLOSED FOR INVOICING')\r\n\t\t\t\t\tGROUP BY\t[From Header ID]\r\n\t\t\t\t\t,\t\t\t[From Line ID]\r\n\t\t\t\t) oq\r\n\tON\t\t\toq.[From Header ID] = pc.[PO Header ID]\r\n\tAND\t\t\toq.[From Line ID] = pc.[PO Line ID]\r\n\tLEFT JOIN\t[Core].[Users] u\r\n\tON\t\t\tpc.[Buyer] = u.[Person ID]\r\n\tLEFT JOIN\t[Core].[FXRates] fx\r\n\tON\t\t\tCAST(pc.[Agreement Start Date] AS DATE) = CAST(fx.[CONVERSION_DATE] AS DATE)\r\n\tLEFT JOIN\t[Trade].[Yield] y\r\n\tON\t\t\to.[Business Unit Name] = y.[Business Unit]\r\n\tAND\t\t\tCASE WHEN i.[Category Code] = 'Feedstock.TallowABP' THEN 'Feedstock.Tallow' ELSE i.[Category Code] END = y.[Item Category]\r\n\tAND\t\t\t(CASE WHEN YEAR(CAST(pc.[Agreement Start Date] AS DATE)) < 2020 THEN CAST('2020-01-01' AS DATE)\r\n\t\t\t\t\t ELSE CAST(pc.[Agreement Start Date] AS DATE)\r\n\t\t\t\tEND BETWEEN y.[Start Date] AND y.[End date] OR (pc.[Agreement Start Date] > y.[Start Date] AND y.[End date] IS NULL))\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\t\tSELECT\t\tDISTINCT [Business Unit]\r\n\t\t\t\t\t\t,\t\t\t[Start date]\r\n\t\t\t\t\t\t,\t\t\t[End date]\r\n\t\t\t\t\t\t,\t\t\tAVG(CAST([Expected yield] AS DECIMAL(28,8)))OVER(PARTITION BY [Business Unit], [Start date]) AS [Average Yield]\r\n\t\t\t\t\t\tFROM\t\t[Trade].[Yield]\t\r\n\t\t\t\t) av\r\n\tON\t\t\to.[Business Unit Name] = av.[Business Unit]\r\n\tAND\t\t\tCASE WHEN YEAR(CAST(pc.[Agreement Start Date] AS DATE)) < 2020 THEN CAST('2020-01-01' AS DATE)\r\n\t\t\t\t\t ELSE CAST(pc.[Agreement Start Date] AS DATE)\r\n\t\t\t\tEND BETWEEN av.[Start Date] AND ISNULL(av.[End date],CAST(GETDATE() AS DATE))\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\t\tSELECT\t\tDISTINCT [Business Unit]\r\n\t\t\t\t\t\t,\t\t\t[Start date]\r\n\t\t\t\t\t\t,\t\t\t[End date]\r\n\t\t\t\t\t\t,\t\t\tAVG(CAST([Expected yield] AS DECIMAL(28,8)))OVER(PARTITION BY [Business Unit], [Start date]) AS [Average Yield]\r\n\t\t\t\t\t\tFROM\t\t[Trade].[Yield]\t\r\n\t\t\t\t\t\tWHERE\t\tCAST(GETDATE() AS DATE) BETWEEN [Start Date] AND ISNULL([End date],CAST(GETDATE() AS DATE))\r\n\t\t\t\t) av2\r\n\tON\t\t\to.[Business Unit Name] = av2.[Business Unit]\r\n\tWHERE\t\to.[Business Unit Name] NOT IN ('ROTIE BU','Quatra BU')\r\n\tAND\t\t\tpc.[Blanket Purchase Agreement Number] NOT IN (\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tSELECT\t\tDISTINCT [Blanket Purchase Agreement Number]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tFROM\t\t[Core].[PurchaseContracts]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tWHERE\t\t[Amount Released Against Agreement] = 0\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAND\t\t\t[Agreement End Date] < '2021-07-01'\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t   ) \t\r\n\r\n\r\n /********************************************************************************************************\r\n\tStep 1.3:\tAdd current day's sales contracts data to SupplyChain.SalesContracts\r\n********************************************************************************************************/\t\r\n\r\n\tINSERT INTO [SupplyChain].[SalesContracts]\t\t\t\r\n\tSELECT\t\to.[Business Unit Name]\r\n\t,\t\t\tsc.[Sales Contract Number]\r\n\t,\t\t\tsc.[Sales Contract Version]\r\n\t,\t\t\tREPLACE(CONCAT(LEFT(sc.[Sales Contract Status],1),LOWER(SUBSTRING(sc.[Sales Contract Status],2,LEN(sc.[Sales Contract Status])-1))),'_',' ')\tAS [Sales Contract Status]\r\n\t,\t\t\tUPPER(c.[Customer])\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Customer]\r\n\t,\t\t\tc.[Customer Number]\r\n\t,\t\t\tUPPER(sc.[Customer Bill To])\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Customer Bill To]\r\n\t,\t\t\tUPPER(sc.[Customer Ship To])\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Customer Ship To]\r\n\t,\t\t\tsc.[Description]\r\n\t,\t\t\tsc.[Additional Description]\r\n\t,\t\t\tsc.[Item Name]\r\n\t,\t\t\ti.[Item Name]\tAS [Item Description]\r\n\t,\t\t\ti.[Category Code]\r\n\t,\t\t\tCAST(CASE WHEN sc.[Agreement Price] IS NULL THEN '0' ELSE sc.[Agreement Price] END AS NUMERIC(28,8)) \r\n\t\t\t\t- CAST(CASE WHEN sc.[Transporter Unit Price] IS NULL THEN '0' ELSE sc.[Transporter Unit Price] END AS NUMERIC(28,2))\r\n\t\t\t\t- CAST(CASE WHEN sc.[Additional Charges 1 Unit Price] IS NULL THEN '0' ELSE sc.[Additional Charges 1 Unit Price] END AS NUMERIC(28,2))\r\n\t\t\t\t- CAST(CASE WHEN sc.[Additional Charges 2 Unit Price] IS NULL THEN '0' ELSE sc.[Additional Charges 2 Unit Price] END AS NUMERIC(28,2))\t\tAS [Total Price per tonne]\r\n\t,\t\t\t(CAST(CASE WHEN sc.[Transporter Amount] IS NULL THEN '0' ELSE sc.[Transporter Amount] END AS NUMERIC(28,2))\r\n\t\t\t\t+ CAST(CASE WHEN sc.[Additional Charges 1 Amount] IS NULL THEN '0' ELSE sc.[Additional Charges 1 Amount] END AS NUMERIC(28,2))\r\n\t\t\t\t+ CAST(CASE WHEN sc.[Additional Charges 2 Amount] IS NULL THEN '0' ELSE sc.[Additional Charges 2 Amount] END AS NUMERIC(28,2))) * (-1)\t\tAS [Add. Cost per Transport]\r\n\t,\t\t\tsc.[Currency Code]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN sc.[Line Quantity] IS NULL\r\n\t\t\t\t\t\tTHEN CAST(CASE WHEN sc.[Line Amount] IS NULL THEN '0' ELSE sc.[Line Amount] END AS NUMERIC(28,2))/NULLIF(CAST(CASE WHEN sc.[Agreement Price] IS NULL THEN '0' ELSE sc.[Agreement Price] END AS NUMERIC(28,2)),0)\r\n\t\t\t\t\tELSE CAST(sc.[Line Quantity] AS NUMERIC(28,2))\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Line Quantity]\r\n\t,\t\t\tsc.[UOM Code]\r\n\t,\t\t\tsc.[Line Start Date]\r\n\t,\t\t\tsc.[Line End Date]\r\n\t,\t\t\tsc.[Shipping Method]\r\n\t,\t\t\tsc.[Incoterm]\r\n\t,\t\t\to.[Business Unit Name]\t\t\t\t\t\t\t\tAS [Seller]\r\n\t,\t\t\tISNULL(q.[Order Quantity],0)\t\t\t\t\t\tAS [Order Quantity]\t\r\n\t,\t\t\tISNULL(q.[Shipped Quantity],0)\t\t\t\t\t\tAS [Shipped Quantity]\r\n\t,\t\t\tsc.[Line Amount]\r\n\t,\t\t\tsc.[Agreement Price]\r\n\t,\t\t\tsc.[Transporter]\r\n\t,\t\t\tsc.[Transporter Unit Price]\r\n\t,\t\t\tsc.[Transporter Amount]\r\n\t,\t\t\tsc.[Transporter Currency]\r\n\t,\t\t\tsc.[Additional Charges 1 Supplier]\r\n\t,\t\t\tsc.[Additional Charges 1 Description]\r\n\t,\t\t\tsc.[Additional Charges 1 Unit Price]\r\n\t,\t\t\tsc.[Additional Charges 1 Amount]\r\n\t,\t\t\tsc.[Additional Charges 1 Currency]\r\n\t,\t\t\tsc.[Additional Charges 2 Supplier]\r\n\t,\t\t\tsc.[Additional Charges 2 Description]\r\n\t,\t\t\tsc.[Additional Charges 2 Unit Price]\r\n\t,\t\t\tsc.[Additional Charges 2 Amount]\r\n\t,\t\t\tsc.[Additional Charges 2 Currency]\r\n\t,\t\t\tsc.[Trader]\r\n\t,\t\t\tsc.[Deal Date]\r\n\t,\t\t\tsc.[Payment Term]\r\n\t,\t\t\tsc.[Tolerance]\r\n\t,\t\t\tsc.[Laycan]\r\n\t,\t\t\tsc.[Sustainability Contact]\r\n\t,\t\t\tsc.[Sustainability Position]\r\n\t,\t\t\tsc.[Sustainability Position Details]\r\n\t,\t\t\tsc.[Quality]\r\n\t,\t\t\tsc.[Temperature]\r\n\t,\t\t\tsc.[Nomination]\r\n\t,\t\t\tsc.[Nomination Requirement]\t\r\n\t,\t\t\tsc.[Lay Time]\r\n\t,\t\t\tsc.[Inspection]\r\n\t,\t\t\tsc.[Detenation Demurrage]\r\n\t,\t\t\tsc.[Demurrage Vessel]\r\n\t,\t\t\tsc.[Legislation]\r\n\t,\t\t\tsc.[Disposal Method]\r\n\t,\t\t\tsc.[Waste Stream Number]\r\n\t,\t\t\tsc.[Waste Description]\r\n\t,\t\t\tsc.[VET ID]\r\n\t,\t\t\tfx.[EUR USD]\r\n\t,\t\t\tfx.[EUR GBP]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN sc.[Sales Contract Status] not in ('Closed', 'Canceled','Finally closed', 'expired') AND ISDATE([Line End Date]) = 1 AND CAST([Line End Date] AS DATE) < GETDATE()\r\n\t\t\t\t\t\tTHEN 'Closed'\r\n\t\t\t\t\tELSE sc.[Sales Contract Status]\r\n\t\t\t\tEND\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Updated Contract Status]\r\n\t,\t\t\tCAST(GETDATE() AS DATE)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [DateStamp]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN sc.[Line Quantity] IS NULL\r\n\t\t\t\t\t\tTHEN CAST(CASE WHEN sc.[Line Amount] IS NULL THEN '0' ELSE sc.[Line Amount] END AS NUMERIC(28,2))/NULLIF(CAST(CASE WHEN sc.[Agreement Price] IS NULL THEN '0' ELSE sc.[Agreement Price] END AS NUMERIC(28,2)),0)\r\n\t\t\t\t\tELSE CAST(sc.[Line Quantity] AS NUMERIC(28,2))\r\n\t\t\t\tEND - ISNULL(q.[Shipped Quantity],0)\t\t\t\tAS [Volume Non-Delivered]\r\n\t,\t\t\tCAST(ISNULL(ISNULL(DATEADD(d,DATEDIFF(d,sc.[Line Start Date],sc.[Line End Date])/2,sc.[Line Start Date]),sc.[Line Start Date]),sc.[Line End Date]) AS DATE) AS [Line Mid Date]\r\n\tFROM\t\t[Core].[SalesContracts] sc\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Party ID]\r\n\t\t\t\t\t,\t\t\t[Party Number]\t\tAS [Customer Number]\r\n\t\t\t\t\t,\t\t\tMIN([Party Name])\tAS [Customer]\r\n\t\t\t\t\tFROM\t\t[Core].[Parties]\r\n\t\t\t\t\tGROUP BY\t[Party ID]\r\n\t\t\t\t\t,\t\t\t[Party Number]\r\n\t\t\t\t) c\r\n\tON\t\t\tsc.[Sales Contract Customer] = c.[Party ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Business Unit ID]\r\n\t\t\t\t\t,\t\t\t[Business Unit Name]\r\n\t\t\t\t\tFROM\t\t[Core].[Organizations]\r\n\t\t\t\t\tGROUP BY\t[Business Unit ID]\r\n\t\t\t\t\t,\t\t\t[Business Unit Name]\r\n\t\t\t\t) o\r\n\tON\t\t\tsc.[Business Unit] = o.[Business Unit ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Item Code]\r\n\t\t\t\t\t,\t\t\t[Item Name]\r\n\t\t\t\t\t,\t\t\t[Category Code]\r\n\t\t\t\t\tFROM\t\t[Core].[Items] \r\n\t\t\t\t\tWHERE\t\t[Organization ID] = '300000001513519' --Master Stock List\r\n\t\t\t\t\tGROUP BY\t[Item Code]\r\n\t\t\t\t\t,\t\t\t[Item Name]\r\n\t\t\t\t\t,\t\t\t[Category Code]\r\n\t\t\t\t) i\r\n\tON\t\t\ti.[Item Code] = sc.[Item Name]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tsc.[Contract Header ID]\r\n\t\t\t\t\t,\t\t\tsc.[Line ID]\r\n\t\t\t\t\t,\t\t\tSUM(CAST(sof.[FULFILLED_QTY] AS NUMERIC(28,2)) - 2*CAST(sof.[RMA_DELIVERED_QTY] AS NUMERIC(28,2)))\tAS [Shipped Quantity]\r\n\t\t\t\t\t,\t\t\tSUM(CAST(sof.[ORDERED_QTY] AS NUMERIC(28,2)) - CAST(sof.[FULFILLED_QTY] AS NUMERIC(28,2)))\t\t\tAS [Order Quantity]\r\n\t\t\t\t\tFROM\t\t[Core].[SalesContracts] sc\r\n\t\t\t\t\tLEFT JOIN\t[Core].[SalesOrders_Fulfilled] sof\r\n\t\t\t\t\tON\t\t\tsc.[Contract Header ID] = sof.[AGREEMENT_HEADER_ID]\r\n\t\t\t\t\tAND\t\t\tsc.[Line ID] = sof.[AGREEMENT_LINE_ID]\r\n\t\t\t\t\tWHERE\t\tsc.[Version Type] = 'C'\r\n\t\t\t\t\tAND\t\t\tsof.[ORDERED_UOM] = 'TN'\r\n\t\t\t\t\tAND\t\t\tsof.[REFERENCE_FLINE_ID] IS NULL\r\n\t\t\t\t\tGROUP BY\tsc.[Contract Header ID]\r\n\t\t\t\t\t,\t\t\tsc.[Line ID]\r\n\t\t\t\t) q\t\r\n\tON\t\t\tsc.[Contract Header ID] = q.[Contract Header ID]\r\n\tAND\t\t\tsc.[Line ID] = q.[Line ID]\r\n\tLEFT JOIN\t[Core].[FXRates] fx\r\n\tON\t\t\tCAST(sc.[Line Start Date] AS DATE) = CAST(fx.[CONVERSION_DATE] AS DATE)\r\n\tWHERE\t\t[Version Type] = 'C'\r\n\tAND\t\t\to.[Business Unit Name] NOT IN ('ROTIE BU','Quatra BU')\t\t\t\t\t\t\t\r\n\t\r\n\t"
						}
					]
				}
			}
		],
		"folder": {
			"name": "Supply Chain"
		},
		"annotations": []
	}
}