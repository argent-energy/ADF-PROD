{
	"name": "SQL_Exceptions",
	"properties": {
		"activities": [
			{
				"name": "ExceptionsTables",
				"type": "Script",
				"dependsOn": [],
				"policy": {
					"timeout": "7.0:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"linkedServiceName": {
					"referenceName": "SqlServerArgent",
					"type": "LinkedServiceReference"
				},
				"typeProperties": {
					"scripts": [
						{
							"type": "NonQuery",
							"text": "/*EXCEPTIONS REPORT TABLES*/\r\n\r\n/********************************************************************************************************\r\n\tStep 1.1\tCreate table of sales orders not captured in invoice table\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Finance].[SalesOrdersNotInvoiced]','U') IS NOT NULL\r\n\t\tDROP TABLE [Finance].[SalesOrdersNotInvoiced]\r\n\r\n\tSELECT\t\t*\r\n\tINTO\t\t[Finance].[SalesOrdersNotInvoiced]\r\n\tFROM\t\t[Core].[SalesOrders] so\r\n\tWHERE\t\t[Order Number] NOT IN\t(\r\n\t\t\t\t\t\t\t\t\t\t\t\tSELECT\t\t[Order Number]\r\n\t\t\t\t\t\t\t\t\t\t\t\tFROM\t\t[Core].[SalesOrders] so\r\n\t\t\t\t\t\t\t\t\t\t\t\tLEFT JOIN\t[Core].[ARInvoices] ar\r\n\t\t\t\t\t\t\t\t\t\t\t\tON\t\t\tso.[Order Number] = ar.[SALES_ORDER]\r\n\t\t\t\t\t\t\t\t\t\t\t\tWHERE\t\tar.[SALES_ORDER] IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t) \r\n\tAND\t\t\t[Order Number] IN\t(\r\n\t\t\t\t\t\t\t\t\t\tSELECT\t[Document Number]\r\n\t\t\t\t\t\t\t\t\t\tFROM\t[Finance].[Traceability]\r\n\t\t\t\t\t\t\t\t\t)\r\n\r\n/********************************************************************************************************\r\n\tStep 1.2\tCreate table of invoices not captured in sales orders table\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Finance].[InvoicesNotInSalesOrders]','U') IS NOT NULL\r\n\t\tDROP TABLE [Finance].[InvoicesNotInSalesOrders]\r\n\r\n\tSELECT\t\t* \r\n\tINTO\t\t[Finance].[InvoicesNotInSalesOrders]\r\n\tFROM\t\tCore.ARInvoices ar\r\n\tWHERE\t\t[SALES_ORDER_LINE] NOT IN\t(\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tSELECT\t\tDISTINCT [Line ID]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tFROM\t\t[Core].[SalesOrders]\r\n\t\t\t\t\t\t\t\t\t\t\t)\r\n\r\n/********************************************************************************************************\r\n\tStep 1.3\tCreate an expanded version of the Trade orders and invoices table\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Finance].[ExpandedOrdersAndInvoices]','U') IS NOT NULL\r\n\t\tDROP TABLE [Finance].[ExpandedOrdersAndInvoices]\r\n\r\n\tSELECT\t\t'PO' AS [Source]\r\n\t,\t\t\t[Order Number]\r\n\t,\t\t\t[Parent Order]\r\n\t,\t\t\t[Supplier/Customer]\r\n\t,\t\t\t[Supplier/Customer Number]\r\n\t,\t\t\t[Agreement Number/Sales Contract Number]\r\n\t,\t\t\t[Item Code]\r\n\t,\t\t\t[Item Description]\r\n\t,\t\t\t[Category Code]\r\n\t,\t\t\t[Agreement Price]\r\n\t,\t\t\t[Quantity]\r\n\t,\t\t\t[Invoice Price]\r\n\t,\t\t\t[Invoiced Quantity]\r\n\t,\t\t\t[Invoice Line Amount]\r\n\t,\t\t\t[Currency]\r\n\t,\t\t\t[Business Unit]\r\n\t,\t\t\t[Inventory Organization Code]\r\n\t,\t\t\t[Inventory Organization Name]\r\n\t,\t\t\t[Ordered Quantity]\r\n\t,\t\t\t[Approval Status]\r\n\t,\t\t\t[Mode of Transport]\r\n\t,\t\t\t[Freight Terms]\r\n\t,\t\t\t[Invoice Number]\r\n\t,\t\t\t[Order Status]\r\n\t,\t\t\t[Transaction Date]\r\n\t,\t\t\t[Invoice Amount]\r\n\t,\t\t\t[EUR USD]\r\n\t,\t\t\t[EUR GBP]\r\n\tINTO\t\t[Finance].[ExpandedOrdersAndInvoices]\r\n\tFROM\t\t[Trade].[PurchaseOrdersAndinvoices]\r\n\r\n\tUNION ALL\r\n\r\n\tSELECT\t\t'SO' AS [Source]\r\n\t,\t\t\t[Order Number]\r\n\t,\t\t\t[Parent Order]\r\n\t,\t\t\t'' AS [Supplier/Customer]\r\n\t,\t\t\t'' AS [Supplier/Customer Number]\t\t\r\n\t,\t\t\t'' AS [Agreement Number/Sales Contract Number]\t\r\n\t,\t\t\t[Item Code]\r\n\t,\t\t\t[Item Description]\r\n\t,\t\t\t[Category Code]\r\n\t,\t\t\tNULL AS [Agreement Price]\r\n\t,\t\t\t'' AS [Quantity]\r\n\t,\t\t\t[Invoice Price]\r\n\t,\t\t\t[Invoiced Quantity]\r\n\t,\t\t\t'' AS [Invoice Line Amount]\r\n\t,\t\t\t[Transactional Currency Code] AS [Currency]\r\n\t,\t\t\t[Business Unit Name] AS [Business Unit]\r\n\t,\t\t\t'' AS [Inventory Organization Code]\r\n\t,\t\t\t'' AS [Inventory Organization Name]\r\n\t,\t\t\t'' AS [Ordered Quantity]\r\n\t,\t\t\t'' AS [Approval Status]\r\n\t,\t\t\t'' AS [Mode of Transport]\r\n\t,\t\t\t'' AS [Freight Terms]\r\n\t,\t\t\t'' AS [Invoice Number]\r\n\t,\t\t\t'' AS [Order Status]\r\n\t,\t\t\t[Transaction Date]\r\n\t,\t\t\t[Invoice Amount]\r\n\t,\t\t\t[EUR:USD] AS [EUR USD]\r\n\t,\t\t\t[EUR:GBP] AS [EUR GBP]\r\n\tFROM\t\t[Trade].[SalesOrdersAndInvoices]\r\n\r\n/********************************************************************************************************\r\n\tStep 1.4\tCreate a rec differences table\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Finance].[ReconciliationDifferences]','U') IS NOT NULL\r\n\t\tDROP TABLE [Finance].[ReconciliationDifferences]\r\n\r\n\tSELECT * INTO [Finance].[ReconciliationDifferences] FROM [Finance].[ReconcilationYTD] WHERE [Difference] <> 0\r\n\r\n\r\n/********************************************************************************************************\r\n\tStep 1.5\tCreate a grouped version of the traceability table\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[Finance].[TraceabilityGrouped]','U') IS NOT NULL\r\n\t\tDROP TABLE [Finance].[TraceabilityGrouped]\r\n\r\n\r\n\tSELECT\t\tCAST(LEFT([TRANSACTION_DATE],10) AS DATE) AS [Transaction Date]\r\n\t,\t\t\t[Business Unit Name]\r\n\t,\t\t\t[Subinventory]\r\n\t,\t\t\tCASE WHEN [Unit of Measure] = 'LTR' THEN 'TN' ELSE [Unit of Measure] END AS [Unit of Measure]\r\n\t,\t\t\tSUM(CASE WHEN [Unit of Measure] = 'LTR' THEN [Quantity] * 0.0008745 ELSE [Quantity] END) AS [Quantity]\t\t\t\r\n\tINTO\t\t[Finance].[TraceabilityGrouped]\r\n\tFROM\t\t[Finance].[Traceability]\r\n\tGROUP BY\tCAST(LEFT([TRANSACTION_DATE],10) AS DATE)\r\n\t,\t\t\t[Business Unit Name]\r\n\t,\t\t\t[Subinventory]\r\n\t,\t\t\tCASE WHEN [Unit of Measure] = 'LTR' THEN 'TN' ELSE [Unit of Measure] END\r\n\tORDER BY\tCAST(LEFT([TRANSACTION_DATE],10) AS DATE)\r\n\t,\t\t\t[Business Unit Name]\r\n\t,\t\t\t[Subinventory]\r\n\t,\t\t\tCASE WHEN [Unit of Measure] = 'LTR' THEN 'TN' ELSE [Unit of Measure] END\r\n\r\n\r\n/********************************************************************************************************\r\n\tStep 1.5\tCreate a grouped version of the traceability table with a rolling inventory number\r\n********************************************************************************************************/\r\n\r\n\r\n\tIF OBJECT_ID('[Finance].[TraceabilityGroupedRollingInventory]','U') IS NOT NULL\r\n\t\tDROP TABLE [Finance].[TraceabilityGroupedRollingInventory]\r\n\r\n\tSELECT\t\t[Transaction Date]\r\n\t,\t\t\t[Business Unit Name]\r\n\t,\t\t\t[Subinventory]\r\n\t,\t\t\t[Unit of Measure]\r\n\t,\t\t\tSUM(CASE\r\n\t\t\t\t\t\tWHEN [Latest Date Marker] = 'X' THEN ISNULL([Quantity],0)\r\n\t\t\t\t\t\tELSE ISNULL([Quantity],0)*(-1)\r\n\t\t\t\t\tEND) OVER (PARTITION BY [Business Unit Name], [Subinventory], [Unit of Measure] ORDER BY [Transaction Date] DESC) AS [Rolling Total]\r\n\tINTO\t\t[Finance].[TraceabilityGroupedRollingInventory]\r\n\tFROM\t\t(\r\n\r\n\t\t\t\t\tSELECT\t\tCAST(GETDATE() AS DATE) AS [Transaction Date]\r\n\t\t\t\t\t,\t\t\t[Business Unit Name]\r\n\t\t\t\t\t,\t\t\t[Subinventory]\r\n\t\t\t\t\t,\t\t\tCASE WHEN [Transaction UOM Code] = 'LTR' THEN 'TN' ELSE [Transaction UOM Code] END AS [Unit of Measure]\r\n\t\t\t\t\t,\t\t\tSUM(CASE WHEN [Transaction UOM Code] = 'LTR' THEN [Primary Transaction Quantity] * 0.0008745 ELSE [Primary Transaction Quantity] END) AS [Quantity]\t\r\n\t\t\t\t\t,\t\t\t'X' AS [Latest Date Marker]\r\n\t\t\t\t\tFROM\t\t[Core].[OnHandBalance]\r\n\t\t\t\t\tGROUP BY\t[Business Unit Name]\r\n\t\t\t\t\t,\t\t\t[Subinventory]\r\n\t\t\t\t\t,\t\t\tCASE WHEN [Transaction UOM Code] = 'LTR' THEN 'TN' ELSE [Transaction UOM Code] END\r\n\r\n\t\t\t\t\tUNION ALL\r\n\r\n\t\t\t\t\tSELECT\t\t[Transaction Date]\r\n\t\t\t\t\t,\t\t\t[Business Unit Name]\r\n\t\t\t\t\t,\t\t\t[Subinventory]\r\n\t\t\t\t\t,\t\t\t[Unit of Measure]\r\n\t\t\t\t\t,\t\t\t[Quantity]\r\n\t\t\t\t\t,\t\t\t'' AS [Latest Date Marker]\r\n\t\t\t\t\tFROM\t\t[Finance].[TraceabilityGrouped]\r\n\t\t\t\t\tWHERE\t\t[Transaction Date] <> CAST(GETDATE() AS DATE)\r\n\t\t\t\t\tAND\t\t\tCONCAT([Business Unit Name],[Subinventory]) IN (\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tSELECT\t\tDISTINCT CONCAT([Business Unit Name],[Subinventory])\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tFROM\t\t[Core].[OnHandBalance]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t)\r\n\r\n\t\t\t\t) x"
						}
					]
				}
			}
		],
		"folder": {
			"name": "Finance"
		},
		"annotations": [],
		"lastPublishTime": "2022-12-10T11:05:42Z"
	},
	"type": "Microsoft.DataFactory/factories/pipelines"
}