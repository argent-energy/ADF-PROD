{
	"name": "SQL_ShippingData",
	"properties": {
		"activities": [
			{
				"name": "Shipping Data",
				"type": "Script",
				"dependsOn": [],
				"policy": {
					"timeout": "7.00:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"linkedServiceName": {
					"referenceName": "SqlServerArgent",
					"type": "LinkedServiceReference"
				},
				"typeProperties": {
					"scripts": [
						{
							"type": "NonQuery",
							"text": "/********************************************************************************************************\r\n\tStep 5.1:\tCombine shipping files\r\n********************************************************************************************************/\t\r\n\r\n\tIF OBJECT_ID('[SupplyChain].[Shipping]','U') IS NOT NULL\r\n\t\tDROP TABLE [SupplyChain].[Shipping]\r\n\t\r\n\tSELECT\t\tROW_NUMBER()OVER(ORDER BY [Country]) AS [Index]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [File] = 'UK22'\r\n\t\t\t\t\t\tTHEN 0\r\n\t\t\t\t\tWHEN CAST([x].[BL date] AS DATE) < CAST(GETDATE() AS DATE) AND ([x].[ATA Date] > CAST(GETDATE() AS DATE) OR [x].[ATA Date] IS NULL)\r\n\t\t\t\t\t\tTHEN 1\r\n\t\t\t\t\tELSE 0\r\n\t\t\t\tEND AS [Live Shipment Indicator]\r\n\t,\t\t\t*\r\n\tINTO\t\t[SupplyChain].[Shipping]\r\n\tFROM\t\t(\r\n\r\n\t\t\t\t\tSELECT\t\t'UK'\t\t\tAS [Country]\r\n\t\t\t\t\t,\t\t\t[Product]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN [BL date] LIKE '%as%'\r\n\t\t\t\t\t\t\t\t\t\tTHEN CONCAT('2023-',RIGHT(REPLACE([BL date],'as ',''),2),'-',LEFT(REPLACE([BL date],'as ',''),2))\r\n\t\t\t\t\t\t\t\t\tELSE [BL date]\r\n\t\t\t\t\t\t\t\tEND AS [BL date]\r\n\t\t\t\t\t,\t\t\t[Port of load/disch]\t\t\tAS [Planned Port]\r\n\t\t\t\t\t,\t\t\tCAST(CASE\r\n\t\t\t\t\t\t\t\t\t\tWHEN [Planned] IS NULL\r\n\t\t\t\t\t\t\t\t\t\t\tTHEN NULL\r\n\t\t\t\t\t\t\t\t\t\tWHEN TRY_CAST([Planned] AS DATE) IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\tTHEN [Planned]\r\n\t\t\t\t\t\t\t\t\t\tWHEN [Planned] LIKE 'end%'\r\n\t\t\t\t\t\t\t\t\t\t\tTHEN CAST(CAST(CONCAT('30 ',RIGHT([Planned],LEN([Planned])-CHARINDEX('-',[Planned],1)),' 2023') AS DATE) AS NVARCHAR(255))\r\n\t\t\t\t\t\t\t\t\t\tELSE CAST(CAST(REPLACE(CONCAT(RIGHT(REPLACE(REPLACE(REPLACE([Planned],'17-Mar','17 Mar'),' Port Klang',''),' Ams',''),6),' 2023'),'  ',' ') AS DATE) AS NVARCHAR(255))\r\n\t\t\t\t\t\t\t\t\tEND AS DATE)\tAS [Planned Date]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN [ATA Stanlow] IS NULL OR [ATA Stanlow] LIKE '%Vasto%' OR [ATA Stanlow] LIKE '%Port Klang%'\r\n\t\t\t\t\t\t\t\t\t\tTHEN NULL\r\n\t\t\t\t\t\t\t\t\tWHEN TRY_CAST([ATA Stanlow] AS DATE) IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\tTHEN [ATA Stanlow]\r\n\t\t\t\t\t\t\t\t\tELSE CAST(CAST(REPLACE(CONCAT(RIGHT([ATA Stanlow],6),' 2023'),'  ','') AS DATE) AS NVARCHAR(255))\r\n\t\t\t\t\t\t\t\tEND\tAS [ATA Date]\r\n\t\t\t\t\t,\t\t\t[Vessel]\r\n\t\t\t\t\t,\t\t\t[Vessel IMO]\r\n\t\t\t\t\t,\t\t\t[mothervessel]\r\n\t\t\t\t\t,\t\t\t[Mothervessel IMO]\r\n\t\t\t\t\t,\t\t\t[x] AS [Vessel Transfer Indicator]\r\n\t\t\t\t\t,\t\t\t[Customer]\r\n\t\t\t\t\t,\t\t\t[L/D]\r\n\t\t\t\t\t,\t\t\t[Tonnage]\t\t\r\n\t\t\t\t\t,\t\t\tLTRIM(RTRIM(REPLACE([Oracle Contract nr.],'+','/'))) AS [Oracle Contract nr.]\r\n\t\t\t\t\t,\t\t\tLTRIM(RTRIM(REPLACE(REPLACE(REPLACE([Oracle Order nr.],'+','/'),' ->) ','/'),'(','')))  AS [Oracle Order nr.]\r\n\t\t\t\t\t,\t\t\tLTRIM(RTRIM(REPLACE([Self-procurement orders],'+','/'))) AS [Self-procurement orders]\r\n\t\t\t\t\t,\t\t\tLTRIM(RTRIM(REPLACE([Transport  orders],'+','/'))) AS [Transport orders]\r\n\t\t\t\t\t,\t\t\t'UK23' AS [File]\r\n\t\t\t\t\tFROM\t\t[RAW].[SC.Shipping2023UK]\r\n\t\t\t\t\tWHERE\t\t[Product] IS NOT NULL\r\n\t\t\t\t\tAND\t\t\t[Product] <> 'Product'\r\n\r\n\r\n\t\t\t\t\tUNION ALL\r\n\r\n\t\t\t\t\tSELECT\t\t'UK' AS [Country]\r\n\t\t\t\t\t,\t\t\t[Product]\r\n\t\t\t\t\t,\t\t\t[BL date]\r\n\t\t\t\t\t,\t\t\t[Port of loading] AS [Planned Port]\r\n\t\t\t\t\t,\t\t\tCAST(CASE\r\n\t\t\t\t\t\t\t\t\t\tWHEN [Planned] = 'Amsterdam' OR [Planned] IS NULL\r\n\t\t\t\t\t\t\t\t\t\t\tTHEN NULL\r\n\t\t\t\t\t\t\t\t\t\tWHEN TRY_CAST([Planned] AS DATE) IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\tTHEN [Planned]\r\n\t\t\t\t\t\t\t\t\t\tELSE CAST(CAST(REPLACE(REPLACE(CONCAT(RIGHT(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE([Planned],'Rdam',''),'Rtm ',''),' Ams',''),'Rtd',''),'Ams ',''),'Sept','Sep'),6),' 2022'),'  ',' '),'-',' ') AS DATE) AS NVARCHAR(255))\r\n\t\t\t\t\t\t\t\t\tEND AS DATE) AS [Planned Date]\r\n\t\t\t\t\t,\t\t\tNULLIF([ATA],'Amsterdam') AS [ATA Date]\r\n\t\t\t\t\t,\t\t\t[Vessel]\r\n\t\t\t\t\t,\t\t\t'' AS [Vessel IMO]\r\n\t\t\t\t\t,\t\t\t[mothervessel]\r\n\t\t\t\t\t,\t\t\t'' AS [Mothervessel IMO]\r\n\t\t\t\t\t,\t\t\t'' AS [Vessel Transfer Indicator]\r\n\t\t\t\t\t,\t\t\t[Customer]\r\n\t\t\t\t\t,\t\t\t[L/D]\r\n\t\t\t\t\t,\t\t\t[Tonnage]\r\n\t\t\t\t\t,\t\t\tLTRIM(RTRIM(REPLACE([Oracle Contract nr.],'+','/'))) AS [Oracle Contract nr.]\r\n\t\t\t\t\t,\t\t\tLTRIM(RTRIM(REPLACE([Oracle Order nr.],'+','/'))) AS [Oracle Order nr.]\t\r\n\t\t\t\t\t,\t\t\tLTRIM(RTRIM(REPLACE([Self-procurement orders],'+','/'))) AS [Self-procurement orders]\r\n\t\t\t\t\t,\t\t\tLTRIM(RTRIM(REPLACE([Transport orders],'+','/'))) AS [Transport orders]\r\n\t\t\t\t\t,\t\t\t'UK22' AS [File]\r\n\t\t\t\t\tFROM\t\t[RAW].[SC.Shipping2022UK]\r\n\t\t\t\t\tWHERE\t\t[Product] IS NOT NULL\r\n\r\n\t\t\t\t\tUNION ALL\r\n\r\n\t\t\t\t\tSELECT\t\t'NL' AS [Country]\r\n\t\t\t\t\t,\t\t\t[Product]\r\n\t\t\t\t\t,\t\t\t[BL] AS [BL Date]\r\n\t\t\t\t\t,\t\t\t[Port of load/disch] AS [Planned Port]\r\n\t\t\t\t\t,\t\t\tCAST(REPLACE(REPLACE(CASE\r\n\t\t\t\t\t\t\t\t\t\t\tWHEN TRY_CAST([Planned] AS DATE) IS NOT NULL\r\n\t\t\t\t\t\t\t\t\t\t\t\tTHEN [Planned]\r\n\t\t\t\t\t\t\t\t\t\t\tWHEN [Planned] LIKE 'end%'\r\n\t\t\t\t\t\t\t\t\t\t\t\tTHEN CAST(CAST(CONCAT('30 ',RIGHT([Planned],LEN([Planned])-CHARINDEX('-',[Planned],1)),' ',ISNULL([Year],'2023')) AS DATE) AS NVARCHAR(255))\r\n\t\t\t\t\t\t\t\t\t\t\tELSE CONCAT(RIGHT(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE([Planned],'Maart','Mar'),' Rdam',''),' Rtd',''),'Savona ',''),' Ams',''),'June','Jun'),6),' ',ISNULL(CASE WHEN [Year] = '#VALUE!' THEN '2022' ELSE [Year] END,'2023'))\r\n\t\t\t\t\t\t\t\t\t\tEND,'-5 ','05'),'-7 ','07') AS DATE) AS [Planned Date]\r\n\t\t\t\t\t,\t\t\t[ATA Ams] AS [ATA Date]\r\n\t\t\t\t\t,\t\t\t[Vessel]\r\n\t\t\t\t\t,\t\t\t'' AS [Vessel IMO]\r\n\t\t\t\t\t,\t\t\t'' AS [mothervessel]\r\n\t\t\t\t\t,\t\t\t'' AS [Mothervessel IMO]\r\n\t\t\t\t\t,\t\t\t'' AS [Vessel Transfer Indicator]\r\n\t\t\t\t\t,\t\t\t[Customer]\r\n\t\t\t\t\t,\t\t\t[L/D]\r\n\t\t\t\t\t,\t\t\t[Tonnage]\r\n\t\t\t\t\t,\t\t\tLTRIM(RTRIM(REPLACE([Contract],'+','/'))) AS [Oracle Contract nr.]\r\n\t\t\t\t\t,\t\t\tLTRIM(RTRIM(REPLACE(REPLACE([Order],'4 8','4/8'),'+','/')))  AS [Oracle Order nr.]\t\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN [T or Self-procument] LIKE '%T'\r\n\t\t\t\t\t\t\t\t\t\tTHEN NULL\r\n\t\t\t\t\t\t\t\t\tELSE LTRIM(RTRIM(REPLACE([T or Self-procument],'+','/')))\r\n\t\t\t\t\t\t\t\tEND AS [Self-procurement orders]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN [T or Self-procument] LIKE '%T'\r\n\t\t\t\t\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE([T or Self-procument],'+','/')))\r\n\t\t\t\t\t\t\t\t\tELSE NULL\r\n\t\t\t\t\t\t\t\tEND AS [Transport orders]\r\n\t\t\t\t\t,\t\t\t'NL' AS [File]\r\n\t\t\t\t\tFROM\t\t[RAW].[SC.ShippingNL]\r\n\t\t\t\t\tWHERE\t\t[Product] IS NOT NULL\r\n\t\t\t\t\tAND\t\t\t[Product] <> 'Product'\r\n\t\t\t) x\r\n\tWHERE\t[Product] <> 'Product'\r\n\r\n /********************************************************************************************************\r\n\tStep 5.2:\tSeparate order numbers.\r\n********************************************************************************************************/\t\r\n\tIF OBJECT_ID('tempdb..#ShippingSeparatedContractsAndOrders/','U') IS NOT NULL\r\n\t\tDROP TABLE #ShippingSeparatedContractsAndOrders\r\n\t\r\n\tSELECT\t\t[s].[Index]\r\n\t,\t\t\t[Live Shipment Indicator]\r\n\t,\t\t\t[Country]\r\n\t,\t\t\t[Product]\r\n\t,\t\t\t[BL Date]\r\n\t,\t\t\t[Planned Port]\r\n\t,\t\t\t[Planned Date]\r\n\t,\t\t\t[ATA Date]\r\n\t,\t\t\t[Vessel]\r\n\t,\t\t\t[s].[mothervessel]\r\n\t,\t\t\t[Vessel IMO]\r\n\t,\t\t\t[s].[mothervessel IMO]\r\n\t,\t\t\t[Vessel Transfer Indicator]\r\n\t,\t\t\t[Customer]\r\n\t,\t\t\t[L/D]\r\n\t,\t\t\t[Tonnage]\r\n\t,\t\t\t[Oracle Contract nr.]\r\n\t,\t\t\t[Oracle Order nr.]\r\n\t,\t\t\t[Self-procurement orders]\r\n\t,\t\t\t[Transport orders]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [Oracle Order nr.] NOT LIKE '%/%'\r\n\t\t\t\t\t\tTHEN [Oracle Order nr.]\r\n\t\t\t\t\tELSE LTRIM(RTRIM(REPLACE(SUBSTRING([Oracle Order nr.],1,[OrderSeparatorIndex1]),'/','')))\r\n\t\t\t\tEND AS [Order1]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [NumberOfOrders] = 2\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Oracle Order nr.],[OrderSeparatorIndex1],LEN([Oracle Order nr.])),'/','')))\r\n\t\t\t\t\tWHEN [NumberOfOrders] > 2\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Oracle Order nr.],[OrderSeparatorIndex1],[OrderSeparatorIndex2]-[OrderSeparatorIndex1]),'/','')))\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [Order2]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [NumberOfOrders] = 3\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Oracle Order nr.],[OrderSeparatorIndex2],LEN([Oracle Order nr.])),'/','')))\r\n\t\t\t\t\tWHEN [NumberOfOrders] > 3\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Oracle Order nr.],[OrderSeparatorIndex2],[OrderSeparatorIndex3]-[OrderSeparatorIndex2]),'/','')))\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [Order3]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [NumberOfOrders] = 4\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Oracle Order nr.],[OrderSeparatorIndex3],LEN([Oracle Order nr.])),'/','')))\r\n\t\t\t\t\tWHEN [NumberOfOrders] > 4\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Oracle Order nr.],[OrderSeparatorIndex3],[OrderSeparatorIndex4]-[OrderSeparatorIndex3]),'/','')))\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [Order4]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [NumberOfOrders] = 5\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Oracle Order nr.],[OrderSeparatorIndex4],LEN([Oracle Order nr.])),'/','')))\r\n\t\t\t\tEND AS [Order5]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [Self-procurement orders] NOT LIKE '%/%'\r\n\t\t\t\t\t\tTHEN [Self-procurement orders]\r\n\t\t\t\t\tELSE LTRIM(RTRIM(REPLACE(SUBSTRING([Self-procurement orders],1,[SP_OrderSeparatorIndex1]),'/','')))\r\n\t\t\t\tEND AS [SP_Order1]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [NumberOf_SP_Orders] = 2\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Self-procurement orders],[SP_OrderSeparatorIndex1],LEN([Self-procurement orders])),'/','')))\r\n\t\t\t\t\tWHEN [NumberOf_SP_Orders] > 2\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Self-procurement orders],[SP_OrderSeparatorIndex1],[SP_OrderSeparatorIndex2]-[SP_OrderSeparatorIndex1]),'/','')))\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [SP_Order2]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [NumberOf_SP_Orders] = 3\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Self-procurement orders],[SP_OrderSeparatorIndex2],LEN([Self-procurement orders])),'/','')))\r\n\t\t\t\t\tWHEN [NumberOf_SP_Orders] > 3\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Self-procurement orders],[SP_OrderSeparatorIndex2],[SP_OrderSeparatorIndex3]-[SP_OrderSeparatorIndex2]),'/','')))\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [SP_Order3]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [NumberOf_SP_Orders] = 4\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Self-procurement orders],[SP_OrderSeparatorIndex3],LEN([Self-procurement orders])),'/','')))\r\n\t\t\t\t\tWHEN [NumberOf_SP_Orders] > 4\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Self-procurement orders],[SP_OrderSeparatorIndex3],[SP_OrderSeparatorIndex4]-[SP_OrderSeparatorIndex3]),'/','')))\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [SP_Order4]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [NumberOf_SP_Orders] = 5\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Self-procurement orders],[SP_OrderSeparatorIndex4],LEN([Self-procurement orders])),'/','')))\r\n\t\t\t\tEND AS [SP_Order5]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [Transport orders] NOT LIKE '%/%'\r\n\t\t\t\t\t\tTHEN [Transport orders]\r\n\t\t\t\t\tELSE LTRIM(RTRIM(REPLACE(SUBSTRING([Transport orders],1,[T_OrderSeparatorIndex1]),'/','')))\r\n\t\t\t\tEND AS [T_Order1]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [NumberOf_T_Orders] = 2\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Transport orders],[T_OrderSeparatorIndex1],LEN([Transport orders])),'/','')))\r\n\t\t\t\t\tWHEN [NumberOf_T_Orders] > 2\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Transport orders],[T_OrderSeparatorIndex1],[T_OrderSeparatorIndex2]-[T_OrderSeparatorIndex1]),'/','')))\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [T_Order2]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [NumberOf_T_Orders] = 3\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Transport orders],[T_OrderSeparatorIndex2],LEN([Transport orders])),'/','')))\r\n\t\t\t\t\tWHEN [NumberOf_T_Orders] > 3\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Transport orders],[T_OrderSeparatorIndex2],[T_OrderSeparatorIndex3]-[T_OrderSeparatorIndex2]),'/','')))\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [T_Order3]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [NumberOf_T_Orders] = 4\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Transport orders],[T_OrderSeparatorIndex3],LEN([Transport orders])),'/','')))\r\n\t\t\t\t\tWHEN [NumberOf_T_Orders] > 4\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Transport orders],[T_OrderSeparatorIndex3],[T_OrderSeparatorIndex4]-[T_OrderSeparatorIndex3]),'/','')))\r\n\t\t\t\t\tELSE NULL\r\n\t\t\t\tEND AS [T_Order4]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN [NumberOf_T_Orders] = 5\r\n\t\t\t\t\t\tTHEN LTRIM(RTRIM(REPLACE(SUBSTRING([Transport orders],[T_OrderSeparatorIndex4],LEN([Transport orders])),'/','')))\r\n\t\t\t\tEND AS [T_Order5]\r\n\tINTO\t\t#ShippingSeparatedContractsAndOrders\r\n\tFROM\t\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\t,\t\t\tLEN([Oracle Order nr.]) - LEN(REPLACE([Oracle Order nr.],'/','')) + 1 AS [NumberOfOrders]\r\n\t\t\t\t\t,\t\t\tLEN([Oracle Order nr.]) - LEN(REPLACE([Oracle Order nr.],'/','')) AS [NumberOfOrderSeparators]\r\n\t\t\t\t\t,\t\t\tCHARINDEX('/',[Oracle Order nr.],1) AS [OrderSeparatorIndex1]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN LEN([Oracle Order nr.]) - LEN(REPLACE([Oracle Order nr.],'/','')) > 1\r\n\t\t\t\t\t\t\t\t\t\tTHEN CHARINDEX('/',[Oracle Order nr.],CHARINDEX('/',[Oracle Order nr.])+1)\r\n\t\t\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\t\t\tEND AS [OrderSeparatorIndex2]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN LEN([Oracle Order nr.]) - LEN(REPLACE([Oracle Order nr.],'/','')) > 2\r\n\t\t\t\t\t\t\t\t\t\tTHEN CHARINDEX('/',[Oracle Order nr.],CHARINDEX('/',[Oracle Order nr.],CHARINDEX('/',[Oracle Order nr.])+1)+1)\r\n\t\t\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\t\t\tEND AS [OrderSeparatorIndex3]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN LEN([Oracle Order nr.]) - LEN(REPLACE([Oracle Order nr.],'/','')) > 3\r\n\t\t\t\t\t\t\t\t\t\tTHEN CHARINDEX('/',[Oracle Order nr.],CHARINDEX('/',[Oracle Order nr.],CHARINDEX('/',[Oracle Order nr.],CHARINDEX('/',[Oracle Order nr.])+1)+1)+1)\r\n\t\t\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\t\t\tEND AS [OrderSeparatorIndex4]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN LEN([Oracle Order nr.]) - LEN(REPLACE([Oracle Order nr.],'/','')) > 4\r\n\t\t\t\t\t\t\t\t\t\tTHEN CHARINDEX('/',[Oracle Order nr.],CHARINDEX('/',[Oracle Order nr.],CHARINDEX('/',[Oracle Order nr.],CHARINDEX('/',[Oracle Order nr.],CHARINDEX('/',[Oracle Order nr.])+1)+1)+1)+1)\r\n\t\t\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\t\t\tEND AS [OrderSeparatorIndex5]\r\n\t\t\t\t\t,\t\t\tLEN([Self-procurement orders]) - LEN(REPLACE([Self-procurement orders],'/','')) + 1 AS [NumberOf_SP_Orders]\r\n\t\t\t\t\t,\t\t\tLEN([Self-procurement orders]) - LEN(REPLACE([Self-procurement orders],'/','')) AS [NumberOf_SP_OrderSeparators]\r\n\t\t\t\t\t,\t\t\tCHARINDEX('/',[Self-procurement orders],1) AS [SP_OrderSeparatorIndex1]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN LEN([Self-procurement orders]) - LEN(REPLACE([Self-procurement orders],'/','')) > 1\r\n\t\t\t\t\t\t\t\t\t\tTHEN CHARINDEX('/',[Self-procurement orders],CHARINDEX('/',[Self-procurement orders])+1)\r\n\t\t\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\t\t\tEND AS [SP_OrderSeparatorIndex2]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN LEN([Self-procurement orders]) - LEN(REPLACE([Self-procurement orders],'/','')) > 2\r\n\t\t\t\t\t\t\t\t\t\tTHEN CHARINDEX('/',[Self-procurement orders],CHARINDEX('/',[Self-procurement orders],CHARINDEX('/',[Self-procurement orders])+1)+1)\r\n\t\t\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\t\t\tEND AS [SP_OrderSeparatorIndex3]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN LEN([Self-procurement orders]) - LEN(REPLACE([Self-procurement orders],'/','')) > 3\r\n\t\t\t\t\t\t\t\t\t\tTHEN CHARINDEX('/',[Self-procurement orders],CHARINDEX('/',[Self-procurement orders],CHARINDEX('/',[Self-procurement orders],CHARINDEX('/',[Self-procurement orders])+1)+1)+1)\r\n\t\t\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\t\t\tEND AS [SP_OrderSeparatorIndex4]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN LEN([Self-procurement orders]) - LEN(REPLACE([Self-procurement orders],'/','')) > 4\r\n\t\t\t\t\t\t\t\t\t\tTHEN CHARINDEX('/',[Self-procurement orders],CHARINDEX('/',[Self-procurement orders],CHARINDEX('/',[Self-procurement orders],CHARINDEX('/',[Self-procurement orders],CHARINDEX('/',[Self-procurement orders])+1)+1)+1)+1)\r\n\t\t\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\t\t\tEND AS [SP_OrderSeparatorIndex5]\r\n\t\t\t\t\t,\t\t\tLEN([Transport orders]) - LEN(REPLACE([Transport orders],'/','')) + 1 AS [NumberOf_T_Orders]\r\n\t\t\t\t\t,\t\t\tLEN([Transport orders]) - LEN(REPLACE([Transport orders],'/','')) AS [NumberOf_T_OrderSeparators]\r\n\t\t\t\t\t,\t\t\tCHARINDEX('/',[Transport orders],1) AS [T_OrderSeparatorIndex1]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN LEN([Transport orders]) - LEN(REPLACE([Transport orders],'/','')) > 1\r\n\t\t\t\t\t\t\t\t\t\tTHEN CHARINDEX('/',[Transport orders],CHARINDEX('/',[Transport orders])+1)\r\n\t\t\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\t\t\tEND AS [T_OrderSeparatorIndex2]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN LEN([Transport orders]) - LEN(REPLACE([Transport orders],'/','')) > 2\r\n\t\t\t\t\t\t\t\t\t\tTHEN CHARINDEX('/',[Transport orders],CHARINDEX('/',[Transport orders],CHARINDEX('/',[Transport orders])+1)+1)\r\n\t\t\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\t\t\tEND AS [T_OrderSeparatorIndex3]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN LEN([Transport orders]) - LEN(REPLACE([Transport orders],'/','')) > 3\r\n\t\t\t\t\t\t\t\t\t\tTHEN CHARINDEX('/',[Transport orders],CHARINDEX('/',[Transport orders],CHARINDEX('/',[Transport orders],CHARINDEX('/',[Transport orders])+1)+1)+1)\r\n\t\t\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\t\t\tEND AS [T_OrderSeparatorIndex4]\r\n\t\t\t\t\t,\t\t\tCASE\r\n\t\t\t\t\t\t\t\t\tWHEN LEN([Transport orders]) - LEN(REPLACE([Transport orders],'/','')) > 4\r\n\t\t\t\t\t\t\t\t\t\tTHEN CHARINDEX('/',[Transport orders],CHARINDEX('/',[Transport orders],CHARINDEX('/',[Transport orders],CHARINDEX('/',[Transport orders],CHARINDEX('/',[Transport orders])+1)+1)+1)+1)\r\n\t\t\t\t\t\t\t\t\tELSE 0\r\n\t\t\t\t\t\t\t\tEND AS [T_OrderSeparatorIndex5]\r\n\t\t\t\t\tFROM\t\tSupplyChain.Shipping \r\n\t\t\t\t) s\r\n\r\n\tUNION ALL\r\n\r\n\tSELECT\t\t[Index]\r\n\t,\t\t\t[Live Shipment Indicator]\r\n\t,\t\t\t[Country]\r\n\t,\t\t\t[Product]\r\n\t,\t\t\t[BL Date]\r\n\t,\t\t\t[Planned Port]\r\n\t,\t\t\t[Planned Date]\r\n\t,\t\t\t[ATA Date]\r\n\t,\t\t\t[Vessel]\r\n\t,\t\t\t[mothervessel]\r\n\t,\t\t\t[Vessel IMO]\r\n\t,\t\t\t[mothervessel IMO]\r\n\t,\t\t\t[Vessel Transfer Indicator]\r\n\t,\t\t\t[Customer]\r\n\t,\t\t\t[L/D]\r\n\t,\t\t\t[Tonnage]\r\n\t,\t\t\t[Oracle Contract nr.]\r\n\t,\t\t\t[Oracle Order nr.]\r\n\t,\t\t\tNULL AS [Self-procurement orders]\r\n\t,\t\t\tNULL AS [Transport orders]\r\n\t,\t\t\tNULL AS [Order1]\r\n\t,\t\t\tNULL AS [Order2]\r\n\t,\t\t\tNULL AS [Order3]\r\n\t,\t\t\tNULL AS [Order4]\r\n\t,\t\t\tNULL AS [Order5]\r\n\t,\t\t\tNULL AS [SP_Order1]\r\n\t,\t\t\tNULL AS [SP_Order2]\r\n\t,\t\t\tNULL AS [SP_Order3]\r\n\t,\t\t\tNULL AS [SP_Order4]\r\n\t,\t\t\tNULL AS [SP_Order5]\r\n\t,\t\t\tNULL AS [T_Order1]\r\n\t,\t\t\tNULL AS [T_Order2]\r\n\t,\t\t\tNULL AS [T_Order3]\r\n\t,\t\t\tNULL AS [T_Order4]\r\n\t,\t\t\tNULL AS [T_Order5]\r\n\tFROM\t\tSupplyChain.Shipping\r\n\tWHERE\t\t[Oracle Order nr.] IS NULL\r\n\r\n /********************************************************************************************************\r\n\tStep 5.3:\tUnpivot data to create list of order numbers per shipping index.\r\n********************************************************************************************************/\r\n\r\n\tSELECT\t\t*\r\n\tINTO\t\t#ShippingOrdersUnpivot\r\n\tFROM\t\t(\r\n\t\t\t\t\tSELECT\t\t[b].[Index]\r\n\t\t\t\t\t,\t\t\t[Live Shipment Indicator]\r\n\t\t\t\t\t,\t\t\t[b].[Country]\r\n\t\t\t\t\t,\t\t\t[b].[BL date]\r\n\t\t\t\t\t,\t\t\t[b].[Planned Port]\r\n\t\t\t\t\t,\t\t\t[b].[Planned Date]\r\n\t\t\t\t\t,\t\t\t[b].[ATA Date]\r\n\t\t\t\t\t,\t\t\t[b].[Vessel]\r\n\t\t\t\t\t,\t\t\t[b].[mothervessel]\r\n\t\t\t\t\t,\t\t\t[Vessel IMO]\r\n\t\t\t\t\t,\t\t\t[Mothervessel IMO]\r\n\t\t\t\t\t,\t\t\t[Vessel Transfer Indicator]\r\n\t\t\t\t\t,\t\t\t[b].[Product]\r\n\t\t\t\t\t,\t\t\t[b].[Oracle Contract nr.]\r\n\t\t\t\t\t,\t\t\t[b].[Oracle Order nr.]\r\n\t\t\t\t\t,\t\t\t[b].[Customer]\r\n\t\t\t\t\t,\t\t\t[b].[L/D]\r\n\t\t\t\t\t,\t\t\t[b].[Tonnage]\r\n\t\t\t\t\t,\t\t\tREPLACE([Order Number],'SO','') AS [Order Number]\r\n\t\t\t\t\t,\t\t\t'Standard' AS [Order Type] \r\n\t\t\t\t\tFROM\t\t#ShippingSeparatedContractsAndOrders a\r\n\t\t\t\t\tUNPIVOT\t\t([Order Number] FOR [Order] IN ([Order1],[Order2],[Order3],[Order4],[Order5])) b\r\n\t\t\t\t\t\r\n\t\t\t\t\tUNION ALL\r\n\r\n\t\t\t\t\tSELECT\t\t[b].[Index]\r\n\t\t\t\t\t,\t\t\t[Live Shipment Indicator]\r\n\t\t\t\t\t,\t\t\t[b].[Country]\r\n\t\t\t\t\t,\t\t\t[b].[BL date]\r\n\t\t\t\t\t,\t\t\t[b].[Planned Port]\r\n\t\t\t\t\t,\t\t\t[b].[Planned Date]\r\n\t\t\t\t\t,\t\t\t[b].[ATA Date]\r\n\t\t\t\t\t,\t\t\t[b].[Vessel]\r\n\t\t\t\t\t,\t\t\t[b].[mothervessel]\r\n\t\t\t\t\t,\t\t\t[Vessel IMO]\r\n\t\t\t\t\t,\t\t\t[Mothervessel IMO]\r\n\t\t\t\t\t,\t\t\t[Vessel Transfer Indicator]\r\n\t\t\t\t\t,\t\t\t[b].[Product]\r\n\t\t\t\t\t,\t\t\t[b].[Oracle Contract nr.]\r\n\t\t\t\t\t,\t\t\t[b].[Oracle Order nr.]\r\n\t\t\t\t\t,\t\t\t[b].[Customer]\r\n\t\t\t\t\t,\t\t\t[b].[L/D]\r\n\t\t\t\t\t,\t\t\t[b].[Tonnage]\r\n\t\t\t\t\t,\t\t\tREPLACE([b].[SP Order Number],'SO','') AS [Order Number]\r\n\t\t\t\t\t,\t\t\t'Self-Procurement' AS [Order Type]\r\n\t\t\t\t\tFROM\t\t#ShippingSeparatedContractsAndOrders\r\n\t\t\t\t\tUNPIVOT\t\t([SP Order Number] FOR [S-P Order] IN([SP_Order1],[SP_Order2],[SP_Order3],[SP_Order4],[SP_Order5])) b\r\n\r\n\t\t\t\t\tUNION ALL\r\n\r\n\t\t\t\t\tSELECT\t\t[b].[Index]\r\n\t\t\t\t\t,\t\t\t[Live Shipment Indicator]\r\n\t\t\t\t\t,\t\t\t[b].[Country]\r\n\t\t\t\t\t,\t\t\t[b].[BL date]\r\n\t\t\t\t\t,\t\t\t[b].[Planned Port]\r\n\t\t\t\t\t,\t\t\t[b].[Planned Date]\r\n\t\t\t\t\t,\t\t\t[b].[ATA Date]\r\n\t\t\t\t\t,\t\t\t[b].[Vessel]\r\n\t\t\t\t\t,\t\t\t[b].[mothervessel]\r\n\t\t\t\t\t,\t\t\t[Vessel IMO]\r\n\t\t\t\t\t,\t\t\t[Mothervessel IMO]\r\n\t\t\t\t\t,\t\t\t[Vessel Transfer Indicator]\r\n\t\t\t\t\t,\t\t\t[b].[Product]\r\n\t\t\t\t\t,\t\t\t[b].[Oracle Contract nr.]\r\n\t\t\t\t\t,\t\t\t[b].[Oracle Order nr.]\r\n\t\t\t\t\t,\t\t\t[b].[Customer]\r\n\t\t\t\t\t,\t\t\t[b].[L/D]\r\n\t\t\t\t\t,\t\t\t[b].[Tonnage]\r\n\t\t\t\t\t,\t\t\tREPLACE([b].[T Order Number],'SO','') AS [Order Number]\r\n\t\t\t\t\t,\t\t\t'Transport' AS [Order Type]\r\n\t\t\t\t\tFROM\t\t#ShippingSeparatedContractsAndOrders\r\n\t\t\t\t\tUNPIVOT\t\t([T Order Number] FOR [T Order] IN([T_Order1],[T_Order2],[T_Order3],[T_Order4],[T_Order5])) b\r\n\t\t\t\t) u\r\n\tORDER BY\t[Index]\r\n\r\n /********************************************************************************************************\r\n\tStep 5.4:\tCreate final shipping contracts table\r\n********************************************************************************************************/\t\r\n\r\nIF OBJECT_ID('SupplyChain.ShippingContracts','U') IS NOT NULL\r\n\t\tDROP TABLE SupplyChain.ShippingContracts\r\n\r\n\tSELECT\t\tu.*\r\n\t,\t\t\tCOALESCE(poi.[Blanket Purchase Agreement Number],soi.[Sales Contract Number]) AS [Agreement/Sales Contract Number]\r\n\t,\t\t\tCOALESCE(poi.[Transaction Date],soi.[Transaction Date]) AS [Transaction Date]\r\n\t,\t\t\tCOALESCE(poi.[Total Invoiced Quantity],soi.[Total Invoiced Quantity]) AS [Total Invoiced Quantity]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN TRY_CAST([u].[Order Number] AS FLOAT) IS NULL THEN 'Purchases'\r\n\t\t\t\t\tELSE 'Sales'\r\n\t\t\t\tEND AS [Sales/Purchase]\r\n\t,\t\t\tpoi.[Inventory Organization Code]\r\n\t,\t\t\tpoi.[Inventory Organization Name]\r\n\t,\t\t\tpoi.[Approval Status]\r\n\t,\t\t\tpoi.[Order Status]\t\t\t\r\n\t,\t\t\tCOALESCE(poi.[Supplier/Customer Number],sc.[Customer Number]) AS [Supplier/Customer Number]\r\n\t,\t\t\tCOALESCE(pc.[Supplier Name],sc.[Customer]) AS [Supplier/Customer]\t\t\r\n\t,\t\t\ti.[Item Code]\r\n\t,\t\t\ti.[Item Name]\r\n\t,\t\t\tCOALESCE(poi.[Mode of Transport],sc.[Shipping Method]) AS [Shipping Method]\r\n\t,\t\t\tCOALESCE(poi.[Business Unit],soi.[Business Unit Name],pc.[Business Unit Name],sc.[Business Unit Name]) AS [Business Unit Name]\r\n\t,\t\t\tCAST(LEFT(so.[Request Ship Date],10) AS DATE) AS [Request Ship Date]\r\n\t,\t\t\tCAST(LEFT(so.[Schedule Ship Date],10) AS DATE) AS [Schedule Ship Date]\r\n\t,\t\t\tCAST(LEFT(po.[Requested Date],10) AS DATE) AS [Requested Date]\r\n\t,\t\t\tCAST(LEFT([Pick up Date],10) AS DATE) AS [Pick Up Date]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN TRY_CAST([u].[Order Number] AS FLOAT) IS NULL\r\n\t\t\t\t\t\tTHEN bu.[Country]\r\n\t\t\t\t\tELSE COALESCE(l2.[Country],l3.[Country],l4.[Country])\r\n\t\t\t\tEND AS [Ship To Country]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN TRY_CAST([u].[Order Number] AS FLOAT) IS NULL\r\n\t\t\t\t\t\tTHEN bu.[City]\r\n\t\t\t\t\tELSE COALESCE(l2.[City],L3.[City],l4.[City])\r\n\t\t\t\tEND AS [Ship To City]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN TRY_CAST([u].[Order Number] AS FLOAT) IS NULL\r\n\t\t\t\t\t\tTHEN bu.[Postal Code]\r\n\t\t\t\t\tELSE COALESCE(l2.[Postal Code],l3.[Postal Code],l4.[Postal Code])\r\n\t\t\t\tEND AS [Ship To Postal Code]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN TRY_CAST([u].[Order Number] AS FLOAT) IS NULL\r\n\t\t\t\t\t\tTHEN bu.[Address]\r\n\t\t\t\t\tELSE COALESCE(l2.[Address],l3.[Address],l4.[Address])\r\n\t\t\t\tEND AS [Ship To Address]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN TRY_CAST([u].[Order Number] AS FLOAT) IS NULL\r\n\t\t\t\t\t\tTHEN bu.[Business Unit Name]\r\n\t\t\t\t\tELSE COALESCE(l2.[Company Name],l3.[Company Name],l4.[Company Name])\r\n\t\t\t\tEND AS [Ship To Company]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN TRY_CAST([u].[Order Number] AS FLOAT) IS NULL\r\n\t\t\t\t\t\tTHEN COALESCE(l1.[Country],l5.[Country])\r\n\t\t\t\t\tELSE bu.[Country]\r\n\t\t\t\tEND AS [Ship From Country]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN TRY_CAST([u].[Order Number] AS FLOAT) IS NULL\r\n\t\t\t\t\t\tTHEN COALESCE(l1.[City],l5.[City])\r\n\t\t\t\t\tELSE bu.[City]\r\n\t\t\t\tEND AS [Ship From City]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN TRY_CAST([u].[Order Number] AS FLOAT) IS NULL\r\n\t\t\t\t\t\tTHEN COALESCE(l1.[Postal Code],L5.[Postal Code])\r\n\t\t\t\t\tELSE bu.[Postal Code]\r\n\t\t\t\tEND AS [Ship From Postal Code]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN TRY_CAST([u].[Order Number] AS FLOAT) IS NULL\r\n\t\t\t\t\t\tTHEN COALESCE(l1.[Address],NULLIF(REPLACE(CONCAT([l5].[Company Name],',',ISNULL([l5].[Address Line 2],''),',',ISNULL([l5].[Address Line 3],'')),',,',','),','))\r\n\t\t\t\t\tELSE bu.[Address]\r\n\t\t\t\tEND AS [Ship From Address]\r\n\t,\t\t\tCASE\r\n\t\t\t\t\tWHEN TRY_CAST([u].[Order Number] AS FLOAT) IS NULL\r\n\t\t\t\t\t\tTHEN COALESCE(l1.[Company Name],l5.[Company Name])\r\n\t\t\t\t\tELSE bu.[Business Unit Name]\t\r\n\t\t\t\tEND AS [Ship From Company]\r\n\tINTO\t\tSupplyChain.ShippingContracts\r\n\tFROM\t\t#ShippingOrdersUnpivot u\t\t\t\t\t\t\t\r\n\tLEFT JOIN\t[Core].[PurchaseOrders] po\r\n\tON\t\t\tpo.[Purchase Order Number] = u.[Order Number]\t\t\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Order Number] \r\n\t\t\t\t\t,\t\t\t[Request Ship Date]\r\n\t\t\t\t\t,\t\t\t[Submitted Flag]\r\n\t\t\t\t\t,\t\t\t[Sold To Party ID]\r\n\t\t\t\t\t,\t\t\t[Inventory Item ID]\r\n\t\t\t\t\t,\t\t\tMAX([Schedule Ship Date]) AS [Schedule Ship Date]\r\n\t\t\t\t\tFROM\t\t[Core].[SalesOrders]\r\n\t\t\t\t\tGROUP BY\t[Order Number] \r\n\t\t\t\t\t,\t\t\t[Request Ship Date]\r\n\t\t\t\t\t,\t\t\t[Submitted Flag]\r\n\t\t\t\t\t,\t\t\t[Sold To Party ID]\r\n\t\t\t\t\t,\t\t\t[Inventory Item ID]\r\n\t\t\t\t) so\r\n\tON\t\t\tso.[Order Number] = u.[Order Number]\r\n\tAND\t\t\tLEN(u.[Order Number]) <> 3\t\t\t\r\n\tAND\t\t\tso.[Submitted Flag] = 'Y'\t\t\t\t\t\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tDISTINCT [PO Header ID]\r\n\t\t\t\t\t,\t\t\t[PO Line ID]\r\n\t\t\t\t\t,\t\t\t[Ship From Location ID]\r\n\t\t\t\t\t,\t\t\t[Deliver To Location ID]\r\n\t\t\t\t\t,\t\t\t[Transaction Type]\r\n\t\t\t\t\tFROM\t\t[Core].[ReceivingTransactions]\r\n\t\t\t\t) rt\r\n\tON\t\t\tpo.[PO Header ID] = rt.[PO Header ID]\r\n\tAND\t\t\tpo.[PO Line ID] = rt.[PO Line ID]\r\n\tAND\t\t\trt.[Transaction Type] = 'RECEIVE'\t\t\t\t\t\t\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tDISTINCT [SOURCE_HEADER_NUMBER]\r\n\t\t\t\t\t,\t\t\t[SHIP_FROM_LOCATION_ID]\r\n\t\t\t\t\t,\t\t\t[SHIP_TO_LOCATION_ID]\r\n\t\t\t\t\tFROM\t\t[Core].[ShippingDetails]\r\n\t\t\t\t) sd\r\n\tON\t\t\tso.[Order Number] = sd.[SOURCE_HEADER_NUMBER]\r\n\tAND\t\t\tso.[Submitted Flag] = 'Y'\t\t\t\t\t\t\t\t\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Blanket Purchase Agreement Number]\r\n\t\t\t\t\t,\t\t\t[Order Number]\r\n\t\t\t\t\t,\t\t\tMIN([Transaction Date]) AS [Transaction Date]\r\n\t\t\t\t\t,\t\t\t[Inventory Organization Code]\r\n\t\t\t\t\t,\t\t\t[Inventory Organization Name]\r\n\t\t\t\t\t,\t\t\t[Approval Status]\r\n\t\t\t\t\t,\t\t\t[Order Status]\t\t\t\r\n\t\t\t\t\t,\t\t\t[Supplier/Customer Number]\r\n\t\t\t\t\t,\t\t\t[Mode of Transport]\r\n\t\t\t\t\t,\t\t\t[Business Unit]\r\n\t\t\t\t\t,\t\t\tSUM(CAST([Invoiced Quantity] AS DECIMAL(28,4))) AS [Total Invoiced Quantity]\r\n\t\t\t\t\tFROM\t\tSupplyChain.PurchaseInvoicesAndContractNumber\r\n\t\t\t\t\tWHERE\t\t[Approval Status] <> 'CANCELLED'\r\n\t\t\t\t\tGROUP BY\t[Blanket Purchase Agreement Number]\r\n\t\t\t\t\t,\t\t\t[Order Number]\r\n\t\t\t\t\t,\t\t\t[Inventory Organization Code]\r\n\t\t\t\t\t,\t\t\t[Inventory Organization Name]\r\n\t\t\t\t\t,\t\t\t[Approval Status]\r\n\t\t\t\t\t,\t\t\t[Order Status]\t\t\t\r\n\t\t\t\t\t,\t\t\t[Supplier/Customer Number]\r\n\t\t\t\t\t,\t\t\t[Mode of Transport]\r\n\t\t\t\t\t,\t\t\t[Business Unit]\r\n\t\t\t\t) poi\r\n\tON\t\t\tpo.[Purchase Order Number] = poi.[Order Number]\t\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Business Unit Name]\r\n\t\t\t\t\t,\t\t\t[Order Number]\r\n\t\t\t\t\t,\t\t\t[Sales Contract Number]\r\n\t\t\t\t\t,\t\t\tSUM([Invoiced Quantity]) AS [Total Invoiced Quantity]\r\n\t\t\t\t\t,\t\t\tMIN([Transaction Date]) AS [Transaction Date]\r\n\t\t\t\t\tFROM\t\tSupplyChain.SalesInvoicesAndContractNumber\r\n\t\t\t\t\tGROUP BY\t[Business Unit Name]\r\n\t\t\t\t\t,\t\t\t[Order Number]\r\n\t\t\t\t\t,\t\t\t[Sales Contract Number]\r\n\t\t\t\t) soi\r\n\tON\t\t\tso.[Order Number] = soi.[Order Number]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Inventory Item ID]\r\n\t\t\t\t\t,\t\t\t[Item Code]\r\n\t\t\t\t\t,\t\t\tMAX([Item Name]) AS [Item Name] \r\n\t\t\t\t\tFROM\t\tCore.Items\r\n\t\t\t\t\tGROUP BY\t[Inventory Item ID]\r\n\t\t\t\t\t,\t\t\t[Item Code]\r\n\t\t\t\t) i\r\n\tON\t\t\ti.[Inventory Item ID] = COALESCE(po.[Item ID],so.[Inventory Item ID]) \r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tDISTINCT [Sales Contract Number]\r\n\t\t\t\t\t,\t\t\t[Shipping Method]\r\n\t\t\t\t\t,\t\t\t[Business Unit Name]\r\n\t\t\t\t\t,\t\t\t[Customer Ship To]\r\n\t\t\t\t\t,\t\t\t[sc].[Customer]\r\n\t\t\t\t\t,\t\t\t[sc].[Customer Number]\r\n\t\t\t\t\tFROM\t\t[SupplyChain].[SalesContracts] sc\r\n\t\t\t\t\tWHERE\t\tsc.[DateStamp] = (SELECT MAX([DateStamp]) FROM [SupplyChain].[SalesContracts])\r\n\t\t\t\t) sc\r\n\tON\t\t\tCOALESCE(COALESCE(poi.[Blanket Purchase Agreement Number],soi.[Sales Contract Number]),u.[Order Number]) = sc.[Sales Contract Number]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\t,\t\t\tREPLACE(CONCAT([Company Name],',',ISNULL([Address Line 2],''),',',ISNULL([Address Line 3],'')),',,',',') AS [Address]\r\n\t\t\t\t\tFROM\t\tCore.Locations\r\n\t\t\t\t) l1\r\n\tON\t\t\trt.[Ship From Location ID] = l1.[Location ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\t,\t\t\tREPLACE(CONCAT([Company Name],',',ISNULL([Address Line 2],''),',',ISNULL([Address Line 3],'')),',,',',') AS [Address]\r\n\t\t\t\t\tFROM\t\tCore.Locations\r\n\t\t\t\t) l2\r\n\tON\t\t\tsd.[SHIP_TO_LOCATION_ID] = l2.[Location ID]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\t\tSELECT\t\tDISTINCT [Business Unit Name],\r\n                                    [Blanket Purchase Agreement Number],\r\n\t\t\t\t\t\t\t\t\t[Supplier Name],\r\n                                    DateStamp\r\n\t\t\t\t\t\tFROM\t\tSupplyChain.PurchaseContracts\r\n\t\t\t\t\t\tWHERE\t\t[DateStamp] = (SELECT MAX([DateStamp]) FROM [SupplyChain].PurchaseContracts)\r\n\t\t\t\t) pc\r\n\tON\t\t\tpc.[Blanket Purchase Agreement Number] = COALESCE(COALESCE(poi.[Blanket Purchase Agreement Number],soi.[Sales Contract Number]),u.[Order Number])\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tDISTINCT [Business Unit Name]\r\n\t\t\t\t\t,\t\t\t[Business Unit ID]\r\n\t\t\t\t\t,\t\t\to.[Party ID]\r\n\t\t\t\t\t,\t\t\tp.[Location ID]\r\n\t\t\t\t\t,\t\t\tl.[Country]\r\n\t\t\t\t\t,\t\t\tl.[City]\r\n\t\t\t\t\t,\t\t\tl.[Postal Code]\r\n\t\t\t\t\t,\t\t\tl.[Company Name]\r\n\t\t\t\t\t,\t\t\tREPLACE(CONCAT([l].[Company Name],',',ISNULL([l].[Address Line 2],''),',',ISNULL([l].[Address Line 3],'')),',,',',') AS [Address]\r\n\t\t\t\t\tFROM\t\tCore.Organizations o\r\n\t\t\t\t\tLEFT JOIN\tCore.Parties p\r\n\t\t\t\t\tON\t\t\tp.[Party ID] = o.[Party ID]\r\n\t\t\t\t\tLEFT JOIN\tCore.Locations l\r\n\t\t\t\t\tON\t\t\tp.[Location ID] = l.[Location ID]\r\n\t\t\t\t\tWHERE\t\to.[Party ID] <> 'N/A'\r\n\t\t\t\t) bu\r\n\tON\t\t\tCOALESCE(poi.[Business Unit],soi.[Business Unit Name],pc.[Business Unit Name],sc.[Business Unit Name]) = bu.[Business Unit Name]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Party ID]\r\n\t\t\t\t\t,\t\t\t[Party Site Name]\r\n\t\t\t\t\t,\t\t\tMIN(l.[Country]) AS [Country]\r\n\t\t\t\t\t,\t\t\tMIN(l.[City]) AS [City]\r\n\t\t\t\t\t,\t\t\tMIN(l.[Postal Code]) AS [Postal Code]\r\n\t\t\t\t\t,\t\t\tMIN(l.[Company Name]) AS [Company Name]\r\n\t\t\t\t\t,\t\t\tMIN(REPLACE(CONCAT([l].[Company Name],',',ISNULL([l].[Address Line 2],''),',',ISNULL([l].[Address Line 3],'')),',,',',')) AS [Address]\r\n\t\t\t\t\tFROM\t\tCore.Parties p\r\n\t\t\t\t\tLEFT JOIN\tCore.Locations l\r\n\t\t\t\t\tON\t\t\tp.[Location ID] = l.[Location ID]\r\n\t\t\t\t\tGROUP BY\t[Party ID]\r\n\t\t\t\t\t,\t\t\t[Party Site Name]\r\n\t\t\t\t) l3\r\n\tON\t\t\tso.[Sold To Party ID] = l3.[Party ID]\r\n\tAND\t\t\tsc.[Customer Ship To] = l3.[Party Site Name]\t\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Party ID]\r\n\t\t\t\t\t,\t\t\t[Party Site Name]\r\n\t\t\t\t\t,\t\t\tl.[Country]\r\n\t\t\t\t\t,\t\t\tl.[City]\r\n\t\t\t\t\t,\t\t\tl.[Postal Code]\r\n\t\t\t\t\t,\t\t\tREPLACE(CONCAT([l].[Company Name],',',ISNULL([l].[Address Line 2],''),',',ISNULL([l].[Address Line 3],'')),',,',',') AS [Address]\r\n\t\t\t\t\t,\t\t\tl.[Company Name]\r\n\t\t\t\t\tFROM\t\tCore.Parties p\r\n\t\t\t\t\tLEFT JOIN\tCore.Locations l\r\n\t\t\t\t\tON\t\t\tp.[Location ID] = l.[Location ID]\r\n\t\t\t\t\tWHERE\t\tp.[Primary Party Site] = 'Y'\r\n\t\t\t\t\tAND\t\t\tp.[Party Site Name] <> 'Do Not Use'\r\n\t\t\t\t) l4\r\n\tON\t\t\tso.[Sold To Party ID] = l4.[Party ID]\r\n\tLEFT JOIN\tCore.Suppliers su\r\n\tON\t\t\tsu.[Vendor ID] = po.[Supplier]\r\n\tAND\t\t\tsu.[Vendor SIte ID] = po.[Supplier Site]\r\n\tLEFT JOIN\tCore.Locations l5\r\n\tON\t\t\tl5.[Location ID] = su.[Location ID]\r\n\tWHERE\t\t[i].[Item Code] NOT LIKE 'SE%' OR [i].[Item Code] IS NULL\r\n\tORDER BY\t[Index], COALESCE(poi.[Transaction Date],soi.[Transaction Date])\r\n"
						}
					]
				}
			}
		],
		"folder": {
			"name": "Supply Chain"
		},
		"annotations": []
	}
}