{
	"name": "SQL_Margin_Traceability_Report_Script",
	"properties": {
		"activities": [
			{
				"name": "Margin Traceability Report Script",
				"type": "Script",
				"dependsOn": [],
				"policy": {
					"timeout": "7.00:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"linkedServiceName": {
					"referenceName": "SqlServerArgent",
					"type": "LinkedServiceReference"
				},
				"typeProperties": {
					"scripts": [
						{
							"type": "NonQuery",
							"text": "/*==============================================================================================================================*\r\n * Project:\t\tArgent\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Purpose:\t\tFind the feedstock items that have been used to create each biodiesel sale\t\t\t\t\t\t\t\t\t\t*\r\n * Description:\t1) Create the traceability table which contains all movements of feedstock/biodiesel and the quantities involved*\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n *\t\t\t\t2) Self join the traceability table multiple times to trace each biodiesel sale back to the feedstock items\t    *\r\n *\t\t\t\t   that have been purchased.\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Prerequisites: Run Core tables script.\t\t\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Outputs: Tables \"Trade.Traceability\", \"Trade.TraceabilityLooped\"\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Date:       29/07/2022\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Version:     1.0\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\t\r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * SQL ATR - Complicated process but made up of basic joins.\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t* \r\n *\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n *==============================================================================================================================*\r\n * Updates:\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * Date\t\t| Version | Author\t\t| Change made\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n * -----------------------------------------------------------------------------------------------------------------------------*\r\n * --/--/-- |  1.-\t  |\t\t\t\t|\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *\t\t\t|\t\t  |\t\t\t\t|\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t*\r\n *==============================================================================================================================*/\r\n/********************************************************************************************************\r\n\tStep 2.1\tCreate traceability table.\r\n\r\n\t\t\t\tThis table is built using [Core].[InventoryTransactions], [Core].[ShippingDetails],\r\n\t\t\t\t[Core].[SalesOrders], [Core].[SalesOrders_Fulfilled], [Core].[Organizations], [Core].[ReceivingTransactions],\r\n\t\t\t\t[Core].[PurchaseOrders], [Core].[InventoryLotNumberTransactions] and [Core].[InventoryLotNumbers].\r\n\r\n\t\t\t\tThe table contains details all movements of inventory items throughout the business. This includes all feedstock items\r\n\t\t\t\tthat have been purchased, the quantity of every feedstock/biodiesel batch that gets created as well as the quantities of\r\n\t\t\t\tthe items used to produce them and also the details of the biodiesel sold.\r\n********************************************************************************************************/\r\n\tIF OBJECT_ID('[Trade].[Traceability]','U') IS NOT NULL\r\n\t\tDROP TABLE [Trade].[Traceability]\r\n\r\n\tSELECT\t\to.[Business Unit Name]\r\n\t,\t\t\tit.[SUBINVENTORY_CODE]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Subinventory]\r\n\t,\t\t\tCOALESCE(\r\n\t\t\t\t\t\t\tLEFT(it.[ATTRIBUTE_TIMESTAMP1],10)\r\n\t\t\t\t\t\t,\tLEFT(rt.[ATTRIBUTE_TIMESTAMP2],10)\r\n\t\t\t\t\t\t,\tCASE\r\n\t\t\t\t\t\t\t\tWHEN so.[Comments] LIKE '%Time Off Site%'\r\n\t\t\t\t\t\t\t\t\tTHEN \r\n\t\t\t\t\t\t\t\t\t\tCONCAT(\r\n\t\t\t\t\t\t\t\t\t\t\tRIGHT(SUBSTRING(so.[Comments],CHARINDEX('Time Off Site',so.[Comments])+14,10),4)\r\n\t\t\t\t\t\t\t\t\t\t,\tSUBSTRING(SUBSTRING(so.[Comments],CHARINDEX('Time Off Site',so.[Comments])+14,10),3,4)\r\n\t\t\t\t\t\t\t\t\t\t,\tLEFT(SUBSTRING(so.[Comments],CHARINDEX('Time Off Site',so.[Comments])+14,10),2)\r\n\t\t\t\t\t\t\t\t\t\t)\r\n\t\t\t\t\t\t\t\tELSE so.[Schedule Ship Date]\r\n\t\t\t\t\t\t\tEND\r\n\t\t\t\t\t\t,\tLEFT(sof.[REQUEST_SHIP_DATE],10)\r\n\t\t\t\t\t\t,\tLEFT(it.[TRANSACTION_DATE],10)\r\n\t\t\t\t\t\t)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Physical Date]\r\n\t,\t\t\tCOALESCE(\r\n\t\t\t\t\t\t\tpo.[Purchase Order Number]\r\n\t\t\t\t\t\t,\tso.[Order Number]\r\n\t\t\t\t\t\t,\tit.[TRANSACTION_SOURCE_NAME]\r\n\t\t\t\t\t\t,\tit.[TRANSACTION_REFERENCE]\t\r\n\t\t\t\t\t\t,\trsh.[RA_DOCUMENT_NUMBER]\r\n\t\t\t\t\t\t)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Document Number]\r\n\t,\t\t\tit.[TRANSACTION_TYPE_NAME]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Transaction Type]\r\n\t,\t\t\ti.[Item Code]\r\n\t,\t\t\ti.[Item Name]\r\n\t,\t\t\ti.[Unit of Measure]\t\t\t\t\t\t\t\t\t\t\t\r\n\t,\t\t\tCAST(ilnt.[PRIMARY_QUANTITY] AS NUMERIC(28,8))\t\t\t\t\t\t\t\t\t\t\tAS [Quantity]\r\n\t,\t\t\tit.[TRANSFER_SUBINVENTORY]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Transfer Subinventory]\r\n\t,\t\t\tilnt.[LOT_NUMBER]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Lot Numbers]\r\n\t,\t\t\tit.[TRANSACTION_ID]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [Transaction ID]\r\n\t,\t\t\tit.[CREATION_DATE]\r\n\t,\t\t\tit.[TRANSACTION_DATE]\r\n\t,\t\t\tsd.[SOURCE_HEADER_NUMBER]\r\n\t,\t\t\tsd.[SOURCE_LINE_NUMBER]\r\n\t,\t\t\tCAST(GETDATE() AS DATE)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tAS [DateStamp]\r\n\tINTO\t\t[Trade].[Traceability]\r\n\tFROM\t\t[Core].[InventoryTransactions] it\r\n\tLEFT JOIN\t[Core].[ShippingDetails] sd\r\n\tON\t\t\tit.[TRX_SOURCE_LINE_ID] = sd.[DELIVERY_DETAIL_ID]\r\n\tAND\t\t\tit.[TRANSACTION_SOURCE_TYPE_ID] = '2'\t\t\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Header ID]\r\n\t\t\t\t\t,\t\t\t[Order Number]\r\n\t\t\t\t\t,\t\t\t[Comments]\r\n\t\t\t\t\t,\t\t\tMAX([Schedule Ship Date]) AS [Schedule Ship Date]\r\n\t\t\t\t\t,\t\t\t[Submitted Flag]\r\n\t\t\t\t\tFROM\t\t[Core].[SalesOrders]\r\n\t\t\t\t\tGROUP BY\t[Header ID]\r\n\t\t\t\t\t,\t\t\t[Order Number]\r\n\t\t\t\t\t,\t\t\t[Comments]\r\n\t\t\t\t\t,\t\t\t[Submitted Flag]\r\n\t\t\t\t) so\r\n\tON\t\t\tso.[Order Number] = sd.[SOURCE_HEADER_NUMBER]\r\n\tAND\t\t\tso.[Submitted Flag] = 'Y'\t\r\n\tLEFT JOIN\t[Core].[SalesOrders_Fulfilled] sof\r\n\tON\t\t\tso.[Header ID] = sof.[HEADER_ID]\r\n\tAND\t\t\tsof.[FULFILL_LINE_ID] = sd.[SOURCE_SHIPMENT_ID]\r\n\tLEFT JOIN\t[Core].[Organizations] o\r\n\tON\t\t\to.[Organization ID] = it.[ORGANIZATION_ID]\r\n\tLEFT JOIN\t[Core].[Items] i\r\n\tON\t\t\ti.[Inventory Item ID] = it.[INVENTORY_ITEM_ID]\r\n\tAND\t\t\ti.[Organization ID] = it.[ORGANIZATION_ID]\r\n\tLEFT JOIN\t[Core].[ReceivingTransactions] rt\r\n\tON\t\t\trt.[Transaction ID] = it.[RCV_TRANSACTION_ID]\r\n\tLEFT JOIN\t[Core].[ReceivingShipmentHeaders] rsh\r\n\tON\t\t\trt.[Receipt Advice Header ID] = rsh.[SHIPMENT_HEADER_ID]\r\n    AND\t\t\trt.[Source Document Code] = 'RMA'\r\n    AND\t\t\trt.[Transaction Type] = 'DELIVER'\r\n\tLEFT JOIN\t[Core].[PurchaseOrders] po\r\n\tON\t\t\tpo.[PO Header ID] = rt.[PO Header ID]\r\n\tAND\t\t\tpo.[PO Line ID] = rt.[PO Line ID]\r\n\tLEFT JOIN\t[Core].[InventoryLotNumberTransactions] ilnt\r\n\tON\t\t\tilnt.[TRANSACTION_ID] = it.[TRANSACTION_ID]\r\n\tLEFT JOIN\t[Core].[InventoryLotNumbers] iln\r\n\tON\t\t\tiln.[LOT_NUMBER] = ilnt.[LOT_NUMBER]\r\n\tAND\t\t\tiln.[ORGANIZATION_ID] = o.[Organization ID]\r\n\tAND\t\t\tiln.[LOT_ATTRIBUTE_CATEGORY] IN ('Biodiesel','AENL Weigh Bridge')\r\n\tWHERE\t\to.[Business Unit Name] IN ('BDA BU','Motherwell','Stanlow')\r\n\tAND\t\t\to.[Inventory Organization Code] IN ('BDA','MBDR','MBLD''MCOM','MPTP','SBDR','SBLD','SCOM','SPOP','SPTP')\r\n\tAND\t\t\tLEFT(it.[TRANSACTION_DATE],10) >= '2021-01-01'\r\n\r\n/********************************************************************************************************\r\n\tStep 2.2\tFind the feedstock items that feed into each biodiesel batch.\r\n\r\n\t\t\t\tThis table is built by left joining [Trade].[Traceability] onto itself multiple times.\r\n********************************************************************************************************/\r\n\r\n\r\n\tIF OBJECT_ID('[Trade].[TraceabilityLooped]','U') IS NOT NULL\r\n\t\tDROP TABLE [Trade].[TraceabilityLooped]\r\n\r\n\tSELECT\t\tt1.[Physical Date]\r\n\t,\t\t\tt1.[CREATION_DATE]\r\n\t,\t\t\tt1.[Business Unit Name]\r\n\t,\t\t\tt1.[Document Number]\r\n\t,\t\t\tt1.[Transaction Type]\r\n\t,\t\t\tt1.[Item Code]\r\n\t,\t\t\tt1.[Item Name]\r\n\t,\t\t\tt1.[Unit of Measure]\r\n\t,\t\t\tCASE WHEN t1.[Unit of Measure] = 'LTR' THEN t1.[Quantity] * 0.0008745 ELSE t1.[Quantity] END AS [Quantity]\r\n\t,\t\t\tt1.[SOURCE_HEADER_NUMBER]\t\t\r\n\t,\t\t\tt1.[SOURCE_LINE_NUMBER]\r\n\t,\t\t\tt1.[Lot Numbers]\r\n\t,\t\t\tt2.[Document Number]\t\t\t\tAS [Document Number_2]\t\t\t\r\n\t,\t\t\tt2.[Transaction Type]\t\t\t\tAS [Transaction Type_2]\t\t\t\r\n\t,\t\t\tt2.[Item Code]\t\t\t\t\t\tAS [Item Code_2]\t\t\t\t\r\n\t,\t\t\tt2.[Item Name]\t\t\t\t\t\tAS [Item Name_2]\t\r\n\t,\t\t\tt2.[Unit of Measure]\t\t\t\tAS [Unit of Measure_2]\t\t\r\n\t,\t\t\tCASE WHEN t2.[Unit of Measure] = 'LTR' THEN t2.[Quantity] * 0.0008745 ELSE t2.[Quantity] END\t\t\t\t\t\tAS [Quantity_2]\t\t\t\t\t\r\n\t,\t\t\tt2.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_2]\t\t\t\r\n\t,\t\t\tt3.[Document Number] \t\t\t\tAS [Document Number_3] \t\t\t\r\n\t,\t\t\tt3.[Transaction Type]\t\t\t\tAS [Transaction Type_3]\t\t\t\r\n\t,\t\t\tt3.[Item Code]\t\t\t\t\t\tAS [Item Code_3]\t\t\t\t\r\n\t,\t\t\tt3.[Item Name]\t\t\t\t\t\tAS [Item Name_3]\t\r\n\t,\t\t\tt3.[Unit of Measure]\t\t\t\tAS [Unit of Measure_3]\t\t\t\t\r\n\t,\t\t\tCASE WHEN t3.[Unit of Measure] = 'LTR' THEN t3.[Quantity] * 0.0008745 ELSE t3.[Quantity] END\t\t\t\t\t\tAS [Quantity_3]\t\t\t\t\t\r\n\t,\t\t\tt3.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_3]\t\t\t\t\r\n\t,\t\t\tt4.[Document Number] \t\t\t\tAS [Document Number_4] \t\t\t\r\n\t,\t\t\tt4.[Transaction Type]\t\t\t\tAS [Transaction Type_4]\t\t\t\r\n\t,\t\t\tt4.[Item Code]\t\t\t\t\t\tAS [Item Code_4]\t\t\t\t\r\n\t,\t\t\tt4.[Item Name]\t\t\t\t\t\tAS [Item Name_4]\t\t\r\n\t,\t\t\tt4.[Unit of Measure]\t\t\t\tAS [Unit of Measure_4]\t\t\r\n\t,\t\t\tCASE WHEN t4.[Unit of Measure] = 'LTR' THEN t4.[Quantity] * 0.0008745 ELSE t4.[Quantity] END\t\t\t\t\t\tAS [Quantity_4]\t\t\t\t\t\r\n\t,\t\t\tt4.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_4]\t\t\t\t\r\n\t,\t\t\tt5.[Document Number] \t\t\t\tAS [Document Number_5] \t\t\t\r\n\t,\t\t\tt5.[Transaction Type]\t\t\t\tAS [Transaction Type_5]\t\t\t\r\n\t,\t\t\tt5.[Item Code]\t\t\t\t\t\tAS [Item Code_5]\t\t\t\t\r\n\t,\t\t\tt5.[Item Name]\t\t\t\t\t\tAS [Item Name_5]\r\n\t,\t\t\tt5.[Unit of Measure]\t\t\t\tAS [Unit of Measure_5]\t\t\t\t\t\r\n\t,\t\t\tCASE WHEN t5.[Unit of Measure] = 'LTR' THEN t5.[Quantity] * 0.0008745 ELSE t5.[Quantity] END\t\t\t\t\t\tAS [Quantity_5]\t\t\t\t\t\r\n\t,\t\t\tt5.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_5]\t\t\t\r\n\t,\t\t\tt6.[Document Number] \t\t\t\tAS [Document Number_6] \t\t\t\r\n\t,\t\t\tt6.[Transaction Type]\t\t\t\tAS [Transaction Type_6]\t\t\t\r\n\t,\t\t\tt6.[Item Code]\t\t\t\t\t\tAS [Item Code_6]\t\t\t\t\r\n\t,\t\t\tt6.[Item Name]\t\t\t\t\t\tAS [Item Name_6]\t\r\n\t,\t\t\tt6.[Unit of Measure]\t\t\t\tAS [Unit of Measure_6]\t\t\t\r\n\t,\t\t\tCASE WHEN t6.[Unit of Measure] = 'LTR' THEN t6.[Quantity] * 0.0008745 ELSE t6.[Quantity] END\t\t\t\t\t\tAS [Quantity_6]\t\t\t\t\t\r\n\t,\t\t\tt6.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_6]\t\r\n\t,\t\t\tt7.[Document Number] \t\t\t\tAS [Document Number_7] \t\t\t\r\n\t,\t\t\tt7.[Transaction Type]\t\t\t\tAS [Transaction Type_7]\t\t\t\r\n\t,\t\t\tt7.[Item Code]\t\t\t\t\t\tAS [Item Code_7]\t\t\t\t\r\n\t,\t\t\tt7.[Item Name]\t\t\t\t\t\tAS [Item Name_7]\t\r\n\t,\t\t\tt7.[Unit of Measure]\t\t\t\tAS [Unit of Measure_7]\t\t\t\t\r\n\t,\t\t\tCASE WHEN t7.[Unit of Measure] = 'LTR' THEN t7.[Quantity] * 0.0008745 ELSE t7.[Quantity] END\t\t\t\t\t\tAS [Quantity_7]\t\t\t\t\t\r\n\t,\t\t\tt7.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_7]\r\n\t,\t\t\tt8.[Document Number] \t\t\t\tAS [Document Number_8] \t\t\t\r\n\t,\t\t\tt8.[Transaction Type]\t\t\t\tAS [Transaction Type_8]\t\t\t\r\n\t,\t\t\tt8.[Item Code]\t\t\t\t\t\tAS [Item Code_8]\t\t\t\t\r\n\t,\t\t\tt8.[Item Name]\t\t\t\t\t\tAS [Item Name_8]\t\r\n\t,\t\t\tt8.[Unit of Measure]\t\t\t\tAS [Unit of Measure_8]\t\t\t\t\r\n\t,\t\t\tCASE WHEN t8.[Unit of Measure] = 'LTR' THEN t8.[Quantity] * 0.0008745 ELSE t8.[Quantity] END\t\t\t\t\tAS [Quantity_8]\t\t\t\t\t\r\n\t,\t\t\tt8.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_8]\t\t\t\r\n\t,\t\t\tt9.[Document Number] \t\t\t\tAS [Document Number_9] \t\t\t\r\n\t,\t\t\tt9.[Transaction Type]\t\t\t\tAS [Transaction Type_9]\t\t\t\r\n\t,\t\t\tt9.[Item Code]\t\t\t\t\t\tAS [Item Code_9]\t\t\t\t\r\n\t,\t\t\tt9.[Item Name]\t\t\t\t\t\tAS [Item Name_9]\t\r\n\t,\t\t\tt9.[Unit of Measure]\t\t\t\tAS [Unit of Measure_9]\t\t\t\t\r\n\t,\t\t\tCASE WHEN t9.[Unit of Measure] = 'LTR' THEN t9.[Quantity] * 0.0008745 ELSE t9.[Quantity] END\t\t\t\t\tAS [Quantity_9]\t\t\t\t\t\r\n\t,\t\t\tt9.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_9]\t\t\t\r\n\t,\t\t\tt10.[Document Number] \t\t\t\tAS [Document Number_10] \t\t\t\r\n\t,\t\t\tt10.[Transaction Type]\t\t\t\tAS [Transaction Type_10]\t\t\t\r\n\t,\t\t\tt10.[Item Code]\t\t\t\t\t\tAS [Item Code_10]\t\t\t\t\r\n\t,\t\t\tt10.[Item Name]\t\t\t\t\t\tAS [Item Name_10]\t\r\n\t,\t\t\tt10.[Unit of Measure]\t\t\t\tAS [Unit of Measure_10]\t\t\t\t\r\n\t,\t\t\tCASE WHEN t10.[Unit of Measure] = 'LTR' THEN t10.[Quantity] * 0.0008745 ELSE t10.[Quantity] END\t\t\t\t\tAS [Quantity_10]\t\t\t\t\t\r\n\t,\t\t\tt10.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_10]\t\r\n\t,\t\t\tt11.[Document Number]\t\t\t\tAS [Document Number_11] \t\r\n\t,\t\t\tt11.[Transaction Type]\t\t\t\tAS [Transaction Type_11]\t\r\n\t,\t\t\tt11.[Item Code]\t\t\t\t\t\tAS [Item Code_11]\t\t\t\r\n\t,\t\t\tt11.[Item Name]\t\t\t\t\t\tAS [Item Name_11]\t\t\r\n\t,\t\t\tt11.[Unit of Measure]\t\t\t\tAS [Unit of Measure_11]\t\t\r\n\t,\t\t\tCASE WHEN t11.[Unit of Measure] = 'LTR' THEN t11.[Quantity] * 0.0008745 ELSE t11.[Quantity] END\t\t\t\t\tAS [Quantity_11]\t\t\t\r\n\t,\t\t\tt11.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_11]\t\t\r\n\t,\t\t\tt12.[Document Number]\t\t\t\tAS [Document Number_12]\t\t\t\r\n\t,\t\t\tt12.[Transaction Type]\t\t\t\tAS [Transaction Type_12]\t\t\t\r\n\t,\t\t\tt12.[Item Code]\t\t\t\t\t\tAS [Item Code_12]\t\t\t\t\r\n\t,\t\t\tt12.[Item Name]\t\t\t\t\t\tAS [Item Name_12]\t\t\r\n\t,\t\t\tt12.[Unit of Measure]\t\t\t\tAS [Unit of Measure_12]\t\t\t\r\n\t,\t\t\tCASE WHEN t12.[Unit of Measure] = 'LTR' THEN t12.[Quantity] * 0.0008745 ELSE t12.[Quantity] END\t\t\t\t\tAS [Quantity_12]\t\t\t\t\t\r\n\t,\t\t\tt12.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_12]\t\t\t\r\n\t,\t\t\tt13.[Document Number] \t\t\t\tAS [Document Number_13] \t\t\t\r\n\t,\t\t\tt13.[Transaction Type]\t\t\t\tAS [Transaction Type_13]\t\t\t\r\n\t,\t\t\tt13.[Item Code]\t\t\t\t\t\tAS [Item Code_13]\t\t\t\t\r\n\t,\t\t\tt13.[Item Name]\t\t\t\t\t\tAS [Item Name_13]\t\t\r\n\t,\t\t\tt13.[Unit of Measure]\t\t\t\tAS [Unit of Measure_13]\t\t\t\r\n\t,\t\t\tCASE WHEN t13.[Unit of Measure] = 'LTR' THEN t13.[Quantity] * 0.0008745 ELSE t13.[Quantity] END\t\t\t\t\tAS [Quantity_13]\t\t\t\t\t\r\n\t,\t\t\tt13.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_13]\t\t\t\t\r\n\t,\t\t\tt14.[Document Number] \t\t\t\tAS [Document Number_14] \t\t\t\r\n\t,\t\t\tt14.[Transaction Type]\t\t\t\tAS [Transaction Type_14]\t\t\t\r\n\t,\t\t\tt14.[Item Code]\t\t\t\t\t\tAS [Item Code_14]\t\t\t\t\r\n\t,\t\t\tt14.[Item Name]\t\t\t\t\t\tAS [Item Name_14]\t\t\r\n\t,\t\t\tt14.[Unit of Measure]\t\t\t\tAS [Unit of Measure_14]\t\t\t\t\r\n\t,\t\t\tCASE WHEN t14.[Unit of Measure] = 'LTR' THEN t14.[Quantity] * 0.0008745 ELSE t14.[Quantity] END\t\t\t\t\tAS [Quantity_14]\t\t\t\t\t\r\n\t,\t\t\tt14.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_14]\t\t\t\t\r\n\t,\t\t\tt15.[Document Number] \t\t\t\tAS [Document Number_15] \t\t\t\r\n\t,\t\t\tt15.[Transaction Type]\t\t\t\tAS [Transaction Type_15]\t\t\t\r\n\t,\t\t\tt15.[Item Code]\t\t\t\t\t\tAS [Item Code_15]\t\t\t\t\r\n\t,\t\t\tt15.[Item Name]\t\t\t\t\t\tAS [Item Name_15]\t\t\r\n\t,\t\t\tt15.[Unit of Measure]\t\t\t\tAS [Unit of Measure_15]\t\t\t\r\n\t,\t\t\tCASE WHEN t15.[Unit of Measure] = 'LTR' THEN t15.[Quantity] * 0.0008745 ELSE t15.[Quantity] END\t\t\t\t\tAS [Quantity_15]\t\t\t\t\t\r\n\t,\t\t\tt15.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_15]\t\t\t\r\n\t,\t\t\tt16.[Document Number] \t\t\t\tAS [Document Number_16] \t\t\t\r\n\t,\t\t\tt16.[Transaction Type]\t\t\t\tAS [Transaction Type_16]\t\t\t\r\n\t,\t\t\tt16.[Item Code]\t\t\t\t\t\tAS [Item Code_16]\t\t\t\t\r\n\t,\t\t\tt16.[Item Name]\t\t\t\t\t\tAS [Item Name_16]\t\r\n\t,\t\t\tt16.[Unit of Measure]\t\t\t\tAS [Unit of Measure_16]\t\t\t\t\r\n\t,\t\t\tCASE WHEN t16.[Unit of Measure] = 'LTR' THEN t16.[Quantity] * 0.0008745 ELSE t16.[Quantity] END\t\t\t\t\tAS [Quantity_16]\t\t\t\t\t\r\n\t,\t\t\tt16.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_16]\t\r\n\t,\t\t\tt17.[Document Number] \t\t\t\tAS [Document Number_17] \t\t\t\r\n\t,\t\t\tt17.[Transaction Type]\t\t\t\tAS [Transaction Type_17]\t\t\t\r\n\t,\t\t\tt17.[Item Code]\t\t\t\t\t\tAS [Item Code_17]\t\t\t\t\r\n\t,\t\t\tt17.[Item Name]\t\t\t\t\t\tAS [Item Name_17]\t\t\r\n\t,\t\t\tt17.[Unit of Measure]\t\t\t\tAS [Unit of Measure_17]\t\t\t\r\n\t,\t\t\tCASE WHEN t17.[Unit of Measure] = 'LTR' THEN t17.[Quantity] * 0.0008745 ELSE t17.[Quantity] END\t\t\t\t\tAS [Quantity_17]\t\t\t\t\t\r\n\t,\t\t\tt17.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_17]\t\r\n\t,\t\t\tt18.[Document Number] \t\t\t\tAS [Document Number_18] \t\t\t\r\n\t,\t\t\tt18.[Transaction Type]\t\t\t\tAS [Transaction Type_18]\t\t\t\r\n\t,\t\t\tt18.[Item Code]\t\t\t\t\t\tAS [Item Code_18]\t\t\t\t\r\n\t,\t\t\tt18.[Item Name]\t\t\t\t\t\tAS [Item Name_18]\t\r\n\t,\t\t\tt18.[Unit of Measure]\t\t\t\tAS [Unit of Measure_18]\t\t\t\t\t\r\n\t,\t\t\tCASE WHEN t18.[Unit of Measure] = 'LTR' THEN t18.[Quantity] * 0.0008745 ELSE t18.[Quantity] END\t\t\t\t\tAS [Quantity_18]\t\t\t\t\t\r\n\t,\t\t\tt18.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_18]\t\t\r\n\t,\t\t\tt19.[Document Number] \t\t\t\tAS [Document Number_19] \t\t\t\r\n\t,\t\t\tt19.[Transaction Type]\t\t\t\tAS [Transaction Type_19]\t\t\t\r\n\t,\t\t\tt19.[Item Code]\t\t\t\t\t\tAS [Item Code_19]\t\t\t\t\r\n\t,\t\t\tt19.[Item Name]\t\t\t\t\t\tAS [Item Name_19]\t\t\r\n\t,\t\t\tt19.[Unit of Measure]\t\t\t\tAS [Unit of Measure_19]\t\t\t\r\n\t,\t\t\tCASE WHEN t19.[Unit of Measure] = 'LTR' THEN t19.[Quantity] * 0.0008745 ELSE t19.[Quantity] END\t\t\t\t\t\tAS [Quantity_19]\t\t\t\t\t\r\n\t,\t\t\tt19.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_19]\t\t\r\n\t,\t\t\tt20.[Document Number] \t\t\t\tAS [Document Number_20] \t\t\t\r\n\t,\t\t\tt20.[Transaction Type]\t\t\t\tAS [Transaction Type_20]\t\t\t\r\n\t,\t\t\tt20.[Item Code]\t\t\t\t\t\tAS [Item Code_20]\t\t\t\t\r\n\t,\t\t\tt20.[Item Name]\t\t\t\t\t\tAS [Item Name_20]\t\r\n\t,\t\t\tt20.[Unit of Measure]\t\t\t\tAS [Unit of Measure_20]\t\t\t\t\r\n\t,\t\t\tCASE WHEN t20.[Unit of Measure] = 'LTR' THEN t20.[Quantity] * 0.0008745 ELSE t20.[Quantity] END\t\t\t\t\t\tAS [Quantity_20]\t\t\t\t\t\r\n\t,\t\t\tt20.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_20]\t\r\n\t,\t\t\tt21.[Document Number] \t\t\t\tAS [Document Number_21] \t\t\t\r\n\t,\t\t\tt21.[Transaction Type]\t\t\t\tAS [Transaction Type_21]\t\t\t\r\n\t,\t\t\tt21.[Item Code]\t\t\t\t\t\tAS [Item Code_21]\t\t\t\t\r\n\t,\t\t\tt21.[Item Name]\t\t\t\t\t\tAS [Item Name_21]\t\r\n\t,\t\t\tt21.[Unit of Measure]\t\t\t\tAS [Unit of Measure_21]\t\t\t\t\r\n\t,\t\t\tCASE WHEN t21.[Unit of Measure] = 'LTR' THEN t21.[Quantity] * 0.0008745 ELSE t21.[Quantity] END\t\t\t\t\t\tAS [Quantity_21]\t\t\t\t\t\r\n\t,\t\t\tt21.[Lot Numbers]\t\t\t\t\tAS [Lot Numbers_21]\t\r\n\t,\t\t\tCAST(GETDATE() AS DATE)\t\t\t\tAS [DateStamp]\r\n\tINTO\t\t[Trade].[TraceabilityLooped]\r\n\tFROM\t\t[Trade].[Traceability] t1\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Product Completion'\r\n\t\t\t\t\tAND\t\t\t[Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t) t2\r\n\tON\t\t\tt1.[Lot Numbers] = t2.[Lot Numbers]\r\n\tAND\t\t\tt1.[Item Code] = t2.[Item Code]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Material Issue'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t3\r\n\tON\t\t\tt2.[Document Number] = t3.[Document Number]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Product Completion'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t4\r\n\tON\t\t\tt3.[Lot Numbers] = t4.[Lot Numbers]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Material Issue'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t5\r\n\tON\t\t\tt4.[Document Number] = t5.[Document Number]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Product Completion'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t6\r\n\tON\t\t\tt5.[Lot Numbers] = t6.[Lot Numbers]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Material Issue'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t7\r\n\tON\t\t\tt6.[Document Number] = t7.[Document Number]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Product Completion'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t8\r\n\tON\t\t\tt7.[Lot Numbers] = t8.[Lot Numbers]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Material Issue'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t9\r\n\tON\t\t\tt8.[Document Number] = t9.[Document Number]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Product Completion'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t10\r\n\tON\t\t\tt9.[Lot Numbers] = t10.[Lot Numbers]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Material Issue'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t11\r\n\tON\t\t\tt10.[Document Number] = t11.[Document Number]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Product Completion'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t12\r\n\tON\t\t\tt11.[Lot Numbers] = t12.[Lot Numbers]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Material Issue'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t13\r\n\tON\t\t\tt12.[Document Number] = t13.[Document Number]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Product Completion'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t14\r\n\tON\t\t\tt13.[Lot Numbers] = t14.[Lot Numbers]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Material Issue'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t15\r\n\tON\t\t\tt14.[Document Number] = t15.[Document Number]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Product Completion'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t16\r\n\tON\t\t\tt15.[Lot Numbers] = t16.[Lot Numbers]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Material Issue'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t17\r\n\tON\t\t\tt16.[Document Number] = t17.[Document Number]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Product Completion'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t18\r\n\tON\t\t\tt17.[Lot Numbers] = t18.[Lot Numbers]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Material Issue'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t19\r\n\tON\t\t\tt18.[Document Number] = t19.[Document Number]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Product Completion'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t20\r\n\tON\t\t\tt19.[Lot Numbers] = t20.[Lot Numbers]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t*\r\n\t\t\t\t\tFROM\t\t[Trade].[Traceability]\r\n\t\t\t\t\tWHERE\t\t[Transaction Type] = 'Work in Process Material Issue'\r\n\t\t\t\t\tAND\t\t\t([Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')\r\n\t\t\t\t\tOR\t\t\t[Item Code] LIKE 'FS%')\r\n\t\t\t\t) t21\r\n\tON\t\t\tt20.[Document Number] = t21.[Document Number]\r\n\tWHERE\t\tt1.[Transaction Type] = 'Sales Order Issue'\r\n\tAND\t\t\tt1.[Item Code] IN ('PR00900','PR00220','PR00150','PR00102','PR00100')"
						}
					]
				}
			}
		],
		"folder": {
			"name": "Trade/Margin"
		},
		"annotations": [],
		"lastPublishTime": "2022-11-21T20:07:57Z"
	},
	"type": "Microsoft.DataFactory/factories/pipelines"
}