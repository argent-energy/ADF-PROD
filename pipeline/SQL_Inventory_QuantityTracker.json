{
	"name": "SQL_Inventory_QuantityTracker",
	"properties": {
		"activities": [
			{
				"name": "Supply Chain Inventory Table",
				"type": "Script",
				"dependsOn": [],
				"policy": {
					"timeout": "7.00:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"linkedServiceName": {
					"referenceName": "SqlServerArgent",
					"type": "LinkedServiceReference"
				},
				"typeProperties": {
					"scripts": [
						{
							"type": "NonQuery",
							"text": "\r\n\tIF OBJECT_ID('tempdb..#DateList','U') IS NOT NULL \r\n\t\tDROP TABLE #DateList\r\n\r\n\tDECLARE @StartDate  date = (\r\n\t\t\t\t\t\t\t\t\tSELECT\t\tMIN([DateStamp])\r\n\t\t\t\t\t\t\t\t\tFROM\t\t[SupplyChain].[InventoryQuantityAndValue]\r\n\t\t\t\t\t\t\t\t)\r\n\r\n\tDECLARE @CutoffDate date =\t(\r\n\t\t\t\t\t\t\t\t\tSELECT\t\tMAX([DateStamp])\r\n\t\t\t\t\t\t\t\t\tFROM\t\t[SupplyChain].[InventoryQuantityAndValue]\r\n\t\t\t\t\t\t\t\t);\r\n\r\n\t;WITH seq(n) AS \r\n\t(\r\n\t  SELECT 0 UNION ALL SELECT n + 1 FROM seq\r\n\t  WHERE n < DATEDIFF(DAY, @StartDate, @CutoffDate)\r\n\t),\r\n\td([Date]) AS \r\n\t(\r\n\t  SELECT DATEADD(DAY, n, @StartDate) FROM seq\r\n\t)\r\n\tSELECT [Date] \r\n\tINTO #DateList\r\n\tFROM d\r\n\tORDER BY [Date]\r\n\tOPTION (MAXRECURSION 0);\r\n\r\n\r\n\tSELECT\t\t* \r\n\tINTO\t\t#DatesAndSubinventory\r\n\tFROM\t\t#DateList dl\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tDISTINCT [Subinventory]\r\n\t\t\t\t\tFROM\t\t[SupplyChain].[InventoryQuantityAndValue]\r\n\t\t\t\t) i\r\n\tON\t\t\t1=1\r\n\tORDER BY\tdl.[Date]\r\n\r\n\r\n\tSELECT\t\tdas.[Date]\r\n\t,\t\t\tdas.[Subinventory]\r\n\t,\t\t\t[Item Code]\r\n\t,\t\t\t[Item Name]\r\n\t,\t\t\t[Category Code]\r\n\t,\t\t\tSUM([Quantity]) AS [Quantity]\r\n\t,\t\t\tSUM([Value GBP]) AS [Value GBP]\r\n\t,\t\t\tSUM([Value EUR]) AS [Value EUR]\r\n\tINTO\t\t#InventoryGrouped\r\n\tFROM\t\t#DatesAndSubinventory das\r\n\tLEFT JOIN\t[SupplyChain].[InventoryQuantityAndValue] iq\r\n\tON\t\t\tdas.[Date] = iq.[DateStamp]\r\n\tAND\t\t\tdas.[Subinventory] = iq.[Subinventory]\r\n\t--WHERE\t\tdas.[Subinventory] = 'AOT003'\r\n\tGROUP BY\tdas.[Date]\r\n\t,\t\t\tdas.[Subinventory]\r\n\t,\t\t\t[Item Code]\r\n\t,\t\t\t[Item Name]\r\n\t,\t\t\t[Category Code]\r\n\t,\t\t\t[DateStamp]\r\n\r\n\r\n\tSELECT\t\t*\r\n\t,\t\t\t[Quantity] - LAG([Quantity])OVER(PARTITION BY [Subinventory],[Item Code] ORDER BY [Date]) AS [QuantityDifference]\r\n\t,\t\t\tCASE WHEN [Item Code] IS NULL THEN 1 ELSE 0 END AS [Empty Tank Identifier]\r\n\tINTO\t\t[SupplyChain].[SubinventoryQuantityTracker]\r\n\tFROM\t\t#InventoryGrouped\r\n\tORDER BY\t[Subinventory],[Date],[Item Code]\r\n\r\n\r\n\tIF OBJECT_ID('[SupplyChain].[SubinventoryLastEmptyTankDate]','U') IS NOT NULL\r\n\t\tDROP TABLE [SupplyChain].[SubinventoryLastEmptyTankDate]\r\n\r\n\tSELECT\t\ta.[Date]\r\n\t,\t\t\ta.[Subinventory]\r\n\t,\t\t\tSUM([Quantity])\tAS [Quantity]\r\n\t,\t\t\tSUM([Value GBP]) AS [Value GBP]\r\n\t,\t\t\tSUM([Value EUR]) AS [Value EUR]\r\n\t,\t\t\tb.[Last Empty Date]\r\n\t,\t\t\tc.[Last Increase Date]\r\n\tINTO\t\t[SupplyChain].[SubinventoryLastEmptyTankDate]\r\n\tFROM\t\t[SupplyChain].[SubinventoryQuantityTracker] a\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Subinventory]\r\n\t\t\t\t\t,\t\t\tMAX([Date]) AS [Last Empty Date]\r\n\t\t\t\t\tFROM\t\t[SupplyChain].[SubinventoryQuantityTracker]\r\n\t\t\t\t\tWHERE\t\t[Empty Tank Identifier] = 1\r\n\t\t\t\t\tGROUP BY\t[Subinventory]\r\n\t\t\t\t) b\r\n\tON\t\t\ta.[Subinventory] = b.[Subinventory]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Subinventory]\r\n\t\t\t\t\t,\t\t\tMAX([Date]) AS [Last Increase Date]\r\n\t\t\t\t\tFROM\t\t[SupplyChain].[SubinventoryQuantityTracker]\r\n\t\t\t\t\tWHERE\t\t[QuantityDifference] > 0\r\n\t\t\t\t\tGROUP BY\t[Subinventory]\r\n\t\t\t\t) c\r\n\tON\t\t\ta.[Subinventory] = c.[Subinventory]\r\n\tWHERE\t\t[Date] = (SELECT MAX([Date]) FROM [SupplyChain].[SubinventoryQuantityTracker])\r\n\tGROUP BY\ta.[Date]\r\n\t,\t\t\ta.[Subinventory]\r\n\t,\t\t\tb.[Last Empty Date]\r\n\t,\t\t\tc.[Last Increase Date]\r\n\tORDER BY\ta.[Subinventory],[Date]\r\n\r\n\r\n\r\n\tSELECT\t\t*\r\n\tFROM\t\t[SupplyChain].[SubinventoryLastEmptyTankDate]\r\n\r\n\r\n\r\n--\tCREATE TABLE [RAW].[SC.Inventory_SafetyStock_TankHeels]\r\n--\t(\r\n--\t\t[Tank] NVARCHAR(50)\r\n--\t,\t[Product] NVARCHAR(50)\r\n--\t,\t[Tank Size] NVARCHAR(50)\r\n--\t,\t[Safety Stock] NVARCHAR(50)\r\n--\t,\t[Heel in mt] NVARCHAR(50)\r\n--\t,\t[Country] NVARCHAR(50)\r\n--\t)\r\n\r\n\r\n--\tINSERT INTO [RAW].[SC.Inventory_SafetyStock_TankHeels] (Tank,Product,[Tank Size],[Safety Stock],[Heel in mt],Country) VALUES \r\n--\t('2','Tallow Sterilized','275','125','25','UK'),\r\n--('18'\t,'Tallow Sterilized'\t\t,'450'\t,'125'\t,'40'\t,'UK'\t\t  )\t\t\t\t,\r\n--('68'\t,'Tallow Sterilized'\t\t,'450'\t,'125'\t,'40'\t,'UK'\t\t  )\t\t\t\t,\r\n--('3'\t\t,'Tallow unsterlized'\t,'275'\t,'125'\t,'25'\t,'UK'\t\t\t  )\t\t\t,\r\n--('5'\t\t,'Tallow unsterlized'\t,'275'\t,'125'\t,'25'\t,'UK'\t\t\t  )\t\t\t,\r\n--('12'\t,'Tallow Sterilized'\t\t,'450'\t,'125'\t,'40'\t,'UK'\t\t  )\t\t\t\t,\r\n--('19'\t,'Tallow unsterlized'\t,'450'\t,'125'\t,'40'\t,'UK'\t\t\t  )\t\t\t\t,\r\n--('20'\t,'Tallow unsterlized'\t,'450'\t,'125'\t,'40'\t,'UK'\t\t\t  )\t\t\t\t,\r\n--('65'\t,'Tallow unsterlized'\t,'450'\t,'125'\t,'40'\t,'UK'\t\t\t  )\t\t\t\t,\r\n--('69'\t,'Tallow unsterlized'\t,'450'\t,'125'\t,'40'\t,'UK'\t\t\t  )\t\t\t\t,\r\n--('70'\t,'Tallow unsterlized'\t,'450'\t,'125'\t,'40'\t,'UK'\t\t\t  )\t\t\t\t,\r\n--('300'\t,'POME'\t\t\t\t\t,'2700'\t,'650'\t,'100'\t,'UK'\t\t\t  )\t\t\t\t,\r\n--('301'\t,'POME'\t\t\t\t\t,'2700'\t,'650'\t,'100'\t,'UK'\t\t\t  )\t\t\t\t,\r\n--('302'\t,'POME'\t\t\t\t\t,'2700'\t,'650'\t,'100'\t,'UK'\t\t\t  )\t\t\t\t,\r\n--('305'\t,'POME'\t\t\t\t\t,'2700'\t,'650'\t,'100'\t,'UK'\t\t\t  )\t\t\t\t,\r\n--('21'\t,'Biodiesel'\t\t\t\t,'2200'\t,'200'\t,'20'\t,'UK'\t\t  )\t\t\t\t,\r\n--('24'\t,'Biodiesel'\t\t\t\t,'900'\t,'200'\t,'10'\t,'UK'\t\t  )\t\t\t\t,\r\n--('25'\t,'Biodiesel'\t\t\t\t,'900'\t,'200'\t,'10'\t,'UK'\t\t  )\t\t\t\t,\r\n--('26'\t,'Biodiesel'\t\t\t\t,'900'\t,'200'\t,'10'\t,'UK'\t\t  )\t\t\t\t,\r\n--('27'\t,'Biodiesel'\t\t\t\t,'900'\t,'200'\t,'10'\t,'UK'\t\t  )\t\t\t\t,\r\n--('29'\t,'Biodiesel'\t\t\t\t,'900'\t,'200'\t,'10'\t,'UK'\t\t  )\t\t\t\t,\r\n--('99'\t,'Biodiesel'\t\t\t\t,'900'\t,'200'\t,'10'\t,'UK'\t\t  )\t\t\t\t,\r\n--('100'\t,'Biodiesel'\t\t\t\t,'1250'\t,'200'\t,'10'\t,'UK'\t\t  )\t\t\t\t,\r\n--('303'\t,'Biodiesel'\t\t\t\t,'2700'\t,'200'\t,'30'\t,'UK'\t\t  )\t\t\t\t,\r\n--('304'\t,'Biodiesel'\t\t\t\t,'2700'\t,'200'\t,'30'\t,'UK'\t\t  )\t\t\t\t,\r\n--('4'\t\t,'BFO Clean'\t\t\t\t,'275'\t,'0'\t\t,'15'\t,'UK'\t  )\t\t\t,\r\n--('7'\t\t,'BFO Clean'\t\t\t\t,'275'\t,'0'\t\t,'15'\t,'UK'\t  )\t\t\t,\r\n--('8'\t\t,'BFO Clean'\t\t\t\t,'275'\t,'0'\t\t,'15'\t,'UK'\t  )\t\t\t,\r\n--('9'\t\t,'BFO Clean'\t\t\t\t,'275'\t,'0'\t\t,'15'\t,'UK'\t  )\t\t\t,\r\n--('10'\t,'BFO Clean'\t\t\t\t,'275'\t,'0'\t\t,'15'\t,'UK'\t  )\t\t\t\t,\r\n--('1'\t\t,'Glycerine' \t\t\t,'300'\t,'0'\t\t,'25'\t,'UK'\t\t  )\t\t\t,\r\n--('11'\t,'Glycerine' \t\t\t,'450'\t,'0'\t\t,'40'\t,'UK'\t\t  )\t\t\t\t,\r\n--('6'\t\t,'GLP'\t\t\t\t\t,'300'\t,'0'\t\t,'25'\t,'UK'\t\t  )\t\t\t,\r\n--('14'\t,'GLP'\t\t\t\t\t,'450'\t,'0'\t\t,'40'\t,'UK'\t\t  )\t\t\t\t,\r\n--('R1022'\t,'Tallow CAT1'\t\t\t,'840'\t,'555'\t,'30'\t,'NL'\t\t\t  )\t\t\t,\r\n--('R2016'\t,'Tallow CAT1'\t\t\t,'1745'\t,'555'\t,'50'\t,'NL'\t\t\t  )\t\t\t,\r\n--('R1506'\t,'Tallow CAT1'\t\t\t,'1296'\t,'555'\t,'40'\t,'NL'\t\t\t  )\t\t\t,\r\n--('R1025'\t,'Tallow CAT1'\t\t\t,'846'\t,'555'\t,'30'\t,'NL'\t\t\t  )\t\t\t,\r\n--('R1509'\t,'Tallow CAT1'\t\t\t,'1296'\t,'555'\t,'40'\t,'NL'\t\t\t  )\t\t\t,\r\n--('R1023'\t,'Tallow CAT1'\t\t\t,'846'\t,'555'\t,'30'\t,'NL'\t\t\t  )\t\t\t,\r\n--('R2015'\t,'Tallow CAT1'\t\t\t,'1745'\t,'555'\t,'50'\t,'NL'\t\t\t  )\t\t\t,\r\n--('R1508'\t,'Tallow CAT1'\t\t\t,'1250'\t,'555'\t,'40'\t,'NL'\t\t\t  )\t\t\t,\r\n--('R1510'\t,'Tallow CAT1'\t\t\t,'1250'\t,'555'\t,'40'\t,'NL'\t\t\t  )\t\t\t,\r\n--('R1024'\t,'BFO Clean'\t\t\t\t,'830'\t,'0'\t\t,'0'\t\t,'NL' )\t\t\t,\r\n--('R806'\t,'BFO Clean'\t\t\t\t,'690'\t,'0'\t\t,'0'\t\t,'NL' )\t\t\t\t,\r\n--('R1505'\t,'Glycerine'\t\t\t\t,'1780'\t,'0'\t\t,'150'\t,'NL'\t  )\t\t\t,\r\n--('R1507'\t,'Glycerine'\t\t\t\t,'1780'\t,'0'\t\t,'150'\t,'NL'\t  )\t\t\t,\r\n--('R490'\t,'Biodiesel'\t\t\t\t,'450'\t,'0'\t\t,'0'\t\t,'NL' )\t\t\t\t,\r\n--('R491'\t,'Biodiesel'\t\t\t\t,'450'\t,'0'\t\t,'0'\t\t,'NL' )\t\t\t\t,\r\n--('R492'\t,'Biodiesel'\t\t\t\t,'450'\t,'0'\t\t,'0'\t\t,'NL' )\t\t\t\t,\r\n--('R2601'\t,'Biodiesel'\t\t\t\t,'2000'\t,'0'\t\t,'0'\t\t,'NL' )\t\t\t,\r\n--('R2602'\t,'Biodiesel'\t\t\t\t,'2000'\t,'0'\t\t,'0'\t\t,'NL' )\t\t\t\r\n\r\n\r\n--SELECT * FROM [RAW].[SC.Inventory_SafetyStock_TankHeels]"
						}
					]
				}
			}
		],
		"folder": {
			"name": "Supply Chain"
		},
		"annotations": []
	}
}