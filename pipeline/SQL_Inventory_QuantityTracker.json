{
	"name": "SQL_Inventory_QuantityTracker",
	"properties": {
		"activities": [
			{
				"name": "Supply Chain Inventory Table",
				"type": "Script",
				"dependsOn": [],
				"policy": {
					"timeout": "7.00:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"linkedServiceName": {
					"referenceName": "SqlServerArgent",
					"type": "LinkedServiceReference"
				},
				"typeProperties": {
					"scripts": [
						{
							"type": "NonQuery",
							"text": " /********************************************************************************************************\r\n\tStep 4.1:\tCreate a date list.\r\n********************************************************************************************************/\r\n\r\n\r\n\tIF OBJECT_ID('tempdb..#DateList','U') IS NOT NULL \r\n\t\tDROP TABLE #DateList\r\n\r\n\tDECLARE @StartDate  date = (\r\n\t\t\t\t\t\t\t\t\tSELECT\t\tMIN([DateStamp])\r\n\t\t\t\t\t\t\t\t\tFROM\t\t[SupplyChain].[InventoryQuantityAndValue]\r\n\t\t\t\t\t\t\t\t)\r\n\r\n\tDECLARE @CutoffDate date =\t(\r\n\t\t\t\t\t\t\t\t\tSELECT\t\tMAX([DateStamp])\r\n\t\t\t\t\t\t\t\t\tFROM\t\t[SupplyChain].[InventoryQuantityAndValue]\r\n\t\t\t\t\t\t\t\t);\r\n\r\n\t;WITH seq(n) AS \r\n\t(\r\n\t  SELECT 0 UNION ALL SELECT n + 1 FROM seq\r\n\t  WHERE n < DATEDIFF(DAY, @StartDate, @CutoffDate)\r\n\t),\r\n\td([Date]) AS \r\n\t(\r\n\t  SELECT DATEADD(DAY, n, @StartDate) FROM seq\r\n\t)\r\n\tSELECT [Date] \r\n\tINTO #DateList\r\n\tFROM d\r\n\tORDER BY [Date]\r\n\tOPTION (MAXRECURSION 0);\r\n\r\n /********************************************************************************************************\r\n\tStep 4.2:\tJoin the inventory value table on to the date list.\r\n********************************************************************************************************/\r\n\r\n\tSELECT\t\t* \r\n\tINTO\t\t#DatesAndSubinventory\r\n\tFROM\t\t#DateList dl\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\tDISTINCT [Subinventory]\r\n\t\t\t\t\tFROM\t\t[SupplyChain].[InventoryQuantityAndValue]\r\n\t\t\t\t) i\r\n\tON\t\t\t1=1\r\n\tORDER BY\tdl.[Date]\r\n\r\n /********************************************************************************************************\r\n\tStep 4.3:\tSum the quantities and values to the item level for each day.\r\n********************************************************************************************************/\r\n\r\n\tSELECT\t\tdas.[Date]\r\n\t,\t\t\tdas.[Subinventory]\r\n\t,\t\t\t[Item Code]\r\n\t,\t\t\t[Item Name]\r\n\t,\t\t\t[Category Code]\r\n\t,\t\t\tSUM([Quantity]) AS [Quantity]\r\n\t,\t\t\tSUM([Value GBP]) AS [Value GBP]\r\n\t,\t\t\tSUM([Value EUR]) AS [Value EUR]\r\n\tINTO\t\t#InventoryGrouped\r\n\tFROM\t\t#DatesAndSubinventory das\r\n\tLEFT JOIN\t[SupplyChain].[InventoryQuantityAndValue] iq\r\n\tON\t\t\tdas.[Date] = iq.[DateStamp]\r\n\tAND\t\t\tdas.[Subinventory] = iq.[Subinventory]\r\n\tGROUP BY\tdas.[Date]\r\n\t,\t\t\tdas.[Subinventory]\r\n\t,\t\t\t[Item Code]\r\n\t,\t\t\t[Item Name]\r\n\t,\t\t\t[Category Code]\r\n\t,\t\t\t[DateStamp]\r\n\r\n /********************************************************************************************************\r\n\tStep 4.4:\tCalculate the change in quantity for each item per day.\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[SupplyChain].[SubinventoryQuantityTracker]','U') IS NOT NULL\r\n\t\tDROP TABLE [SupplyChain].[SubinventoryQuantityTracker]\r\n\r\n\tSELECT\t\t*\r\n\t,\t\t\t[Quantity] - LAG([Quantity])OVER(PARTITION BY [Subinventory],[Item Code] ORDER BY [Date]) AS [QuantityDifference]\r\n\t,\t\t\tCASE WHEN [Item Code] IS NULL THEN 1 ELSE 0 END AS [Empty Tank Identifier]\r\n\tINTO\t\t[SupplyChain].[SubinventoryQuantityTracker]\r\n\tFROM\t\t#InventoryGrouped\r\n\tORDER BY\t[Subinventory],[Date],[Item Code]\r\n\r\n /********************************************************************************************************\r\n\tStep 4.5:\tFind the most recent date where the subinventory had no items and the most recent date\r\n\t\t\t\twhere the change in quantity of the items increased.\r\n********************************************************************************************************/\r\n\r\n\tIF OBJECT_ID('[SupplyChain].[SubinventoryLastEmptyTankDate]','U') IS NOT NULL\r\n\t\tDROP TABLE [SupplyChain].[SubinventoryLastEmptyTankDate]\r\n\r\n\tSELECT\t\ta.[Date]\r\n\t,\t\t\ta.[Subinventory]\r\n\t,\t\t\tSUM([Quantity])\tAS [Quantity]\r\n\t,\t\t\tSUM([Value GBP]) AS [Value GBP]\r\n\t,\t\t\tSUM([Value EUR]) AS [Value EUR]\r\n\t,\t\t\tb.[Last Empty Date]\r\n\t,\t\t\tc.[Last Increase Date]\r\n\tINTO\t\t[SupplyChain].[SubinventoryLastEmptyTankDate]\r\n\tFROM\t\t[SupplyChain].[SubinventoryQuantityTracker] a\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Subinventory]\r\n\t\t\t\t\t,\t\t\tMAX([Date]) AS [Last Empty Date]\r\n\t\t\t\t\tFROM\t\t[SupplyChain].[SubinventoryQuantityTracker]\r\n\t\t\t\t\tWHERE\t\t[Empty Tank Identifier] = 1\r\n\t\t\t\t\tGROUP BY\t[Subinventory]\r\n\t\t\t\t) b\r\n\tON\t\t\ta.[Subinventory] = b.[Subinventory]\r\n\tLEFT JOIN\t(\r\n\t\t\t\t\tSELECT\t\t[Subinventory]\r\n\t\t\t\t\t,\t\t\tMAX([Date]) AS [Last Increase Date]\r\n\t\t\t\t\tFROM\t\t[SupplyChain].[SubinventoryQuantityTracker]\r\n\t\t\t\t\tWHERE\t\t[QuantityDifference] > 0\r\n\t\t\t\t\tGROUP BY\t[Subinventory]\r\n\t\t\t\t) c\r\n\tON\t\t\ta.[Subinventory] = c.[Subinventory]\r\n\tWHERE\t\t[Date] = (SELECT MAX([Date]) FROM [SupplyChain].[SubinventoryQuantityTracker])\r\n\tGROUP BY\ta.[Date]\r\n\t,\t\t\ta.[Subinventory]\r\n\t,\t\t\tb.[Last Empty Date]\r\n\t,\t\t\tc.[Last Increase Date]\r\n\tORDER BY\ta.[Subinventory],[Date]\r\n"
						}
					]
				}
			}
		],
		"folder": {
			"name": "Supply Chain"
		},
		"annotations": []
	}
}